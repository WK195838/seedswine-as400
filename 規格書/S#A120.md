# S#A120程序規格書

## 1. 基本信息

| 項目 | 內容 |
|------|------|
| 程序ID | S#A120 |
| 程序名稱 | 使用者權限維護 |
| 所屬系統 | 西祺企業管理資訊系統 |
| 所屬子系統 | 程序權限管理系統 |
| 開發者 | 未指定 |
| 創建日期 | 未指定 |
| 最後更新 | 未指定 |
| 程序語言 | RPG |
| 程序位置 | QRPGSRC_REPLIB/S#A120.txt |

## 2. 程序概述

S#A120程序是西祺企業管理資訊系統中的一個重要管理工具，主要用於維護和管理系統中使用者對各程序的訪問權限。該程序提供了一個完整的界面，允許系統管理員查詢、新增、修改和刪除使用者的程序訪問權限，包括增加(ADD)、修改(UPD)、刪除(DLT)、查詢(INQ)等不同類型的權限。這是系統安全管理的核心組件，確保每個使用者只能訪問其被授權的程序和功能。

## 3. 系統架構

### 3.1 位置關係
S#A120程序位於程序權限管理系統中，是系統管理模塊的一部分，可從系統主菜單(S#M000)中的選項2訪問。

### 3.2 調用關係
- **被調用方式**：從系統主菜單(S#M000)的選項2調用
- **調用其他程序**：無明確調用其他程序的證據
- **相關文件**：
  - S#SDPF - 程序權限主檔（更新）
  - S#SPPF - 程序主檔（讀取）
  - S#SUPF - 使用者主檔（讀取）
  - S#A120D - 顯示文件

### 3.3 運行環境
- **操作系統**：IBM AS/400
- **運行庫**：REPLIB
- **所需資源**：
  - S#SDPF、S#SPPF、S#SUPF數據文件

## 4. 程序流程

### 4.1 主要流程
1. 初始化程序環境(RTN010)
2. 根據屏幕ID處理不同屏幕：
   - SC01：主屏幕，用於輸入查詢條件(RTN100)
   - SC02：子文件屏幕，顯示和維護權限(RTN200)
3. 主屏幕處理：
   - 顯示主屏幕(EXFMTDSPC1)
   - 檢查輸入參數(RTN110)
   - 根據輸入條件進入子文件屏幕
4. 子文件屏幕處理：
   - 初始化子文件(RTN210)
   - 添加子文件數據(RTN211)
   - 保護特定字段(RTN212)
   - 顯示子文件界面(RTN220)
5. 數據保存處理：
   - 新增模式(RTN310)
   - 修改模式(RTN320)
   - 刪除模式(RTN340)

### 4.2 流程圖
```
開始
  ↓
初始化程序環境(RTN010)
  ↓
根據屏幕ID分支
  ↓                 ↓
主屏幕(SC01)        子文件屏幕(SC02)
  ↓                 ↓
顯示主屏幕          初始化子文件(RTN210)
  ↓                 ↓
檢查輸入參數(RTN110) 添加子文件數據(RTN211)
  ↓                 ↓
進入子文件屏幕       保護特定字段(RTN212)
                    ↓
                   顯示子文件界面(RTN220)
                    ↓
                   處理用戶操作
                    ↓
                   根據操作類型分支
                    ↓        ↓        ↓
                   新增(RTN310) 修改(RTN320) 刪除(RTN340)
                    ↓        ↓        ↓
                   保存數據   保存數據   保存數據
                    ↓        ↓        ↓
                   返回子文件屏幕
  ↓
退出程序
  ↓
結束
```

## 5. 參數說明

程序沒有明確的輸入參數，但使用了以下主要變數：

| 變數名 | 類型 | 長度 | 說明 |
|--------|------|------|------|
| SCID | CHAR | 4 | 屏幕ID，用於區分不同屏幕 |
| DSD01 | CHAR | 10 | 使用者編號 |
| DSD021 | CHAR | 10 | 程序編號起始值 |
| DSD022 | CHAR | 10 | 程序編號結束值 |
| DOPT | CHAR | 1 | 操作類型（1=新增，2=修改，4=刪除） |

## 6. 程序代碼說明

### 6.1 主要變數

| 變數名 | 類型 | 長度 | 說明 |
|--------|------|------|------|
| CENTER | CHAR | 10 | 中心用戶ID |
| USER | CHAR | 10 | 當前用戶ID |
| WSD01 | CHAR | 10 | 程序權限主檔鍵值1(用戶ID) |
| WSD02 | CHAR | 10 | 程序權限主檔鍵值2(程序ID) |
| WFUN | 陣列 | 5x6 | 功能選項描述陣列 |
| SD03-SD09 | CHAR | 1 | 權限標誌（ADD、UPD、DLT、INQ等） |

### 6.2 子程序說明

#### 6.2.1 RTN010 - 初始化程序
- 初始化程序環境和變數
- 讀取當前用戶信息

#### 6.2.2 RTN100 - 主屏幕處理
- 顯示主屏幕
- 處理用戶輸入
- 檢查輸入參數(RTN110)

#### 6.2.3 RTN110 - 檢查主屏幕輸入
- 檢查使用者編號有效性
- 檢查程序編號範圍有效性
- 檢查用戶權限

#### 6.2.4 RTN200 - 子文件屏幕處理
- 初始化子文件(RTN210)
- 添加子文件數據(RTN211)
- 顯示子文件界面(RTN220)
- 處理用戶操作

#### 6.2.5 RTN210 - 初始化子文件
- 清除子文件
- 設置子文件控制指示符

#### 6.2.6 RTN211 - 添加子文件數據
- 根據查詢條件讀取程序權限數據
- 格式化數據並添加到子文件
- 調用RTN212保護特定字段

#### 6.2.7 RTN212 - 保護特定字段
- 根據用戶權限和數據狀態保護特定字段
- 控制哪些權限可以被修改

#### 6.2.8 RTN213 - 刷新子文件
- 用於刷新子文件顯示
- 在權限變更後重新加載數據

#### 6.2.9 RTN220 - 顯示子文件界面
- 顯示子文件控制記錄
- 處理功能鍵和用戶輸入

#### 6.2.10 RTN300 - 保存數據主程序
- 根據操作類型分派到不同的保存程序
- 處理數據驗證和錯誤

#### 6.2.11 RTN310 - 新增模式保存
- 保存新增的權限數據
- 更新程序權限主檔

#### 6.2.12 RTN320 - 修改模式保存
- 先刪除舊權限(RTN340)
- 再新增修改後的權限(RTN310)

#### 6.2.13 RTN340 - 刪除模式保存
- 刪除選定的權限記錄
- 更新程序權限主檔

## 7. 錯誤處理

### 7.1 程序內部錯誤處理
- 檢查使用者編號有效性
- 檢查程序編號範圍有效性
- 檢查用戶是否有權限進行操作
- 處理文件訪問錯誤

### 7.2 可能的錯誤情況
- 無效的使用者編號
- 程序編號範圍無效
- 用戶無權修改特定權限
- 文件訪問錯誤

## 8. 安全考慮

### 8.1 訪問控制
- 程序應只允許系統管理員和權限主管使用
- 中心用戶(CENTER)可以管理所有用戶的權限
- 非中心用戶只能管理其下屬用戶的權限

### 8.2 數據安全
- 程序修改關鍵的權限數據，應嚴格控制訪問
- 權限變更應有適當的記錄和審計

## 9. 性能考慮

### 9.1 執行效率
- 使用子文件提高顯示效率
- 使用鍵值訪問提高數據讀取效率

### 9.2 資源消耗
- CPU使用率：中等
- 內存使用：中等
- I/O操作：高（讀取和更新多個文件）

## 10. 測試要點

### 10.1 單元測試
- 測試不同用戶類型的權限限制
- 測試各種權限組合的新增、修改和刪除
- 測試錯誤處理和邊界條件

### 10.2 集成測試
- 與系統主菜單的集成
- 與其他權限管理功能的集成
- 測試權限變更後系統行為

## 11. 維護建議

### 11.1 日常維護
- 定期檢查程序是否正常運行
- 監控權限變更記錄
- 定期審核用戶權限

### 11.2 功能擴展建議
- 增加批量權限管理功能
- 增加權限模板功能
- 增加權限變更審計日誌
- 增加權限分析和報表功能

## 12. 相關文檔

### 12.1 系統文檔
- 西祺企業管理資訊系統技術手冊
- 程序權限管理系統使用指南
- IBM AS/400 RPG編程指南

### 12.2 技術參考
- AS/400子文件設計指南
- 系統安全管理最佳實踐

## 13. 版本歷史

| 版本號 | 更新日期 | 更新內容 | 更新者 |
|--------|----------|----------|--------|
| 1.0 | 未知 | 初始版本 | 未知 |

## 14. 附錄

### 14.1 顯示界面說明
- 主屏幕(SC01)：用於輸入查詢條件，包括使用者編號和程序編號範圍
- 子文件屏幕(SC02)：顯示和維護權限，包含程序列表和權限設置

### 14.2 數據文件結構
- S#SDPF（程序權限主檔）：
  - SD01：使用者編號
  - SD02：程序編號
  - SD03：新增權限(ADD)
  - SD04：修改權限(UPD)
  - SD05：刪除權限(DLT)
  - SD06：查詢權限(INQ)
  - SD07-SD09：其他權限標誌

- S#SUPF（使用者主檔）：
  - SU01：使用者編號
  - SU02：使用者名稱
  - SU03：上級主管編號

- S#SPPF（程序主檔）：
  - SP01：程序編號
  - SP02：程序名稱
  - SP03：程序類型

### 14.3 權限標誌說明
- SD03(ADD)：允許新增數據
- SD04(UPD)：允許修改數據
- SD05(DLT)：允許刪除數據
- SD06(INQ)：允許查詢數據
- SD07-SD09：其他自定義權限

### 14.4 調用示例
```
CALL S#A120
```

## 15. 結語

S#A120程序作為西祺企業管理資訊系統中的權限維護工具，提供了重要的系統安全管理功能。它允許系統管理員和權限主管維護和管理使用者對各程序的訪問權限，確保系統安全和數據保護。程序設計考慮了不同用戶類型的權限限制，提供了靈活的權限管理機制。建議在未來的系統升級中，考慮擴展其功能，增加更多的權限管理選項和審計功能，以滿足不斷發展的安全管理需求。