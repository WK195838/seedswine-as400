# S#S01程式規格說明文檔（完整版）

## 1. 基本資訊

- **程式名稱**：S#S01
- **程式類型**：RPG程式
- **程式庫**：REPLIB
- **功能描述**：系統權限檢查程式
- **相關檔案**：
  - S#SDPF（系統權限定義檔案）
  - MTMCPF（系統用戶主檔案）
  - S#SUPF（系統用戶權限檔案）
- **系統名稱**：西祺企業經營管理資訊系統
- **子系統**：系統基礎數據管理模塊
- **作者**：A1034 STEPHANIE
- **建立日期**：79/06/28
- **最後修改日期**：未明確標示
- **程式說明**：提供系統權限檢查功能，確保只有授權用戶才能訪問特定功能

## 2. 程式概述

S#S01是西祺企業經營管理資訊系統中的核心權限檢查程式，主要負責檢查用戶對特定程式的訪問權限。該程式通過檢查用戶ID和程式ID的組合，判斷用戶是否有權限執行特定的程式，並返回相應的權限標誌。

程式實現了多層次的權限控制機制，包括用戶級別權限、程式級別權限、功能級別權限、數據級別權限和操作級別權限。系統管理員和特殊用戶（如D9、RE或SC開頭的用戶）擁有全部權限，而一般用戶則根據S#SDPF和S#SUPF檔案中的設置分配權限。

S#S01程式採用模組化設計，主程式負責參數處理和權限判斷，而具體的權限檢查邏輯則由子程序完成，確保程式結構清晰、易於維護和擴展。程式還實現了嚴格的權限返回機制，通過明確的返回值傳遞權限檢查結果，避免模糊處理。

作為系統安全架構的關鍵組件，S#S01確保只有授權用戶才能訪問特定功能，保障系統的安全性和數據的完整性。

## 3. 程式流程詳解

### 3.1 主要流程圖

```
開始
  |
  ↓
初始化數據結構
  |
  ↓
獲取用戶類型
  |
  ↓
判斷用戶類型
  |   ↙        ↘
特殊用戶      一般用戶
  |              |
  ↓              ↓
設置全部權限    查詢S#SDPF檔案
  |              |
  ↓              ↓
查詢S#SUPF檔案  檢查權限記錄是否存在
  |              |   ↙        ↘
  |           存在          不存在
  |              |              |
  |              ↓              ↓
  |           查詢S#SUPF檔案   設置無權限
  |              |              |
  |              ↓              |
  |           獲取部門代碼      |
  |              |              |
  |              ↓              |
  |           查詢MTMCPF檔案    |
  |              |              |
  |              ↓              |
  |           設置有權限        |
  |              |              |
  ↓              ↓              ↓
返回權限標誌
  |
  ↓
結束
```

### 3.2 詳細流程說明

#### 3.2.1 初始化階段

```RPG
FS#SDPF  IF  E           K        DISK
FS#SUPF  IF  E           K        DISK
FMTMCPF  IF  E           K        DISK
IS#DA01       DS
I                                        1  10 $S#01
I                                      135 135 $ADD
I                                      136 136 $UPD
I                                      137 137 $DLT
I                                      138 138 $INQ
I                                      139 139 $RMK01
I                                      140 140 $RMK02
I                                      141 141 $RMK03
I                                      142 147 $DEP
I                                      148 151 $STORE
I                                      152 161 SU02
I                                      173 176 SU07
I                                      501 505 $WRHUS
I                                      506 506 $PURID
I                                      507 507 $TRNID
I                                      508 512 $APAU1
I                                      513 513 $WRHTY
I                                      522 522 $APAU2
I                                      523 524 MC26
```

1. **檔案宣告**：
   - `S#SDPF`：系統權限定義檔案，輸入模式
   - `S#SUPF`：系統用戶權限檔案，輸入模式
   - `MTMCPF`：系統用戶主檔案，輸入模式

2. **數據結構定義**：
   - 定義S#DA01數據結構，包含用戶ID、權限標誌、部門代碼等字段
   - 初始化MC26為0

#### 3.2.2 參數處理

1. **參數定義**：
   ```RPG
   C     *ENTRY    PLIST
   C                PARM           S0101I  10        用戶ID
   C                PARM           S0102I  10        程式ID
   C                PARM           S0101O   1        權限返回值
   ```
   - `S0101I`：用戶ID，輸入參數
   - `S0102I`：程式ID，輸入參數
   - `S0101O`：權限返回值，輸出參數

2. **用戶類型判斷**：
   ```RPG
   C                MOVE S0101I    $S#01
   C                Z-ADD0         MC26
   C                MOVE S0101I    USER     2
   C           USER      IFEQ 'D9'
   C                     EXSR RTN100
   C                     ELSE
   C           USER      IFEQ 'RE'
   C                     EXSR RTN100
   C                     ELSE
   C           USER      IFEQ 'SC'
   C                     EXSR RTN100
   C                     ELSE
   C           S0101I    IFEQ $S#01
   C                     EXSR RTN100
   C                     ELSE
   C                     EXSR RTN200
   C                     ENDIF
   C                     ENDIF
   C                     ENDIF
   C                     ENDIF
   ```
   - 從S0101I提取用戶ID前兩位到USER變量
   - 檢查S0101I是否等於$S#01（系統管理員）
   - 檢查USER是否等於'D9'、'RE'或'SC'（特殊用戶）
   - 如果是上述任一情況，執行RTN100子程序（特殊用戶處理）
   - 否則，執行RTN200子程序（一般用戶處理）

#### 3.2.3 特殊用戶處理

```RPG
C           RTN100    BEGSR
C                     MOVE 'Y'       $ADD
C                     MOVE 'Y'       $UPD
C                     MOVE 'Y'       $DLT
C                     MOVE 'Y'       $INQ
C                     MOVE 'Y'       $RMK01
C                     MOVE 'Y'       $RMK02
C                     MOVE 'Y'       $RMK03
C                     MOVE 'ALL'     $DEP
C                     MOVE 'ALL'     $STORE
C                     MOVE '*ALL'    $WRHUS
C                     MOVE 'C'       $PURID
C                     MOVE 'C'       $TRNID
C                     MOVE 'A'       $WRHTY
C                     MOVE 'YYYYY'   $APAU1
C                     MOVE 'Y'       $APAU2
C           KEYSU     CHAIN S#SUPF                  40
C                     MOVE 'Y'       S0101O
C                     ENDSR
```
- 設置所有權限標誌為'Y'：
  - $ADD = 'Y'（新增權限）
  - $UPD = 'Y'（修改權限）
  - $DLT = 'Y'（刪除權限）
  - $INQ = 'Y'（查詢權限）
  - $RMK01 = 'Y'（備註1權限）
  - $RMK02 = 'Y'（備註2權限）
  - $RMK03 = 'Y'（備註3權限）
- 設置部門代碼$DEP為'ALL'
- 設置門市代碼$STORE為'ALL'
- 設置倉庫代碼$WRHUS為'*ALL'
- 設置採購標識$PURID為'C'
- 設置轉移標識$TRNID為'C'
- 設置倉庫類型$WRHTY為'A'
- 設置審核權限$APAU1為'YYYYY'
- 設置審核權限$APAU2為'Y'
- 使用S0101I查詢S#SUPF檔案（CHAINSU0）
- 設置權限返回值S0101O為'Y'（可訪問）

#### 3.2.4 一般用戶處理

```RPG
C           RTN200    BEGSR
C                     MOVE 'N'       S0101O
C           KEYSD     CHAIN S#SDPF                  40
C           *IN40     IFEQ '0'
C           KEYSU     CHAIN S#SUPF                  40
C           SU04      IFNE *BLANKS
C                     MOVE SU04      $DEP
C                     ENDIF
C           SU05      IFNE *BLANKS
C                     MOVE SU05      $STORE
C                     ENDIF
C                     MOVE SU04      MC01
C           KEYMC     CHAIN MTMCPF                  40
C           *IN40     IFEQ '0'
C                     MOVE 'Y'       S0101O
C                     ENDIF
C                     ENDIF
C                     ENDSR
```
- 默認設置權限返回值S0101O為'N'（不可訪問）
- 使用KEYSD（用戶ID和程式ID組合）查詢S#SDPF檔案（CHAINSD0）
- 如果查詢成功（*IN40 = '0'）：
  - 使用S0101I查詢S#SUPF檔案（CHAINSU0）
  - 從S#SUPF獲取用戶的部門代碼SU04到$DEP
  - 從S#SUPF獲取用戶的門市代碼SU05到$STORE
  - 從SU04獲取部門代碼到MC01
  - 使用MC01查詢MTMCPF檔案（CHAINMC0）
  - 如果MTMCPF查詢成功（*IN40 = '0'）：
    - 設置權限返回值S0101O為'Y'（可訪問）

#### 3.2.5 結束處理

```RPG
C                     SETON                     LR
```
- 設置LR指示符
- 返回調用程式

## 基本信息

- **程式名稱**：S#S01
- **程式類型**：RPG程式
- **作者**：A1034 STEPHANIE
- **創建日期**：79/06/28
- **系統**：西祺企業管理信息系統 - 系統基礎數據管理模塊
- **用途**：系統權限檢查程式
- **程式位置**：QRPGSRC_REPLIB庫
- **相關版本**：S#S01S.txt（可能是備份或修改版本）

## 程式概述

S#S01是西祺企業管理信息系統中的核心權限檢查程式，主要負責檢查用戶對特定程式的訪問權限。該程式通過檢查用戶ID和程式ID的組合，判斷用戶是否有權限執行特定的程式，並返回相應的權限標誌。這是系統安全架構的關鍵組件，確保只有授權用戶才能訪問特定功能。

## 文件結構

程式使用以下三個主要文件：

1. **S#SDPF** - 系統權限定義文件
   - 類型：物理文件（PF）
   - 訪問方式：輸入文件（IF）
   - 鍵值：有（K）
   - 存儲：磁盤（DISK）
   - 用途：存儲用戶-程式權限映射關係

2. **MTMCPF** - 系統用戶主文件
   - 類型：物理文件（PF）
   - 訪問方式：輸入文件（IF）
   - 鍵值：有（K）
   - 存儲：磁盤（DISK）
   - 用途：存儲用戶基本信息和部門關係

3. **S#SUPF** - 系統用戶權限文件
   - 類型：物理文件（PF）
   - 訪問方式：輸入文件（IF）
   - 鍵值：有（K）
   - 存儲：磁盤（DISK）
   - 用途：存儲用戶的詳細權限設置

## 數據結構

### 1. S#DA01 - 系統權限數據結構

| 字段名 | 位置 | 長度 | 數據類型 | 說明 |
|--------|------|------|----------|------|
| $S#01 | 1-10 | 10 | 字符 | 系統用戶ID |
| $ADD/SD03 | 135 | 1 | 字符 | 新增權限標誌（Y/N） |
| $UPD/SD04 | 136 | 1 | 字符 | 修改權限標誌（Y/N） |
| $DLT/SD05 | 137 | 1 | 字符 | 刪除權限標誌（Y/N） |
| $INQ/SD06 | 138 | 1 | 字符 | 查詢權限標誌（Y/N） |
| $RMK01/SD07 | 139 | 1 | 字符 | 備註1權限標誌（Y/N） |
| $RMK02/SD08 | 140 | 1 | 字符 | 備註2權限標誌（Y/N） |
| $RMK03/SD09 | 141 | 1 | 字符 | 備註3權限標誌（Y/N） |
| $DEP | 142-147 | 6 | 字符 | 部門代碼 |
| $STORE | 148-151 | 4 | 字符 | 門市代碼 |
| SU02 | 152-161 | 10 | 字符 | 用戶相關字段 |
| SU07 | 173-176 | 4 | 字符 | 用戶相關字段 |
| MC15/$WRHUS | 501-505 | 5 | 字符 | 倉庫代碼 |
| MC16/$PURID | 506 | 1 | 字符 | 採購標識 |
| MC17/$TRNID | 507 | 1 | 字符 | 轉移標識 |
| MC18-MC22/$APAU1 | 508-512 | 5 | 字符 | 審核權限1 |
| MC24/$WRHTY | 513 | 1 | 字符 | 倉庫類型 |
| MC25/$APAU2 | 522 | 1 | 字符 | 審核權限2 |
| MC26 | 523-524 | 2 | 數值 | 用戶相關數值字段 |

### 2. S0101I - 輸入數據結構

| 字段名 | 位置 | 長度 | 數據類型 | 說明 |
|--------|------|------|----------|------|
| X0101I | 8-10 | 3 | 字符 | 輸入相關字段 |

## 參數列表

程式接受以下參數：

| 參數名 | 長度 | 數據類型 | 說明 | 方向 |
|--------|------|----------|------|------|
| S0101I | 10 | 字符 | 用戶ID | 輸入 |
| S0102I | 10 | 字符 | 程式ID | 輸入 |
| S0101O | 1 | 字符 | 權限返回值（Y/N） | 輸出 |

## 鍵值列表

程式定義了以下鍵值列表：

### KEYSD - 權限檢查鍵值列表
- S0101I - 用戶ID
- S0102I - 程式ID

## 主要邏輯流程

程式的主要邏輯流程如下：

1. **初始化階段**：
   - 定義數據結構S#DA01
   - 初始化MC26為0
   - 從S0101I提取用戶ID前兩位到USER變量

2. **用戶類型判斷**：
   - 檢查S0101I是否等於$S#01（系統管理員）
   - 檢查USER是否等於'D9'、'RE'或'SC'（特殊用戶）
   - 如果是上述任一情況，執行RTN100子程序（特殊用戶處理）
   - 否則，執行RTN200子程序（一般用戶處理）

3. **特殊用戶處理（RTN100）**：
   - 設置所有權限標誌為'Y'：
     - $ADD = 'Y'（新增權限）
     - $UPD = 'Y'（修改權限）
     - $DLT = 'Y'（刪除權限）
     - $INQ = 'Y'（查詢權限）
     - $RMK01 = 'Y'（備註1權限）
     - $RMK02 = 'Y'（備註2權限）
     - $RMK03 = 'Y'（備註3權限）
   - 設置部門代碼$DEP為'ALL'
   - 設置門市代碼$STORE為'ALL'
   - 設置倉庫代碼$WRHUS為'*ALL'
   - 設置採購標識$PURID為'C'
   - 設置轉移標識$TRNID為'C'
   - 設置倉庫類型$WRHTY為'A'
   - 設置審核權限$APAU1為'YYYYY'
   - 設置審核權限$APAU2為'Y'
   - 使用S0101I查詢S#SUPF文件（CHAINSU0）
   - 設置權限返回值S0101O為'Y'（可訪問）

4. **一般用戶處理（RTN200）**：
   - 默認設置權限返回值S0101O為'N'（不可訪問）
   - 使用KEYSD（用戶ID和程式ID組合）查詢S#SDPF文件（CHAINSD0）
   - 如果查詢成功（*IN40 = '0'）：
     - 使用S0101I查詢S#SUPF文件（CHAINSU0）
     - 從S#SUPF獲取用戶的部門代碼SU04到$DEP
     - 從S#SUPF獲取用戶的門市代碼SU05到$STORE
     - 從SU04獲取部門代碼到MC01
     - 使用MC01查詢MTMCPF文件（CHAINMC0）
     - 如果MTMCPF查詢成功（*IN40 = '0'）：
       - 設置權限返回值S0101O為'Y'（可訪問）

5. **結束處理**：
   - 設置LR指示符
   - 返回調用程式

## 權限控制機制詳解

S#S01實現了多層次的權限控制機制：

### 1. 用戶級別權限

根據用戶類型分配不同的權限：
- **系統管理員**（$S#01）：擁有全部權限
- **特殊用戶**（D9、RE、SC開頭）：擁有全部權限
- **一般用戶**：根據S#SDPF和S#SUPF文件中的設置分配權限

### 2. 程式級別權限

通過S#SDPF文件控制用戶對特定程式的訪問權限：
- 用戶ID和程式ID的組合作為鍵值
- 只有在S#SDPF中有對應記錄的用戶才能訪問特定程式

### 3. 功能級別權限

通過權限標誌控制用戶對特定功能的權限：
- $ADD：新增權限
- $UPD：修改權限
- $DLT：刪除權限
- $INQ：查詢權限
- $RMK01/$RMK02/$RMK03：備註相關權限

### 4. 數據級別權限

通過部門、門市、倉庫等代碼控制用戶對特定數據的訪問權限：
- $DEP：部門代碼，限制用戶只能訪問特定部門的數據
- $STORE：門市代碼，限制用戶只能訪問特定門市的數據
- $WRHUS：倉庫代碼，限制用戶只能訪問特定倉庫的數據

### 5. 操作級別權限

通過特定標識控制用戶的操作權限：
- $PURID：採購標識，控制用戶的採購相關操作
- $TRNID：轉移標識，控制用戶的轉移相關操作
- $APAU1/$APAU2：審核權限，控制用戶的審核相關操作

## 程式調用方式

其他程式通過以下方式調用S#S01進行權限檢查：

```
C     *ENTRY    PLIST
C                PARM           USERID  10        用戶ID
C                PARM           PGMID   10        程式ID
C                PARM           RESULT   1        權限返回值
```

調用示例：
```
C     *ENTRY    PLIST
C                PARM           'USER001'        用戶ID
C                PARM           'PROG001'        程式ID
C                PARM           AUTH             權限返回值
C     AUTH      IFEQ 'Y'
C                EXSR PROCESS               如果有權限，執行處理
C                ELSE
C                EXSR NOACCESS              如果無權限，執行無權限處理
C                END
```

## 權限返回值解釋

S#S01返回的權限標誌S0101O有以下含義：
- **Y**：用戶有權限訪問指定程式
- **N**：用戶無權限訪問指定程式

## 文件關係圖

```
+----------+     +----------+     +----------+
|  S#SDPF  |     |  S#SUPF  |     |  MTMCPF  |
+----------+     +----------+     +----------+
      |                |                |
      |                |                |
      v                v                v
+------------------------------------------+
|                  S#S01                   |
+------------------------------------------+
                     |
                     v
+------------------------------------------+
|             調用程式                     |
+------------------------------------------+
```

## 安全考慮

1. **權限分離**：
   - 程式實現了功能權限和數據權限的分離
   - 不同類型的權限由不同的標誌控制，實現細粒度權限控制

2. **特殊用戶管理**：
   - 系統管理員和特殊用戶擁有全部權限，應嚴格控制這些用戶賬號的分配
   - 建議定期審計特殊用戶的操作日誌

3. **權限數據保護**：
   - 權限數據存儲在專用文件中，應設置適當的文件訪問控制
   - 建議對權限文件進行定期備份

4. **權限檢查機制**：
   - 程式實現了多層次的權限檢查，確保權限控制的完整性
   - 權限檢查結果通過明確的返回值傳遞，避免模糊處理

## 性能考慮

1. **文件訪問優化**：
   - 程式使用鍵值訪問文件，提高查詢效率
   - 特殊用戶處理避免了不必要的文件訪問

2. **邏輯流程優化**：
   - 程式首先判斷用戶類型，對特殊用戶直接授權，減少文件訪問
   - 一般用戶處理中，只有在S#SDPF查詢成功後才進行後續查詢

## 維護建議

1. **權限管理**：
   - 定期檢查和更新用戶權限，確保權限分配符合業務需求和安全要求
   - 建立權限變更審批流程，控制權限變更風險

2. **用戶管理**：
   - 定期清理不活躍用戶，減少安全風險
   - 對特殊用戶進行嚴格管理，定期審核其必要性

3. **程式優化**：
   - 考慮增加權限緩存機制，減少頻繁的文件訪問
   - 增加權限變更日誌，記錄權限變更歷史

4. **安全審計**：
   - 定期審計權限分配，確保符合最小權限原則
   - 監控異常的權限使用情況，及時發現安全問題

## 與其他程式的關係

S#S01是系統權限控制的核心程式，與以下程式密切相關：

1. **用戶管理程式**：
   - 負責用戶創建和基本信息維護
   - 與S#SUPF文件交互，設置用戶的基本權限

2. **權限管理程式**：
   - 負責維護S#SDPF文件，設置用戶-程式權限映射
   - 可能包括權限分配、權限審核等功能

3. **系統管理程式**：
   - 負責系統配置和權限策略管理
   - 可能包括特殊用戶管理、權限模板設置等功能

4. **各業務模塊程式**：
   - 調用S#S01進行權限檢查
   - 根據返回的權限標誌控制用戶的操作

## 程式碼分析

### 關鍵代碼段1：特殊用戶判斷

```
C                     MOVELS0101I    USER    2
C           S0101I    IFEQ $S#01
C           USER      OREQ 'D9'
C           USER      OREQ 'RE'
C           USER      OREQ 'SC'
C                     EXSR RTN100                        ALL AUT
C                     ELSE
C                     EXSR RTN200
C                     END
```

這段代碼從用戶ID提取前兩位字符，然後判斷用戶是否為系統管理員或特殊用戶。如果是，則執行RTN100子程序授予全部權限；否則，執行RTN200子程序進行常規權限檢查。

### 關鍵代碼段2：特殊用戶權限設置

```
C           RTN100    BEGSR
C*
C                     MOVE 'Y'       $ADD
C                     MOVE 'Y'       $UPD
C                     MOVE 'Y'       $DLT
C                     MOVE 'Y'       $INQ
C                     MOVE 'Y'       $RMK01
C                     MOVE 'Y'       $RMK02
C                     MOVE 'Y'       $RMK03
C                     MOVEL'ALL'     $DEP
C                     MOVEL'ALL'     $STORE
C                     MOVE '*ALL '   $WRHUS
C                     MOVE 'C'       $PURID
C                     MOVE 'C'       $TRNID
C                     MOVE 'A'       $WRHTY
C                     MOVE 'YYYYY'   $APAU1
C                     MOVE 'Y'       $APAU2
C           S0101I    CHAINSU0                  40
C                     MOVE 'Y'       S0101O            可訪問
C*
C                     ENDSR
```

這段代碼為特殊用戶設置所有權限標誌為'Y'，並設置相應的部門、門市、倉庫等代碼，最後返回權限標誌S0101O為'Y'，表示用戶可以訪問。

### 關鍵代碼段3：一般用戶權限檢查

```
C           RTN200    BEGSR
C*
C                     MOVE 'N'       S0101O            無權訪問
C           KEYSD     CHAINSD0                  40
C           *IN40     IFEQ '0'
C           KEYSU     CHAIN S#SUPF                  40
C           SU04      IFNE *BLANKS
C                     MOVE SU04      $DEP
C                     ENDIF
C           SU05      IFNE *BLANKS
C                     MOVE SU05      $STORE
C                     ENDIF
C                     MOVE SU04      MC01
C           KEYMC     CHAIN MTMCPF                  40
C           *IN40     IFEQ '0'
C                     MOVE 'Y'       S0101O
C                     ENDIF
C                     ENDIF
C                     ENDSR
```

這段代碼首先設置權限標誌S0101O為'N'，然後使用用戶ID和程式ID組合查詢S#SDPF文件。如果查詢成功，則獲取用戶的部門和門市代碼，並使用部門代碼查詢MTMCPF文件。如果MTMCPF查詢也成功，則設置權限標誌S0101O為'Y'，表示用戶可以訪問。

## 總結

S#S01是西祺企業管理信息系統中的關鍵程式，實現了完善的權限控制機制，確保系統安全和數據保護。通過多層次的權限控制，該程式能夠靈活地滿足不同業務場景的權限需求，是系統安全架構的重要組成部分。程式的設計考慮了權限分離、特殊用戶管理、權限數據保護等安全因素，同時也注重了文件訪問和邏輯流程的優化，確保權限檢查的效率和可靠性。