# WKBKUP程序規格說明

## 1. 基本信息

- **程序名稱**：WKBKUP
- **程序類型**：CL程序
- **庫**：QLIBSS
- **功能描述**：週期性備份系統庫
- **相關文件**：
  - WKBKUPF（數據文件）
  - WKBKUPT（相關程序）
  - WKBKUPV（相關程序）
  - WKBKUPX1（相關程序）
  - SET（設置程序）
- **作者**：JULIA
- **創建日期**：80/02/08

## 2. 程序概述

WKBKUP是一個用於週期性備份系統庫的CL程序。該程序從WKBKUPF文件中讀取需要備份的庫列表，然後使用SAVLIB命令將這些庫備份到磁帶設備（TAP01）。程序在執行備份前會向所有工作站發送消息，通知用戶即將進行備份操作，並在備份完成後發送完成消息。

## 3. 程序流程

### 3.1 初始化階段

1. **參數定義**：
   ```
   - &MSGYN：是否發送消息的標誌（Y/N）
   - &IN03：功能鍵F3的標誌
   - &TIME：時間變數
   - &N：序列號變數，初始值為1
   - &ENDINT：結束標誌，初始值為'N'
   - &OPTLIB：庫類型選項，初始值為'*'
   - &WRKSTN：工作站名稱
   ```

2. **消息隊列設置**：
   ```
   CHGMSGQ MSGQ(*USRPRF) DLVRY(*NOTIFY)
   ```

3. **發送通知消息**：
   ```
   如果&MSGYN不等於'n'或'N'，則向所有工作站發送消息：
   SNDBRKMSG MSG('PLEASE SIGNOFF FOR WEEKLY BACKUP ... THANKS ........') TOMSGQ(*ALLWS)
   ```

4. **調用SET程序**：
   ```
   CALL PGM(SET) PARM(&IN03 &ENDINT &OPTLIB)
   ```

5. **設置庫類型選項**：
   ```
   如果&OPTLIB='1'，則設置為'2'
   如果&OPTLIB='2'，則設置為'1'
   ```

### 3.2 主處理階段

1. **讀取WKBKUPF文件**：
   ```
   RCVF
   如果到達文件末尾，則跳轉到ENDPGM標籤
   如果庫名為空，則繼續讀取下一條記錄
   ```

2. **檢查庫是否存在**：
   ```
   CHKOBJ OBJ(QSYS/&LIB) OBJTYPE(*LIB)
   如果庫不存在，則繼續讀取下一條記錄
   ```

3. **備份庫**：
   ```
   如果庫類型(&TYPE1)與選項(&OPTLIB)相符，則執行：
   SNDPGMMSG MSGID(CPF9898) MSGF(QCPFMSG) MSGDTA('正在LIB: ' *CAT &LIB *CAT '進行WEEKLY BACKUP') TOPGMQ(*EXT) MSGTYPE(*STATUS)
   SAVLIB LIB(&LIB) DEV(TAP01) SEQNBR(&N) EXPDATE(090189) ENDOPT(*LEAVE) TGTRLS(*CURRENT)
   &N = &N + 1
   ```

4. **循環處理**：
   ```
   跳轉到RCVFIL標籤，繼續處理下一個庫
   ```

### 3.3 結束階段

1. **關閉文件**：
   ```
   CLOF OPNID(WKBKUP)
   ```

2. **獲取工作站名稱**：
   ```
   RTVJOBA JOB(&WRKSTN)
   ```

3. **發送完成消息**：
   ```
   SNDBRKMSG MSG('謝謝您 WEEKLY BACKUP 已經完成，DSPJOBLOG可看到SAVE各個之LIBRARY及其作業紀錄... SAVE ...請保持磁帶 ......謝謝您的合作......') TOMSGQ(&WRKSTN)
   ```

4. **顯示作業日誌**：
   ```
   DSPJOBLOG
   ```

5. **恢復消息隊列設置**：
   ```
   CHGMSGQ MSGQ(*USRPRF) DLVRY(*BREAK)
   ```

## 4. 數據結構

### 4.1 WKBKUPF文件結構

```
R CUST
  NO        3  0    # 序號
  LIB      10       # 庫名
  CMD      10       # 命令
  TYPE1     1       # 類型1
  TYPE2     1       # 類型2
K NO               # 主鍵：序號
K LIB              # 主鍵：庫名
```

### 4.2 主要變數

- **&MSGYN**：是否發送消息的標誌（Y/N）
- **&IN03**：功能鍵F3的標誌
- **&TIME**：時間變數
- **&N**：序列號變數，用於SAVLIB命令的SEQNBR參數
- **&ENDINT**：結束標誌
- **&OPTLIB**：庫類型選項
- **&WRKSTN**：工作站名稱
- **&LIB**：從WKBKUPF文件讀取的庫名
- **&TYPE1**：從WKBKUPF文件讀取的庫類型

## 5. 相關程序

### 5.1 SET程序

SET程序用於設置系統參數，主要功能包括：

1. 接收參數：&IN03（功能鍵F3標誌）、&ENDINT（結束標誌）、&OPTLIB（庫類型選項）
2. 調用SETRPG程序處理參數
3. 如果&IN03='0'，則設置系統值QIPLDATTIM

### 5.2 WKBKUPT程序

WKBKUPT是WKBKUP的變體，主要區別在於：

1. 不接收&MSGYN參數
2. 不進行庫類型選擇，備份所有指定的庫

### 5.3 WKBKUPV程序

WKBKUPV是另一個WKBKUP的變體，主要特點包括：

1. 增加了&PLIB變數，用於記錄上一個備份的庫名
2. 在備份前向所有工作站發送更詳細的消息，包括當前庫名和上一個備份的庫名

### 5.4 WKBKUPX1程序

WKBKUPX1是一個更複雜的WKBKUP變體，主要特點包括：

1. 增加了延遲功能（DLYJOB）
2. 增加了向特定程序員發送消息的功能
3. 使用SBMJOB命令提交作業，調用SNDMSGSTN程序發送消息

## 6. 程序特點

### 6.1 備份策略

WKBKUP程序實現了一個靈活的備份策略：

1. **選擇性備份**：可以根據庫類型（&TYPE1）選擇性地備份特定類型的庫
2. **序列化備份**：使用序列號（&N）確保備份按順序寫入磁帶
3. **過期日期設置**：設置備份的過期日期（EXPDATE）為090189（1989年1月9日）

### 6.2 用戶通知

程序在備份過程中提供了完善的用戶通知機制：

1. **開始通知**：在備份開始前向所有工作站發送通知消息
2. **進度通知**：在備份每個庫時發送狀態消息
3. **完成通知**：在備份完成後發送完成消息

### 6.3 錯誤處理

程序包含了基本的錯誤處理機制：

1. **異常監控**：使用MONMSG命令監控可能的錯誤
2. **庫存在檢查**：在備份前檢查庫是否存在
3. **作業日誌**：在備份完成後顯示作業日誌，便於查看詳細信息

## 7. 系統架構關係

### 7.1 與操作系統的關係

WKBKUP程序與AS/400操作系統緊密相關：

1. 使用SAVLIB命令備份庫
2. 使用CHGMSGQ命令管理消息隊列
3. 使用SNDBRKMSG命令發送消息
4. 使用CHKOBJ命令檢查對象是否存在

### 7.2 與其他程序的關係

WKBKUP程序與其他程序的關係包括：

1. 調用SET程序設置系統參數
2. 與WKBKUPT、WKBKUPV、WKBKUPX1等變體程序共享相似的功能和結構
3. 可能與SNDMSGSTN等其他程序協同工作

## 8. 注意事項與改進建議

### 8.1 代碼優化

1. **註釋完善**：增加更詳細的註釋，說明程序的功能和邏輯
2. **變數命名**：使用更有意義的變數名稱，提高代碼可讀性
3. **錯誤處理**：增強錯誤處理機制，提供更詳細的錯誤信息

### 8.2 功能增強

1. **參數化過期日期**：將過期日期作為參數傳入，而不是硬編碼
2. **備份確認**：增加備份後的確認機制，確保備份成功
3. **日誌記錄**：增加更詳細的日誌記錄，便於後續查詢和分析

### 8.3 安全性增強

1. **權限檢查**：增加對用戶權限的檢查，確保只有授權用戶才能執行備份
2. **數據加密**：考慮對備份數據進行加密，提高安全性
3. **審計跟踪**：增加審計跟踪功能，記錄誰在何時執行了備份操作

## 9. 結論

WKBKUP程序是一個用於週期性備份系統庫的CL程序，它通過從WKBKUPF文件中讀取需要備份的庫列表，然後使用SAVLIB命令將這些庫備份到磁帶設備。程序提供了用戶通知、錯誤處理等基本功能，並有多個變體程序（WKBKUPT、WKBKUPV、WKBKUPX1）提供不同的備份策略和功能。

雖然程序的基本功能完善，但仍有優化空間，如代碼優化、功能增強和安全性增強等。通過這些改進，可以使WKBKUP程序更加高效、靈活和安全。

總的來說，WKBKUP程序是一個典型的AS/400系統維護程序，它反映了早期AS/400系統的備份策略和實現方式，對於理解和維護現有系統具有重要參考價值。