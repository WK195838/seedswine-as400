# WOA系列工作訂單處理程序規格說明

## 1. 基本信息

### 1.1 WOA1004 - 工作訂單處理程序
- **程序名稱**：WOA1004
- **程序類型**：RPG程序
- **庫**：REPLIB
- **功能描述**：工作訂單明細處理程序
- **相關文件**：WOA1004D（顯示文件）
- **作者**：TAYLOR（A1092）
- **創建日期**：85/04/02
- **更新日期**：81/04/17（PHILIP）

### 1.2 WOA200 - 工作訂單管理程序
- **程序名稱**：WOA200
- **程序類型**：RPG程序
- **庫**：REPLIB
- **功能描述**：工作訂單管理程序
- **相關文件**：WOA200D（顯示文件）
- **作者**：JERRY（A1211）
- **創建日期**：84/03/28

## 2. 程序概述

WOA系列程序是西祺企業管理資訊系統中工作訂單子系統的重要組成部分，主要負責工作訂單的創建、修改、查詢和管理。這些程序通過與工作訂單主檔、明細檔等數據庫交互，實現工作訂單的全生命週期管理，為企業的生產和工作流程提供支持。

### 2.1 WOA1004 - 工作訂單處理程序

WOA1004是一個工作訂單明細處理程序，主要用於處理工作訂單的明細信息，包括工作項目、數量、單價等。該程序提供了添加、修改、刪除和查詢工作訂單明細的功能，並支持與其他系統模塊的交互。

### 2.2 WOA200 - 工作訂單管理程序

WOA200是一個工作訂單管理程序，主要用於管理工作訂單的基本信息，包括訂單號、客戶信息、訂單日期等。該程序提供了工作訂單的創建、修改、刪除和查詢功能，並支持與工作訂單明細程序的交互。

## 3. 系統架構

### 3.1 整體架構

工作訂單系統是西祺企業管理資訊系統的一個子系統，與其他子系統（如銷售訂單系統、採購系統等）相互關聯。工作訂單系統的主要組件包括：

1. **主菜單程序**：WOM000C
2. **工作訂單管理程序**：WOA100、WOA200
3. **工作訂單處理程序**：WOA1004
4. **工作訂單報表程序**：WOR100C、WOR110C、WOR120C

### 3.2 數據流

工作訂單系統的數據流如下：

1. 用戶通過主菜單程序（WOM000C）進入系統
2. 用戶選擇工作訂單管理程序（WOA100或WOA200）創建或管理工作訂單
3. 用戶通過工作訂單處理程序（WOA1004）處理工作訂單明細
4. 用戶通過報表程序（WOR100C、WOR110C、WOR120C）生成各類報表

### 3.3 文件關係

工作訂單系統使用的主要文件包括：

1. **WOWEPF**：工作訂單主檔
2. **WOWBPF**：工作訂單明細檔
3. **WOWIPF**：工作訂單項目檔
4. **WOWDPF**：工作訂單備註檔
5. **WOWELF03**：工作訂單邏輯文件
6. **MTMAPF**：物料主檔

## 4. 程序流程詳解

### 4.1 WOA1004 程序流程

#### 4.1.1 初始化階段

```
- 定義工作變數和鍵值列表
- 設置功能權限（@A01）
- 讀取LDA中的參數值
- 初始化子文件（SFLSR2）
```

#### 4.1.2 主程序流程

```
- 執行R0100子程序（初始化）
- 執行R0200子程序（子文件頭部初始化）
- 執行R1C00子程序（SC04初始化）
- 進入主循環（DOWEQ'SC04'）
- 執行R2000子程序（處理用戶輸入）
```

#### 4.1.3 子程序詳解

1. **R0100**：初始化變數
   ```
   - 設置功能權限（@A01）
   - 從LDA讀取日期（$A6MDY）
   - 設置初始屏幕ID（SCID='SC04'）
   ```

2. **R0200**：子文件頭部初始化
   ```
   - 讀取工作訂單主檔（WOWEPF）
   - 設置顯示字段（DWE02）
   ```

3. **R1C00**：SC04初始化
   ```
   - 執行R1CC0子程序（初始化子文件）
   - 執行R1CE0子程序
   - 執行R1CD0子程序
   - 設置子文件顯示標誌（SFLDSP）
   ```

4. **R1CC0**：子文件初始化
   ```
   - 設置子文件參數（@SFTOP、@SFBOT等）
   - 清除子文件（SFLCLR）
   - 設置日期（FDATE）
   - 寫入子文件控制記錄（SFLCR2）
   ```

5. **R1CD0**：子文件數據初始化
   ```
   - 計算頁面和記錄數
   - 執行R1CD1子程序（初始化子文件數據）
   - 寫入子文件記錄（SFLSR2）
   ```

6. **R1CD1**：子文件數據添加
   ```
   - 清除字段（DDEL2、DWB03等）
   - 設置新記錄標誌（DNEW2='Y'）
   ```

7. **R2000**：處理用戶輸入
   ```
   - 顯示子文件（DSPC1）
   - 處理功能鍵（F3、F4等）
   - 處理用戶輸入的數據
   - 更新工作訂單明細檔（WOWBPF）
   ```

### 4.2 WOA200 程序流程

#### 4.2.1 初始化階段

```
- 定義工作變數和鍵值列表
- 讀取LDA中的參數值
- 初始化子文件（SFLSR1）
```

#### 4.2.2 主程序流程

```
- 執行R0100子程序（初始化）
- 執行R1000子程序（主處理）
- 處理用戶輸入和功能鍵
```

#### 4.2.3 子程序詳解

1. **R1000**：主處理
   ```
   - 顯示子文件控制記錄（SFLCR1）
   - 處理功能鍵（F3、F6等）
   - 執行相應的子程序
   ```

2. **R1A00**：子文件初始化準備
   ```
   - 清除子文件參數（DRRN1、PRRN1等）
   - 清除子文件（SFLCLR）
   - 設置起始鍵值（KEYWE）
   - 執行R1A10子程序（添加子文件數據）
   ```

3. **R1A10**：添加子文件數據
   ```
   - 讀取工作訂單邏輯文件（WOWELF03）
   - 執行R1A11子程序（寫入子文件數據）
   - 設置子文件結束標誌（SFLEND）
   ```

4. **R1B00**：屏幕檢查
   ```
   - 檢查用戶輸入的數據
   - 設置錯誤標誌和消息
   ```

5. **R1C00**：處理選項
   ```
   - 處理用戶選擇的選項（2、4、5等）
   - 執行相應的子程序
   ```

6. **R1C20**：添加工作訂單
   ```
   - 設置添加模式
   - 顯示添加屏幕
   - 處理用戶輸入的數據
   - 添加新的工作訂單記錄
   ```

## 5. 數據結構詳解

### 5.1 主要文件結構

#### 5.1.1 工作訂單主檔（WOWEPF）
- WE01：客戶代碼
- WE02：客戶名稱
- WE03：訂單日期
- WE07：訂單狀態
- WE08：訂單類型
- WE09：訂單金額
- WE15：負責人

#### 5.1.2 工作訂單明細檔（WOWBPF）
- WB01：客戶代碼
- WB02：訂單日期
- WB03：項目代碼
- WB04：數量
- WB05：單價
- WB06：金額

#### 5.1.3 工作訂單項目檔（WOWIPF）
- 包含工作訂單項目的詳細信息

#### 5.1.4 工作訂單備註檔（WOWDPF）
- 包含工作訂單的備註信息

### 5.2 顯示文件結構

#### 5.2.1 WOA1004D（WOA1004的顯示文件）
- SFLSR2：子文件記錄格式
- SFLCR2：子文件控制記錄格式
- DSPC1：顯示屏幕格式

#### 5.2.2 WOA200D（WOA200的顯示文件）
- SFLSR1：子文件記錄格式
- SFLCR1：子文件控制記錄格式
- DSPC1：顯示屏幕格式

### 5.3 主要變數定義

#### 5.3.1 WOA1004中的主要變數
- PWE01：客戶代碼
- RTNID：返回ID
- SCID：屏幕ID
- @DRCD：顯示記錄數
- @PRCD：頁面記錄數
- @LRRN：最後記錄號
- RRN2：子文件記錄號

#### 5.3.2 WOA200中的主要變數
- FDATE：交易日期
- @DRCD：顯示記錄數
- PRRN1：底部記錄號
- RRN1：子文件記錄號
- DELFLG：刪除標誌

## 6. 用戶界面詳解

### 6.1 WOA1004的用戶界面

#### 6.1.1 主屏幕（DSPC1）
- 顯示工作訂單的基本信息
- 包含子文件區域，顯示工作訂單明細

#### 6.1.2 子文件（SFLSR2）
- 每行顯示一個工作訂單明細項目
- 包含項目代碼、數量、單價、金額等字段
- 支持添加、修改和刪除操作

#### 6.1.3 功能鍵
- F3：退出
- F4：提示
- F7/F8：翻頁

### 6.2 WOA200的用戶界面

#### 6.2.1 主屏幕（DSPC1）
- 顯示工作訂單列表
- 包含子文件區域，顯示工作訂單基本信息

#### 6.2.2 子文件（SFLSR1）
- 每行顯示一個工作訂單
- 包含訂單狀態、客戶代碼、訂單日期、訂單類型、金額等字段
- 支持選擇不同的操作（2=修改，4=刪除，5=查詢等）

#### 6.2.3 功能鍵
- F3：退出
- F6：添加
- F9：其他功能
- ROLLUP：下一頁

## 7. 功能模組對應表

| 選項 | 功能描述 | 程序名稱 |
|------|---------|---------|
| 01 | 工作訂單資料維護 | WOA100 |
| 02 | 工作訂單資料查詢 | WOA200 |
| 41 | 工作訂單列印 | WOR100C |
| 42 | 工作訂單明細列印 | WOR110C |
| 43 | 工作訂單統計列印 | WOR120C |

## 8. 程序特點詳解

### 8.1 模組化設計

WOA系列程序採用模組化設計，將不同的功能分解為多個子程序，使程序結構清晰，便於維護和擴展。主要的模組包括：

1. **初始化模組**：負責初始化變數和環境
2. **子文件處理模組**：負責子文件的初始化、填充和顯示
3. **數據處理模組**：負責數據的讀取、寫入和更新
4. **用戶交互模組**：負責處理用戶輸入和功能鍵

### 8.2 子文件技術

WOA系列程序大量使用了子文件（Subfile）技術，這是AS/400系統中處理列表數據的標準方法。子文件技術的優點包括：

1. **高效的數據顯示**：只加載當前頁面的數據，減少系統負擔
2. **標準的用戶界面**：提供一致的用戶體驗
3. **靈活的數據操作**：支持多種操作方式（添加、修改、刪除等）

### 8.3 權限控制

WOA系列程序實現了嚴格的權限控制，通過以下方式：

1. **功能權限**：根據用戶的權限設置可用的功能（@A01）
2. **數據權限**：控制用戶可以訪問的數據範圍
3. **操作權限**：控制用戶可以執行的操作（添加、修改、刪除等）

### 8.4 錯誤處理

WOA系列程序包含完善的錯誤處理機制，包括：

1. **輸入驗證**：驗證用戶輸入的數據是否有效
2. **錯誤消息**：顯示詳細的錯誤消息，幫助用戶理解問題
3. **異常處理**：處理各種異常情況，確保程序的穩定運行

## 9. 系統架構關係詳解

### 9.1 上游系統

#### 9.1.1 客戶管理系統
- 提供客戶基本信息
- 與工作訂單系統共享客戶數據

#### 9.1.2 物料管理系統
- 提供物料基本信息
- 與工作訂單系統共享物料數據

### 9.2 同級系統

#### 9.2.1 銷售訂單系統
- 與工作訂單系統協同工作
- 銷售訂單可能轉換為工作訂單

#### 9.2.2 採購系統
- 與工作訂單系統協同工作
- 工作訂單可能觸發採購需求

### 9.3 下游系統

#### 9.3.1 生產系統
- 根據工作訂單安排生產
- 更新工作訂單的狀態和進度

#### 9.3.2 財務系統
- 處理工作訂單相關的財務數據
- 生成財務報表和分析

## 10. 數據流分析詳解

### 10.1 輸入數據

#### 10.1.1 用戶輸入
- 工作訂單基本信息（客戶代碼、訂單日期等）
- 工作訂單明細信息（項目代碼、數量、單價等）
- 操作選擇（添加、修改、刪除等）

#### 10.1.2 系統數據
- 客戶主檔數據
- 物料主檔數據
- 系統參數和配置

### 10.2 處理邏輯

#### 10.2.1 數據驗證
- 驗證用戶輸入的數據是否有效
- 檢查必填字段是否已填寫
- 檢查數據格式是否正確

#### 10.2.2 數據處理
- 添加、修改或刪除工作訂單數據
- 計算訂單金額和其他派生數據
- 更新相關文件和記錄

### 10.3 輸出數據

#### 10.3.1 屏幕輸出
- 工作訂單列表和詳細信息
- 操作結果和狀態消息
- 錯誤消息和提示

#### 10.3.2 數據庫更新
- 更新工作訂單主檔
- 更新工作訂單明細檔
- 更新其他相關文件

## 11. 注意事項與改進建議

### 11.1 代碼優化

#### 11.1.1 重複代碼消除
- 將重複的代碼段提取為共用子程序
- 使用宏或常量定義重複的值

#### 11.1.2 變數命名規範化
- 採用更有意義的變數名稱
- 添加詳細的註釋說明變數的用途

### 11.2 功能增強

#### 11.2.1 搜索功能
- 添加更強大的搜索功能，支持多條件搜索
- 實現模糊搜索和高級過濾

#### 11.2.2 批量處理
- 添加批量處理功能，支持同時處理多個工作訂單
- 實現批量導入和導出功能

### 11.3 用戶界面改進

#### 11.3.1 界面現代化
- 改進用戶界面設計，提高易用性
- 添加更多的視覺提示和幫助信息

#### 11.3.2 響應性提升
- 優化程序性能，提高響應速度
- 減少不必要的屏幕刷新和數據加載

### 11.4 系統集成

#### 11.4.1 與其他系統的集成
- 加強與銷售訂單系統、生產系統等的集成
- 實現數據的實時同步和共享

#### 11.4.2 API支持
- 提供API接口，支持與外部系統的集成
- 實現更靈活的數據交換和處理

## 12. 結論

WOA系列工作訂單處理程序是西祺企業管理資訊系統中工作訂單子系統的核心組件，負責工作訂單的創建、修改、查詢和管理。這些程序採用模組化設計和子文件技術，提供了高效、靈活的工作訂單處理功能。

通過對程序代碼的詳細分析，我們可以看到這些程序具有完善的功能和嚴格的權限控制，能夠滿足企業對工作訂單管理的基本需求。同時，我們也發現了一些可以改進的地方，如代碼優化、功能增強、用戶界面改進和系統集成等。

隨著企業管理需求的不斷變化和技術的不斷發展，WOA系列程序也需要不斷更新和完善，以適應新的業務需求和技術環境。通過持續的優化和改進，這些程序可以更好地支持企業的工作訂單管理，提高工作效率和管理水平。