# 西祺企業管理資訊系統權限管理詳細規格說明書

## 1. 系統概述

西祺企業管理資訊系統採用AS/400平台開發，使用RPG和CL語言實現。系統權限管理模塊是整個系統的核心組件之一，負責控制用戶對系統各功能的訪問權限，確保系統安全性和數據完整性。

權限管理模塊主要由以下幾個部分組成：
- 用戶管理：維護系統用戶基本信息
- 程序管理：維護系統程序基本信息
- 權限管理：維護用戶對程序的訪問權限
- 權限檢查：檢查用戶是否有權限執行特定程序
- 密碼管理：維護用戶密碼和密碼變更歷史
- 日誌管理：記錄權限變更和系統訪問歷史

## 2. 系統權限相關資料檔案詳細說明

### 2.1 S#SDPF - 程序權限主檔

#### 2.1.1 檔案用途
S#SDPF是系統權限控制的核心檔案，存儲了用戶對特定程序的訪問權限信息。當用戶嘗試訪問某個程序時，系統會檢查此檔案中的記錄，確定用戶是否有權限執行該程序，以及可以執行哪些操作（新增、修改、刪除、查詢等）。

#### 2.1.2 檔案結構
| 欄位名稱 | 資料類型 | 長度 | 說明 | 範例值 |
|---------|---------|------|------|--------|
| SD01 | 字元 | 10 | 用戶ID，主鍵之一 | 'A1062' |
| SD02 | 字元 | 10 | 程序ID，主鍵之一 | 'S#A120' |
| SD03 | 字元 | 1 | 新增權限標誌 | 'Y'/'N' |
| SD04 | 字元 | 1 | 修改權限標誌 | 'Y'/'N' |
| SD05 | 字元 | 1 | 刪除權限標誌 | 'Y'/'N' |
| SD06 | 字元 | 1 | 查詢權限標誌 | 'Y'/'N' |
| SD07 | 字元 | 1 | 備註1權限標誌 | 'Y'/'N' |
| SD08 | 字元 | 1 | 備註2權限標誌 | 'Y'/'N' |
| SD09 | 字元 | 1 | 備註3權限標誌 | 'Y'/'N' |

#### 2.1.3 索引結構
- **主索引**：SD01 + SD02（用戶ID + 程序ID）
  - 用於快速查找特定用戶對特定程序的權限設置
- **次索引1**：SD01（用戶ID）
  - 用於快速查找特定用戶的所有權限設置
- **次索引2**：SD02（程序ID）
  - 用於快速查找所有有權限訪問特定程序的用戶

#### 2.1.4 資料存取方式
- **直接存取**：通過用戶ID和程序ID組合的鍵值進行直接存取
  ```
  C           KEYSD     CHAINSD0                  40
  ```
- **部分鍵值存取**：通過用戶ID進行部分鍵值存取，獲取該用戶的所有權限記錄
  ```
  C           WSD01     SETLLSD0
  C           WSD01     READESD0                      44
  ```
- **部分鍵值存取**：通過程序ID進行部分鍵值存取，獲取所有有權限訪問該程序的用戶
  ```
  C           WSD02     SETLLSD0
  C           WSD02     READESD0                      44
  ```

#### 2.1.5 資料維護程序
- **S#A120**：用戶權限維護程序，用於新增、修改、刪除用戶對程序的權限
  - 支持批量權限設置和權限複製功能
  - 記錄權限變更操作到S#SDLF檔案中
- **S#CP01/S#CP011**：密碼變更程序，涉及權限檢查
  - 在密碼變更過程中可能需要檢查用戶權限

#### 2.1.6 資料使用程序
- **S#S01**：權限檢查程序，用於檢查用戶是否有權限執行特定程序
  - 系統中幾乎所有程序都會調用S#S01進行權限檢查
- **S#R413**：權限報表程序，用於生成用戶權限報表
  - 顯示用戶對程序的權限設置情況

#### 2.1.7 資料維護規則
- 只有系統管理員或具有權限維護權限的用戶才能維護此檔案
- 權限變更操作會自動記錄到S#SDLF檔案中
- 用戶不能修改自己的權限
- 特殊用戶（如'D9'、'RE'、'SC'等）可能有特殊的權限處理規則

### 2.2 S#SUPF - 使用者主檔

#### 2.2.1 檔案用途
S#SUPF是系統用戶管理的核心檔案，存儲了系統中所有用戶的基本信息，包括用戶ID、名稱、上級關係等。這些信息用於用戶認證、權限控制和系統操作記錄。

#### 2.2.2 檔案結構
| 欄位名稱 | 資料類型 | 長度 | 說明 | 範例值 |
|---------|---------|------|------|--------|
| SU01 | 字元 | 10 | 用戶ID，主鍵 | 'A1062' |
| SU02 | 字元 | 10 | 用戶名稱 | '張三' |
| SU03 | 字元 | 10 | 上級用戶ID | 'A1001' |
| SU04 | 字元 | 6 | 部門代碼 | 'IT' |
| SU05 | 字元 | 4 | 倉庫代碼 | 'W01' |
| SU06 | 字元 | 1 | 用戶狀態 | 'A'(活動)/'I'(非活動) |
| SU07 | 字元 | 4 | 用戶權限等級 | '0001' |
| SU08 | 字元 | 10 | 密碼（加密存儲） | '*****' |
| SU09 | 字元 | 8 | 最後登錄日期 | '20230101' |
| SU10 | 字元 | 8 | 密碼最後修改日期 | '20230101' |

#### 2.2.3 索引結構
- **主索引**：SU01（用戶ID）
  - 用於快速查找特定用戶的基本信息
- **次索引1**：SU03（上級用戶ID）
  - 用於快速查找特定上級的所有下屬用戶
- **次索引2**：SU04（部門代碼）
  - 用於快速查找特定部門的所有用戶

#### 2.2.4 資料存取方式
- **直接存取**：通過用戶ID進行直接存取
  ```
  C           USER      CHAINSU0                  40
  ```
- **索引存取**：通過上級用戶ID進行索引存取，獲取所有下屬用戶
  ```
  C           SU03      SETLLSU0
  C           SU03      READESU0                      44
  ```
- **索引存取**：通過部門代碼進行索引存取，獲取特定部門的所有用戶
  ```
  C           SU04      SETLLSU0
  C           SU04      READESU0                      44
  ```

#### 2.2.5 資料維護程序
- **S#A110**：用戶維護程序，用於新增、修改、刪除用戶基本信息
  - 支持用戶狀態管理和上級關係設置
- **S#CP01/S#CP011**：密碼變更程序，用於修改用戶密碼
  - 更新SU08（密碼）和SU10（密碼最後修改日期）欄位

#### 2.2.6 資料使用程序
- **S#S01**：權限檢查程序，用於驗證用戶身份
  - 檢查用戶是否存在和用戶狀態
- **S#S110**：用戶查詢程序，用於查詢用戶信息
  - 顯示用戶基本信息和上級關係
- **S#R431/S#R433**：用戶報表程序，用於生成用戶報表
  - 顯示用戶列表和用戶關係

#### 2.2.7 資料維護規則
- 只有系統管理員或具有用戶維護權限的用戶才能維護此檔案
- 用戶ID一旦創建不能修改
- 用戶密碼必須加密存儲
- 用戶狀態變更可能影響用戶的系統訪問權限
- 上級關係變更可能影響權限繼承

### 2.3 S#SPPF - 程序主檔

#### 2.3.1 檔案用途
S#SPPF是系統程序管理的核心檔案，存儲了系統中所有程序的基本信息，包括程序ID、描述、類型等。這些信息用於程序權限控制和系統菜單顯示。

#### 2.3.2 檔案結構
| 欄位名稱 | 資料類型 | 長度 | 說明 | 範例值 |
|---------|---------|------|------|--------|
| SP01 | 字元 | 10 | 程序ID，主鍵 | 'S#A120' |
| SP02 | 字元 | 50 | 程序描述 | '用戶權限維護程序' |
| SP03 | 字元 | 1 | 程序類型 | 'M'(菜單)/'P'(程序) |
| SP04 | 字元 | 10 | 程序屬性1（模塊代碼） | 'SYS' |
| SP05 | 字元 | 10 | 程序屬性2（子模塊代碼） | 'AUTH' |
| SP06 | 字元 | 10 | 程序屬性3（功能代碼） | 'MAINT' |

#### 2.3.3 索引結構
- **主索引**：SP01（程序ID）
  - 用於快速查找特定程序的基本信息
- **次索引1**：SP03 + SP04（程序類型 + 模塊代碼）
  - 用於快速查找特定類型和模塊的所有程序
- **次索引2**：SP04（模塊代碼）
  - 用於快速查找特定模塊的所有程序

#### 2.3.4 資料存取方式
- **直接存取**：通過程序ID進行直接存取
  ```
  C           DSP01     CHAINSP0                  40
  ```
- **索引存取**：通過程序類型和模塊代碼進行索引存取，獲取特定類型和模塊的所有程序
  ```
  C           KEYSP     SETLLSP0
  C           KEYSP     READESP0                      44
  ```
- **索引存取**：通過模塊代碼進行索引存取，獲取特定模塊的所有程序
  ```
  C           SP04      SETLLSP0
  C           SP04      READESP0                      44
  ```

#### 2.3.5 資料維護程序
- **S#A140**：程序維護程序，用於新增、修改、刪除程序基本信息
  - 支持程序類型和屬性設置
- **S#A142**：程序描述維護程序，用於維護程序描述
  - 專門用於維護SP02（程序描述）欄位

#### 2.3.6 資料使用程序
- **S#S01**：權限檢查程序，用於獲取程序信息
  - 檢查程序是否存在和程序類型
- **S#M010/S#M011**：菜單顯示程序，使用程序信息構建菜單
  - 根據程序類型和屬性顯示菜單項
- **S#I310**：系統初始化程序，涉及程序信息設置
  - 初始化系統程序信息

#### 2.3.7 資料維護規則
- 只有系統管理員或具有程序維護權限的用戶才能維護此檔案
- 程序ID一旦創建不能修改
- 程序類型和屬性變更可能影響系統菜單顯示
- 程序描述應該清晰明確，便於用戶理解程序功能

### 2.4 S#SULF - 使用者權限主管關係檔

#### 2.4.1 檔案用途
S#SULF存儲用戶之間的上下級關係，用於權限繼承和管理結構顯示。當一個用戶是另一個用戶的上級時，上級用戶可能具有查看或管理下級用戶數據的權限。

#### 2.4.2 檔案結構
| 欄位名稱 | 資料類型 | 長度 | 說明 | 範例值 |
|---------|---------|------|------|--------|
| SUL01 | 字元 | 10 | 用戶ID，主鍵之一 | 'A1062' |
| SUL02 | 字元 | 10 | 上級用戶ID，主鍵之一 | 'A1001' |
| SUL03 | 字元 | 1 | 關係類型 | 'D'(直接)/'I'(間接) |
| SUL04 | 字元 | 1 | 權限繼承標誌 | 'Y'/'N' |
| SUL05 | 字元 | 8 | 關係建立日期 | '20230101' |
| SUL06 | 字元 | 10 | 關係建立用戶 | 'A1000' |

#### 2.4.3 索引結構
- **主索引**：SUL01 + SUL02（用戶ID + 上級用戶ID）
  - 用於快速查找特定用戶和上級之間的關係
- **次索引1**：SUL01（用戶ID）
  - 用於快速查找特定用戶的所有上級關係
- **次索引2**：SUL02（上級用戶ID）
  - 用於快速查找特定上級的所有下屬關係

#### 2.4.4 資料存取方式
- **直接存取**：通過用戶ID和上級用戶ID組合的鍵值進行直接存取
  ```
  C           KEYSUL    CHAINSUL                  40
  ```
- **部分鍵值存取**：通過用戶ID進行部分鍵值存取，獲取該用戶的所有上級關係
  ```
  C           SUL01     SETLLSUL
  C           SUL01     READESUL                      44
  ```
- **部分鍵值存取**：通過上級用戶ID進行部分鍵值存取，獲取所有下屬關係
  ```
  C           SUL02     SETLLSUL
  C           SUL02     READESUL                      44
  ```

#### 2.4.5 資料維護程序
- **S#A110**：用戶維護程序，可能包含上下級關係維護功能
  - 在用戶維護過程中設置上級關係
- **專門的關係維護程序**：可能存在專門用於維護用戶關係的程序
  - 支持批量關係設置和權限繼承設置

#### 2.4.6 資料使用程序
- **S#R433**：用戶關係報表程序，用於生成用戶關係報表
  - 顯示用戶的上下級關係和權限繼承設置
- **權限繼承相關程序**：用於實現權限繼承功能
  - 根據上下級關係和權限繼承設置確定用戶權限

#### 2.4.7 資料維護規則
- 只有系統管理員或具有關係維護權限的用戶才能維護此檔案
- 關係類型和權限繼承標誌變更可能影響用戶權限
- 用戶不能成為自己的上級或下級
- 關係建立操作會記錄建立日期和建立用戶

### 2.5 S#SDLF - 程序權限日誌檔

#### 2.5.1 檔案用途
S#SDLF存儲程序權限變更的歷史記錄，記錄了誰在什麼時間對哪個程序的權限進行了什麼操作。這些記錄用於審計和追蹤權限變更歷史。

#### 2.5.2 檔案結構
| 欄位名稱 | 資料類型 | 長度 | 說明 | 範例值 |
|---------|---------|------|------|--------|
| SDL01 | 字元 | 14 | 日誌序號或時間戳，主鍵 | '20230101120000' |
| SDL02 | 字元 | 10 | 程序ID | 'S#A120' |
| SDL03 | 字元 | 10 | 用戶ID | 'A1062' |
| SDL04 | 字元 | 1 | 操作類型 | 'A'(新增)/'U'(修改)/'D'(刪除) |
| SDL05 | 字元 | 14 | 操作時間 | '20230101120000' |
| SDL06 | 字元 | 10 | 操作用戶 | 'A1001' |
| SDL07 | 字元 | 10 | 操作前權限值 | 'YNNNNNNN' |
| SDL08 | 字元 | 10 | 操作後權限值 | 'YYNNNYNN' |

#### 2.5.3 索引結構
- **主索引**：SDL01（日誌序號或時間戳）
  - 用於快速查找特定日誌記錄
- **次索引1**：SDL02 + SDL03（程序ID + 用戶ID）
  - 用於快速查找特定程序和用戶的所有權限變更記錄
- **次索引2**：SDL06（操作用戶）
  - 用於快速查找特定用戶進行的所有權限變更操作
- **次索引3**：SDL05（操作時間）
  - 用於快速查找特定時間段的所有權限變更操作

#### 2.5.4 資料存取方式
- **直接存取**：通過日誌序號進行直接存取
  ```
  C           SDL01     CHAINSDL                  40
  ```
- **索引存取**：通過程序ID和用戶ID組合進行索引存取，獲取特定程序和用戶的所有權限變更記錄
  ```
  C           KEYSDL    SETLLSDL
  C           KEYSDL    READESDL                      44
  ```
- **索引存取**：通過操作用戶進行索引存取，獲取特定用戶進行的所有權限變更操作
  ```
  C           SDL06     SETLLSDL
  C           SDL06     READESDL                      44
  ```

#### 2.5.5 資料維護程序
- **S#A130**：權限日誌維護程序，可能用於查詢和管理權限變更日誌
  - 支持日誌查詢和報表生成
- **權限變更操作**：會自動記錄到此檔案
  - 在S#A120等程序中進行權限變更時自動記錄

#### 2.5.6 資料使用程序
- **S#R423**：權限日誌報表程序，用於生成權限變更日誌報表
  - 顯示權限變更歷史和操作詳情
- **審計和追蹤相關程序**：用於審計和追蹤權限變更歷史
  - 支持按時間、用戶、程序等條件查詢

#### 2.5.7 資料維護規則
- 日誌記錄是自動生成的，不應手動修改
- 日誌記錄應包含完整的變更前後信息，便於追蹤變更內容
- 日誌記錄可能有保留期限，超過期限的記錄可能被歸檔或刪除

### 2.6 S#SDLF9 - 密碼變更日誌檔

#### 2.6.1 檔案用途
S#SDLF9存儲用戶密碼變更的歷史記錄，記錄了用戶在什麼時間進行了密碼變更操作。這些記錄用於安全審計和密碼策略管理。

#### 2.6.2 檔案結構
| 欄位名稱 | 資料類型 | 長度 | 說明 | 範例值 |
|---------|---------|------|------|--------|
| SDL901 | 字元 | 10 | 用戶ID，主鍵之一 | 'A1062' |
| SDL902 | 字元 | 14 | 密碼變更時間，主鍵之一 | '20230101120000' |
| SDL903 | 字元 | 10 | 密碼變更前的密碼（加密） | '*****' |
| SDL904 | 字元 | 10 | 密碼變更後的密碼（加密） | '*****' |
| SDL905 | 字元 | 10 | 操作用戶 | 'A1062' |
| SDL906 | 字元 | 1 | 變更類型 | 'U'(用戶變更)/'A'(管理員變更)/'R'(重置) |

#### 2.6.3 索引結構
- **主索引**：SDL901 + SDL902（用戶ID + 密碼變更時間）
  - 用於快速查找特定用戶在特定時間的密碼變更記錄
- **次索引1**：SDL901（用戶ID）
  - 用於快速查找特定用戶的所有密碼變更記錄
- **次索引2**：SDL905（操作用戶）
  - 用於快速查找特定用戶進行的所有密碼變更操作

#### 2.6.4 資料存取方式
- **直接存取**：通過用戶ID和密碼變更時間組合的鍵值進行直接存取
  ```
  C           KEYSDL9   CHAINSDL9                 40
  ```
- **部分鍵值存取**：通過用戶ID進行部分鍵值存取，獲取該用戶的所有密碼變更記錄
  ```
  C           SDL901    SETLLSDL9
  C           SDL901    READESDL9                     44
  ```
- **索引存取**：通過操作用戶進行索引存取，獲取特定用戶進行的所有密碼變更操作
  ```
  C           SDL905    SETLLSDL9
  C           SDL905    READESDL9                     44
  ```

#### 2.6.5 資料維護程序
- **S#CP01/S#CP011**：密碼變更程序，會自動記錄密碼變更日誌
  - 在密碼變更過程中自動記錄變更信息

#### 2.6.6 資料使用程序
- **密碼策略管理程序**：用於實現密碼策略（如密碼歷史檢查、密碼過期提醒等）
  - 檢查新密碼是否與歷史密碼重複
- **安全審計程序**：用於審計密碼變更操作
  - 監控異常的密碼變更行為

#### 2.6.7 資料維護規則
- 密碼變更日誌是自動生成的，不應手動修改
- 密碼信息應該加密存儲，確保安全性
- 密碼變更日誌可能有保留期限，超過期限的記錄可能被歸檔或刪除

## 3. 系統權限控制詳細流程

### 3.1 用戶登錄流程

#### 3.1.1 用戶輸入階段
1. 用戶啟動系統登錄程序
2. 系統顯示登錄畫面，要求輸入用戶ID和密碼
3. 用戶輸入用戶ID和密碼
4. 系統對輸入進行基本驗證（如長度、格式等）
   - 用戶ID長度通常為10個字符
   - 密碼長度和複雜度根據系統設置可能有不同要求

#### 3.1.2 身份驗證階段
1. 系統從S#SUPF檔案中讀取用戶記錄
   ```
   C           USER      CHAINSU0                  40
   ```
2. 如果用戶記錄不存在，顯示錯誤信息並返回登錄畫面
3. 系統驗證用戶密碼是否匹配
   - 密碼通常以加密形式存儲，需要進行加密比較
4. 系統檢查用戶狀態是否為活動狀態
   ```
   C           SU06      IFEQ 'A'                        *活動狀態
   ```
5. 系統檢查密碼是否過期
   ```
   C           SU10      COMP EXPDATE                 50 *密碼過期
   ```

#### 3.1.3 登錄成功處理
1. 系統記錄用戶登錄信息（時間、IP等）
2. 系統更新用戶的最後登錄日期
   ```
   C                     MOVE TODAY     SU09
   C                     UPDATSU0
   ```
3. 系統將用戶信息加載到本地數據區（LDA）
   ```
   C                     MOVE USER      LDAUSER
   C                     MOVE SU02      LDANAME
   C                     MOVE TODAY     LDADATE
   C                     MOVE TIME      LDATIME
   ```

4. 系統顯示主菜單或用戶上次訪問的畫面
   
5. 系統可能顯示密碼即將過期的提醒（如果適用）
   ```
   C           DAYSLEFT  IFLT 7
   C                     EXSR PWDWARN
   C                     END
   ```
6. 系統可能顯示系統公告或重要通知

### 3.2 權限檢查流程（S#S01程序）

#### 3.2.1 權限檢查初始化
1. 程序接收參數：用戶ID（SU01）和程序ID（SP01）
   ```
   C     *ENTRY        PLIST
   C                   PARM           DSU01           10
   C                   PARM           DSP01           10
   C                   PARM           DAUTH            1
   ```
2. 系統檢查用戶ID是否為特殊用戶（如系統管理員）
   ```
   C           DSU01     IFEQ 'D9'                       *系統管理員
   C                     MOVE 'Y'       DAUTH
   C                     GOTO ENDJOB
   C                     END
   ```

#### 3.2.2 程序信息檢查
1. 系統從S#SPPF檔案中讀取程序記錄
   ```
   C           DSP01     CHAINSP0                  40
   ```
2. 如果程序記錄不存在，返回錯誤信息
   ```
   C                     IFNE *ON40
   C                     MOVE 'N'       DAUTH
   C                     GOTO ENDJOB
   C                     END
   ```
3. 系統檢查程序類型，如果是菜單類型可能有特殊處理
   ```
   C           SP03      IFEQ 'M'                       *菜單類型
   C                     EXSR MENUAUTH
   C                     END
   ```

#### 3.2.3 用戶權限檢查
1. 系統構建S#SDPF檔案的鍵值（用戶ID + 程序ID）
   ```
   C                     MOVE DSU01     SD01
   C                     MOVE DSP01     SD02
   ```
2. 系統從S#SDPF檔案中讀取權限記錄
   ```
   C           KEYSD     CHAINSD0                  40
   ```
3. 如果權限記錄不存在，檢查是否需要繼承上級權限
   ```
   C                     IFNE *OFF40
   C                     EXSR CHKAUTH
   C                     ELSE
   C                     EXSR INHAUTH               *檢查繼承權限
   C                     END
   ```
4. 根據權限記錄和操作類型確定是否有權限
   ```
   C           OPTYPE    IFEQ 'A'                       *新增操作
   C           SD03      IFEQ 'Y'
   C                     MOVE 'Y'       DAUTH
   C                     END
   C                     END
   ```

#### 3.2.4 權限繼承處理
1. 系統從S#SUPF檔案中讀取用戶記錄，獲取上級用戶ID
   ```
   C           DSU01     CHAINSU0                  40
   C                     MOVE SU03      SUPUSER
   ```
2. 如果上級用戶ID存在，檢查上級用戶對程序的權限
   ```
   C           SUPUSER   IFNE *BLANKS
   C                     MOVE SUPUSER    SD01
   C                     MOVE DSP01      SD02
   C                     EXSR CHKSUPER
   C                     END
   ```
3. 系統可能還會檢查S#SULF檔案中的權限繼承設置
   ```
   C           DSU01     SETLLSUL
   C           DSU01     READESUL                      44
   C                     DOWEQ *OFF44
   C           SUL04     IFEQ 'Y'                       *允許繼承
   C                     EXSR CHKINH
   C                     END
   C           DSU01     READESUL                      44
   C                     END
   ```

### 3.3 用戶權限維護流程（S#A120程序）

#### 3.3.1 權限維護初始化
1. 程序接收參數：用戶ID（SU01）
   ```
   C     *ENTRY        PLIST
   C                   PARM           DSU01           10
   ```
2. 系統檢查用戶是否有權限維護的權限
   ```
   C                   MOVE 'S#A120'   DSP01
   C                   CALL 'S#S01'
   C                   PARM           DUSER
   C                   PARM           DSP01
   C                   PARM           DAUTH
   C           DAUTH     IFNE 'Y'
   C                     GOTO ENDJOB
   C                     END
   ```
3. 系統從S#SUPF檔案中讀取用戶記錄，獲取用戶名稱
   ```
   C           DSU01     CHAINSU0                  40
   C                     MOVE SU02      DNAME
   ```

#### 3.3.2 權限列表顯示
1. 系統構建S#SDPF檔案的部分鍵值（用戶ID）
   ```
   C                     MOVE DSU01     WSD01
   ```
2. 系統從S#SDPF檔案中讀取該用戶的所有權限記錄
   ```
   C           WSD01     SETLLSD0
   C           WSD01     READESD0                      44
   ```
3. 系統將權限記錄加載到子檔案中顯示
   ```
   C                     DOWEQ *OFF44
   C                     MOVE SD02      SFPGM
   C                     EXSR GETPGM                   *獲取程序描述
   C                     MOVE SP02      SFDES
   C                     MOVE SD03      SFADD
   C                     MOVE SD04      SFUPD
   C                     MOVE SD05      SFDLT
   C                     MOVE SD06      SFQRY
   C                     WRITE SUBFILE
   C           WSD01     READESD0                      44
   C                     END
   ```

#### 3.3.3 權限新增處理
1. 用戶輸入程序ID和權限設置
2. 系統檢查程序ID是否存在
   ```
   C           INPGM     CHAINSP0                  40
   C                     IFNE *OFF40
   C                     EXSR ERRPGM
   C                     END
   ```
3. 系統檢查權限記錄是否已存在
   ```
   C                     MOVE DSU01     SD01
   C                     MOVE INPGM     SD02
   C           KEYSD     CHAINSD0                  40
   C                     IFEQ *ON40
   C                     EXSR ADDAUTH               *新增權限
   C                     ELSE
   C                     EXSR UPDAUTH               *更新權限
   C                     END
   ```
4. 系統新增權限記錄
   ```
   C                     BEGSR ADDAUTH
   C                     MOVE DSU01     SD01
   C                     MOVE INPGM     SD02
   C                     MOVE INADD     SD03
   C                     MOVE INUPD     SD04
   C                     MOVE INDLT     SD05
   C                     MOVE INQRY     SD06
   C                     WRITE SD0REC
   C                     EXSR LOGADD                *記錄權限變更
   C                     ENDSR
   ```

#### 3.3.4 權限修改處理
1. 用戶選擇要修改的權限記錄
2. 系統讀取選中的權限記錄
   ```
   C                     MOVE DSU01     SD01
   C                     MOVE SFPGM     SD02
   C           KEYSD     CHAINSD0                  40
   ```
3. 用戶修改權限設置
4. 系統更新權限記錄
   ```
   C                     BEGSR UPDAUTH
   C                     MOVE OLDAUTH    SAVAUTH           *保存舊權限
   C                     MOVE INADD      SD03
   C                     MOVE INUPD      SD04
   C                     MOVE INDLT      SD05
   C                     MOVE INQRY      SD06
   C                     UPDATSD0
   C                     EXSR LOGUPD                      *記錄權限變更
   C                     ENDSR
   ```

#### 3.3.5 權限刪除處理
1. 用戶選擇要刪除的權限記錄
2. 系統讀取選中的權限記錄
   ```
   C                     MOVE DSU01     SD01
   C                     MOVE SFPGM     SD02
   C           KEYSD     CHAINSD0                  40
   ```
3. 系統刪除權限記錄
   ```
   C                     BEGSR DLTAUTH
   C                     MOVE SD03      SAVAUTH            *保存舊權限
   C                     MOVE SD04      SAVAUTH+1
   C                     MOVE SD05      SAVAUTH+2
   C                     MOVE SD06      SAVAUTH+3
   C                     DELETSD0
   C                     EXSR LOGDLT                       *記錄權限變更
   C                     ENDSR
   ```

#### 3.3.6 權限變更日誌記錄
1. 系統生成日誌序號或使用時間戳
   ```
   C                     TIME           HHMMSS
   C                     MOVE TODAY     SDL05
   C                     MOVE HHMMSS    SDL05+8
   C                     MOVE SDL05     SDL01
   ```
2. 系統記錄權限變更信息
   ```
   C                     BEGSR LOGUPD
   C                     MOVE SD02      SDL02
   C                     MOVE SD01      SDL03
   C                     MOVE 'U'       SDL04
   C                     MOVE TODAY     SDL05
   C                     MOVE TIME      SDL05+8
   C                     MOVE DUSER     SDL06
   C                     MOVE SAVAUTH   SDL07
   C                     MOVE SD03      SDL08
   C                     MOVE SD04      SDL08+1
   C                     MOVE SD05      SDL08+2
   C                     MOVE SD06      SDL08+3
   C                     WRITE SDLREC
   C                     ENDSR
   ```

### 3.4 用戶維護流程（S#A110程序）

#### 3.4.1 用戶維護初始化
1. 程序接收參數：用戶ID（SU01）
   ```
   C     *ENTRY        PLIST
   C                   PARM           DSU01           10
   ```
2. 系統檢查用戶是否有用戶維護的權限
   ```
   C                   MOVE 'S#A110'   DSP01
   C                   CALL 'S#S01'
   C                   PARM           DUSER
   C                   PARM           DSP01
   C                   PARM           DAUTH
   C           DAUTH     IFNE 'Y'
   C                     GOTO ENDJOB
   C                     END
   ```

#### 3.4.2 用戶新增處理
1. 用戶輸入新用戶信息
2. 系統檢查用戶ID是否已存在
   ```
   C           INUSER    CHAINSU0                  40
   C                     IFEQ *OFF40
   C                     EXSR ERRUSER
   C                     END
   ```
3. 系統新增用戶記錄
   ```
   C                     BEGSR ADDUSER
   C                     MOVE INUSER    SU01
   C                     MOVE INNAME    SU02
   C                     MOVE INSUPER   SU03
   C                     MOVE INDEPT    SU04
   C                     MOVE INWHSE    SU05
   C                     MOVE 'A'       SU06
   C                     MOVE INLEVEL   SU07
   C                     MOVE INPWD     SU08
   C                     MOVE TODAY     SU10
   C                     WRITE SU0REC
   C                     EXSR ADDREL                *添加上下級關係
   C                     ENDSR
   ```

#### 3.4.3 用戶修改處理
1. 用戶選擇要修改的用戶記錄
2. 系統讀取選中的用戶記錄
   ```
   C           INUSER    CHAINSU0                  40
   ```
3. 用戶修改用戶信息
4. 系統更新用戶記錄
   ```
   C                     BEGSR UPDUSER
   C                     MOVE INNAME    SU02
   C                     MOVE OLDSUPER  SAVSUPER          *保存舊上級
   C                     MOVE INSUPER   SU03
   C                     MOVE INDEPT    SU04
   C                     MOVE INWHSE    SU05
   C                     MOVE INSTAT    SU06
   C                     MOVE INLEVEL   SU07
   C                     UPDATSU0
   C                     EXSR UPDREL                      *更新上下級關係
   C                     ENDSR
   ```

#### 3.4.4 用戶刪除處理
1. 用戶選擇要刪除的用戶記錄
2. 系統檢查是否有依賴關係
   ```
   C                     BEGSR CHKDEP
   C                     MOVE INUSER    WSD01
   C           WSD01     SETLLSD0
   C           WSD01     READESD0                      44
   C                     IFNE *ON44
   C                     EXSR ERRDEP
   C                     END
   C                     ENDSR
   ```
3. 系統刪除用戶記錄
   ```
   C                     BEGSR DLTUSER
   C                     EXSR DLTREL                      *刪除上下級關係
   C                     DELETSU0
   C                     ENDSR
   ```

#### 3.4.5 用戶上下級關係維護
1. 系統添加上下級關係
   ```
   C                     BEGSR ADDREL
   C                     MOVE SU01      SUL01
   C                     MOVE SU03      SUL02
   C                     MOVE 'D'       SUL03
   C                     MOVE 'Y'       SUL04
   C                     MOVE TODAY     SUL05
   C                     MOVE DUSER     SUL06
   C                     WRITE SULREC
   C                     ENDSR
   ```
2. 系統更新上下級關係
   ```
   C                     BEGSR UPDREL
   C                     IFNE SAVSUPER  SU03              *上級變更
   C                     EXSR DLTREL
   C                     EXSR ADDREL
   C                     END
   C                     ENDSR
   ```
3. 系統刪除上下級關係
   ```
   C                     BEGSR DLTREL
   C                     MOVE SU01      SUL01
   C                     MOVE SAVSUPER  SUL02
   C           KEYSUL    CHAINSUL                  40
   C                     IFNE *ON40
   C                     DELETSUL
   C                     END
   C                     ENDSR
   ```

### 3.5 程序維護流程（S#A140程序）

#### 3.5.1 程序維護初始化
1. 程序接收參數：程序ID（SP01）
   ```
   C     *ENTRY        PLIST
   C                   PARM           DSP01           10
   ```
2. 系統檢查用戶是否有程序維護的權限
   ```
   C                   MOVE 'S#A140'   CHKPGM
   C                   CALL 'S#S01'
   C                   PARM           DUSER
   C                   PARM           CHKPGM
   C                   PARM           DAUTH
   C           DAUTH     IFNE 'Y'
   C                     GOTO ENDJOB
   C                     END
   ```

#### 3.5.2 程序新增處理
1. 用戶輸入新程序信息
2. 系統檢查程序ID是否已存在
   ```
   C           INPGM     CHAINSP0                  40
   C                     IFEQ *OFF40
   C                     EXSR ERRPGM
   C                     END
   ```
3. 系統新增程序記錄
   ```
   C                     BEGSR ADDPGM
   C                     MOVE INPGM     SP01
   C                     MOVE INDES     SP02
   C                     MOVE INTYPE    SP03
   C                     MOVE INMOD     SP04
   C                     MOVE INSUBM    SP05
   C                     MOVE INFUNC    SP06
   C                     WRITE SP0REC
   C                     ENDSR
   ```

#### 3.5.3 程序修改處理
1. 用戶選擇要修改的程序記錄
2. 系統讀取選中的程序記錄
   ```
   C           INPGM     CHAINSP0                  40
   ```
3. 用戶修改程序信息
4. 系統更新程序記錄
   ```
   C                     BEGSR UPDPGM
   C                     MOVE INDES     SP02
   C                     MOVE INTYPE    SP03
   C                     MOVE INMOD     SP04
   C                     MOVE INSUBM    SP05
   C                     MOVE INFUNC    SP06
   C                     UPDATSP0
   C                     ENDSR
   ```

#### 3.5.4 程序刪除處理
1. 用戶選擇要刪除的程序記錄
2. 系統檢查是否有依賴關係
   ```
   C                     BEGSR CHKDEP
   C                     MOVE INPGM     WSD02
   C           WSD02     SETLLSD0
   C           WSD02     READESD0                      44
   C                     IFNE *ON44
   C                     EXSR ERRDEP
   C                     END
   C                     ENDSR
   ```
3. 系統刪除程序記錄
   ```
   C                     BEGSR DLTPGM
   C                     DELETSP0
   C                     ENDSR
   ```

### 3.6 密碼變更流程（S#CP01程序）

#### 3.6.1 密碼變更初始化
1. 程序接收參數：用戶ID（SU01）
   ```
   C     *ENTRY        PLIST
   C                   PARM           DSU01           10
   ```
2. 系統從S#SUPF檔案中讀取用戶記錄
   ```
   C           DSU01     CHAINSU0                  40
   C                     IFNE *OFF40
   C                     EXSR ERRUSER
   C                     END
   ```

#### 3.6.2 密碼驗證處理
1. 用戶輸入舊密碼
2. 系統驗證舊密碼是否正確
   ```
   C                     BEGSR CHKPWD
   C           INOLDPWD  IFEQ SU08
   C                     MOVE *OFF      *IN50
   C                     ELSE
   C                     MOVE *ON       *IN50
   C                     END
   C                     ENDSR
   ```

#### 3.6.3 新密碼檢查處理
1. 用戶輸入新密碼和確認密碼
2. 系統檢查新密碼是否符合規則
   ```
   C                     BEGSR CHKNEW
   C           INNEWPWD  IFLT MINLEN                    *最小長度
   C                     EXSR ERRLEN
   C                     END
   C                     EXSR CHKCOMP                   *檢查複雜度
   C                     ENDSR
   ```
3. 系統檢查新密碼是否與舊密碼相同
   ```
   C           INNEWPWD  IFEQ SU08
   C                     EXSR ERRSAME
   C                     END
   ```
4. 系統檢查新密碼是否與歷史密碼重複
   ```
   C                     BEGSR CHKHIST
   C                     MOVE DSU01     SDL901
   C           SDL901    SETLLSDL9
   C           SDL901    READESDL9                     44
   C                     DOWEQ *OFF44
   C           INNEWPWD  IFEQ SDL904
   C                     EXSR ERRHIST
   C                     END
   C           SDL901    READESDL9                     44
   C                     END
   C                     ENDSR
   ```

#### 3.6.4 密碼更新處理
1. 系統更新用戶密碼
   ```
   C                     BEGSR UPDPWD
   C                     MOVE SU08      OLDPWD            *保存舊密碼
   C                     MOVE INNEWPWD  SU08
   C                     MOVE TODAY     SU10
   C                     UPDATSU0
   C                     EXSR LOGPWD                     *記錄密碼變更
   C                     ENDSR
   ```
2. 系統記錄密碼變更日誌
   ```
   C                     BEGSR LOGPWD
   C                     MOVE DSU01     SDL901
   C                     MOVE TODAY     SDL902
   C                     MOVE TIME      SDL902+8
   C                     MOVE OLDPWD    SDL903
   C                     MOVE SU08      SDL904
   C                     MOVE DSU01     SDL905
   C                     MOVE 'U'       SDL906
   C                     WRITE SDL9REC
   C                     ENDSR
   ```

## 4. 系統權限管理最佳實踐

### 4.1 權限設計原則

#### 4.1.1 最小權限原則
- 用戶只應被授予完成其工作所需的最小權限集
- 定期審查用戶權限，移除不必要的權限
- 使用角色或部門來組織權限，避免直接分配過多權限

#### 4.1.2 職責分離原則
- 關鍵業務功能應由不同用戶負責
- 避免單一用戶同時擁有相互制約的權限
- 特別是財務和審計相關功能應嚴格分離

#### 4.1.3 權限繼承原則
- 合理設計組織結構，使權限繼承符合業務需求
- 上級用戶通常應具有查看下級用戶數據的權限
- 但上級不一定需要具有修改下級數據的權限

### 4.2 權限管理流程

#### 4.2.1 權限申請流程
- 用戶提交權限申請，指明所需程序和權限類型
- 申請需經過部門主管和系統管理員審批
- 權限申請應記錄在案，便於後續審計

#### 4.2.2 權限審批流程
- 部門主管審核權限申請是否符合業務需求
- 系統管理員審核權限申請是否符合系統安全策略
- 雙重審批通過後，系統管理員設置權限

#### 4.2.3 權限變更流程
- 用戶角色或職責變更時，應及時調整權限
- 權限變更應經過與權限申請相同的審批流程
- 權限變更應記錄在案，便於後續審計

#### 4.2.4 權限撤銷流程
- 用戶離職或調崗時，應及時撤銷或調整權限
- 權限撤銷應由系統管理員執行
- 權限撤銷應記錄在案，便於後續審計

### 4.3 權限審計與監控

#### 4.3.1 定期權限審計
- 定期（如每季度）審查用戶權限設置
- 檢查是否存在過度授權或權限沖突
- 審計結果應形成報告，提交給管理層

#### 4.3.2 權限變更監控
- 監控權限變更操作，特別是敏感程序的權限變更
- 對異常的權限變更進行調查
- 建立權限變更監控報告機制

#### 4.3.3 系統訪問監控
- 監控用戶對系統的訪問情況，特別是敏感程序的訪問
- 對異常的系統訪問進行調查
- 建立系統訪問監控報告機制

## 5. 系統權限管理常見問題與解決方案

### 5.1 權限設置問題

#### 5.1.1 權限過度授權
- **問題**：用戶被授予超出其工作需求的權限
- **解決方案**：
  - 定期審查用戶權限，移除不必要的權限
  - 建立基於角色的權限模型，避免直接分配過多權限
  - 實施權限申請和審批流程，確保權限授予合理

#### 5.1.2 權限不足
- **問題**：用戶無法訪問完成工作所需的程序
- **解決方案**：
  - 建立明確的權限申請流程，便於用戶申請所需權限
  - 定期收集用戶反饋，了解權限需求
  - 考慮使用臨時權限機制，滿足臨時性的權限需求

#### 5.1.3 權限繼承問題
- **問題**：權限繼承設置不當，導致權限混亂
- **解決方案**：
  - 明確定義權限繼承規則，確保符合業務需求
  - 定期審查權限繼承設置，確保正確性
  - 考慮使用顯式權限設置，減少對繼承的依賴

### 5.2 用戶管理問題

#### 5.2.1 用戶離職未及時處理
- **問題**：用戶離職後，其賬號和權限未及時撤銷
- **解決方案**：
  - 建立用戶離職流程，包括賬號和權限處理
  - 定期審查用戶賬號，識別並處理離職用戶
  - 實施賬號自動過期機制，減少人為疏忽風險

#### 5.2.2 臨時用戶管理
- **問題**：臨時用戶（如實習生、顧問）的權限管理不當
- **解決方案**：
  - 為臨時用戶設置賬號有效期
  - 限制臨時用戶的權限範圍
  - 加強對臨時用戶的監控

#### 5.2.3 特權用戶管理
- **問題**：特權用戶（如系統管理員）的權限過大且缺乏監控
- **解決方案**：
  - 限制特權用戶的數量
  - 對特權用戶的操作進行嚴格監控和審計
  - 考慮實施特權賬號管理系統

### 5.3 密碼管理問題

#### 5.3.1 密碼策略不足
- **問題**：密碼策略不夠嚴格，導致密碼安全性低
- **解決方案**：
  - 實施強密碼策略，包括長度、複雜度和過期時間
  - 定期檢查密碼是否符合策略
  - 考慮實施多因素認證

#### 5.3.2 密碼共享
- **問題**：用戶之間共享密碼，導致權限混亂和安全風險
- **解決方案**：
  - 制定明確的密碼安全政策，禁止密碼共享
  - 加強用戶安全意識培訓
  - 實施登錄監控，識別可能的密碼共享行為
  - 考慮實施單點登錄系統，減少密碼共享的需求

#### 5.3.3 密碼重置流程不安全
- **問題**：密碼重置流程存在安全漏洞，可能被利用進行未授權訪問
- **解決方案**：
  - 建立安全的密碼重置流程，包括身份驗證步驟
  - 密碼重置後強制用戶立即修改密碼
  - 記錄所有密碼重置操作，便於審計
  - 考慮使用臨時密碼或一次性密碼進行密碼重置

### 5.4 系統配置問題

#### 5.4.1 權限檢查繞過
- **問題**：某些程序未正確實施權限檢查，導致權限控制被繞過
- **解決方案**：
  - 對所有程序進行權限檢查審計，確保正確實施
  - 建立程序開發標準，要求所有程序必須實施權限檢查
  - 考慮實施集中式權限檢查機制，減少人為錯誤

#### 5.4.2 權限數據不一致
- **問題**：權限數據在不同檔案之間存在不一致，導致權限控制混亂
- **解決方案**：
  - 定期檢查權限數據一致性，修復不一致問題
  - 實施數據完整性檢查機制，確保權限數據一致性
  - 考慮實施事務處理機制，確保權限數據更新的原子性

#### 5.4.3 系統日誌不完整
- **問題**：系統日誌不完整，難以追蹤權限變更和系統訪問歷史
- **解決方案**：
  - 加強系統日誌記錄，確保所有關鍵操作都有記錄
  - 定期檢查系統日誌完整性
  - 考慮實施集中式日誌管理系統，便於日誌分析和審計

## 6. 系統權限管理技術實現詳解

### 6.1 權限檢查實現（S#S01程序）

#### 6.1.1 權限檢查邏輯流程
```
開始
  |
  V
接收參數（用戶ID、程序ID）
  |
  V
檢查用戶ID是否為特殊用戶（如系統管理員）
  |
  V
是特殊用戶？ --是--> 返回有權限
  |
  否
  V
檢查程序ID是否存在
  |
  V
程序存在？ --否--> 返回無權限
  |
  是
  V
檢查程序類型
  |
  V
是菜單類型？ --是--> 執行菜單權限檢查
  |
  否
  V
從S#SDPF檔案中讀取權限記錄
  |
  V
權限記錄存在？ --是--> 檢查具體權限
  |                     |
  否                    V
  |                  有權限？ --是--> 返回有權限
  V                     |
檢查是否需要繼承上級權限   否
  |                     |
  V                     V
需要繼承？ --是--> 檢查上級權限 --> 上級有權限？ --是--> 返回有權限
  |                                   |
  否                                  否
  V                                   V
返回無權限 <---------------------------|
```

#### 6.1.2 關鍵代碼段解析
```
C     *ENTRY        PLIST
C                   PARM           DSU01           10  *用戶ID
C                   PARM           DSP01           10  *程序ID
C                   PARM           DAUTH            1  *返回權限標誌

* 檢查特殊用戶
C           DSU01     IFEQ 'D9'                       *系統管理員
C                     MOVE 'Y'       DAUTH
C                     GOTO ENDJOB
C                     END

* 檢查程序是否存在
C           DSP01     CHAINSP0                  40
C                     IFNE *OFF40
C                     MOVE 'N'       DAUTH
C                     GOTO ENDJOB
C                     END

* 檢查程序類型
C           SP03      IFEQ 'M'                       *菜單類型
C                     EXSR MENUAUTH
C                     END

* 檢查用戶權限
C                     MOVE DSU01     SD01
C                     MOVE DSP01     SD02
C           KEYSD     CHAINSD0                  40
C                     IFNE *ON40
C                     EXSR CHKAUTH
C                     ELSE
C                     EXSR INHAUTH               *檢查繼承權限
C                     END

* 檢查具體權限
C                     BEGSR CHKAUTH
C           OPTYPE    IFEQ 'A'                       *新增操作
C           SD03      IFEQ 'Y'
C                     MOVE 'Y'       DAUTH
C                     END
C                     END
C                     ENDSR

* 檢查繼承權限
C                     BEGSR INHAUTH
C           DSU01     CHAINSU0                  40
C                     MOVE SU03      SUPUSER
C           SUPUSER   IFNE *BLANKS
C                     MOVE SUPUSER    SD01
C                     MOVE DSP01      SD02
C                     EXSR CHKSUPER
C                     END
C                     ENDSR
```

#### 6.1.3 性能優化考慮
- 使用直接存取方式（CHAIN）而非順序存取，提高檢索效率
- 特殊用戶和特殊情況的快速路徑處理，減少不必要的檢查
- 權限繼承的遞歸檢查限制深度，避免過深的遞歸導致性能問題
- 考慮使用本地數據區（LDA）緩存常用權限信息，減少檔案訪問

### 6.2 權限維護實現（S#A120程序）

#### 6.2.1 權限維護畫面設計
- 主畫面：顯示用戶基本信息和權限列表
- 權限列表：使用子檔案（SUBFILE）顯示用戶的所有權限記錄
- 權限編輯：提供新增、修改、刪除權限的功能
- 權限複製：提供從其他用戶複製權限的功能

#### 6.2.2 權限維護邏輯流程
```
開始
  |
  V
接收參數（用戶ID）
  |
  V
檢查用戶是否有權限維護的權限
  |
  V
有權限？ --否--> 結束程序
  |
  是
  V
讀取用戶基本信息
  |
  V
讀取用戶的所有權限記錄
  |
  V
顯示權限維護畫面
  |
  V
用戶選擇操作
  |
  V
新增權限？ --是--> 執行新增權限流程
  |                |
  否               V
  |             返回主畫面
  V
修改權限？ --是--> 執行修改權限流程
  |                |
  否               V
  |             返回主畫面
  V
刪除權限？ --是--> 執行刪除權限流程
  |                |
  否               V
  |             返回主畫面
  V
複製權限？ --是--> 執行複製權限流程
  |                |
  否               V
  |             返回主畫面
  V
退出程序？ --是--> 結束程序
  |
  否
  V
返回主畫面
```

#### 6.2.3 關鍵代碼段解析
```
* 權限維護初始化
C     *ENTRY        PLIST
C                   PARM           DSU01           10  *用戶ID

* 檢查權限
C                   MOVE 'S#A120'   DSP01
C                   CALL 'S#S01'
C                   PARM           DUSER
C                   PARM           DSP01
C                   PARM           DAUTH
C           DAUTH     IFNE 'Y'
C                     GOTO ENDJOB
C                     END

* 讀取用戶信息
C           DSU01     CHAINSU0                  40
C                     MOVE SU02      DNAME

* 讀取權限記錄
C                     MOVE DSU01     WSD01
C           WSD01     SETLLSD0
C           WSD01     READESD0                      44
C                     DOWEQ *OFF44
C                     MOVE SD02      SFPGM
C                     EXSR GETPGM                   *獲取程序描述
C                     MOVE SP02      SFDES
C                     MOVE SD03      SFADD
C                     MOVE SD04      SFUPD
C                     MOVE SD05      SFDLT
C                     MOVE SD06      SFQRY
C                     WRITE SUBFILE
C           WSD01     READESD0                      44
C                     END

* 新增權限
C                     BEGSR ADDAUTH
C                     MOVE DSU01     SD01
C                     MOVE INPGM     SD02
C                     MOVE INADD     SD03
C                     MOVE INUPD     SD04
C                     MOVE INDLT     SD05
C                     MOVE INQRY     SD06
C                     WRITE SD0REC
C                     EXSR LOGADD                *記錄權限變更
C                     ENDSR

* 記錄權限變更
C                     BEGSR LOGADD
C                     MOVE SD02      SDL02
C                     MOVE SD01      SDL03
C                     MOVE 'A'       SDL04
C                     MOVE TODAY     SDL05
C                     MOVE TIME      SDL05+8
C                     MOVE DUSER     SDL06
C                     MOVE *BLANKS   SDL07
C                     MOVE SD03      SDL08
C                     MOVE SD04      SDL08+1
C                     MOVE SD05      SDL08+2
C                     MOVE SD06      SDL08+3
C                     WRITE SDLREC
C                     ENDSR
```

#### 6.2.4 批量權限處理
- 權限複製：從其他用戶複製權限到當前用戶
- 權限模板：使用預定義的權限模板設置用戶權限
- 部門權限：根據用戶所屬部門自動設置相應權限
- 角色權限：根據用戶角色自動設置相應權限

### 6.3 用戶維護實現（S#A110程序）

#### 6.3.1 用戶維護畫面設計
- 主畫面：顯示用戶列表
- 用戶編輯：提供新增、修改、刪除用戶的功能
- 用戶詳情：顯示用戶詳細信息，包括基本信息和上下級關係

#### 6.3.2 用戶維護邏輯流程
```
開始
  |
  V
檢查用戶是否有用戶維護的權限
  |
  V
有權限？ --否--> 結束程序
  |
  是
  V
顯示用戶列表
  |
  V
用戶選擇操作
  |
  V
新增用戶？ --是--> 執行新增用戶流程
  |                |
  否               V
  |             返回主畫面
  V
修改用戶？ --是--> 執行修改用戶流程
  |                |
  否               V
  |             返回主畫面
  V
刪除用戶？ --是--> 執行刪除用戶流程
  |                |
  否               V
  |             返回主畫面
  V
查看用戶詳情？ --是--> 顯示用戶詳情
  |                    |
  否                   V
  |                 返回主畫面
  V
退出程序？ --是--> 結束程序
  |
  否
  V
返回主畫面
```

#### 6.3.3 關鍵代碼段解析
```
* 用戶維護初始化
C     *ENTRY        PLIST
C                   PARM           DSU01           10  *用戶ID

* 檢查權限
C                   MOVE 'S#A110'   DSP01
C                   CALL 'S#S01'
C                   PARM           DUSER
C                   PARM           DSP01
C                   PARM           DAUTH
C           DAUTH     IFNE 'Y'
C                     GOTO ENDJOB
C                     END

* 新增用戶
C                     BEGSR ADDUSER
C                     MOVE INUSER    SU01
C                     MOVE INNAME    SU02
C                     MOVE INSUPER   SU03
C                     MOVE INDEPT    SU04
C                     MOVE INWHSE    SU05
C                     MOVE 'A'       SU06
C                     MOVE INLEVEL   SU07
C                     MOVE INPWD     SU08
C                     MOVE TODAY     SU10
C                     WRITE SU0REC
C                     EXSR ADDREL                *添加上下級關係
C                     ENDSR

* 添加上下級關係
C                     BEGSR ADDREL
C                     MOVE SU01      SUL01
C                     MOVE SU03      SUL02
C                     MOVE 'D'       SUL03
C                     MOVE 'Y'       SUL04
C                     MOVE TODAY     SUL05
C                     MOVE DUSER     SUL06
C                     WRITE SULREC
C                     ENDSR
```

#### 6.3.4 用戶密碼管理
- 密碼加密存儲：使用加密算法存儲密碼，確保安全性
- 密碼複雜度檢查：檢查密碼是否符合複雜度要求
- 密碼過期管理：設置密碼過期時間，強制用戶定期修改密碼
- 密碼歷史檢查：檢查新密碼是否與歷史密碼重複

### 6.4 程序維護實現（S#A140程序）

#### 6.4.1 程序維護畫面設計
- 主畫面：顯示程序列表
- 程序編輯：提供新增、修改、刪除程序的功能
- 程序詳情：顯示程序詳細信息，包括基本信息和屬性

#### 6.4.2 程序維護邏輯流程
```
開始
  |
  V
檢查用戶是否有程序維護的權限
  |
  V
有權限？ --否--> 結束程序
  |
  是
  V
顯示程序列表
  |
  V
用戶選擇操作
  |
  V
新增程序？ --是--> 執行新增程序流程
  |                |
  否               V
  |             返回主畫面
  V
修改程序？ --是--> 執行修改程序流程
  |                |
  否               V
  |             返回主畫面
  V
刪除程序？ --是--> 執行刪除程序流程
  |                |
  否               V
  |             返回主畫面
  V
查看程序詳情？ --是--> 顯示程序詳情
  |                    |
  否                   V
  |                 返回主畫面
  V
退出程序？ --是--> 結束程序
  |
  否
  V
返回主畫面
```

#### 6.4.3 關鍵代碼段解析
```
* 程序維護初始化
C     *ENTRY        PLIST
C                   PARM           DSP01           10  *程序ID

* 檢查權限
C                   MOVE 'S#A140'   CHKPGM
C                   CALL 'S#S01'
C                   PARM           DUSER
C                   PARM           CHKPGM
C                   PARM           DAUTH
C           DAUTH     IFNE 'Y'
C                     GOTO ENDJOB
C                     END

* 新增程序
C                     BEGSR ADDPGM
C                     MOVE INPGM     SP01
C                     MOVE INDES     SP02
C                     MOVE INTYPE    SP03
C                     MOVE INMOD     SP04
C                     MOVE INSUBM    SP05
C                     MOVE INFUNC    SP06
C                     WRITE SP0REC
C                     ENDSR
```

#### 6.4.4 程序分類管理
- 程序類型：區分菜單程序和功能程序
- 模塊分類：按模塊對程序進行分類，便於管理
- 功能分類：按功能對程序進行分類，便於權限分配
- 程序依賴關係：管理程序之間的依賴關係，確保系統完整性

## 7. 系統權限管理未來發展方向

### 7.1 技術升級方向

#### 7.1.1 現代化認證機制
- 實施多因素認證（MFA），提高安全性
- 支持單點登錄（SSO），提升用戶體驗
- 整合生物識別技術，如指紋、人臉識別等
- 支持OAuth、SAML等現代認證標準

#### 7.1.2 基於角色的訪問控制（RBAC）
- 建立完善的角色體系，簡化權限管理
- 實施角色繼承機制，減少重複配置
- 支持動態角色分配，適應業務變化
- 實施角色生命週期管理，確保角色設置合理

#### 7.1.3 基於屬性的訪問控制（ABAC）
- 根據用戶屬性、資源屬性和環境屬性動態決定訪問權限
- 支持複雜的訪問控制策略，如時間限制、位置限制等
- 實施策略引擎，支持靈活的權限規則定義
- 支持策略評估和衝突解決機制

### 7.2 功能擴展方向

#### 7.2.1 自助服務門戶
- 提供用戶自助密碼重置功能
- 支持用戶自助權限申請和審批流程
- 提供用戶自助權限查詢功能
- 支持用戶自助報告生成功能

#### 7.2.2 智能權限推薦
- 基於用戶角色和行為模式推薦合適的權限設置
- 識別異常的權限設置，提供優化建議
- 預測用戶可能需要的權限，提前準備
- 分析權限使用情況，識別冗餘權限

#### 7.2.3 高級審計和報告
- 提供更詳細的審計日誌，包括操作上下文
- 支持複雜的審計查詢和分析功能
- 生成合規性報告，滿足監管要求
- 提供可視化的權限分析工具，便於決策

### 7.3 集成與互操作性

#### 7.3.1 與企業身份管理系統集成
- 與Active Directory、LDAP等企業身份管理系統集成
- 支持用戶信息自動同步，減少重複維護
- 實施集中式身份管理，確保一致性
- 支持身份聯合，實現跨系統身份認證

#### 7.3.2 與業務系統集成
- 與ERP、CRM等業務系統集成，實現統一權限管理
- 支持業務流程驅動的權限變更
- 實施上下文感知的權限控制，根據業務場景調整權限
- 支持跨系統的權限審計和報告

#### 7.3.3 與安全信息和事件管理（SIEM）系統集成
- 將權限變更和訪問日誌發送到SIEM系統
- 支持安全事件關聯分析，識別潛在威脅
- 實施實時安全監控，及時發現異常
- 支持安全事件響應流程，快速處理安全問題

## 8. 結論與建議

### 8.1 系統權限管理現狀總結
- 西祺企業管理資訊系統採用了基於用戶-程序-權限的三層權限模型
- 系統實現了基本的權限控制功能，包括用戶管理、程序管理、權限管理和密碼管理
- 系統支持權限繼承和權限審計，提供了一定的安全保障
- 系統使用RPG和CL語言實現，運行在AS/400平台上

### 8.2 系統權限管理優化建議

#### 8.2.1 短期優化建議
- 完善權限審計機制，確保所有權限變更都有完整記錄
- 加強密碼策略，實施更嚴格的密碼複雜度要求和過期策略
- 優化權限繼承機制，減少手動權限設置的工作量
- 完善權限報表，提供更詳細的權限分析信息

#### 8.2.2 中期優化建議
- 實施基於角色的訪問控制（RBAC），簡化權限管理
- 建立自助服務門戶，減少管理員工作量
- 加強與其他系統的集成，實現統一身份管理
- 優化權限檢查性能，減少系統響應時間

#### 8.2.3 長期優化建議
- 考慮系統現代化改造，採用更現代的技術架構
- 實施基於屬性的訪問控制（ABAC），支持更靈活的權限策略
- 整合人工智能技術，實現智能權限管理
- 建立完整的安全管理體系，提升整體安全水平

### 8.3 最終建議
西祺企業管理資訊系統的權限管理模塊為企業提供了基本的安全保障，但隨著業務發展和技術進步，系統需要不斷優化和升級。建議企業從短期優化開始，逐步實施中長期優化計劃，最終建立一個安全、高效、靈活的權限管理體系，滿足企業不斷發展的需求。

同時，權限管理不僅是技術問題，也是管理問題。建議企業建立完善的權限管理制度和流程，加強用戶安全意識培訓，形成良好的安全文化，從而全面提升系統安全水平。