# SOR170 銷售訂單報表程式規格說明書

## 1. 基本資訊

- **程式名稱**：SOR170
- **程式類型**：RPG程式
- **程式庫**：REPLIB
- **功能說明**：銷售訂單報表程式 - 銷售訂單明細報表
- **相關檔案**：
  - SOR170D（顯示檔案）
  - SOR170P（印表檔案）
  - SOVMPF（銷售訂單主檔）
  - SOVDPF（銷售訂單明細檔）
  - CTMAPF（客戶主檔）
  - MTMCPF（業務員主檔）
  - PTMAPF（產品主檔）
- **系統名稱**：西祺企業經營管理資訊系統
- **子系統**：銷售訂單管理模組
- **作者**：A1546 VINCENT HO
- **建立日期**：97/11/05
- **最後修改日期**：100/03/20（A1492 TERRY）
- **功能說明**：本程式用於產生銷售訂單明細報表，提供按不同條件查詢和列印銷售訂單明細資料的功能。

## 2. 程式概述

SOR170是西祺企業經營管理資訊系統中銷售訂單管理模組的重要報表程式，專門用於產生銷售訂單明細報表。此程式允許使用者根據不同的條件（如訂單狀態、訂單日期、客戶代碼、產品類別、訂單號碼、產品代碼、業務員等）產生客製化的銷售訂單明細報表，以便管理者分析銷售訂單執行情況。

程式提供了靈活的查詢條件設定，包括選擇特定的訂單狀態、指定日期範圍、選擇特定客戶或產品等。報表可以按照不同的方式排序和分組，以滿足不同的分析需求。報表內容包括訂單基本資訊、產品明細、數量、金額等重要資料，為銷售管理提供全面的資訊支持。

## 3. 程式流程詳細說明

### 3.1 主要流程圖

```
開始
  |
  v
初始化系統環境
  |
  v
顯示查詢條件畫面
  |
  v
接收使用者輸入
  |
  v
< 使用者是否按F3? > --是--> 返回上層選單
  |
  否
  |
  v
< 使用者是否按F4? > --是--> 顯示查詢視窗
  |                         |
  否                        v
  |                     接收查詢結果
  v                         |
< 使用者是否按F5? > --是--> 產生報表
  |                         |
  否                        v
  |                     顯示報表
  v                         |
檢查輸入資料                 v
  |                     返回查詢條件畫面
  v
< 資料是否有效? > --否--> 顯示錯誤訊息
  |                         |
  是                        v
  |                     返回查詢條件畫面
  v
產生報表
  |
  v
顯示報表
  |
  v
返回查詢條件畫面
  |
  v
結束
```

### 3.2 初始化階段

程式開始時進行以下初始化操作：

```RPG
C           *ENTRY    PLIST
C           *IN03     PARM *IN03     IN03    1
C           *IN98     PARM *IN98     IN98    1
C           *IN97     PARM *IN97     IN97    1
C  N97N98             EXSR RTN010                     *INIT ENVIRM
```

- 宣告參數列表，包括功能鍵標誌
- 從本地資料區域(LDA)獲取使用者ID、日期等資訊
- 初始化查詢條件畫面的預設值

### 3.3 主選單處理

程式顯示查詢條件畫面，並處理使用者的選擇：

```RPG
C           *IN03     DOUEQ'1'
C           *IN99     OREQ '0'
C                     EXFMTDSPD1
C                     MOVEA*ALL'0'   *IN,60
C           *IN03     IFEQ '0'
C           *IN04     IFEQ '1'
C                     EXSR RTNF4
C                     ELSE
C           *IN05     IFEQ '1'
C                     EXSR RTN200
C                     ELSE
C                     EXSR RTN100                     *CHECK SCR01?
C                     END
C                     END
C                     END
C                     END
```

- 顯示查詢條件畫面並接收使用者輸入
- 處理功能鍵：F3（返回）、F4（查詢）、F5（產生報表）
- 檢查輸入資料的有效性

### 3.4 資料檢查

程式檢查使用者輸入的查詢條件是否有效：

```RPG
C           RTN100    BEGSR
C           SOST      IFLT '1'
C           SOST      ORGT '9'
C                     SETON                     639993
C                     END
C   99                GOTO END100
C                     Z-ADDSOST      SOST
C                     MOVELCNO       CNOS
```

- 檢查訂單狀態是否有效（1-9）
- 檢查日期範圍是否有效（起始日期不能大於結束日期）
- 檢查客戶代碼是否存在
- 檢查產品代碼是否存在
- 檢查業務員代碼是否存在
- 檢查其他查詢條件的有效性

### 3.5 報表產生

當使用者按下F5鍵時，程式產生報表：

```RPG
C           RTN200    BEGSR
C                     CALL 'SOR1701'
C                     PARM SOST      S0101I  1
C                     PARM SDTS      S0102I  80
C                     PARM SDTE      S0103I  80
C                     PARM CNOS      S0104I  60
C                     PARM CNOE      S0105I  60
C                     PARM PTCS      S0106I  20
C                     PARM PTCE      S0107I  20
C                     PARM SNOS      S0108I  100
C                     PARM SNOE      S0109I  100
C                     PARM PTNS      S0110I  150
C                     PARM PTNE      S0111I  150
C                     PARM SALS      S0112I  30
C                     PARM SALE      S0113I  30
C                     PARM $EVR      S0114I  1
C                     PARM $CPY      S0115I  30
C                     PARM $PRTID    S0116I  20
C                     PARM           S0101O  1
```

- 調用SOR1701子程式產生報表
- 傳遞查詢條件參數，包括：
  - 訂單狀態（SOST）
  - 日期範圍（SDTS, SDTE）
  - 客戶代碼範圍（CNOS, CNOE）
  - 產品類別範圍（PTCS, PTCE）
  - 訂單號碼範圍（SNOS, SNOE）
  - 產品代碼範圍（PTNS, PTNE）
  - 業務員代碼範圍（SALS, SALE）
  - 報表格式（$EVR）
  - 列印份數（$CPY）
  - 印表機ID（$PRTID）

## 4. 畫面說明

### 4.1 查詢條件畫面 (SCR001)

查詢條件畫面允許使用者設定報表的產生條件：

- **訂單狀態**：可選擇1（未處理）、2（處理中）、3（已完成）等狀態
- **訂單日期**：指定要查詢的訂單日期範圍（YYMMDD格式）
- **客戶代碼**：指定要查詢的客戶代碼範圍
- **產品類別**：指定要查詢的產品類別範圍
- **訂單號碼**：指定要查詢的訂單號碼範圍
- **產品代碼**：指定要查詢的產品代碼範圍
- **業務員**：指定要查詢的業務員代碼範圍
- **報表格式**：可選擇1（摘要）或2（明細）
- **列印份數**：指定要列印的份數
- **印表機**：指定要使用的印表機ID

**功能鍵**：
- F3：返回上層選單
- F4：查詢（客戶、產品、業務員等）
- F5：產生報表

## 5. 報表格式說明

### 5.1 銷售訂單明細報表

銷售訂單明細報表包含以下欄位：

- **報表標題**：銷售訂單明細報表
- **報表日期**：產生報表的日期
- **頁碼**：報表頁碼
- **訂單號碼**：訂單的唯一識別號碼
- **訂單日期**：訂單建立日期
- **客戶代碼**：客戶的代碼
- **客戶名稱**：客戶的名稱
- **產品代碼**：產品的代碼
- **產品名稱**：產品的名稱
- **產品規格**：產品的規格
- **訂購數量**：訂購的產品數量
- **單位**：數量的單位
- **單價**：產品的單價
- **金額**：訂購數量乘以單價的金額
- **交貨日期**：預計交貨日期
- **訂單狀態**：訂單的處理狀態
- **業務員**：負責此訂單的業務員
- **備註**：訂單的備註說明

### 5.2 報表排序

報表可以按照以下方式排序：

1. **按訂單號碼排序**：訂單號碼由小到大排序
2. **按客戶代碼排序**：先按客戶代碼排序，再按訂單號碼排序
3. **按產品代碼排序**：先按產品代碼排序，再按訂單號碼排序
4. **按業務員排序**：先按業務員代碼排序，再按訂單號碼排序

## 6. 資料檔案說明

本程式主要使用以下檔案：

- **SOR170D**：顯示檔案，用於顯示查詢條件畫面
- **SOR170P**：印表檔案，用於產生報表
- **SOVMPF**：銷售訂單主檔，存儲訂單的基本資訊
- **SOVDPF**：銷售訂單明細檔，存儲訂單的產品明細資訊
- **CTMAPF**：客戶主檔，用於獲取客戶資訊
- **MTMCPF**：業務員主檔，用於獲取業務員資訊
- **PTMAPF**：產品主檔，用於獲取產品資訊
- **LDA（本地資料區域）**：存儲使用者ID、日期等系統環境資訊

## 7. 程式邏輯

### 7.1 查詢條件處理邏輯

1. 程式初始化時，設定查詢條件的預設值
2. 顯示查詢條件畫面，等待使用者輸入
3. 使用者輸入查詢條件後，程式檢查條件的有效性
4. 如果條件有效，程式準備產生報表的參數

### 7.2 訂單狀態處理邏輯

1. 程式接收使用者輸入的訂單狀態
2. 檢查訂單狀態是否有效（1-9）
3. 如果訂單狀態有效，程式使用此狀態作為報表的查詢條件
4. 如果使用者未指定訂單狀態，程式將產生所有狀態的訂單報表

### 7.3 日期處理邏輯

1. 程式接收使用者輸入的日期範圍（YYMMDD格式）
2. 檢查日期範圍的有效性（起始日期不能大於結束日期）
3. 如果日期範圍有效，程式使用此範圍作為報表的查詢條件
4. 如果使用者未指定日期範圍，程式將產生所有日期的訂單報表

### 7.4 客戶處理邏輯

1. 程式接收使用者輸入的客戶代碼範圍
2. 檢查客戶代碼是否存在於客戶主檔（CTMAPF）中
3. 如果客戶代碼有效，程式使用此範圍作為報表的查詢條件
4. 如果使用者未指定客戶代碼，程式將產生所有客戶的訂單報表

### 7.5 產品處理邏輯

1. 程式接收使用者輸入的產品代碼範圍
2. 檢查產品代碼是否存在於產品主檔（PTMAPF）中
3. 如果產品代碼有效，程式使用此範圍作為報表的查詢條件
4. 如果使用者未指定產品代碼，程式將產生所有產品的訂單報表

### 7.6 報表產生邏輯

1. 程式調用SOR1701子程式產生報表
2. 傳遞所有查詢條件參數給子程式
3. 子程式根據參數產生報表
4. 報表產生後，程式返回查詢條件畫面，等待使用者的下一個操作

## 8. 錯誤處理

程式處理以下錯誤情況：

1. **無效訂單狀態**：如果使用者輸入的訂單狀態不在1-9範圍內，程式顯示錯誤訊息
2. **無效日期範圍**：如果起始日期大於結束日期，程式顯示錯誤訊息
3. **無效客戶代碼**：如果客戶代碼不存在，程式顯示錯誤訊息
4. **無效產品代碼**：如果產品代碼不存在，程式顯示錯誤訊息
5. **無效業務員代碼**：如果業務員代碼不存在，程式顯示錯誤訊息
6. **其他輸入錯誤**：程式檢查所有輸入欄位的有效性，並顯示相應的錯誤訊息

## 9. 維護歷史

| 日期 | 作者 | 修改內容 |
|------|------|----------|
| 97/11/05 | A1546 VINCENT HO | 程式初版建立 |
| 100/03/20 | A1492 TERRY | 程式更新，增加產品類別查詢條件 |

## 10. 系統整合

SOR170程式與以下系統或模組整合：

1. **銷售訂單管理模組**：作為銷售訂單管理模組的一部分，提供銷售訂單明細報表功能
2. **客戶管理模組**：使用客戶主檔（CTMAPF）獲取客戶資訊
3. **產品管理模組**：使用產品主檔（PTMAPF）獲取產品資訊
4. **業務員管理模組**：使用業務員主檔（MTMCPF）獲取業務員資訊

## 11. 使用說明

### 11.1 進入程式

1. 從銷售訂單管理主選單選擇"銷售訂單明細報表"選項
2. 系統顯示SOR170查詢條件畫面

### 11.2 設定查詢條件

1. 選擇訂單狀態（如未處理、處理中、已完成等）
2. 指定訂單日期範圍
3. 指定客戶代碼範圍（可使用F4鍵查詢）
4. 指定產品類別範圍
5. 指定訂單號碼範圍
6. 指定產品代碼範圍（可使用F4鍵查詢）
7. 指定業務員代碼範圍（可使用F4鍵查詢）
8. 選擇報表格式（摘要或明細）
9. 指定列印份數和印表機ID

### 11.3 產生報表

1. 設定完查詢條件後，按F5鍵產生報表
2. 系統產生報表並顯示或列印
3. 報表產生後，系統返回查詢條件畫面

### 11.4 退出程式

1. 在查詢條件畫面上，按F3鍵
2. 系統返回上層選單

## 12. 效能考量

1. **報表產生時間**：根據查詢條件和資料量，報表產生時間可能會有所不同
2. **記憶體使用**：程式處理大量資料時，可能需要較多的記憶體
3. **資源使用**：報表產生過程中，程式會讀取多個檔案，可能會影響系統效能

## 13. 安全考量

1. **權限控制**：程式通過系統權限控制機制，確保只有授權使用者才能執行
2. **資料保護**：程式只顯示使用者有權限查看的資料
3. **審計追蹤**：系統記錄報表產生的相關資訊，以便進行審計追蹤

## 14. 未來擴展建議

1. **報表格式增強**：可以增加更多的報表格式選項，如圖表、趨勢分析等
2. **查詢條件擴展**：可以增加更多的查詢條件，如訂單類型、付款方式等
3. **整合增強**：可以增強與其他模組的整合，如與庫存模組的整合，提供庫存與訂單的綜合分析
4. **電子報表**：可以增加電子報表功能，如PDF、Excel等格式的報表輸出

## 15. 結論

SOR170程式作為銷售訂單管理模組的重要組成部分，提供了強大的銷售訂單明細報表功能。程式設計靈活，允許使用者根據不同的條件產生客製化的報表，以滿足不同的分析需求。通過這些報表，管理者可以有效地分析銷售訂單執行情況，為銷售管理和決策提供重要的參考依據。 