# WOR100 工作訂單報表程式規格說明書

## 1. 基本資訊

- **程式名稱**：WOR100
- **程式類型**：RPG程式
- **程式庫**：REPLIB
- **功能描述**：工作訂單報表列印程式
- **相關檔案**：
  - WOR100D（顯示檔案）
  - WOR100P（打印檔案）
  - WOWCLF（工作訂單邏輯檔）
  - WOWCPF（工作訂單主檔）
  - WOWDPF（工作訂單明細檔）
  - CTMAPF（客戶主檔）
  - MTMAPF（產品主檔）
- **系統名稱**：西祺企業經營管理資訊系統
- **子系統**：工作訂單管理系統
- **作者**：A1139 JANE
- **建立日期**：81/02/13
- **最後修改日期**：未明確標示
- **程式說明**：提供工作訂單報表的列印功能，支援多種查詢條件和報表格式

## 2. 程式概述

WOR100是西祺企業經營管理資訊系統中工作訂單管理系統的報表程式，主要功能是根據使用者指定的條件產生工作訂單報表。此程式提供多種查詢條件，包括訂單編號範圍、訂單日期範圍、客戶代碼範圍、訂單狀態、產品類別等，使用者可以根據實際需求選擇適合的條件組合，生成客製化的工作訂單報表。

報表內容包括工作訂單的基本資訊（訂單編號、訂單日期、客戶資訊等）和明細資訊（產品代碼、產品名稱、數量、單價、金額等），可以按照不同的排序方式（如訂單編號、訂單日期、客戶代碼等）進行排序，方便使用者查閱和分析。

WOR100程式採用模組化設計，主程式負責參數處理和報表控制，而實際的報表產生則由子程式（WOR1001）完成，確保程式結構清晰、易於維護和擴展。

## 3. 程式流程詳解

### 3.1 主要流程圖

```
開始
  |
  ↓
初始化系統環境
  |
  ↓
顯示選擇畫面
  |
  ↓
接收使用者輸入的查詢條件
  |
  ↓
驗證輸入條件
  |
  ↓
根據執行方式選擇處理方式
  |   ↙        ↘
立即執行      批次執行
  |              |
  ↓              ↓
呼叫WOR1001    提交批次作業
  |              |
  ↓              ↓
產生報表       結束程式
  |
  ↓
結束程式
```

### 3.2 詳細流程說明

#### 3.2.1 初始化階段

```RPG
FWOR100D CF  E                    WORKSTN
F                                              KINFDS DSPFDS
ILDA        UDS
I                                      101 110 $USER
I                                      119 1240$EGMDY
I                                      162 1620$EVR
I                                      598 5990$PRTID
```

1. **檔案宣告**：
   - `WOR100D`：顯示檔案，工作站模式

2. **變數宣告**：
   - 從LDA獲取使用者ID、日期和執行方式資訊
   - 定義查詢條件變數和控制變數

#### 3.2.2 主畫面處理

1. **初始化變數**：
   ```RPG
   C                     EXSR RTN010
   ```
   - 初始化查詢條件和控制變數
   - 設定預設值

2. **顯示主畫面**：
   ```RPG
   C                     EXSR RTN011
   ```
   - 顯示查詢條件輸入畫面
   - 處理使用者輸入

3. **驗證輸入**：
   ```RPG
   C                     EXSR RTN020
   ```
   - 檢查訂單編號範圍是否有效
   - 檢查訂單日期範圍是否有效
   - 檢查客戶代碼範圍是否有效
   - 檢查訂單狀態範圍是否有效
   - 檢查產品類別範圍是否有效

#### 3.2.3 報表處理

1. **執行方式判斷**：
   ```RPG
   C           $EVR      IFEQ '1'
   C                     EXSR RTN030
   C                     ELSE
   C                     EXSR RTN040
   C                     ENDIF
   ```
   - `1`：立即執行
   - `2`：批次執行

2. **立即執行處理**：
   ```RPG
   C           RTN030    BEGSR
   C                     CALL 'WOR1001'
   C                     PARM           PARM01
   C                     ENDSR
   ```
   - 呼叫WOR1001子程式
   - 傳遞查詢條件參數

3. **批次執行處理**：
   ```RPG
   C           RTN040    BEGSR
   C                     CALL 'QCMDEXC'
   C                     PARM           CMDSTR   500
   C                     PARM           CMDLEN    15 0
   C                     ENDSR
   ```
   - 使用QCMDEXC呼叫CL命令
   - 提交批次作業

#### 3.2.4 功能鍵處理

```RPG
C                     IF        *IN03 = *ON
C                     MOVE *ON       *INLR
C                     ENDIF
C                     IF        *IN04 = *ON
C                     EXSR F4HELP
C                     ENDIF
```
- F3：結束程式
- F4：顯示代碼查詢視窗

## 4. 畫面說明

### 4.1 主畫面（SCR001）

主畫面用於接收使用者輸入的查詢條件。

```
WOR100                      工作訂單報表                     日期: YY/MM/DD
SCR001                                                      時間: HH:MM:SS
                                                            USER: XXXXXXXXXX

        訂單狀態: X - X (1=新建 2=處理中 3=完成 4=取消)

        訂單日期: XXXXXX - XXXXXX

        客戶代碼: XXXXXX - XXXXXX

        產品類別: XX - XX

        訂單編號: XXXXXX - XXXXXX

        產品代碼: XXXXXXXXX - XXXXXXXXX

        業務人員: XXXXXX - XXXXXX


F3=結束 F4=代碼查詢
```

### 4.2 功能鍵說明

| 功能鍵 | 功能描述 | 處理子程序 |
|--------|---------|-----------|
| F3 | 結束程式 | 返回上層選單 |
| F4 | 代碼查詢 | F4HELP |

## 5. 報表格式說明

### 5.1 工作訂單報表格式

工作訂單報表顯示工作訂單的基本資訊和明細資訊。

```
                                工作訂單報表                           頁碼: XXX
                                                                      日期: YY/MM/DD

訂單狀態: X - X

訂單日期: XXXXXX - XXXXXX

客戶代碼: XXXXXX - XXXXXX

產品類別: XX - XX

訂單編號: XXXXXX - XXXXXX

產品代碼: XXXXXXXXX - XXXXXXXXX

訂單編號  訂單日期  客戶代碼  客戶名稱              產品代碼    產品名稱            數量    單價     金額     狀態
--------  --------  --------  --------------------  ---------   ----------------  ------  -------  ---------  ----
XXXXXX    YY/MM/DD  XXXXXX    XXXXXXXXXXXXXXXXXXXX  XXXXXXXXX   XXXXXXXXXXXXXXXX  9,999   9,999.99  9,999,999.99  X
XXXXXX    YY/MM/DD  XXXXXX    XXXXXXXXXXXXXXXXXXXX  XXXXXXXXX   XXXXXXXXXXXXXXXX  9,999   9,999.99  9,999,999.99  X
XXXXXX    YY/MM/DD  XXXXXX    XXXXXXXXXXXXXXXXXXXX  XXXXXXXXX   XXXXXXXXXXXXXXXX  9,999   9,999.99  9,999,999.99  X

                                                                      合計金額:  9,999,999.99
```

## 6. 資料檔案說明

### 6.1 WOWCPF（工作訂單主檔）

工作訂單主檔存儲工作訂單的基本資訊。

| 欄位名稱 | 資料類型 | 長度 | 說明 | 範例值 |
|---------|---------|------|------|--------|
| WC01 | 字元 | 6 | 工作訂單編號，主鍵 | 'W00001' |
| WC02 | 數值 | 6,0 | 訂單日期（YYMMDD） | 810215 |
| WC03 | 字元 | 6 | 客戶代碼 | 'C00123' |
| WC04 | 字元 | 20 | 訂單描述 | '設備維修訂單' |
| WC05 | 數值 | 6,0 | 預計完成日期 | 810228 |
| WC06 | 數值 | 6,0 | 實際完成日期 | 810225 |
| WC07 | 字元 | 1 | 訂單狀態（1=新建, 2=處理中, 3=完成, 4=取消） | '2' |
| WC08 | 字元 | 30 | 備註 | '緊急處理' |
| WCXX | 數值 | 6,0 | 建立日期 | 810213 |
| WCYY | 數值 | 6,0 | 建立時間 | 143025 |
| WCZZ | 字元 | 10 | 建立用戶 | 'A1139' |

### 6.2 WOWDPF（工作訂單明細檔）

工作訂單明細檔存儲工作訂單的產品明細資訊。

| 欄位名稱 | 資料類型 | 長度 | 說明 | 範例值 |
|---------|---------|------|------|--------|
| WD01 | 字元 | 6 | 工作訂單編號，主鍵之一 | 'W00001' |
| WD02 | 數值 | 3,0 | 明細序號，主鍵之一 | 1 |
| WD03 | 字元 | 9 | 產品代碼 | 'P00000123' |
| WD04 | 數值 | 5,0 | 數量 | 10 |
| WD05 | 數值 | 7,2 | 單價 | 1250.00 |
| WD06 | 數值 | 9,2 | 金額（數量×單價） | 12500.00 |
| WD07 | 字元 | 20 | 備註 | '標準配置' |
| WDXX | 數值 | 6,0 | 建立日期 | 810213 |
| WDYY | 數值 | 6,0 | 建立時間 | 143025 |
| WDZZ | 字元 | 10 | 建立用戶 | 'A1139' |

### 6.3 CTMAPF（客戶主檔）

客戶主檔存儲客戶的基本資訊。

| 欄位名稱 | 資料類型 | 長度 | 說明 | 範例值 |
|---------|---------|------|------|--------|
| CT01 | 字元 | 6 | 客戶代碼，主鍵 | 'C00123' |
| CT02 | 字元 | 20 | 客戶名稱 | '台灣電子股份有限公司' |
| CT03 | 字元 | 6 | 客戶群組 | 'G001' |
| CT04 | 字元 | 6 | 業務人員代碼 | 'S00123' |
| CT05 | 字元 | 50 | 地址 | '台北市信義區信義路五段7號' |
| CT06 | 字元 | 15 | 電話 | '02-27291999' |
| CT07 | 字元 | 15 | 傳真 | '02-27291998' |
| CTXX | 數值 | 6,0 | 建立日期 | 800615 |
| CTYY | 數值 | 6,0 | 建立時間 | 093045 |
| CTZZ | 字元 | 10 | 建立用戶 | 'A1045' |

## 7. 程式邏輯說明

### 7.1 查詢條件處理

1. **訂單編號範圍處理**：
   - 如果未輸入起始訂單編號，預設為最小值（低值）
   - 如果未輸入結束訂單編號，預設為最大值（高值）
   - 檢查起始訂單編號是否小於等於結束訂單編號

2. **訂單日期範圍處理**：
   - 如果未輸入起始日期，預設為系統日期減去30天
   - 如果未輸入結束日期，預設為系統日期
   - 檢查起始日期是否小於等於結束日期

3. **客戶代碼範圍處理**：
   - 如果未輸入起始客戶代碼，預設為最小值（低值）
   - 如果未輸入結束客戶代碼，預設為最大值（高值）
   - 檢查起始客戶代碼是否小於等於結束客戶代碼

4. **訂單狀態範圍處理**：
   - 如果未輸入起始訂單狀態，預設為'1'（新建）
   - 如果未輸入結束訂單狀態，預設為'4'（取消）
   - 檢查起始訂單狀態是否小於等於結束訂單狀態

5. **產品類別範圍處理**：
   - 如果未輸入起始產品類別，預設為最小值（低值）
   - 如果未輸入結束產品類別，預設為最大值（高值）
   - 檢查起始產品類別是否小於等於結束產品類別

### 7.2 報表產生流程

1. **資料讀取**：
   - 根據查詢條件讀取工作訂單主檔和明細檔
   - 使用工作訂單邏輯檔加速查詢
   - 讀取客戶主檔和產品主檔獲取相關資訊

2. **資料排序**：
   - 按照訂單編號排序
   - 按照明細序號排序

3. **報表產生**：
   - 顯示報表標題和查詢條件
   - 顯示工作訂單基本資訊和明細資訊
   - 計算合計金額

### 7.3 參數傳遞機制

程式使用參數結構傳遞查詢條件給子程式：

```RPG
C           PARM01     DS
C                     PARM           DWE01S   6         起始訂單編號
C                     PARM           DWE01E   6         結束訂單編號
C                     PARM           DWE07S   1         起始訂單狀態
C                     PARM           DWE07E   1         結束訂單狀態
C                     PARM           DWE18S   6         起始客戶代碼
C                     PARM           DWE18E   6         結束客戶代碼
C                     PARM           DWE08S   2         起始產品類別
C                     PARM           DWE08E   2         結束產品類別
C                     PARM           DWE11S   2         起始業務人員
C                     PARM           DWE11E   2         結束業務人員
C                     PARM           DWE10S   6 0       起始訂單日期
C                     PARM           DWE10E   6 0       結束訂單日期
C                     PARM           $PRTID   2         印表機ID
```

## 8. 錯誤處理

### 8.1 輸入驗證錯誤

| 錯誤代碼 | 錯誤訊息 | 處理方式 |
|---------|---------|---------|
| ERR001 | 起始訂單編號不能大於結束訂單編號 | 顯示錯誤訊息，游標定位到起始訂單編號欄位 |
| ERR002 | 起始訂單日期不能大於結束訂單日期 | 顯示錯誤訊息，游標定位到起始訂單日期欄位 |
| ERR003 | 起始客戶代碼不能大於結束客戶代碼 | 顯示錯誤訊息，游標定位到起始客戶代碼欄位 |
| ERR004 | 起始訂單狀態不能大於結束訂單狀態 | 顯示錯誤訊息，游標定位到起始訂單狀態欄位 |
| ERR005 | 起始產品類別不能大於結束產品類別 | 顯示錯誤訊息，游標定位到起始產品類別欄位 |
| ERR006 | 起始業務人員不能大於結束業務人員 | 顯示錯誤訊息，游標定位到起始業務人員欄位 |

### 8.2 報表產生錯誤

| 錯誤代碼 | 錯誤訊息 | 處理方式 |
|---------|---------|---------|
| ERR101 | 無符合條件的資料 | 顯示警告訊息，返回查詢畫面 |
| ERR102 | 報表產生過程中發生錯誤 | 顯示錯誤訊息，記錄錯誤日誌 |

## 9. 程式維護歷史

| 修改日期 | 修改者 | 修改內容 |
|---------|-------|---------|
| 81/02/13 | A1139 JANE | 程式初版建立 |

## 10. 系統整合

WOR100作為工作訂單管理系統的報表程式，與以下系統模組有緊密的整合關係：

1. **工作訂單管理系統**（WOA001）：提供工作訂單資料
2. **客戶管理系統**（CTM000C）：提供客戶資料
3. **產品管理系統**（MTM000C）：提供產品資料
4. **業務人員管理系統**（SAM000C）：提供業務人員資料

## 11. 使用說明

### 11.1 進入程式

從工作訂單管理系統主選單選擇「工作訂單報表」選項進入本程式。

### 11.2 設定查詢條件

1. 在主畫面輸入查詢條件
2. 使用F4功能鍵可以查詢代碼
3. 設定執行方式（1=立即執行、2=批次執行）
4. 按下Enter鍵確認

### 11.3 報表列印

如果執行方式設為立即執行，系統會立即產生報表並列印；如果設為批次執行，系統會提交批次作業，在背景執行報表產生和列印。

## 12. 效能考量

### 12.1 查詢優化

程式在處理大量資料時採取以下優化策略：

1. **條件過濾**：
   - 使用查詢條件縮小資料範圍
   - 減少需要處理的記錄數量

2. **索引使用**：
   - 使用工作訂單邏輯檔的索引
   - 提高檔案讀取效率

### 12.2 報表產生

報表產生過程中的效能考量：

1. **分批處理**：
   - 每次讀取一定數量的記錄
   - 避免一次載入過多資料

2. **記憶體管理**：
   - 適當使用暫存變數
   - 避免不必要的資料複製

## 13. 安全考量

### 13.1 權限控制

程式從LDA獲取使用者ID（$USER），根據使用者的權限控制可執行的操作：

- 只有具有查詢權限的使用者才能執行本程式
- 系統會記錄報表產生的使用者和時間

### 13.2 資料過濾

程式在產生報表時會根據使用者的權限過濾資料：

1. **業務人員限制**：
   - 一般業務人員只能查詢自己負責的客戶訂單
   - 主管可以查詢所有訂單

2. **敏感資料處理**：
   - 根據使用者權限決定是否顯示成本和利潤資訊
   - 限制特定客戶資料的查詢

## 14. 未來擴展建議

### 14.1 功能擴展

1. **報表格式**：
   - 增加更多報表格式選項
   - 支援自定義報表欄位

2. **匯出功能**：
   - 增加將報表匯出為Excel或PDF格式的功能
   - 支援電子郵件發送報表

3. **圖表功能**：
   - 增加工作訂單趨勢圖表
   - 提供視覺化的工作訂單分析

### 14.2 技術改進

1. **使用者介面**：
   - 改善查詢條件輸入界面
   - 增加更多的視覺提示

2. **效能優化**：
   - 優化大量資料處理邏輯
   - 實現更高效的報表產生機制

## 15. 結論

WOR100是西祺企業經營管理資訊系統中工作訂單管理系統的重要報表程式，提供了全面的工作訂單報表功能。它支援多種查詢條件，能夠滿足企業不同層級使用者的需求，為工作訂單分析和決策提供重要依據。

程式採用模組化設計，主程式負責參數處理和報表控制，而實際的報表產生則由子程式完成，確保程式結構清晰、易於維護和擴展。通過嚴格的輸入驗證和權限控制，確保了系統的安全性和資料的準確性。

隨著系統的不斷發展，WOR100可以進一步擴展功能，如增加更多報表格式、支援資料匯出和圖表顯示等，為企業提供更全面、更靈活的工作訂單報表解決方案。 