# SOVRLF02 銷售訂單明細檔規格書

## 1. 基本資訊

| 項目 | 說明 |
|------|------|
| 檔案名稱 | SOVRLF02 |
| 檔案類型 | 邏輯檔案 (Logical File) |
| 檔案用途 | 銷售訂單明細檔 |
| 所屬系統 | 西祺企業管理資訊系統 - 銷售模組 |
| 相關程式 | VTA004, VTR0202, VTR0402 等 |
| 相關檔案 | SOVRPF (銷售訂單主檔) |

## 2. 檔案結構

### 2.1 基本結構

SOVRLF02是一個邏輯檔案，基於實體檔案建立，通過VR0欄位重命名為VRL1。在程式中的定義方式為：

```
FSOVRLF02UF  E           K        DISK
F            VR0                               KRENAMEVRL1
```

這表示SOVRLF02檔案中的VR0欄位被重命名為VRL1，用於存取和操作。

### 2.2 主要欄位定義

根據程式碼分析，SOVRLF02檔案可能包含以下欄位：

| 欄位名稱 | 資料類型 | 長度 | 說明 | 備註 |
|---------|---------|------|------|------|
| VR91 | CHAR | 2 | 客戶類型代碼 | 與SOVRPF相同 |
| VR91L | CHAR | 1 | VR91的第一個字元 | 衍生欄位 |
| VR92 | CHAR | 1 | 辦事處代碼 | 與SOVRPF相同 |
| VR04 | CHAR/DEC | 6 | 訂單日期 (YYMMDD) | 與SOVRPF相同 |
| VR01 | CHAR | 2 | 訂單格式/類型 | 與SOVRPF相同 |
| VR96 | CHAR | 6 | 業務員/使用者代碼 | 與SOVRPF相同 |
| VR97 | DEC | 8,0 | 建檔日期 | 與SOVRPF相同 |

此外，根據VTR0202程式的使用，SOVRLF02可能還包含以下欄位：

| 欄位名稱 | 資料類型 | 長度 | 說明 | 備註 |
|---------|---------|------|------|------|
| VR07 | DEC | 未知 | 付款條件代碼/金額 | 在VTR0202中被加總 |
| VR08 | CHAR | 1 | 稅別代碼 | 在VTR0202中被使用 |
| VR09 | DEC | 未知 | 營業稅 | 在VTR0202中被加總 |
| VR18 | DEC | 未知 | 已付金額 | 在VTR0202中被加總 |

### 2.3 索引結構

根據程式碼分析，SOVRLF02檔案可能有以下索引：

1. **主索引**：
   - 欄位組合：VR91 + VR92 + VR04 + VR96
   - 用途：與SOVRPF主檔關聯，快速查詢特定客戶、辦事處、日期和業務員的訂單明細

2. **次要索引**：
   - 可能包含VR01等欄位
   - 用於特定查詢需求

## 3. 檔案操作

### 3.1 讀取操作

在RPG程式中，SOVRLF02通常被定義為輸入或更新檔案：

```
FSOVRLF02IF  E           K        DISK  // 輸入檔案
FSOVRLF02UF  E           K        DISK  // 更新檔案
```

主要讀取方式：
- 透過CHAIN指令直接存取特定記錄
- 透過SETLL和READE指令循序讀取符合條件的記錄

例如：
```
C           KEYVR1    CHAINVRL1                 41
C           KEYVR1    SETLLVRL1
C           KEYVR1    READEVRL1                     46
```

### 3.2 刪除操作

在VTA004等程式中，可以看到對SOVRLF02檔案（通過VRL1）的刪除操作：

```
C                     DELETVRL1
```

這通常用於刪除訂單明細記錄。

### 3.3 查詢操作

在VTR0202程式中，可以看到對SOVRLF02檔案的查詢操作：

```
C                     READ VR0                      45
C           *IN45     DOWEQ'0'
C           VR91L     IFEQ DVR91
C           VR92      ANDGEDVR92S
C           VR92      ANDLEDVR92E
C           VR04      ANDGEYMD6S
C           VR04      ANDLEYMD6E
C           VR01      ANDLE'38'
C           VR01      ANDGE'31'
C           VR96      ANDGEDVR96S
C           VR96      ANDLEDVR96E
C           VR97      ANDGEYMD97S
C           VR97      ANDLEYMD97E
```

這種查詢方式用於篩選符合特定條件的訂單明細記錄。

## 4. 業務邏輯

### 4.1 與SOVRPF的關係

SOVRLF02作為銷售訂單明細檔，與SOVRPF（銷售訂單主檔）有密切關係：

1. **一對多關係**：
   - 一個SOVRPF記錄（訂單主檔）可以對應多個SOVRLF02記錄（訂單明細）
   - 通過相同的索引欄位（VR91, VR92, VR04, VR96等）關聯

2. **同步操作**：
   - 當刪除SOVRPF記錄時，相關的SOVRLF02記錄也會被刪除
   - 當新增SOVRPF記錄時，可能會同時新增SOVRLF02記錄

### 4.2 資料處理流程

根據VTR0202程式的分析，SOVRLF02檔案在報表生成過程中的使用流程：

1. **資料讀取**：
   - 讀取SOVRLF02中的訂單明細記錄
   - 根據條件（客戶類型、辦事處、日期範圍等）篩選記錄

2. **資料處理**：
   - 將符合條件的記錄寫入工作檔案（REWFD2, REWFD3）
   - 對金額欄位（VR07, VR09, VR18）進行加總

3. **報表生成**：
   - 基於處理後的資料生成報表

## 5. 系統整合

### 5.1 與其他檔案的關聯

| 關聯檔案 | 關聯欄位 | 關聯類型 | 說明 |
|---------|---------|---------|------|
| SOVRPF | VR91, VR92, VR04, VR96 | 多對一 | 訂單明細對應訂單主檔 |
| REWFD2 | 未知 | 未知 | 報表工作檔案 |
| REWFD3 | 未知 | 未知 | 報表工作檔案 |

### 5.2 與其他模組的整合

1. **訂單管理模組**：
   - 透過VTA004等程式維護訂單明細資料

2. **報表模組**：
   - 透過VTR0202, VTR0402等程式生成訂單明細報表

## 6. 程式使用情況

### 6.1 主要使用程式

| 程式名稱 | 程式類型 | 主要功能 |
|---------|---------|---------|
| VTA004 | RPG | 銷售訂單維護主程式，包含訂單明細維護 |
| VTR0202 | RPG | 銷售訂單明細報表程式 |
| VTR0402 | RPG | 銷售訂單明細報表程式 |

### 6.2 程式使用方式

**VTA004 程式**：
- 定義SOVRLF02為更新檔案（UF）
- 使用鍵值列表KEYVR1進行檔案存取
- 透過CHAIN, SETLL, READE, DELET等操作維護訂單明細

**VTR0202 程式**：
- 定義SOVRLF02為輸入檔案（IF）
- 讀取訂單明細記錄並根據條件篩選
- 將處理後的資料寫入工作檔案

## 7. 資料安全與存取控制

### 7.1 共享設定

在多數程式中，SOVRLF02檔案可能設定為共享模式，允許多個程式同時存取檔案。

### 7.2 存取權限

根據程式碼分析，可能的存取權限控制：
- 透過使用者代碼(VR96)控制資料存取權限
- 可能有功能權限控制（如$ADD, $UPD, $DLT, $INQ）

## 8. 效能考量

### 8.1 索引使用

- 主索引用於直接存取特定訂單明細
- 在循序讀取時使用SETLL和READE操作

### 8.2 查詢優化

- 在VTR0202程式中，使用多個條件篩選記錄，可能需要優化查詢效能

## 9. 維護與擴展建議

### 9.1 潛在改進

1. **欄位標準化**：
   - 考慮將欄位定義標準化，確保與SOVRPF一致

2. **索引優化**：
   - 根據常用查詢條件，可能需要增加次要索引

3. **程式整合**：
   - 考慮整合相似功能的程式，減少重複代碼

### 9.2 擴展方向

1. **Web介面整合**：
   - 開發Web介面存取SOVRLF02資料

2. **報表功能強化**：
   - 增加更多分析報表功能

3. **與現代系統整合**：
   - 開發API允許現代系統存取SOVRLF02資料

## 10. 結論

SOVRLF02作為西祺企業管理資訊系統中的銷售訂單明細檔，扮演著重要角色。它儲存了所有銷售訂單的明細資訊，並與SOVRPF主檔緊密關聯。透過本規格書的詳細說明，可以更全面地了解SOVRLF02的結構、功能和使用方式，為系統維護和未來擴展提供參考。