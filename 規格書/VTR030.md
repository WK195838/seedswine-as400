# VTR030 銷售統計報表程式規格說明書

## 1. 基本資訊

- **程式名稱**：VTR030
- **程式類型**：RPG程式
- **程式庫**：REPLIB
- **功能說明**：銷售統計報表 - 同期比較
- **相關檔案**：
  - VTR030D（顯示檔案）
  - VTR030P1（印表檔案）
  - VTR0301（子程式 - 產生工作檔）
  - VTR0304（子程式 - 產生報表）
- **系統名稱**：西祺企業經營管理資訊系統
- **子系統**：銷售統計
- **作者**：MICHELLE
- **建立日期**：10/15/02
- **修改日期**：未指定
- **備註**：銷售統計報表列印 - 同期比較

## 2. 程式概述

VTR030是西祺企業經營管理資訊系統中銷售統計模組的重要報表程式，專門用於產生銷售同期比較報表。此程式允許使用者根據不同的條件（如銷售類型、客戶群組、年月範圍等）產生銷售同期比較報表，以便管理者分析不同時期的銷售趨勢和變化。

程式採用模組化設計，主程式負責處理用戶輸入的查詢條件，子程式負責實際的報表產生，確保程式結構清晰、易於維護和擴展。報表提供了詳細的銷售資料比較，包括銷售金額、數量、毛利等指標，並計算同期增長率，為管理決策提供重要依據。

## 3. 程式流程

### 3.1 流程圖

```
開始
  |
  v
初始化畫面
  |
  v
顯示查詢條件畫面
  |
  v
使用者輸入查詢條件
  |
  v
驗證查詢條件
  |
  v
呼叫VTR0301產生工作檔
  |
  v
呼叫VTR0304產生報表
  |
  v
結束
```

### 3.2 初始化階段

```RPG
C           RTN010    BEGSR
C                     IN   LDA
C                     MOVEL$USER     AUT     3
C                     MOVE *BLANK    DVQ91
C                     MOVE *BLANK    DVQ92S
C                     MOVE *BLANK    DVQ92E
C                     MOVE *BLANK    DVQ92
C                     MOVE *BLANK    CMPS
C                     MOVE *BLANK    CMPE
C                     Z-ADD0         DVQ04S
C                     Z-ADD0         DVQ04E
C                     ENDSR
```

初始化階段主要完成以下工作：
1. 讀取LDA（Local Data Area）資料
2. 設置使用者權限
3. 初始化查詢條件欄位
4. 設置預設值

### 3.3 查詢條件處理

程式提供多種查詢條件，包括：
1. 銷售類型（國內/外銷）
2. 客戶群組範圍
3. 年月範圍（起始年月/結束年月）
4. 比較方式（同月比較/累計比較）

使用者可以根據需要填寫一個或多個條件，系統會根據這些條件組合產生相應的銷售同期比較報表。

### 3.4 報表產生流程

當使用者輸入查詢條件並按下確認鍵後，程式會執行以下步驟：
1. 驗證查詢條件的有效性
2. 呼叫VTR0301子程式，根據查詢條件從銷售資料檔中讀取符合的記錄，產生工作檔
3. 呼叫VTR0304子程式，讀取工作檔並產生銷售同期比較報表
4. 顯示報表產生完成訊息

## 4. 畫面說明

### 4.1 查詢條件畫面（SCR001）

查詢條件畫面包含以下主要欄位：
- 銷售類型（國內/外銷）
- 客戶群組範圍（起始/結束）
- 年月範圍（起始年月/結束年月）
- 比較方式（同月比較/累計比較）

功能鍵：
- F3：退出
- F4：提示（用於選擇客戶群組）
- Enter：執行報表產生

## 5. 資料檔案說明

程式使用以下主要資料檔案：

### 5.1 SOVQLF02（銷售統計檔）

包含銷售統計資料，是產生報表的主要資料來源。

主要欄位：
- VQ91：銷售類型（1=國內、2=外銷）
- VQ92：客戶群組
- VQ04：年月（YYMM格式）
- VQ01：資料類型
- VQ05：銷售金額
- VQ06：銷售數量
- VQ07：銷售成本
- VQ08：毛利

### 5.2 REWFD6（工作檔）

由VTR0301子程式產生的暫存工作檔，用於存儲符合查詢條件的銷售資料。

主要欄位：
- WF01：銷售類型
- WF02：客戶群組
- WF03：年月
- WF04：銷售金額
- WF05：銷售數量
- WF06：銷售成本
- WF07：毛利
- WF08：比較年月
- WF09：比較銷售金額
- WF10：比較銷售數量
- WF11：比較銷售成本
- WF12：比較毛利
- WF13：銷售金額增長率
- WF14：銷售數量增長率
- WF15：毛利增長率

## 6. 程式邏輯

### 6.1 查詢條件處理邏輯

1. 當使用者未輸入特定範圍的起始值時，系統自動設置為最小值
2. 當使用者未輸入特定範圍的結束值時，系統自動設置為最大值
3. 系統檢查起始值不得大於結束值
4. 當使用者未選擇銷售類型時，系統預設查詢所有類型

```RPG
C           RTN100    BEGSR
C           DVQ92S    IFEQ *BLANKS
C                     MOVE *LOVAL    DVQ92S
C                     END
C           DVQ92E    IFEQ *BLANKS
C                     MOVE *HIVAL    DVQ92E
C                     END
C           DVQ92S    IFGT DVQ92E
C                     SETON                     666799
C                     END
C                     ENDSR
```

### 6.2 工作檔產生邏輯（VTR0301）

1. 根據使用者輸入的條件從SOVQLF02檔案中讀取符合的銷售資料
2. 對於每筆符合條件的記錄，寫入REWFD6工作檔
3. 根據比較方式（同月比較/累計比較），計算比較期間的資料

### 6.3 報表產生邏輯（VTR0304）

1. 讀取REWFD6工作檔中的資料
2. 根據銷售類型、客戶群組和年月進行排序
3. 計算同期比較的增長率
4. 產生報表，包括標題、明細和合計

## 7. 錯誤處理

程式包含以下錯誤處理機制：

1. **無效的查詢條件**：
   - 當起始值大於結束值時，系統顯示錯誤訊息並要求使用者修正
   - 當年月格式不正確時，系統顯示錯誤訊息

2. **查詢結果為空**：
   - 當沒有符合條件的記錄時，系統顯示「無符合條件的記錄」訊息

3. **系統錯誤**：
   - 當發生系統錯誤時，程式顯示錯誤代碼和訊息，並記錄錯誤日誌

## 8. 維護歷史

| 日期 | 作者 | 修改內容 |
|------|------|----------|
| 10/15/02 | MICHELLE | 程式建立 |

## 9. 系統整合

VTR030程式與以下系統或模組整合：

1. **銷售統計模組**：
   - 與其他銷售統計報表程式（如VTR010、VTR020）整合，提供完整的銷售分析功能
   - 與銷售資料收集程式整合，確保報表資料的準確性和及時性

2. **銷售訂單模組**：
   - 與銷售訂單管理程式整合，使用銷售訂單資料產生統計報表

3. **客戶管理模組**：
   - 與客戶管理程式整合，使用客戶群組資訊進行銷售分析

## 10. 使用說明

### 10.1 程式調用

程式可以通過以下方式調用：
1. 從銷售統計主選單選擇「銷售同期比較報表」選項
2. 直接執行命令：CALL VTR030

### 10.2 產生報表

1. 在查詢條件畫面輸入所需的查詢條件
   - 選擇銷售類型（國內/外銷）
   - 輸入客戶群組範圍
   - 輸入年月範圍
   - 選擇比較方式（同月比較/累計比較）
2. 按Enter鍵執行報表產生
3. 系統顯示報表產生完成訊息

### 10.3 查看報表

報表產生後，可以通過以下方式查看：
1. 使用WRKOUTQ命令查看輸出佇列
2. 使用DSPSPLF命令查看特定的報表檔案

### 10.4 退出程式

在任何畫面按F3鍵退出程式

## 11. 效能考量

1. **查詢效率**：
   - 程式使用索引鍵進行查詢，確保查詢效率
   - 使用工作檔存儲中間結果，減少重複計算

2. **記憶體使用**：
   - 程式使用工作檔存儲查詢結果，避免過度佔用記憶體
   - 報表產生過程中分批處理資料，減少記憶體使用

3. **報表產生時間**：
   - 一般報表產生時間控制在5分鐘以內
   - 大量資料的報表可能需要更長時間

## 12. 安全考量

1. **權限控制**：
   - 程式檢查使用者權限，只有具有適當權限的使用者才能執行報表產生
   - 特定報表（如含成本資訊的報表）可能需要額外權限

2. **資料保護**：
   - 程式只處理使用者有權查看的銷售資料
   - 敏感資訊（如成本資料）只對有權限的使用者顯示

3. **審計追蹤**：
   - 系統記錄報表產生操作，包括查詢條件和時間
   - 管理者可以查看報表產生日誌

## 13. 未來擴展建議

1. **增加比較維度**：
   - 增加更多比較維度，如產品類別、業務員等
   - 支援多期間比較（如三年比較）

2. **圖形化顯示**：
   - 增加銷售趨勢的圖形化顯示
   - 提供銷售同期比較的圖表

3. **資料匯出**：
   - 增加報表資料匯出功能，支援CSV、Excel等格式
   - 提供電子郵件發送功能

4. **線上查詢**：
   - 增加線上查詢功能，允許使用者在畫面上直接查看比較結果
   - 提供互動式查詢和分析功能

## 14. 結論

VTR030銷售統計報表程式是西祺企業經營管理資訊系統中銷售統計模組的重要組成部分，提供了全面的銷售同期比較分析功能。程式設計靈活，允許使用者根據不同的條件產生客製化的銷售同期比較報表，為管理者提供重要的決策依據。

通過比較不同時期的銷售資料，管理者可以清楚地了解銷售趨勢和變化，識別潛在的問題和機會，制定更有效的銷售策略。隨著系統的不斷發展，VTR030可以進一步擴展功能，提供更全面、更靈活的銷售分析解決方案。 