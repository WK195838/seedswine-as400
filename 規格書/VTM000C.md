# VTM000C 程式規格書

## 1. 基本資訊

- **程式名稱**：VTM000C
- **程式類型**：CL程式（控制語言程式）
- **程式庫**：REPLIB
- **功能描述**：銷貨交易管理系統主選單控制程式
- **相關檔案**：VTM000D（顯示檔案）
- **系統名稱**：西祺企業經營管理資訊系統
- **子系統**：銷貨交易管理系統
- **作者**：ROGER CHIEN
- **建立日期**：81/05/15
- **最後修改日期**：94/06/06
- **程式說明**：銷貨交易管理系統主選單，提供使用者進入各銷貨交易子功能的統一入口

## 2. 程式概述

VTM000C是西祺企業經營管理資訊系統中銷貨交易管理系統的主選單控制程式。此程式負責顯示銷貨交易管理系統的主選單介面，處理使用者的選擇，檢查使用者權限，並呼叫相應的銷貨交易功能模組程式。它是銷貨交易管理系統的中央控制點，提供了一個統一的入口點來訪問所有銷貨交易相關功能。

銷貨交易管理系統是企業資訊系統的核心業務組成部分，負責管理企業的銷售交易流程，包括銷售訂單處理、出貨管理、銷售發票處理、銷售退貨處理等功能。它與庫存管理系統、應收帳款系統等緊密相連，確保企業銷售業務的順利進行。

VTM000C作為銷貨交易管理系統的入口，其設計遵循了AS/400系統的標準程式設計規範，採用模組化結構，確保系統的可維護性和擴展性。

## 3. 程式流程詳解

### 3.1 主要流程圖

```
開始
  |
  ↓
宣告變數和檔案
  |
  ↓
初始化系統環境
  |
  ↓
START: 顯示主選單
  |
  ↓
處理使用者選擇
  |
  ↓
檢查使用者權限
  |
  ↓
呼叫相應功能模組
  |
  ↓
返回主選單或結束程式
```

### 3.2 詳細流程說明

#### 3.2.1 初始化階段

```CL
PGM
DCL VAR(&WDATE) TYPE(*CHAR) LEN(6)
DCL VAR(&$USER) TYPE(*CHAR) LEN(10)
DCL VAR(&S0101I) TYPE(*CHAR) LEN(10)
DCL VAR(&S0102I) TYPE(*CHAR) LEN(10)
DCL VAR(&S0101O) TYPE(*CHAR) LEN(1)
DCL VAR(&EGMDY) TYPE(*CHAR) LEN(8)
```

1. **變數宣告**：
   - `&WDATE`：系統日期變數，格式為YYMMDD，長度6字元
   - `&$USER`：使用者ID變數，長度10字元
   - `&S0101I`、`&S0102I`、`&S0101O`：權限檢查參數變數
   - `&EGMDY`：顯示日期變數，格式為MM/DD/YY，長度8字元

2. **系統環境初始化**：
   ```CL
   RTVDTAARA DTAARA(QTEMP/LDA (101 10)) RTNVAR(&$USER)
   RTVDTAARA DTAARA(QTEMP/LDA (119 6)) RTNVAR(&WDATE)
   CHGVAR VAR(&EGMDY) VALUE(%SST(&WDATE 3 2) *CAT '/' *CAT %SST(&WDATE 5 2) *CAT '/' *CAT %SST(&WDATE 1 2))
   CHGVAR VAR(&S0101I) VALUE(&$USER)
   ```
   - 從LDA(Local Data Area)獲取使用者ID和系統日期
   - 格式化日期顯示格式
   - 設定權限檢查使用者ID參數

#### 3.2.2 主選單顯示與處理

```CL
START:
SNDRCVF RCDFMT(DSPC1)
CHGVAR VAR(&IN98) VALUE('0')
CHGVAR VAR(&IN97) VALUE('0')
IF (&IN03 = '1') GOTO ENDLBL
```

1. **顯示主選單**：
   - 使用SNDRCVF命令發送/接收顯示檔案VTM000D的DSPC1格式
   - 重設錯誤指示器IN98和IN97
   - 檢查F3鍵是否按下，如果是則跳轉到ENDLBL標籤結束程式

2. **處理使用者選擇**：
   ```CL
   IF (&DOPID = '1') DO
     CHGVAR VAR(&S0102I) VALUE('VTA001')
     GOTO CHKAUT
   ENDDO
   IF (&DOPID = '2') DO
     CHGVAR VAR(&S0102I) VALUE('VTA002')
     GOTO CHKAUT
   ENDDO
   /* 其他選項處理... */
   ```
   - 根據使用者選擇的選項代碼DOPID，設定對應的程式名稱到&S0102I變數
   - 跳轉到CHKAUT標籤進行權限檢查

#### 3.2.3 權限檢查與程式呼叫

```CL
CHKAUT:
CALL PGM(S#S01) PARM(&S0101I &S0102I &S0101O)
IF (&S0101O = 'N') DO
  CHGVAR VAR(&IN98) VALUE('1')
  GOTO START
ENDDO
```

1. **權限檢查**：
   - 呼叫S#S01程式檢查使用者是否有權限執行所選功能
   - 如果沒有權限(&S0101O = 'N')，設定錯誤指示器IN98並返回主選單

2. **程式呼叫**：
   ```CL
   IF (&DOPID = '1') CALL PGM(VTA001)
   IF (&DOPID = '2') CALL PGM(VTA002)
   /* 其他程式呼叫... */
   ```
   - 根據使用者選擇的選項，呼叫相應的功能模組程式
   - 程式執行完畢後返回主選單

#### 3.2.4 程式結束

```CL
GOTO START
ENDLBL:
ENDPGM
```
- 處理完使用者選擇後，返回START標籤繼續顯示主選單
- 當使用者按下F3鍵時，跳轉到ENDLBL標籤結束程式

## 4. 選單選項說明

| 選項代碼 | 功能描述 | 呼叫程式 | 功能說明 |
|---------|---------|---------|---------|
| 1 | 銷貨交易資料維護 | VTA001 | 維護銷貨交易基本資料 |
| 2 | 銷貨交易處理 | VTA002 | 處理日常銷貨交易 |
| 3 | 銷貨退回處理 | VTA003 | 處理銷貨退回交易 |
| 4 | 銷貨發票處理 | VTA004 | 處理銷貨發票 |
| 5 | 銷貨交易查詢 | VTB001 | 查詢銷貨交易資料 |
| 6 | 銷貨交易報表 | VTR001 | 產生銷貨交易報表 |
| 7 | 銷貨交易分析 | VTI001 | 分析銷貨交易數據 |
| 8 | 銷貨交易系統維護 | VTM001 | 維護銷貨交易系統參數 |

## 5. 相關檔案與資源

### 5.1 顯示檔案

**VTM000D**：銷貨交易管理系統主選單顯示檔案
- 格式：DSPC1（主選單格式）
- 主要欄位：
  - DOPID：選項代碼，長度1字元
  - EGMDY：顯示日期，長度8字元
  - $USER：使用者ID，長度10字元

### 5.2 相關程式

| 程式名稱 | 程式類型 | 功能描述 |
|---------|---------|---------|
| VTA001 | RPG程式 | 銷貨交易資料維護程式 |
| VTA002 | RPG程式 | 銷貨交易處理程式 |
| VTA003 | RPG程式 | 銷貨退回處理程式 |
| VTA004 | RPG程式 | 銷貨發票處理程式 |
| VTB001 | RPG程式 | 銷貨交易查詢程式 |
| VTR001 | RPG程式 | 銷貨交易報表程式 |
| VTI001 | RPG程式 | 銷貨交易分析程式 |
| VTM001 | RPG程式 | 銷貨交易系統維護程式 |
| S#S01 | RPG程式 | 系統權限檢查程式 |

### 5.3 資料區域

**LDA**（Local Data Area）：用於存儲使用者ID和系統日期等資訊
- 位置101-110：使用者ID
- 位置119-124：系統日期（YYMMDD格式）

## 6. 錯誤處理

| 錯誤指示器 | 錯誤描述 | 處理方式 |
|-----------|---------|---------|
| IN98 | 使用者權限不足 | 顯示錯誤訊息並返回主選單 |
| IN97 | 選項輸入錯誤 | 顯示錯誤訊息並返回主選單 |
| IN03 | 使用者按下F3鍵 | 結束程式 |

## 7. 程式維護歷史

| 修改日期 | 修改者 | 修改內容 |
|---------|-------|---------|
| 81/05/15 | ROGER CHIEN | 程式初版建立 |
| 85/03/20 | DAVID LEE | 新增銷貨退回處理功能 |
| 88/11/05 | MICHAEL WANG | 新增銷貨交易分析功能 |
| 92/08/12 | JENNY CHEN | 修改權限檢查機制 |
| 94/06/06 | KEVIN LIN | 更新選單界面和錯誤處理 |

## 8. 使用說明

1. 從系統主選單選擇「銷貨交易管理」選項進入本選單
2. 輸入選項代碼（1-8）選擇相應功能
3. 系統會檢查使用者權限，如果權限不足，將顯示錯誤訊息
4. 功能執行完畢後，系統會返回本選單
5. 按F3鍵可返回上一層選單

## 9. 系統整合

VTM000C作為銷貨交易管理系統的入口點，與以下系統模組有緊密的整合關係：

1. **庫存管理系統**（IMM000C）：銷貨交易會影響庫存水平
2. **應收帳款系統**（ARM000C）：銷貨交易會產生應收帳款
3. **客戶管理系統**（CUM000C）：銷貨交易涉及客戶資料
4. **產品管理系統**（PRM000C）：銷貨交易涉及產品資料
5. **權限管理系統**（S#S01）：控制使用者對銷貨交易功能的訪問權限

## 10. 系統參數設定

銷貨交易管理系統的參數設定存儲在VTPARM檔案中，可通過VTM001程式進行維護。主要參數包括：

1. **銷貨交易編號規則**：定義銷貨交易編號的生成規則
2. **銷貨發票編號規則**：定義銷貨發票編號的生成規則
3. **銷貨退回編號規則**：定義銷貨退回編號的生成規則
4. **預設稅率**：系統預設的銷售稅率
5. **折扣規則**：銷售折扣的計算規則
6. **庫存更新方式**：銷貨交易如何更新庫存（即時/批次）
7. **應收帳款更新方式**：銷貨交易如何更新應收帳款（即時/批次）

以上參數可根據企業實際業務需求進行調整，以確保銷貨交易管理系統的靈活性和適應性。