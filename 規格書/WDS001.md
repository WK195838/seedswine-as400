# WDS001 產品代碼提示查詢程式規格說明書

## 1. 基本資訊

- **程式名稱**：WDS001
- **程式類型**：RPG程式
- **程式庫**：REPLIB
- **功能描述**：產品代碼資料提示查詢程式（視窗式）
- **相關檔案**：
  - WDS001D（顯示檔案）
  - MTMAPF（產品主檔）
- **系統名稱**：西祺企業經營管理資訊系統
- **子系統**：系統共用工具模組
- **作者**：A1034 STEPHANIE
- **建立日期**：81/01/16
- **最後修改日期**：未明確標示
- **程式說明**：提供產品代碼的視窗式查詢功能，供其他程式呼叫使用

## 2. 程式概述

WDS001是西祺企業經營管理資訊系統中的一個共用工具程式，主要功能是提供產品代碼的視窗式查詢功能。當使用者在系統中需要輸入產品代碼時，可以透過按下F4功能鍵呼叫此程式，以視窗方式顯示產品清單，讓使用者選擇所需的產品，而不需要記憶產品代碼。

此程式採用視窗式設計，在不離開原程式的情況下，以彈出視窗的方式顯示產品清單，使用者可以透過上下翻頁瀏覽產品資料，並透過選項代碼選擇所需的產品。選擇完成後，程式會將選定的產品代碼返回給呼叫程式，實現無縫的整合。

WDS001是系統中重要的共用工具程式之一，被多個子系統的程式所呼叫使用，提高了系統的易用性和資料輸入的準確性。

## 3. 程式流程詳解

### 3.1 主要流程圖

```
開始
  |
  ↓
接收參數
  |
  ↓
初始化變數
  |
  ↓
顯示產品清單視窗
  |
  ↓
處理使用者選擇
  |   ↙        ↓        ↘
選擇產品    翻頁瀏覽    取消操作
  |            |           |
  ↓            |           |
返回產品代碼   |           |
  |            |           |
  ↘          ↓          ↙
       結束程式
```

### 3.2 詳細流程說明

#### 3.2.1 初始化階段

```RPG
FMTMAPF  IF  E           K        DISK
FWDS001D CF  E                    WORKSTN

C           *ENTRY    PLIST
C                     PARM           S001O1  9        產品代碼
```

1. **檔案宣告**：
   - `MTMAPF`：產品主檔，輸入模式
   - `WDS001D`：顯示檔案，工作站模式

2. **參數宣告**：
   - `S001O1`：輸出參數，長度9字元，用於返回選定的產品代碼

3. **資料結構定義**：
   ```RPG
   IWOP0        DS
   I                                        1   8 W01
   I                                        1   1 D1011
   I                                        2   2 D1021
   ...
   IWD0         DS
   I                                        1 352 W02
   I                                        1  44 D1012
   I                                       45  88 D1022
   ...
   ```
   - 定義操作代碼和顯示資料的資料結構
   - 用於處理視窗中的多筆資料顯示

#### 3.2.2 主程式流程

1. **初始化變數**：
   ```RPG
   C                     MOVE *BLANKS   S001O1
   C                     Z-ADD0         HRRN1   40
   C                     Z-ADD0         DRRN1   40
   C                     Z-ADD0         SFLSIZ  40
   C                     Z-ADD0         SFLPAG  40
   ```
   - 初始化輸出參數和子檔控制變數

2. **設定視窗參數**：
   ```RPG
   C                     Z-ADD8         SFLSIZ
   C                     Z-ADD8         SFLPAG
   C                     MOVE *ON       *IN50
   C                     MOVE *ON       *IN51
   ```
   - 設定視窗大小和控制指示器

3. **讀取產品資料**：
   ```RPG
   C                     EXSR LOADPF
   ```
   - 呼叫LOADPF子程序讀取產品主檔資料

4. **顯示視窗**：
   ```RPG
   C                     EXSR DSPSFL
   ```
   - 呼叫DSPSFL子程序顯示產品清單視窗

#### 3.2.3 子程序說明

1. **LOADPF子程序**：
   ```RPG
   C           LOADPF    BEGSR
   C                     Z-ADD0         HRRN1
   C           *LOVAL    SETLLMA01
   C                     READ MA01                    97
   C           *IN97     DOWEQ*OFF
   C                     ADD  1         HRRN1
   C                     MOVE MA01      D1012
   C                     MOVE MA03      D1022
   C                     MOVE MA06      D1032
   C                     MOVE D1012     WTEMP
   C                     WRITE SFLSR1
   C                     READ MA01                    97
   C                     ENDDO
   C                     ENDSR
   ```
   - 從產品主檔讀取資料
   - 將資料寫入子檔記錄
   - 計算總記錄數

2. **DSPSFL子程序**：
   ```RPG
   C           DSPSFL    BEGSR
   C                     MOVE *ON       *IN52
   C                     WRITE SFLCR1
   C                     MOVE *OFF      *IN52
   C                     EXFMTSFLCR1
   C                     ENDSR
   ```
   - 顯示子檔控制記錄
   - 等待使用者輸入

3. **SELRCD子程序**：
   ```RPG
   C           SELRCD    BEGSR
   C                     READCSFLSR1                  97
   C           *IN97     IFEQ *OFF
   C           DOPT1     IFEQ '1'
   C                     MOVE D1012     S001O1
   C                     MOVE *ON       *INLR
   C                     ENDIF
   C                     ENDIF
   C                     ENDSR
   ```
   - 處理使用者選擇
   - 如果使用者選擇了產品，將產品代碼移至輸出參數
   - 設定結束指示器

#### 3.2.4 功能鍵處理

```RPG
C                     IF        *IN03 = *ON
C                     MOVE *ON       *INLR
C                     ENDIF
C                     IF        *IN25 = *ON
C                     EXSR PGDOWN
C                     ENDIF
C                     IF        *IN26 = *ON
C                     EXSR PGUP
C                     ENDIF
```
- F3：結束程式
- ROLL UP：向下翻頁
- ROLL DOWN：向上翻頁

## 4. 畫面說明

### 4.1 主視窗（DSPC1）

主視窗採用視窗式設計，顯示產品清單，並提供選項欄位讓使用者選擇產品。

```
+--------------------------------------------------+
|                                                  |
|  產品代碼                                        |
|                                                  |
|  OP : 1-選擇                                     |
|                                                  |
|  OP 產品代碼  產品名稱            產品規格       |
|  _ XXXXXXXX  XXXXXXXXXXXX        XXXXXXXX       |
|  _ XXXXXXXX  XXXXXXXXXXXX        XXXXXXXX       |
|  _ XXXXXXXX  XXXXXXXXXXXX        XXXXXXXX       |
|  _ XXXXXXXX  XXXXXXXXXXXX        XXXXXXXX       |
|  _ XXXXXXXX  XXXXXXXXXXXX        XXXXXXXX       |
|  _ XXXXXXXX  XXXXXXXXXXXX        XXXXXXXX       |
|  _ XXXXXXXX  XXXXXXXXXXXX        XXXXXXXX       |
|  _ XXXXXXXX  XXXXXXXXXXXX        XXXXXXXX       |
|                                                  |
|  F3=結束 ROLL=翻頁                               |
+--------------------------------------------------+
```

### 4.2 功能鍵說明

| 功能鍵 | 功能描述 | 處理子程序 |
|--------|---------|-----------|
| F3 | 結束程式 | 返回呼叫程式 |
| ROLL UP | 向下翻頁 | PGDOWN |
| ROLL DOWN | 向上翻頁 | PGUP |

## 5. 資料檔案說明

### 5.1 MTMAPF（產品主檔）

產品主檔存儲產品的基本資訊。

| 欄位名稱 | 資料類型 | 長度 | 說明 | 範例值 |
|---------|---------|------|------|--------|
| MA01 | 字元 | 9 | 產品代碼，主鍵 | 'P00000123' |
| MA02 | 字元 | 1 | 產品類型 | '1' |
| MA03 | 字元 | 18 | 產品名稱 | '電動馬達' |
| MA04 | 數值 | 7,2 | 標準單價 | 1250.00 |
| MA05 | 字元 | 6 | 庫存單位 | '個' |
| MA06 | 字元 | 15 | 產品規格 | '220V/1HP' |
| MAXX | 數值 | 6,0 | 建立日期 | 810116 |
| MAYY | 數值 | 6,0 | 建立時間 | 093045 |
| MAZZ | 字元 | 10 | 建立用戶 | 'A1034' |

## 6. 程式邏輯說明

### 6.1 參數傳遞機制

WDS001程式採用參數傳遞機制與呼叫程式進行資料交換：

1. **輸出參數**：
   - `S001O1`：長度9字元，用於返回選定的產品代碼

2. **參數處理流程**：
   - 程式初始化時，將輸出參數設為空白
   - 當使用者選擇產品時，將選定的產品代碼移至輸出參數
   - 程式結束時，呼叫程式可以獲取輸出參數的值

### 6.2 視窗顯示機制

程式採用視窗式設計，在不離開原程式的情況下顯示產品清單：

1. **視窗控制**：
   - 使用DSPATR(RI)屬性繪製視窗邊框
   - 使用OVERLAY關鍵字確保視窗覆蓋在原畫面上

2. **資料顯示**：
   - 使用子檔技術顯示多筆產品資料
   - 每頁顯示8筆記錄
   - 支援上下翻頁功能

### 6.3 選擇處理機制

使用者可以透過輸入選項代碼選擇產品：

1. **選項代碼**：
   - `1`：選擇產品

2. **選擇處理流程**：
   - 使用者輸入選項代碼後按Enter
   - 程式讀取子檔記錄，檢查選項代碼
   - 如果選項代碼為'1'，將選定的產品代碼移至輸出參數
   - 設定結束指示器，返回呼叫程式

## 7. 錯誤處理

### 7.1 資料檢查

程式在顯示產品清單時進行以下檢查：

1. **空檔案檢查**：
   - 如果產品主檔為空，顯示「無資料」訊息
   - 設定指示器*IN53，控制「無資料」訊息的顯示

2. **翻頁檢查**：
   - 檢查是否已到達檔案的開頭或結尾
   - 如果已到達檔案開頭，禁止向上翻頁
   - 如果已到達檔案結尾，禁止向下翻頁

### 7.2 異常處理

程式處理以下異常情況：

1. **檔案錯誤**：
   - 如果讀取產品主檔時發生錯誤，設定指示器*IN97
   - 顯示「檔案讀取錯誤」訊息

2. **取消操作**：
   - 使用者可以按F3鍵取消操作
   - 程式將輸出參數保持為空白，並返回呼叫程式

## 8. 程式維護歷史

| 修改日期 | 修改者 | 修改內容 |
|---------|-------|---------|
| 81/01/16 | A1034 STEPHANIE | 程式初版建立 |
| 81/01/30 | A1139 JANE | 顯示檔案初版建立 |
| 81/05/05 | JOYCE | 顯示檔案更新 |

## 9. 系統整合

WDS001作為系統共用工具程式，被多個子系統的程式所呼叫使用：

1. **工作訂單管理系統**：
   - WOA001、WOA1001-WOA1005等程式在輸入產品代碼時呼叫WDS001

2. **銷貨交易管理系統**：
   - VTA001-VTA004等程式在輸入產品代碼時呼叫WDS001

3. **庫存管理系統**：
   - IMA001-IMA005等程式在輸入產品代碼時呼叫WDS001

4. **採購管理系統**：
   - PUA001-PUA005等程式在輸入產品代碼時呼叫WDS001

## 10. 使用說明

### 10.1 呼叫方式

其他程式可以透過以下方式呼叫WDS001：

```RPG
C                     CALL 'WDS001'
C                     PARM           PRODCD   9
```

### 10.2 使用流程

1. 使用者在需要輸入產品代碼的欄位按下F4功能鍵
2. 系統呼叫WDS001程式，顯示產品清單視窗
3. 使用者可以使用ROLL UP/ROLL DOWN鍵翻頁瀏覽產品清單
4. 使用者在所需產品前輸入選項'1'，然後按Enter
5. 系統將選定的產品代碼返回給呼叫程式
6. 呼叫程式將產品代碼填入相應欄位

### 10.3 取消操作

使用者可以按F3鍵取消操作，系統將返回呼叫程式，不返回任何產品代碼。

## 11. 效能考量

### 11.1 資料讀取

程式在顯示產品清單時，一次讀取多筆記錄，提高效能：

1. **批次讀取**：
   - 一次讀取足夠填滿一頁的記錄
   - 減少檔案存取次數

2. **鍵值存取**：
   - 使用鍵值存取方式讀取產品主檔
   - 提高檔案讀取效率

### 11.2 記憶體使用

程式使用子檔技術顯示產品清單，記憶體使用效率高：

1. **子檔緩衝區**：
   - 只保存當前頁面的記錄
   - 減少記憶體使用量

2. **變數重用**：
   - 重用變數和資料結構
   - 減少記憶體佔用

## 12. 安全考量

### 12.1 資料存取

程式只讀取產品主檔，不進行修改操作，安全性較高：

1. **唯讀存取**：
   - 產品主檔以唯讀模式開啟
   - 防止意外修改資料

2. **資料過濾**：
   - 只顯示必要的產品資訊
   - 不顯示敏感資料（如成本價格）

## 13. 未來擴展建議

### 13.1 功能擴展

1. **搜尋功能**：
   - 增加按產品代碼或名稱搜尋的功能
   - 提高大量產品時的查詢效率

2. **排序功能**：
   - 增加按不同欄位排序的功能
   - 提供更靈活的資料瀏覽方式

3. **多重選擇**：
   - 支援選擇多個產品
   - 適用於批次處理場景

### 13.2 技術改進

1. **使用者介面**：
   - 改善視窗外觀和布局
   - 增加更多的視覺提示

2. **效能優化**：
   - 優化檔案讀取邏輯
   - 實現更高效的翻頁機制

## 14. 結論

WDS001是西祺企業經營管理資訊系統中的一個重要共用工具程式，提供產品代碼的視窗式查詢功能。它採用視窗式設計和子檔技術，實現了高效的產品查詢和選擇功能，大大提高了系統的易用性和資料輸入的準確性。

作為系統共用工具，WDS001被多個子系統的程式所呼叫使用，是系統整合的重要組成部分。它的設計遵循了AS/400系統的標準規範，具有良好的結構和可維護性，為系統提供了統一的產品查詢介面。 