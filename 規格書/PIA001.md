# PIA001 庫存轉移產生程式詳細規格說明書

## 一、基本信息

- **程式ID**: PIA001
- **程式名稱**: 庫存轉移產生程式
- **作者**: A1087 JOYCE
- **建立日期**: 81/04/22
- **更新日期**: 98/11/16 (Y2K修改)
- **系統**: 物料管理系統
- **子系統**: 轉移子系統
- **功能**: 庫存轉移產生

## 二、程式概述

PIA001是西祺企業管理信息系統中的庫存轉移產生程式，負責處理不同倉庫之間的物料轉移作業。該程式允許用戶指定來源倉庫、轉移物料和轉移數量，並自動生成相應的庫存轉移記錄。作為物料管理系統的重要組件，它確保企業內部物料流動的準確記錄和追蹤。

## 三、系統架構

### 相關文件

1. **IMIOPF** - 庫存轉移主檔案（物理文件）
   - 用於存儲庫存轉移記錄
   - 使用方式：更新（UF）
   - 主鍵：IO02（倉庫代碼）+ IO01（物料代碼）+ IO03（轉移單號）

2. **IMITLF01** - 物料主檔案（物理文件）
   - 用於存儲物料基本資料
   - 使用方式：讀取（IF）
   - 主鍵：IT01（物料代碼）

3. **MTMEPF** - 倉庫主檔案（物理文件）
   - 用於存儲倉庫基本資料
   - 使用方式：讀取（IF）
   - 主鍵：ME01（倉庫代碼）

4. **PA#APF** - 基本資料主檔案（物理文件）
   - 用於存儲系統基本資料
   - 使用方式：讀取（IF）
   - 主鍵：#A01（資料類型）+ #A02（資料代碼）

5. **PA#FLF** - 倉庫資料檔案（物理文件）
   - 用於存儲倉庫相關資料
   - 使用方式：讀取（IF）
   - 主鍵：未明確指定

6. **PIA001D** - 顯示文件
   - 用於用戶界面顯示和資料輸入
   - 包含一個記錄格式：DSPD1（主畫面）

### 資料結構

庫存轉移主檔案(IMIOPF)主要欄位：
- **IO01**: 物料代碼（主鍵部分）- 轉移的物料編號
- **IO02**: 倉庫代碼（主鍵部分）- 轉移的來源倉庫
- **IO03**: 轉移單號（主鍵部分）- 轉移作業的唯一識別號
- **IO04**: 物料描述 - 轉移物料的名稱
- **IO05**: 數量 - 轉移的物料數量
- **IO06**: 單價 - 物料的單位價格
- **IO07**: 金額 - 轉移物料的總金額
- **IO08**: 保留欄位 - 未使用
- **IO09**: 備註 - 轉移作業的附加說明
- **IO10**: 狀態碼 - 轉移記錄的狀態（1=正常，2=備用）
- **IO11**: 保留欄位 - 未使用
- **IOXX**: 建立日期 - 記錄創建日期
- **IOYY**: 建立時間 - 記錄創建時間
- **IOZZ**: 建立者ID - 記錄創建者的用戶ID

## 四、程式流程

### 主要流程

1. **初始化（RTN010）**
   - 設定初始值和環境變數
   - 清空倉庫代碼和轉移單號欄位
   - 設定轉移數量為0
   - 獲取系統日期

2. **主畫面處理**
   - 顯示DSPD1畫面（倉庫和轉移資料輸入）
   - 接收用戶輸入（倉庫代碼、轉移單號、備用數量）
   - 處理功能鍵（F3=返回，F14=處理作業）
   - 執行畫面檢查（RTN100）
   - 根據檢查結果執行資料處理（RTN200）

3. **資料處理（RTN200）**
   - 讀取物料主檔案
   - 為每個物料生成轉移記錄
   - 寫入庫存轉移主檔案
   - 更新轉移單號

### 詳細流程

1. **畫面檢查（RTN100）**
   - 檢查倉庫代碼是否為空（錯誤代碼61/95）
   - 檢查倉庫權限（與$WRHUS比較）
   - 檢查倉庫類型（與$WRHTY比較）
   - 檢查倉庫是否存在（通過PA#FLF或MTMEPF檢查）
   - 檢查轉移單號是否為空（錯誤代碼62/95）
   - 檢查轉移單號是否為數字（錯誤代碼62/89）
   - 檢查倉庫和轉移單號組合是否已存在（錯誤代碼60/61/99）

2. **資料處理（RTN200）**
   - 設定物料檔案的鍵值（倉庫代碼）
   - 讀取物料檔案中的記錄
   - 對每個物料執行以下操作：
     - 檢查物料代碼是否變更
     - 如果變更，執行RTN210（產生備用記錄）
     - 設定轉移記錄的欄位值
     - 寫入IMIOPF檔案
     - 更新轉移單號

3. **備用記錄產生（RTN210）**
   - 根據備用數量（DNUM）產生備用記錄
   - 設定備用記錄的欄位值（狀態碼='2'）
   - 寫入IMIOPF檔案
   - 更新轉移單號

## 五、畫面設計

### DSPD1畫面（主畫面）
- 顯示系統標題和日期
- 顯示當前用戶名稱
- 倉庫代碼輸入欄位
- 倉庫名稱顯示欄位（根據輸入的倉庫代碼自動顯示）
- 轉移單號起始值輸入欄位
- 備用數量輸入欄位
- 功能鍵：F3(返回主選單)、F14(處理作業)
- 錯誤訊息顯示區域

## 六、錯誤處理

程式包含完整的錯誤處理機制：

1. **輸入驗證**
   - 倉庫代碼不能為空（錯誤代碼61/95）
   - 轉移單號不能為空（錯誤代碼62/95）
   - 轉移單號必須為數字（錯誤代碼62/89）

2. **權限檢查**
   - 檢查用戶是否有權限操作指定倉庫（錯誤代碼61/96）

3. **資料存在性檢查**
   - 檢查倉庫是否存在（錯誤代碼61/94）
   - 檢查倉庫和轉移單號組合是否已存在（錯誤代碼60/61/99）

4. **錯誤訊息顯示**
   - 使用指示器控制錯誤訊息顯示
   - 錯誤訊息從訊息文件中獲取（PTMF和REMF）

## 七、安全與效能考量

### 安全考量
1. **權限控制**
   - 檢查用戶對倉庫的操作權限
   - 只允許授權用戶執行轉移作業

2. **資料保護**
   - 記錄資料建立和修改資訊（日期、時間、用戶）
   - 防止未授權修改

3. **審計追蹤**
   - 記錄轉移作業的執行者和時間
   - 可追蹤庫存變動歷史

### 效能考量
1. **資料庫訪問優化**
   - 使用鍵值訪問提高效率（CHAIN和SETLL操作）
   - 批量處理物料記錄

2. **畫面處理**
   - 使用指示器控制畫面顯示
   - 減少不必要的畫面重繪

3. **錯誤處理**
   - 及時檢查和報告錯誤
   - 防止無效操作消耗系統資源

## 八、程式調用關係

### 被調用程式
無直接調用其他程式

### 調用方式
1. **從系統主選單進入**
   - 通過PIM000程式調用
   - 參數：無

2. **通過命令行直接調用**
   - 命令：CALL PIA001
   - 參數：無

## 九、程式修改歷史

1. **初始版本**
   - 日期：81/04/22
   - 作者：A1087 JOYCE
   - 描述：程式初始開發

2. **更新版本**
   - 日期：11/16/92
   - 作者：JUDY
   - 描述：程式功能更新

3. **Y2K修改**
   - 日期：98/11/16
   - 作者：MICHELLE
   - 描述：為應對Y2K問題進行修改
   - 修改內容：日期格式處理和顯示

## 十、使用說明

### 操作流程
1. **進入程式**
   - 從系統主選單選擇庫存轉移選項
   - 或直接輸入命令CALL PIA001

2. **主畫面操作**
   - 輸入倉庫代碼（系統會自動顯示倉庫名稱）
   - 輸入轉移單號起始值
   - 輸入備用數量（如需要）
   - 按F14處理作業
   - 按F3返回主選單

### 常見問題處理
1. **權限不足**
   - 確認用戶是否有足夠權限操作指定倉庫
   - 聯繫系統管理員獲取權限

2. **倉庫不存在**
   - 確認倉庫代碼是否正確
   - 檢查倉庫是否已在系統中定義

3. **轉移單號錯誤**
   - 確認輸入的轉移單號是否為數字
   - 確認轉移單號是否已被使用

## 十一、系統整合

1. **與其他模塊的關係**
   - 作為物料管理系統的組件
   - 與庫存查詢和報表模塊密切配合
   - 為庫存調整提供基礎資料

2. **資料共享**
   - IMIOPF檔案被多個程式共享使用
   - 轉移資料被庫存報表和查詢程式引用

3. **系統依賴**
   - 依賴物料主檔案(IMITLF01)提供物料資訊
   - 依賴倉庫主檔案(MTMEPF)提供倉庫資訊
   - 依賴基本資料檔案(PA#APF和PA#FLF)提供系統配置

## 十二、總結

PIA001是西祺企業管理信息系統中的庫存轉移產生程式，提供完整的庫存轉移功能。通過嚴格的權限控制和完善的錯誤處理，確保庫存轉移作業的安全性和準確性。該程式是物料管理系統的重要組成部分，為企業內部物料流動提供有效的管理工具。

程式設計遵循結構化編程原則，具有良好的模塊化和可維護性。通過清晰的流程控制和完善的錯誤處理，確保程式運行的穩定性和可靠性。同時，程式也考慮了效能和安全性，為系統提供高效、安全的庫存轉移功能。

作為物料管理的基礎，PIA001程式的穩定運行對整個庫存管理系統的準確性和可用性至關重要。因此，在系統維護和升級過程中，應特別注意保持此程式的完整性和正確性。