# ARM010 應收帳款管理程式規格說明書

## 1. 基本資訊

- **程式名稱**：ARM010
- **程式類型**：RPG程式
- **程式庫**：REPLIB
- **功能說明**：應收帳款管理程式
- **相關檔案**：
  - ARM010D（顯示檔案）
  - ARMTPF（應收帳款主檔）
  - ARMDPF（應收帳款明細檔）
  - SOVMPF（銷售訂單主檔）
  - SOVDPF（銷售訂單明細檔）
  - CTMAPF（客戶主檔）
  - PTMAPF（產品主檔）
  - BKMPF（銀行主檔）
- **系統名稱**：西祺企業經營管理資訊系統
- **子系統**：財務管理模組
- **作者**：A1546 VINCENT HO
- **建立日期**：98/03/15
- **最後修改日期**：101/05/20（A1492 TERRY）
- **功能說明**：本程式提供應收帳款的新增、修改、刪除和查詢功能，是財務管理模組的核心程式之一，負責處理客戶付款和應收帳款管理。

## 2. 程式概述

ARM010是西祺企業經營管理資訊系統中財務管理模組的核心程式之一，專門用於處理應收帳款管理作業。此程式提供了完整的應收帳款處理功能，包括應收帳款的新增、修改、刪除和查詢。

程式設計採用主檔/明細檔的結構，使用者可以輸入應收帳款的基本資訊（如客戶、收款日期、收款方式等）和應收帳款明細（如銷售訂單、金額等）。程式提供了靈活的操作方式，包括功能鍵、視窗查詢和自動計算等，以提高使用者的工作效率。

程式與銷售訂單程式（SOR010）緊密整合，允許使用者根據銷售訂單進行收款，並自動更新銷售訂單的付款狀態。

## 3. 程式流程詳細說明

### 3.1 主要流程圖

```
開始
  |
  v
初始化系統環境
  |
  v
顯示主選單畫面
  |
  v
接收使用者選擇
  |
  v
< 使用者選擇新增? > --是--> 執行新增處理
  |                          |
  否                         v
  |                      顯示收款輸入畫面
  v                          |
< 使用者選擇修改? > --是--> 執行修改處理
  |                          |
  否                         v
  |                      顯示收款查詢畫面
  v                          |
< 使用者選擇刪除? > --是--> 執行刪除處理
  |                          |
  否                         v
  |                      顯示收款查詢畫面
  v                          |
< 使用者選擇查詢? > --是--> 執行查詢處理
  |                          |
  否                         v
  |                      顯示收款查詢畫面
  v                          |
< 使用者選擇退出? > --是--> 結束程式
  |
  否
  |
  v
返回主選單畫面
```

### 3.2 初始化階段

程式開始時進行以下初始化操作：

```RPG
C           *ENTRY    PLIST
C           *IN03     PARM *IN03     IN03    1
C           *IN98     PARM *IN98     IN98    1
C           *IN97     PARM *IN97     IN97    1
C  N97N98             EXSR RTN010                     *INIT ENVIRM
```

- 宣告參數列表，包括功能鍵標誌
- 從本地資料區域(LDA)獲取使用者ID、日期等資訊
- 初始化系統環境變數和畫面的預設值

### 3.3 主選單處理

程式顯示主選單畫面，並處理使用者的選擇：

```RPG
C           *IN03     DOUEQ'1'
C           *IN99     OREQ '0'
C                     EXFMTDSPD1
C                     MOVEA*ALL'0'   *IN,60
C           *IN03     IFEQ '0'
C                     SELECT
C           WOPT      WHEQ '1'
C                     EXSR RTN100                     *ADD
C           WOPT      WHEQ '2'
C                     EXSR RTN200                     *CHANGE
C           WOPT      WHEQ '3'
C                     EXSR RTN300                     *DELETE
C           WOPT      WHEQ '4'
C                     EXSR RTN400                     *INQUIRY
C                     OTHER
C                     SETON                     99
C                     ENDSL
C                     END
C                     END
```

- 顯示主選單畫面並接收使用者選擇
- 處理使用者選擇：1（新增）、2（修改）、3（刪除）、4（查詢）
- 如果選擇無效，顯示錯誤訊息

### 3.4 新增處理

當使用者選擇新增時，程式執行以下處理：

```RPG
C           RTN100    BEGSR
C                     EXSR RTN110                     *INIT SCR
C           *IN03     DOUEQ'1'
C           *IN99     OREQ '0'
C                     EXFMTDSPD2
C                     MOVEA*ALL'0'   *IN,60
C           *IN03     IFEQ '0'
C           *IN04     IFEQ '1'
C                     EXSR RTNF4
C                     ELSE
C           *IN05     IFEQ '1'
C                     EXSR RTN120                     *ADD HEADER
C                     END
C                     END
C                     END
C                     END
C                     ENDSR
```

- 初始化收款輸入畫面
- 顯示收款輸入畫面並接收使用者輸入
- 處理功能鍵：F3（返回）、F4（查詢）、F5（確認新增）
- 如果使用者按F5鍵，執行收款新增處理

### 3.5 收款主檔新增

當使用者確認新增時，程式執行以下處理：

```RPG
C           RTN120    BEGSR
C                     EXSR RTN121                     *CHECK SCR
C   99                GOTO END120
C                     EXSR RTN122                     *ADD HEADER
C   99                GOTO END120
C                     EXSR RTN130                     *DETAIL
C                     ENDSR
```

- 檢查輸入資料的有效性
- 新增收款主檔記錄
- 進入收款明細處理

### 3.6 收款明細處理

程式處理收款明細的輸入：

```RPG
C           RTN130    BEGSR
C                     EXSR RTN131                     *INIT SCR
C           *IN03     DOUEQ'1'
C           *IN99     OREQ '0'
C                     EXFMTDSPD3
C                     MOVEA*ALL'0'   *IN,60
C           *IN03     IFEQ '0'
C           *IN04     IFEQ '1'
C                     EXSR RTNF4D
C                     ELSE
C           *IN05     IFEQ '1'
C                     EXSR RTN132                     *ADD DETAIL
C                     ELSE
C           *IN06     IFEQ '1'
C                     EXSR RTN133                     *END DETAIL
C                     END
C                     END
C                     END
C                     END
C                     END
C                     ENDSR
```

- 初始化收款明細輸入畫面
- 顯示收款明細輸入畫面並接收使用者輸入
- 處理功能鍵：F3（返回）、F4（查詢）、F5（新增明細）、F6（結束明細輸入）
- 如果使用者按F5鍵，執行明細新增處理
- 如果使用者按F6鍵，結束明細輸入並返回主選單

### 3.7 銷售訂單更新處理

當收款單確認後，程式執行以下處理：

```RPG
C           RTN140    BEGSR
C                     EXSR RTN141                     *UPDATE SO
C                     ENDSR
```

- 更新銷售訂單的付款狀態（SOVMPF、SOVDPF）

## 4. 畫面說明

### 4.1 主選單畫面 (SCR001)

主選單畫面提供以下選項：

- **1. 新增收款**：新增應收帳款收款單
- **2. 修改收款**：修改現有應收帳款收款單
- **3. 刪除收款**：刪除現有應收帳款收款單
- **4. 查詢收款**：查詢應收帳款收款單
- **5. 退出**：退出程式

**功能鍵**：
- F3：退出程式

### 4.2 收款輸入畫面 (SCR002)

收款輸入畫面允許使用者輸入收款單的基本資訊：

- **收款單號**：系統自動產生
- **收款日期**：預設為當天日期，可修改
- **客戶代碼**：可使用F4鍵查詢
- **客戶名稱**：根據客戶代碼自動顯示
- **收款方式**：可選擇現金、支票、匯款等
- **銀行代碼**：可使用F4鍵查詢（如果收款方式為支票或匯款）
- **銀行名稱**：根據銀行代碼自動顯示
- **支票號碼**：可輸入支票號碼（如果收款方式為支票）
- **收款狀態**：預設為1（未處理）
- **備註**：可輸入收款備註

**功能鍵**：
- F3：返回主選單
- F4：查詢（客戶、銀行）
- F5：確認新增，進入明細輸入

### 4.3 收款明細輸入畫面 (SCR003)

收款明細輸入畫面允許使用者輸入收款單的明細資訊：

- **銷售訂單號**：可使用F4鍵查詢
- **訂單日期**：根據銷售訂單號自動顯示
- **訂單金額**：根據銷售訂單號自動顯示
- **已收金額**：根據銷售訂單號自動顯示
- **未收金額**：根據銷售訂單號自動顯示
- **收款金額**：輸入本次收款金額
- **折讓金額**：可輸入折讓金額
- **備註**：可輸入明細備註

**功能鍵**：
- F3：返回收款輸入畫面
- F4：查詢（銷售訂單）
- F5：確認新增明細
- F6：結束明細輸入，返回主選單

### 4.4 收款查詢畫面 (SCR004)

收款查詢畫面允許使用者查詢收款單：

- **收款單號**：輸入要查詢的收款單號
- **客戶代碼**：可使用F4鍵查詢
- **客戶名稱**：根據客戶代碼自動顯示
- **收款日期範圍**：可輸入收款日期範圍
- **收款方式**：可選擇收款方式

**功能鍵**：
- F3：返回主選單
- F4：查詢（客戶）
- F5：確認查詢

### 4.5 收款顯示畫面 (SCR005)

收款顯示畫面顯示收款單的基本資訊和明細資訊：

- **收款基本資訊**：收款單號、收款日期、客戶資訊、收款方式等
- **收款明細資訊**：銷售訂單號、訂單日期、訂單金額、收款金額等
- **收款合計資訊**：總收款金額、總折讓金額等

**功能鍵**：
- F3：返回收款查詢畫面
- F5：確認修改（修改模式）
- F11：確認刪除（刪除模式）

## 5. 資料檔案說明

本程式主要使用以下檔案：

- **ARM010D**：顯示檔案，用於顯示各種畫面
- **ARMTPF**：應收帳款主檔，存儲收款單的基本資訊
- **ARMDPF**：應收帳款明細檔，存儲收款單的明細資訊
- **SOVMPF**：銷售訂單主檔，用於獲取銷售訂單資訊
- **SOVDPF**：銷售訂單明細檔，用於獲取銷售訂單明細資訊
- **CTMAPF**：客戶主檔，用於獲取客戶資訊
- **BKMPF**：銀行主檔，用於獲取銀行資訊
- **LDA（本地資料區域）**：存儲使用者ID、日期等系統環境資訊

## 6. 程式邏輯

### 6.1 收款單號產生邏輯

1. 程式從系統參數檔案中獲取最後使用的收款單號
2. 將最後使用的收款單號加1，作為新收款單的號碼
3. 更新系統參數檔案中的最後使用收款單號
4. 將新收款單號顯示在收款輸入畫面上

### 6.2 客戶資訊處理邏輯

1. 使用者輸入客戶代碼或使用F4鍵查詢客戶
2. 程式從客戶主檔（CTMAPF）中獲取客戶資訊
3. 將客戶名稱等資訊顯示在收款輸入畫面上
4. 如果客戶代碼無效，程式顯示錯誤訊息

### 6.3 銀行資訊處理邏輯

1. 使用者輸入銀行代碼或使用F4鍵查詢銀行
2. 程式從銀行主檔（BKMPF）中獲取銀行資訊
3. 將銀行名稱等資訊顯示在收款輸入畫面上
4. 如果銀行代碼無效，程式顯示錯誤訊息

### 6.4 銷售訂單處理邏輯

1. 使用者輸入銷售訂單號或使用F4鍵查詢銷售訂單
2. 程式從銷售訂單主檔（SOVMPF）中獲取銷售訂單資訊
3. 程式從銷售訂單明細檔（SOVDPF）中獲取銷售訂單明細資訊
4. 將銷售訂單資訊顯示在收款明細輸入畫面上
5. 如果銷售訂單號無效，程式顯示錯誤訊息

### 6.5 金額計算邏輯

1. 程式自動計算未收金額（訂單金額 - 已收金額）
2. 使用者輸入收款金額和折讓金額
3. 程式檢查收款金額 + 折讓金額 <= 未收金額
4. 程式累計收款單的總收款金額和總折讓金額

### 6.6 銷售訂單更新邏輯

1. 當收款單確認後，程式更新銷售訂單主檔（SOVMPF）和銷售訂單明細檔（SOVDPF）
2. 更新銷售訂單的付款狀態（如部分付款、完全付款等）
3. 更新銷售訂單的已收金額
4. 如果所有明細都已完全付款，將銷售訂單狀態更新為已完成

### 6.7 收款查詢邏輯

1. 使用者輸入收款單號、客戶代碼、收款日期範圍或收款方式
2. 程式從應收帳款主檔（ARMTPF）中查詢收款單
3. 如果找到收款單，程式從應收帳款明細檔（ARMDPF）中獲取收款單明細
4. 將收款單資訊顯示在收款顯示畫面上
5. 如果找不到收款單，程式顯示錯誤訊息

## 7. 錯誤處理

程式處理以下錯誤情況：

1. **無效客戶代碼**：如果使用者輸入的客戶代碼不存在，程式顯示錯誤訊息
2. **無效銀行代碼**：如果使用者輸入的銀行代碼不存在，程式顯示錯誤訊息
3. **無效銷售訂單號**：如果使用者輸入的銷售訂單號不存在，程式顯示錯誤訊息
4. **無效收款金額**：如果使用者輸入的收款金額小於或等於0，程式顯示錯誤訊息
5. **超過未收金額**：如果收款金額 + 折讓金額 > 未收金額，程式顯示錯誤訊息
6. **無效日期**：如果使用者輸入的日期格式不正確，程式顯示錯誤訊息
7. **收款單不存在**：如果使用者查詢的收款單不存在，程式顯示錯誤訊息
8. **收款單已處理**：如果使用者嘗試修改或刪除已處理的收款單，程式顯示錯誤訊息

## 8. 維護歷史

| 日期 | 作者 | 修改內容 |
|------|------|----------|
| 98/03/15 | A1546 VINCENT HO | 程式初版建立 |
| 99/08/20 | A1546 VINCENT HO | 增加折讓金額欄位 |
| 101/05/20 | A1492 TERRY | 程式更新，增加收款備註欄位 |

## 9. 系統整合

ARM010程式與以下系統或模組整合：

1. **客戶管理模組**：使用客戶主檔（CTMAPF）獲取客戶資訊
2. **銷售管理模組**：使用銷售訂單主檔（SOVMPF）和銷售訂單明細檔（SOVDPF）獲取銷售訂單資訊
3. **銀行管理模組**：使用銀行主檔（BKMPF）獲取銀行資訊
4. **總帳管理模組**：收款單會影響總帳

## 10. 使用說明

### 10.1 新增收款

1. 從主選單選擇"1. 新增收款"
2. 系統顯示收款輸入畫面
3. 輸入客戶代碼（可使用F4鍵查詢）
4. 選擇收款方式
5. 如果收款方式為支票或匯款，輸入銀行代碼（可使用F4鍵查詢）
6. 輸入其他收款資訊
7. 按F5鍵確認新增，進入明細輸入
8. 輸入銷售訂單號（可使用F4鍵查詢）
9. 輸入收款金額和折讓金額
10. 按F5鍵確認新增明細
11. 重複步驟8-10，輸入所有明細
12. 按F6鍵結束明細輸入
13. 系統顯示新增成功訊息，返回主選單

### 10.2 修改收款

1. 從主選單選擇"2. 修改收款"
2. 系統顯示收款查詢畫面
3. 輸入收款單號或客戶代碼
4. 按F5鍵確認查詢
5. 系統顯示收款單資訊
6. 修改收款單資訊
7. 按F5鍵確認修改
8. 系統顯示修改成功訊息，返回主選單

### 10.3 刪除收款

1. 從主選單選擇"3. 刪除收款"
2. 系統顯示收款查詢畫面
3. 輸入收款單號或客戶代碼
4. 按F5鍵確認查詢
5. 系統顯示收款單資訊
6. 按F11鍵確認刪除
7. 系統顯示刪除成功訊息，返回主選單

### 10.4 查詢收款

1. 從主選單選擇"4. 查詢收款"
2. 系統顯示收款查詢畫面
3. 輸入收款單號、客戶代碼、收款日期範圍或收款方式
4. 按F5鍵確認查詢
5. 系統顯示收款單資訊
6. 按F3鍵返回收款查詢畫面
7. 按F3鍵返回主選單

### 10.5 退出程式

1. 從主選單選擇"5. 退出"或按F3鍵
2. 系統結束程式，返回上層選單

## 11. 效能考量

1. **資料庫存取**：程式使用索引欄位（如收款單號、客戶代碼）進行查詢，以提高查詢效率
2. **記憶體使用**：程式使用分頁顯示收款明細，以減少記憶體使用
3. **響應時間**：程式優化查詢邏輯，以減少響應時間
4. **交易處理**：程式使用交易控制，確保資料的完整性和一致性
5. **批次處理**：大量收款可以通過批次處理程式進行，以提高處理效率

## 12. 安全考量

1. **權限控制**：程式通過系統權限控制機制，確保只有授權使用者才能執行
2. **資料保護**：程式只允許使用者修改或刪除未處理的收款單
3. **審計追蹤**：系統記錄收款單的新增、修改和刪除操作，以便進行審計追蹤
4. **資料驗證**：程式對輸入資料進行驗證，確保資料的正確性和有效性
5. **金額控制**：程式檢查收款金額，防止超過未收金額

## 13. 未來擴展建議

1. **多幣別支援**：可以增加多幣別支援，處理不同幣別的收款
2. **電子支付**：可以增加電子支付功能，支援更多的收款方式
3. **自動對帳**：可以增加自動對帳功能，自動比對銀行對帳單和收款記錄
4. **收款排程**：可以增加收款排程功能，提醒使用者即將到期的應收帳款
5. **客戶信用管理**：可以增加客戶信用管理功能，根據收款情況評估客戶信用

## 14. 結論

ARM010程式作為財務管理模組的核心程式之一，提供了完整的應收帳款處理功能。程式設計靈活，允許使用者方便地新增、修改、刪除和查詢應收帳款收款單。通過與銷售訂單程式和客戶管理模組的良好整合，程式成為西祺企業經營管理資訊系統中不可或缺的一部分，為應收帳款管理作業提供了強大的支持。 