# VTA004 程式規格書

## 1. 基本資訊

- **程式名稱**：VTA004
- **程式類型**：RPG程式
- **程式庫**：REPLIB
- **功能描述**：銷售人員獎金計算系統 - 銷售人員資料輸入
- **相關檔案**：VTA004D（顯示檔案）
- **系統名稱**：獎金計算系統
- **子系統**：銷售獎金
- **作者**：MICHELLE
- **建立日期**：04/24/02（2002年4月24日）
- **最後修改日期**：02/11/22（2022年2月11日，根據M007修改記錄）
- **程式說明**：銷售人員獎金資料輸入

## 2. 程式概述

VTA004是西祺企業獎金計算系統中的一個重要模組，專門用於處理銷售人員的獎金資料輸入。此程式允許使用者輸入、修改、刪除和查詢銷售人員的獎金相關資料，包括銷售金額、獎金比率等。程式支援多個營業據點（倉庫、門市、客服等）和不同的業務處（台北、台中、高雄）的資料處理。

根據程式描述，此系統處理銷售人員的獎金計算，並避免重複發放獎金，確保獎金計算的準確性和公平性。程式提供了完整的資料維護功能，包括新增、修改、刪除和查詢，並實施了嚴格的資料驗證和權限控制。

## 3. 程式流程詳解

```
開始
  |
  ↓
初始化 (R0100)
  | - 讀取本地資料區(LDA)獲取使用者資訊和系統日期
  | - 設定功能權限
  | - 初始化畫面欄位
  ↓
主選單畫面 (SC01)
  | - 顯示主選單畫面
  | - 接收使用者輸入（公司別、業務處、查詢年月、功能選項）
  ↓
畫面檢查 (R1B00)
  | - 驗證使用者輸入
  | - 檢查功能權限
  | - 設定相關變數
  ↓
準備子檔畫面 (R1C00)
  | - 初始化子檔控制
  | - 設定子檔顯示參數
  | - 讀取資料填充子檔
  ↓
子檔畫面 (SC02)
  | - 顯示子檔畫面
  | - 處理使用者操作（新增、修改、刪除、查詢）
  ↓
資料處理
  | - 根據使用者選擇執行相應的資料處理
  | - 新增：新增銷售人員獎金資料
  | - 修改：更新現有獎金資料
  | - 刪除：刪除獎金資料
  | - 查詢：顯示獎金資料
  ↓
結束
```

## 4. 程式碼詳細分析

### 4.1 檔案宣告與使用

```
FSOVRPF  IF  E           K        DISK
FS#SUPF  IF  E           K        DISK
FMTMCPF  IF  E           K        DISK
FSOVRLF02UF  E           K        DISK
F            VR0                               KRENAMEVRL1
FSOVRLF04UF  E           K        DISK                      A
F            VR0                               KRENAMEVRL3
FPA#BPF  IF  E           K        DISK
FVTA004D CF  E                    WORKSTN      KINFDS DSPFDS
F                                        RRN   KSFILE SFLSR
```

- **SOVRPF**：可能是銷售訂單主檔
- **S#SUPF**：使用者資料檔案
- **MTMCPF**：可能是員工主檔
- **SOVRLF02/SOVRLF04**：銷售獎金相關檔案，使用VR0作為記錄格式
- **PA#BPF**：可能是參數檔案
- **VTA004D**：顯示檔案，包含子檔SFLSR

### 4.2 資料結構定義

```
E                    @A01        5  1               功能權限
E                    @AR1     9999 30
E                    @AR2     9999  4 0
```

- **@A01**：功能權限陣列，用於控制使用者對新增、修改、刪除、查詢功能的存取權限
- **@AR1/@AR2**：可能用於獎金計算的陣列，M007修改將大小從999增加到9999

### 4.3 本地資料區(LDA)使用

```
ILDA        UDS
I                                      101 110 $USER
I                                      125 1270$CPY
I                                      135 135 $ADD
I                                      136 136 $UPD
I                                      137 137 $DLT
I                                      138 138 $INQ
```

- **$USER**：使用者ID
- **$CPY**：公司代碼
- **$ADD/$UPD/$DLT/$INQ**：功能權限標誌（新增、修改、刪除、查詢）

### 4.4 主要變數分析

```
I                                        1  14 WVR16
I                                        1   2 VR161
I                                        3  10 VR162
I                                       11  14 VR163
```

- **WVR16**：銷售人員代碼
- **VR161/VR162/VR163**：銷售人員代碼的分段

```
I            DS
I I                                      1   80WVR17
I                                        1   40YY
I                                        5   60MM
I                                        7   80DD
```

- **WVR17**：日期資料結構
- **YY/MM/DD**：年、月、日

### 4.5 畫面控制與子檔處理

```
C                     Z-ADD11        @PRCD            *PGE RCD
C                     Z-ADD11        @SFTOP  20       *SFL TOP ROW
C                     Z-ADD21        @SFBOT  20       *SFL BOT ROW
C                     Z-ADD1         @LNUM   20       *第一行
```

- **@PRCD**：每頁記錄數
- **@SFTOP/@SFBOT**：子檔顯示的起始和結束行
- **@LNUM**：行號

```
C                     Z-ADD0         DRRN
C                     Z-ADD0         RRN
C                     Z-ADD0         @LRRN            *LAST RRN
C                     Z-ADD0         @DRCD            *DSP RCD
```

- **DRRN/RRN**：子檔記錄號
- **@LRRN**：最後記錄號
- **@DRCD**：顯示記錄數

### 4.6 主要功能實現

#### 4.6.1 初始化處理 (R0100)

```
C           R0100     BEGSR
C                     IN   PTDA01
C                     IN   DA02
C                     MOVEL$PFMT     AK11    1
C                     MOVEL$PTYPE    AK09    1
C                     Z-ADD$A8YMD    FDATE
C                     EXSR R9200
C                     Z-ADDP3111O    DATE
```

- 讀取交易日期和系統參數
- 設定日期格式和類型
- 初始化系統日期

#### 4.6.2 畫面檢查 (R1B00)

```
C           R1B00     BEGSR
C           DVR91     IFEQ 'W'
C                     MOVEL'倉庫'  NAME
C                     MOVEL'WH'      WVR91   2
C           DVR91     IFEQ 'R'
C                     MOVEL'門市'  NAME
C                     MOVEL'RM'      WVR91   2
```

- 根據公司別代碼(DVR91)設定公司名稱
- 'W'：倉庫，'R'：門市，'K'：客服，'S'：其他

```
C           DVR92     IFEQ '1'
C                     MOVEL'台北'  OFFICE
C           DVR92     IFEQ '2'
C                     MOVEL'台中'  OFFICE
C           DVR92     IFEQ '3'
C                     MOVEL'高雄'  OFFICE
```

- 根據業務處代碼(DVR92)設定業務處名稱
- '1'：台北，'2'：台中，'3'：高雄

#### 4.6.3 子檔資料初始化 (R1CD1)

```
C           R1CD1     BEGSR
C                     MOVEL*BLANK    DDEL2            .DEL OPT
C                     MOVEL'Y'       DNEW             .NEW RECORD
C                     MOVEL*BLANKS   DVR16
C                     Z-ADD0         DVR17
C                     MOVEL*BLANKS   DVR05
C                     Z-ADD*ZEROS    DVR07
C                     Z-ADD*ZEROS    DVR09
```

- 初始化子檔欄位
- DDEL2：刪除選項
- DNEW：新記錄標誌
- DVR16：銷售人員代碼
- DVR17：日期
- DVR05：可能是銷售人員姓名
- DVR07/DVR09：可能是銷售金額和獎金金額

## 5. 畫面結構分析

### 5.1 主選單畫面 (DSPD1)

```
A                                  1  2'VTA004.1'
A            CONAME        32A  O  1 25MSGID(US# 9001 S#MF)
A            DATE           6Y 0O  1 70EDTCDE(Y)
A            $USERN        10A  O  2  1
A                                  2 30'銷售人員獎金輸入'
A                                      DSPATR(RI)
A                                  2 70TIME
A                                      EDTWRD('  :  :  ')
```

- 顯示程式ID、公司名稱、日期和時間
- 顯示使用者ID和程式標題

```
A                                  4  1'公司別  :'
A            DVR91          1   B  4 13VALUES('W' 'R' 'K' 'S')
A                                  4 28'業務人員：'
A            DVR96          6   B    +2
A            SU02          10O  O    +2
```

- 公司別選擇：W(倉庫)、R(門市)、K(客服)、S(其他)
- 業務人員代碼和名稱

```
A                                  5  1'業務處  :'
A            DVR92          1   B  5 13VALUES('1' '2' '3')
A            OFFICE         6   O  5 16
A                                  6  1'查詢年月:'
A            DVR04          4  0B  6 13EDTWRD('0 /  ')
```

- 業務處選擇：1(台北)、2(台中)、3(高雄)
- 查詢年月輸入

```
A                                  7  1'作業別:'
A            DOPT           1Y 0B  7 13EDTCDE(4)
A                                      VALUES(1 2 4 5)
A                                  7 15'( 1.新增 2.修改 4.刪除 5.查詢 )'
```

- 作業別選擇：1(新增)、2(修改)、4(刪除)、5(查詢)

### 5.2 子檔畫面 (SFLSR/SFLCR)

```
A                                  9 17'發票日期'
A                                  9 28'客戶姓名'
A                                  9 61'獎金比率'
A                                 10  2'D'
A                                 10  6'發票號碼'
A                                 10 17'(MM/DD/YY)'
A                                 10 28'發票金額'
A                                 10 41'銷售額'
A                                 10 53'獎金'
A                                 10 61'獎金比率'
```

- 子檔標題行，顯示各欄位的標題

```
A            DDEL2          1A  B 11  2
A                                      VALUES(' ' 'D' '/')
A            DVR16         14   B 11  4
A            DVR17          6  0B 11 19
A                                      EDTWRD('  /  /  ')
A            DVR05          8   B 11 28
A            DVR07          9  0B 11 37
A                                      EDTCDE(K)
A            DVR09          9  0B 11 50
A                                      EDTCDE(K)
A            DVR01          2   B 11 63
A                                      VALUES('31' '32' '33' '34'  +
                                        '35' '36' '  ')
A            DVR08          1   B 11 67
A                                      VALUES('1' '2' '3' 'D' ' ')
A            DVR21          4  0B 11 72EDTCDE(2)
```

- DDEL2：刪除選項
- DVR16：發票號碼
- DVR17：發票日期，格式為MM/DD/YY
- DVR05：客戶姓名
- DVR07：發票金額
- DVR09：銷售額
- DVR01：獎金比率代碼
- DVR08：可能是獎金類型
- DVR21：獎金金額

### 5.3 功能鍵定義

```
A                                      CA03(03)
A                                      CF04(04)
A                                      CF14(14)
A                                      CF12(12)
A                                      ROLLUP(25)
```

- F3：結束/返回
- F4：提示查詢
- F12：返回前一畫面
- F14：確認
- ROLLUP：向下捲動

## 6. 修改記錄分析

```
A* M001 |MICHELLE|06.26.02|加入資料處理
A* M002 |MICHELLE|05.16.02|發票號碼限制，只能輸入數字
A* M003 |MICHELLE|05.30.02|增加業務人員
A* M004 |MICHELLE|06.26.02|加入資料處理
A* M006 |MICHELLE|03.02.05|獎金比率改為通知獎金
A* M007 |YVONNE  |02.11.22| RRN/DRRN/A改3位改4位
```

- M001/M004：加入資料處理功能
- M002：限制發票號碼只能輸入數字
- M003：增加業務人員相關功能
- M006：獎金比率改為通知獎金
- M007：將記錄號(RRN/DRRN)和陣列大小從3位改為4位，以支援更多記錄

## 7. 業務邏輯分析

### 7.1 獎金計算邏輯

根據程式描述和代碼分析，VTA004主要處理銷售人員的獎金計算，具體邏輯如下：

1. **銷售資料輸入**：
   - 記錄銷售人員的發票號碼、發票日期、客戶姓名、發票金額
   - 計算銷售額（可能是發票金額扣除某些項目後的金額）

2. **獎金計算**：
   - 根據獎金比率代碼(DVR01)確定獎金比率
   - 獎金比率代碼包括：31、32、33、34、35、36等
   - 根據銷售額和獎金比率計算獎金金額

3. **獎金類型**：
   - 根據DVR08欄位區分不同類型的獎金
   - 可能的值包括：1、2、3、D等

4. **重複檢查**：
   - 程式描述提到"避免重複發放獎金"
   - 可能通過檢查發票號碼是否已存在來防止重複輸入

### 7.2 資料驗證邏輯

程式實施了多層資料驗證：

1. **發票號碼驗證**：
   - 檢查發票號碼格式
   - M002修改限制只能輸入數字

2. **日期驗證**：
   - 檢查發票日期格式和有效性
   - 可能檢查日期是否在有效範圍內

3. **金額驗證**：
   - 檢查發票金額和銷售額的有效性
   - 可能檢查金額是否為正數

4. **獎金比率驗證**：
   - 檢查獎金比率代碼是否有效
   - 可能檢查計算出的獎金金額是否合理

## 8. 系統整合分析

### 8.1 與其他系統的整合

VTA004與以下系統或模組可能有整合關係：

1. **使用者管理系統**：
   - 通過S#SUPF檔案獲取使用者資訊
   - 實施功能權限控制

2. **銷售訂單系統**：
   - 可能從SOVRPF獲取銷售訂單資訊
   - 驗證發票資訊的有效性

3. **員工管理系統**：
   - 通過MTMCPF獲取業務人員資訊
   - 驗證業務人員代碼的有效性

4. **財務系統**：
   - 獎金計算結果可能用於薪資發放
   - 可能需要與財務系統整合以確保獎金發放的準確性

### 8.2 資料流分析

```
使用者管理系統 → 使用者資訊和權限 → VTA004
                                      ↓
銷售訂單系統 → 銷售訂單資訊 → VTA004 → 獎金計算結果 → 財務系統
                                      ↓
員工管理系統 → 業務人員資訊 → VTA004
```

## 9. 技術特點分析

### 9.1 程式設計特點

1. **模組化設計**：
   - 使用子程序(BEGSR/ENDSR)組織代碼
   - 清晰的功能分離和邏輯結構

2. **畫面控制技術**：
   - 使用子檔(Subfile)實現資料列表顯示
   - 使用條件指示器控制欄位屬性（保護、高亮等）

3. **資料驗證技術**：
   - 使用VALUES關鍵字限制有效輸入值
   - 使用程式邏輯驗證複雜的資料關係

4. **錯誤處理機制**：
   - 使用錯誤訊息ID(ERRID)和檔案(ERRF)顯示標準化錯誤訊息
   - 使用指示器控制錯誤訊息的顯示

### 9.2 AS/400特性應用

1. **本地資料區(LDA)使用**：
   - 從LDA獲取使用者資訊和權限設定
   - 使用LDA在程式間共享資訊

2. **鍵控檔案存取**：
   - 使用KLIST定義複合鍵
   - 使用CHAIN、SETLL、READE等命令進行檔案存取

3. **顯示檔案技術**：
   - 使用WORKSTN檔案類型處理互動式畫面
   - 使用SFLCTL、SFLDSP等關鍵字控制子檔顯示

## 10. 建議與改進

### 10.1 程式碼優化建議

1. **結構優化**：
   - 使用更現代的程式結構替代GOTO語句
   - 使用更清晰的變數命名規則

2. **錯誤處理增強**：
   - 增加更詳細的錯誤訊息和處理邏輯
   - 實現交易日誌記錄，便於追蹤問題

3. **效能優化**：
   - 優化檔案存取邏輯，減少不必要的讀取
   - 使用索引提高查詢效率

### 10.2 功能擴展建議

1. **報表功能**：
   - 增加獎金統計報表功能
   - 實現按業務人員、部門的獎金彙總

2. **查詢增強**：
   - 增加更靈活的查詢條件
   - 實現歷史資料查詢和比較

3. **整合增強**：
   - 增強與銷售訂單系統的整合
   - 實現自動從銷售訂單生成獎金資料

### 10.3 使用者介面改進

1. **畫面優化**：
   - 改進欄位排列，提高使用者體驗
   - 增加更多的視覺提示和幫助資訊

2. **操作便利性**：
   - 增加批量處理功能
   - 實現更靈活的資料輸入方式

## 11. 結論

VTA004是西祺企業獎金計算系統中的一個重要模組，專門用於處理銷售人員的獎金資料輸入和計算。程式採用了AS/400系統的標準RPG程式設計方法，使用子檔技術實現資料列表顯示，通過本地資料區共享系統資訊，並實施了嚴格的資料驗證和權限控制。

程式的主要功能包括銷售資料輸入、獎金計算、資料驗證和查詢，支援多個營業據點和不同業務處的資料處理。通過避免重複發放獎金的機制，確保了獎金計算的準確性和公平性。

雖然程式使用的技術相對傳統，但其設計理念和功能結構仍然具有參考價值。隨著技術的發展和業務需求的變化，可以考慮使用更現代的技術重構程式，增強其功能和使用者體驗，同時保留其核心業務邏輯。

總之，VTA004是一個典型的AS/400業務應用程式，它通過簡單而有效的設計，實現了銷售人員獎金資料的輸入和計算功能，為企業的銷售激勵和績效管理提供了重要支援。