# VTR020 銷售統計報表程式規格說明書

## 1. 基本資訊

- **程式名稱**：VTR020
- **程式類型**：RPG程式
- **程式庫**：REPLIB
- **功能說明**：銷售統計報表程式 - 業務員銷售報表
- **相關檔案**：
  - VTR020D（顯示檔案）
  - MTMCPF（業務員主檔）
- **系統名稱**：西祺企業經營管理資訊系統
- **子系統**：銷售統計模組
- **作者**：MICHELLE
- **建立日期**：10/15/02
- **最後修改日期**：未知
- **功能說明**：本程式用於產生業務員銷售報表，提供按業務員統計銷售資料的功能。

## 2. 程式概述

VTR020是西祺企業經營管理資訊系統中銷售統計模組的重要報表程式，專門用於產生業務員銷售報表。此程式允許使用者根據不同的條件（如日期範圍、業務員代碼、處理方式等）產生客製化的銷售統計報表，以便管理者分析業務員的銷售績效。

程式提供了靈活的查詢條件設定，包括選擇特定的業務員、指定日期範圍、選擇不同的處理方式（進貨、銷貨、庫存）等。報表可以按照不同的方式排序和分組，以滿足不同的分析需求。

## 3. 程式流程詳細說明

### 3.1 主要流程圖

```
開始
  |
  v
初始化系統環境
  |
  v
顯示查詢條件畫面
  |
  v
接收使用者輸入
  |
  v
< 使用者是否按F3? > --是--> 返回上層選單
  |
  否
  |
  v
< 使用者是否按F4? > --是--> 顯示查詢視窗
  |                         |
  否                        v
  |                     接收查詢結果
  v                         |
< 使用者是否按F5? > --是--> 產生報表
  |                         |
  否                        v
  |                     顯示報表
  v                         |
檢查輸入資料                 v
  |                     返回查詢條件畫面
  v
< 資料是否有效? > --否--> 顯示錯誤訊息
  |                         |
  是                        v
  |                     返回查詢條件畫面
  v
產生報表
  |
  v
顯示報表
  |
  v
返回查詢條件畫面
  |
  v
結束
```

### 3.2 初始化階段

程式開始時進行以下初始化操作：

```RPG
C           *ENTRY    PLIST
C           *IN03     PARM *IN03     IN03    1
C           *IN98     PARM *IN98     IN98    1
C           *IN97     PARM *IN97     IN97    1
C  N97N98             EXSR RTN010                     *INIT ENVIRM
```

- 宣告參數列表，包括功能鍵標誌
- 從本地資料區域(LDA)獲取使用者ID、日期等資訊
- 初始化查詢條件畫面的預設值

### 3.3 主選單處理

程式顯示查詢條件畫面，並處理使用者的選擇：

```RPG
C           *IN03     DOUEQ'1'
C           *IN99     OREQ '0'
C                     EXFMTDSPD1
C                     MOVEA*ALL'0'   *IN,60
C           *IN03     IFEQ '0'
C           *IN04     IFEQ '1'
C                     EXSR RTNF4
C                     ELSE
C           *IN05     IFEQ '1'
C                     EXSR RTN200
C                     ELSE
C                     EXSR RTN100                     *CHECK SCR01?
C                     END
C                     END
C                     END
C                     END
```

- 顯示查詢條件畫面並接收使用者輸入
- 處理功能鍵：F3（返回）、F4（查詢）、F5（產生報表）
- 檢查輸入資料的有效性

### 3.4 資料檢查

程式檢查使用者輸入的查詢條件是否有效：

```RPG
C           RTN100    BEGSR
C           MMS       IFGT 12
C           MMS       ORLT 1
C                     SETON                     639993
C                     END
C   99                GOTO END100
C                     Z-ADDMMS       YYMMS
C                     MOVELYYS       YYMMS
```

- 檢查月份是否有效（1-12）
- 檢查日期範圍是否有效（起始日期不能大於結束日期）
- 檢查業務員代碼是否存在
- 檢查其他查詢條件的有效性

### 3.5 報表產生

當使用者按下F5鍵時，程式產生報表：

```RPG
C           RTN200    BEGSR
C                     CALL 'VTR0201'
C                     PARM DVR91     V0101I  1
C                     PARM DVR92     V0102I  1
C                     PARM YMD8S     V0103I  80
C                     PARM YMD8E     V0104I  80
C                     PARM DOPT      V0105I  1
C                     PARM DVR96S    V0106I  60
C                     PARM DVR96E    V0107I  60
C                     PARM YMD97S    V0108I  80
C                     PARM YMD97E    V0109I  80
C                     PARM $EVR      V0110I  1
C                     PARM $CPY      V0111I  30
C                     PARM $PRTID    V0112I  20
C                     PARM           V0101O  1
```

- 調用VTR0201子程式產生報表
- 傳遞查詢條件參數，包括：
  - 報表類型（DVR91）
  - 處理方式（DVR92）
  - 日期範圍（YMD8S, YMD8E）
  - 選項（DOPT）
  - 業務員代碼範圍（DVR96S, DVR96E）
  - 銷售日期（YMD97S, YMD97E）
  - 報表格式（$EVR）
  - 列印份數（$CPY）
  - 印表機ID（$PRTID）

## 4. 畫面說明

### 4.1 查詢條件畫面 (SCR001)

查詢條件畫面允許使用者設定報表的產生條件：

- **報表類型**：可選擇W（週報）、R（月報）、K（季報）或S（年報）
- **資料處理**：可選擇1（進貨）、2（銷貨）或3（庫存）
- **統計月份**：指定要統計的月份範圍（MM/YY格式）
- **資料選項**：可選擇1（依品項）、2（依客戶）或3（依類別）
- **業務員號碼**：指定要統計的業務員代碼
- **統計日期**：指定要統計的日期
- **報表格式**：可選擇1（摘要）或2（明細）
- **列印份數**：指定要列印的份數
- **印表機**：指定要使用的印表機ID

**功能鍵**：
- F3：返回上層選單
- F4：業務員查詢
- F5：產生報表

## 5. 資料檔案說明

本程式主要使用以下檔案：

- **VTR020D**：顯示檔案，用於顯示查詢條件畫面
- **MTMCPF**：業務員主檔，用於驗證業務員代碼和獲取業務員資訊
- **LDA（本地資料區域）**：存儲使用者ID、日期等系統環境資訊

## 6. 程式邏輯

### 6.1 查詢條件處理邏輯

1. 程式初始化時，設定查詢條件的預設值
2. 顯示查詢條件畫面，等待使用者輸入
3. 使用者輸入查詢條件後，程式檢查條件的有效性
4. 如果條件有效，程式準備產生報表的參數

### 6.2 日期處理邏輯

1. 程式接收使用者輸入的月份和年份（MM/YY格式）
2. 將月份和年份轉換為系統日期格式（YYMMDD）
3. 檢查日期範圍的有效性（起始日期不能大於結束日期）
4. 如果日期有效，程式使用這些日期作為報表的查詢條件

### 6.3 業務員處理邏輯

1. 程式接收使用者輸入的業務員代碼
2. 檢查業務員代碼是否存在於業務員主檔（MTMCPF）中
3. 如果業務員代碼有效，程式顯示業務員名稱
4. 如果使用者未指定業務員代碼，程式將產生所有業務員的報表

### 6.4 報表產生邏輯

1. 程式調用VTR0201子程式產生報表
2. 傳遞所有查詢條件參數給子程式
3. 子程式根據參數產生報表
4. 報表產生後，程式返回查詢條件畫面，等待使用者的下一個操作

## 7. 錯誤處理

程式處理以下錯誤情況：

1. **無效月份**：如果使用者輸入的月份不在1-12範圍內，程式顯示錯誤訊息
2. **無效日期範圍**：如果起始日期大於結束日期，程式顯示錯誤訊息
3. **無效業務員代碼**：如果業務員代碼不存在，程式顯示錯誤訊息
4. **其他輸入錯誤**：程式檢查所有輸入欄位的有效性，並顯示相應的錯誤訊息

## 8. 維護歷史

| 日期 | 作者 | 修改內容 |
|------|------|----------|
| 10/15/02 | MICHELLE | 程式初版建立 |

## 9. 系統整合

VTR020程式與以下系統或模組整合：

1. **銷售統計模組**：作為銷售統計模組的一部分，提供業務員銷售報表功能
2. **業務員管理模組**：使用業務員主檔（MTMCPF）獲取業務員資訊
3. **銷售訂單模組**：使用銷售訂單資料產生銷售統計報表
4. **庫存管理模組**：使用庫存資料產生庫存統計報表

## 10. 使用說明

### 10.1 進入程式

1. 從銷售統計主選單選擇"業務員銷售報表"選項
2. 系統顯示VTR020查詢條件畫面

### 10.2 設定查詢條件

1. 選擇報表類型（週報、月報、季報或年報）
2. 選擇資料處理方式（進貨、銷貨或庫存）
3. 指定統計月份範圍
4. 選擇資料選項（依品項、依客戶或依類別）
5. 指定業務員號碼（可使用F4鍵查詢）
6. 指定統計日期
7. 選擇報表格式（摘要或明細）
8. 指定列印份數和印表機ID

### 10.3 產生報表

1. 設定完查詢條件後，按F5鍵產生報表
2. 系統產生報表並顯示或列印
3. 報表產生後，系統返回查詢條件畫面

### 10.4 退出程式

1. 在查詢條件畫面上，按F3鍵
2. 系統返回上層選單

## 11. 效能考量

1. **報表產生時間**：根據查詢條件和資料量，報表產生時間可能會有所不同
2. **記憶體使用**：程式處理大量資料時，可能需要較多的記憶體
3. **資源使用**：報表產生過程中，程式會讀取多個檔案，可能會影響系統效能

## 12. 安全考量

1. **權限控制**：程式通過系統權限控制機制，確保只有授權使用者才能執行
2. **資料保護**：程式只顯示使用者有權限查看的資料
3. **審計追蹤**：系統記錄報表產生的相關資訊，以便進行審計追蹤

## 13. 未來擴展建議

1. **報表格式增強**：可以增加更多的報表格式選項，如圖表、趨勢分析等
2. **查詢條件擴展**：可以增加更多的查詢條件，如產品類別、客戶類別等
3. **整合增強**：可以增強與其他模組的整合，如與財務模組的整合，提供銷售與財務的綜合分析

## 14. 結論

VTR020程式作為銷售統計模組的重要組成部分，提供了強大的業務員銷售報表功能。程式設計靈活，允許使用者根據不同的條件產生客製化的報表，以滿足不同的分析需求。通過這些報表，管理者可以有效地分析業務員的銷售績效，為銷售策略的制定提供重要的參考依據。 