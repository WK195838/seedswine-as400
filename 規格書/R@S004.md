# R@S004程序規格說明文檔

## 1. 基本資訊

- **程序名稱**：R@S004
- **系統**：西祺企業管理資訊系統 - 系統安全模組
- **子系統**：系統授權檢查
- **功能描述**：系統授權驗證程序
- **開發者**：JEANNY LIN
- **創建日期**：1979/05/16

## 2. 程序結構

R@S004程序是西祺企業管理資訊系統的安全控制程序，負責驗證系統的授權狀態，確保系統只能在授權的環境中運行。該程序是系統啟動時的關鍵安全檢查組件。

### 2.1 程序流程

1. 程序接收子系統代碼(RSUBSYS)作為參數
2. 調用P63程序初始化系統環境
3. 從R@DA01數據區域獲取系統資訊，包括CPU ID、機器型號、授權到期日期、授權子系統列表和安全校驗碼
4. 調用R@S003程序驗證CPU ID、機器型號和授權到期日期
5. 如果R@S003返回錯誤，則調用HELLO程序顯示錯誤訊息並終止系統
6. 調用R@S001程序生成安全校驗碼並與存儲的校驗碼比較
7. 如果校驗碼不匹配，則調用HELLO程序顯示錯誤訊息並終止系統
8. 檢查當前子系統是否在授權子系統列表中
9. 如果當前子系統未授權，則調用HELLO程序顯示錯誤訊息並終止系統
10. 如果所有檢查都通過，則程序正常結束，允許系統繼續運行

## 3. 相關檔案

### 3.1 主要檔案

- **R@DA01**：系統授權數據區域，存儲系統授權資訊
- **R@S003**：系統環境驗證程序，負責驗證CPU ID、機器型號和授權到期日期
- **R@S001**：安全校驗碼生成程序，負責生成和驗證安全校驗碼
- **P63**：系統環境初始化程序，負責設置系統日期和時間等環境變數
- **HELLO**：錯誤處理程序，負責顯示錯誤訊息並終止系統

### 3.2 參數定義

主要參數：

| 參數名 | 描述 | 類型 | 備註 |
|-------|------|------|------|
| RSUBSYS | 子系統代碼 | 字符(2) | 當前運行的子系統代碼 |
| CPUID | CPU識別碼 | 字符(8) | 系統CPU的唯一識別碼 |
| MODEL | 機器型號 | 字符(4) | AS/400機器的型號 |
| EXDATE | 授權到期日期 | 字符(6) | 系統授權的到期日期 |
| SUBSYS | 授權子系統列表 | 字符(80) | 所有授權子系統的代碼列表 |
| PTN01 | 安全校驗碼 | 字符(7) | 存儲的安全校驗碼 |
| RPTN01 | 生成的校驗碼 | 字符(7) | 程序生成的安全校驗碼 |
| ERRC | 錯誤代碼 | 字符(1) | 錯誤狀態代碼 |

## 4. 程序功能詳細說明

### 4.1 系統環境初始化

程序首先調用P63程序初始化系統環境，設置系統日期和時間等環境變數。P63程序是系統啟動時的標準初始化程序，確保系統環境的一致性。

### 4.2 授權資訊獲取

程序從R@DA01數據區域獲取系統授權資訊，包括：
- CPU ID：系統CPU的唯一識別碼
- 機器型號：AS/400機器的型號
- 授權到期日期：系統授權的到期日期
- 授權子系統列表：所有授權子系統的代碼列表
- 安全校驗碼：用於驗證授權資訊完整性的校驗碼

### 4.3 系統環境驗證

程序調用R@S003程序驗證系統環境，主要檢查以下幾點：
1. CPU ID是否匹配：確保系統運行在授權的硬件上
2. 機器型號是否匹配：確保系統運行在授權的機器型號上
3. 授權是否過期：檢查當前日期是否超過授權到期日期

如果任何一項檢查失敗，R@S003會返回相應的錯誤代碼，R@S004會調用HELLO程序顯示錯誤訊息並終止系統。

### 4.4 安全校驗碼驗證

程序調用R@S001程序生成安全校驗碼，並與存儲在R@DA01數據區域中的校驗碼進行比較。安全校驗碼是基於系統授權資訊生成的，用於確保授權資訊的完整性和真實性。

如果生成的校驗碼與存儲的校驗碼不匹配，表示授權資訊可能被篡改，程序會調用HELLO程序顯示錯誤訊息並終止系統。

### 4.5 子系統授權檢查

程序檢查當前子系統代碼(RSUBSYS)是否在授權子系統列表(SUBSYS)中。授權子系統列表是一個包含所有授權子系統代碼的字符串，每個子系統代碼佔用2個字符。

如果授權子系統列表的前兩個字符是'@@'，表示所有子系統都被授權，程序會直接通過檢查。否則，程序會遍歷授權子系統列表，檢查當前子系統是否在列表中。

如果當前子系統未在授權列表中，程序會調用HELLO程序顯示錯誤訊息並終止系統。

## 5. 業務規則

### 5.1 系統授權模型

系統採用基於硬件綁定的授權模型，主要包括以下幾個方面：

1. **硬件綁定**：系統授權與特定的CPU ID和機器型號綁定，確保系統只能在授權的硬件上運行。

2. **時間限制**：系統授權有明確的到期日期，超過到期日期後系統將無法運行。如果授權到期日期設置為'999999'，表示永久授權。

3. **功能限制**：系統授權限制了可以運行的子系統，只有在授權子系統列表中的子系統才能運行。

4. **完整性保護**：系統使用安全校驗碼保護授權資訊的完整性，防止授權資訊被篡改。

### 5.2 錯誤處理

系統定義了多種錯誤代碼，對應不同的授權問題：

- '1'：機器型號不匹配
- '2'：授權已過期
- '3'：子系統未授權
- '4'：安全校驗碼不匹配
- '7'：CPU ID不匹配

當發生任何授權錯誤時，系統會調用HELLO程序顯示錯誤訊息並終止系統，確保未授權的系統無法運行。

## 6. 安全機制

### 6.1 多層次驗證

系統採用多層次的授權驗證機制，包括：

1. **硬件驗證**：驗證CPU ID和機器型號，確保系統只能在授權的硬件上運行。

2. **時間驗證**：驗證授權到期日期，確保系統只能在授權期內運行。

3. **功能驗證**：驗證子系統授權，確保只有授權的子系統才能運行。

4. **完整性驗證**：驗證安全校驗碼，確保授權資訊的完整性和真實性。

### 6.2 安全數據存儲

系統授權資訊存儲在R@DA01數據區域中，這是一個受保護的系統資源，普通用戶無法直接訪問和修改。

### 6.3 錯誤處理和日誌

當發生授權錯誤時，系統會調用HELLO程序顯示錯誤訊息，並向系統操作員(QSYSOPR)發送訊息，記錄授權錯誤的詳細資訊，便於系統管理員追蹤和解決問題。

## 7. 維護建議

1. **定期更新授權**：在授權到期前及時更新系統授權，避免系統因授權過期而無法使用。

2. **備份授權資訊**：定期備份R@DA01數據區域，確保在系統重新安裝或恢復時能夠恢復授權資訊。

3. **監控授權狀態**：定期檢查系統授權狀態，確保系統在授權期內正常運行。

4. **安全加固**：考慮增強安全校驗碼的生成算法，提高系統的安全性。

5. **授權管理**：建立完善的授權管理流程，確保授權資訊的安全和有效管理。

## 8. 總結

R@S004程序是西祺企業管理資訊系統的關鍵安全組件，負責驗證系統的授權狀態，確保系統只能在授權的環境中運行。該程序通過多層次的驗證機制，包括硬件驗證、時間驗證、功能驗證和完整性驗證，全面保護系統的安全性和合法性。

程序的設計遵循了AS/400系統的安全最佳實踐，採用了數據區域存儲授權資訊、多程序協作驗證和完整的錯誤處理機制，確保系統的安全性和可靠性。通過這些機制，系統能夠有效防止未授權使用和授權資訊篡改，保護軟件開發商的知識產權和商業利益。