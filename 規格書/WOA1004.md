# WOA1004 工作訂單處理程式規格說明書

## 1. 基本信息

- **程式名稱**：WOA1004
- **程式類型**：RPG程式
- **系統**：西祺企業管理資訊系統
- **子系統**：工作訂單管理模組
- **功能**：處理工作訂單的維護和管理
- **建立日期**：85/04/02
- **更新日期**：81/04/17 (Philip)
- **作者**：不詳

## 2. 程式結構

### 2.1 檔案引用
- **輸入/輸出檔案**：
  - `WOWBPF`：工作訂單主檔（更新模式）
  - `WOWEPF`：工作訂單明細檔（輸入模式）
  - `MTMAPF`：主檔資料檔（輸入模式）
  - `WOA1004D`：顯示檔案（工作站模式）

### 2.2 資料結構
- **資料區域**：
  - `$USER`：用戶ID
  - `$A6MDY`：系統日期（6位）
  - `$A8YMD`：系統日期（8位）
  - `$ADD`、`$UPD`、`$DLT`、`$INQ`：功能權限標識
  - `$FMT`、`$TYPE`：日期格式和類型

- **子檔控制變數**：
  - `@DRCD`：顯示記錄數
  - `@PRCD`：每頁記錄數
  - `@LRRN`：最後記錄號
  - `@LPAGE`：最後頁碼
  - `@PRRN`：提示使用
  - `@SFTOP`、`@SFBOT`：子檔頂部和底部行號

- **鍵值列表**：
  - `KEYWB`：完整鍵值（PWE01, WB02, SWB03）
  - `KEYWB1`：部分鍵值（PWE01, WB02）
  - `KEYWB2`：擴展鍵值（PWE01, WB02, HWB03, HWB05）

### 2.3 程式流程

1. **初始化階段**：
   - `R0100`：初始化變數和權限
   - `R0200`：初始化子檔頭部
   - `R1C00`：初始化SC04畫面

2. **子檔處理**：
   - `R1CC0`：子檔初始化
   - `R1CD0`：子檔資料初始化
   - `R1CD1`：子檔資料新增
   - `R1CE0`：從檔案讀取資料到子檔
   - `R1CE1`：處理子檔資料

3. **主畫面處理**：
   - `R2000`：SC04畫面主處理
   - `R2B00`：檢查畫面輸入
   - `R2B20`：檢查明細資料
   - `R2D00`：檔案處理
   - `R2D10`：檔案處理（明細）
   - `R2D11`：移動資料

4. **工具子程序**：
   - `R9100`：日期類型轉換（畫面到檔案）
   - `R9200`：日期類型轉換（檔案到畫面）

## 3. 功能說明

### 3.1 主要功能
- 維護工作訂單主檔（WOWBPF）
- 顯示工作訂單明細資料（WOWEPF）
- 提供新增、修改、刪除工作訂單的功能
- 支援查詢和瀏覽工作訂單資料

### 3.2 畫面功能
- **SC04畫面**：主要工作畫面，顯示工作訂單資料
- **子檔功能**：使用子檔顯示多筆工作訂單資料
- **功能鍵**：
  - F3：結束程式
  - F4：提示（呼叫WDS001）
  - F8：重新整理
  - F10：提示（呼叫WDS031）
  - F12：返回
  - F25：下一頁
  - F27：重新開始

### 3.3 資料處理功能
- **新增**：新增工作訂單記錄
- **修改**：修改現有工作訂單資料
- **刪除**：刪除工作訂單記錄
- **查詢**：查詢工作訂單資料

## 4. 資料處理邏輯

### 4.1 初始化邏輯
- 從LDA獲取用戶ID和日期
- 設置功能權限
- 初始化子檔和畫面

### 4.2 子檔處理邏輯
- 設置子檔參數（頂部行、底部行、每頁記錄數等）
- 從工作訂單主檔讀取資料
- 將資料寫入子檔
- 處理分頁和捲動

### 4.3 資料驗證邏輯
- 檢查必填欄位（如DWB03）
- 驗證欄位值的有效性
- 檢查參照完整性（如檢查產品代碼是否存在）

### 4.4 檔案處理邏輯
- 根據操作類型（新增、修改、刪除）處理工作訂單主檔
- 更新工作訂單資料
- 記錄操作時間和用戶

## 5. 畫面說明

### 5.1 SC04畫面
- **標題區**：顯示程式標題和系統資訊
- **子檔區**：顯示工作訂單資料列表
- **功能鍵區**：顯示可用的功能鍵
- **訊息區**：顯示錯誤和提示訊息

### 5.2 子檔欄位
- `DDEL2`：刪除選項
- `DWB03`：產品代碼
- `DMA03`：產品名稱
- `DWB04`：數量
- `DWB06`：單價
- `DWB05`：備註

### 5.3 隱藏欄位
- `DNEW2`：新記錄標識
- `RRN2`：記錄號
- `HWB01`、`HWB02`、`HWB03`、`HWB05`：隱藏的工作訂單資料

## 6. 相關程式

### 6.1 直接相關程式
- **WDS001**：提示程式（F4）
- **WDS031**：提示程式（F10）
- **P30**：日期檢查程式
- **P31**：日期轉換程式

### 6.2 間接相關程式
- **WOA1001**、**WOA1002**、**WOA1003**：其他工作訂單處理程式
- **WOA200**：工作訂單管理程式
- **WOR1001**、**WOR1101**：工作訂單報表程式

## 7. 資料檔案說明

### 7.1 WOWBPF（工作訂單主檔）
- **主鍵**：WB01（客戶ID）、WB02（訂單日期）、WB03（產品代碼）
- **主要欄位**：
  - `WB01`：客戶ID
  - `WB02`：訂單日期
  - `WB03`：產品代碼
  - `WB04`：數量
  - `WB05`：備註
  - `WB06`：單價
  - `WBXX`：建立日期
  - `WBYY`：建立時間
  - `WBZZ`：建立用戶

### 7.2 WOWEPF（工作訂單明細檔）
- **主鍵**：WE01（客戶ID）、WE02（訂單編號）
- **主要欄位**：
  - `WE01`：客戶ID
  - `WE02`：訂單編號
  - `WE03`：訂單描述

### 7.3 MTMAPF（主檔資料檔）
- 包含產品資料
- **主要欄位**：
  - `MA01`：產品代碼
  - `MA03`：產品名稱

## 8. 業務邏輯

### 8.1 工作訂單處理流程
1. 用戶輸入客戶ID（PWE01）
2. 系統顯示該客戶的工作訂單資料
3. 用戶可以新增、修改或刪除工作訂單
4. 系統驗證輸入資料
5. 系統更新工作訂單主檔

### 8.2 資料驗證規則
- 產品代碼（DWB03）必須存在於產品主檔
- 客戶ID（PWE01）必須存在於客戶主檔
- 數量（DWB04）必須大於零
- 日期格式必須有效

### 8.3 特殊處理邏輯
- 刪除記錄時，只刪除工作訂單主檔中的記錄
- 新增記錄時，自動填入系統日期、時間和用戶ID
- 日期格式轉換使用P31程式

## 9. 錯誤處理

### 9.1 錯誤訊息
- `UPT0010`：產品代碼不能為空
- `UPT0040`：日期格式錯誤
- `UPT1003`：產品代碼或客戶ID不存在
- `UPT2050`：無資料

### 9.2 錯誤處理邏輯
- 顯示錯誤訊息
- 設置錯誤指示器
- 將游標定位到錯誤欄位

## 10. 維護建議

### 10.1 代碼優化
- 簡化複雜的條件判斷
- 使用更現代的程式結構
- 改善變數命名，提高可讀性

### 10.2 功能擴展
- 增加更多的查詢條件
- 提供批次處理功能
- 增加報表生成功能

### 10.3 效能改進
- 優化檔案讀取邏輯
- 減少不必要的檔案操作
- 使用索引加速查詢

### 10.4 使用者介面改進
- 提供更友善的錯誤訊息
- 增加線上說明功能
- 改善畫面布局

## 11. 總結

WOA1004是西祺企業管理資訊系統中的工作訂單處理程式，負責維護和管理工作訂單資料。該程式提供了完整的工作訂單生命週期管理功能，包括新增、修改、刪除和查詢。

程式使用子檔技術顯示多筆工作訂單資料，並提供各種功能鍵簡化操作。資料驗證和錯誤處理邏輯確保了資料的完整性和正確性。

作為工作訂單管理模組的核心程式，WOA1004在企業的生產管理和訂單處理中扮演著重要角色，幫助企業有效管理工作訂單，提高生產效率。