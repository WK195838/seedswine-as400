# SOR160C1 - 銷售訂單入庫報表查詢程式規格書

## 基本資訊
- **程式名稱**：SOR160C1
- **程式類型**：RPG程式
- **所屬資料庫**：REPLIB
- **功能說明**：銷售訂單入庫報表查詢程式
- **相關檔案**：
  - REWF2（工作檔）
  - SOVDPF（銷售訂單明細檔）
  - SOVMPF（銷售訂單主檔）
  - PA#HPF（客戶主檔）
  - PTMAPF（商品主檔）
  - MTMELF（業務員主檔）
- **系統名稱**：西祺企業經營管理資訊系統
- **子系統**：銷售訂單管理系統
- **作者**：EASON
- **建立日期**：96/09/06
- **最後修改日期**：00/11/08
- **功能特點**：負責根據用戶指定的查詢條件從銷售訂單相關檔案中查詢數據，並將結果寫入工作檔供報表生成程式使用。

## 程式概述
SOR160C1是西祺企業經營管理資訊系統中銷售訂單入庫報表程式(SOR160系列)的查詢程式，負責根據用戶指定的查詢條件從銷售訂單相關檔案中查詢數據。該程式接收來自控制程式SOR160C的查詢條件參數，然後從銷售訂單主檔、明細檔、客戶主檔、商品主檔和業務員主檔中查詢符合條件的數據，並將結果寫入工作檔REWF2，供報表生成程式（SOR1602或SOR1603）使用。

SOR160C1作為查詢程式，負責數據的篩選和準備工作，確保報表生成程式能夠獲取準確、完整的數據，為用戶提供全面的銷售訂單入庫資訊。

## 程式流程圖
```
開始
  |
  ↓
接收查詢條件參數
  |
  ↓
初始化工作檔
  |
  ↓
讀取銷售訂單明細檔
  |
  ↓
<符合查詢條件?>──否──→ 繼續讀取下一筆
  |                     |
  是                    ↓
  |                   <讀取完成?>──否──→ 繼續讀取
  ↓                     |
讀取相關主檔資訊          是
  |                     |
  ↓                     ↓
寫入工作檔               返回控制程式
  |
  ↓
繼續讀取下一筆
```

## 初始化階段
程式啟動時，進行以下初始化操作：
1. 宣告變數和數據結構
2. 接收查詢條件參數
3. 清空工作檔REWF2
4. 初始化計數器和累計變數

```RPG
FREWF2   O   E           K        DISK
FSOVDPF  IF  E           K        DISK
FSOVMPF  IF  E           K        DISK
FPA#HPF  IF  E           K        DISK
FPTMAPF  IF  E           K        DISK
FMTMELF  IF  E           K        DISK
F            ME0                               KRENAMEME0L
```

## 主要處理流程

### 1. 接收查詢條件參數
SOR160C1接收來自控制程式SOR160C的查詢條件參數：
1. 交易類型（COMP）
2. 客戶代碼（CUST）
3. 商品代碼（PROD）
4. 業務員代碼（SLMN）
5. 開始日期（SDATE）
6. 結束日期（EDATE）
7. 客戶群組（CGRP）
8. 商品群組（PGRP）

```RPG
C     *ENTRY    PLIST
C                     PARM           COMP  1
C                     PARM           CUST  6
C                     PARM           PROD 15
C                     PARM           SLMN  4
C                     PARM           SDATE 8
C                     PARM           EDATE 8
C                     PARM           CGRP  2
C                     PARM           PGRP  2
```

### 2. 初始化工作檔
SOR160C1在開始查詢前初始化工作檔：
1. 清空工作檔REWF2
2. 初始化工作檔結構

```RPG
C                     EXSR RTN010                     *INIT
```

### 3. 讀取銷售訂單明細檔
SOR160C1讀取銷售訂單明細檔SOVDPF：
1. 設置讀取條件
2. 循環讀取明細檔
3. 檢查是否符合查詢條件

```RPG
C                     EXSR RTN100                     *READ SOVDPF
```

### 4. 檢查查詢條件
SOR160C1檢查每筆記錄是否符合查詢條件：
1. 檢查交易類型
2. 檢查客戶代碼
3. 檢查商品代碼
4. 檢查業務員代碼
5. 檢查日期範圍
6. 檢查客戶群組
7. 檢查商品群組

```RPG
C           RTN200    BEGSR
C*
C           COMP      IFNE *BLANKS
C           COMP      ANDNE'3'
C           SOCOMP    IFNE COMP
C                     GOTO ENDCHK
C                     END
C                     END
C*
C           CUST      IFNE *BLANKS
C           SOCUST    IFNE CUST
C                     GOTO ENDCHK
C                     END
C                     END
```

### 5. 讀取相關主檔資訊
SOR160C1讀取相關主檔資訊：
1. 讀取銷售訂單主檔SOVMPF
2. 讀取客戶主檔PA#HPF
3. 讀取商品主檔PTMAPF
4. 讀取業務員主檔MTMELF

```RPG
C           RTN300    BEGSR
C*
C           SOCUST    CHAIN(E)PA#HPF                      50
C                     IFEQ *ON
C                     MOVEL*BLANKS CUSNM
C                     ELSE
C                     MOVELCUSNM   CUSNM
C                     END
```

### 6. 寫入工作檔
SOR160C1將符合條件的數據寫入工作檔REWF2：
1. 設置工作檔字段值
2. 寫入工作檔記錄

```RPG
C           RTN400    BEGSR
C*
C                     MOVELSOCOMP  RECOMP
C                     MOVELSODATE  REDATE
C                     MOVELSONUM   RENUM
C                     MOVELSOITEM  REITEM
C                     MOVELSOQTY   REQTY
C                     MOVELSOAMT   REAMT
C                     MOVELCUSNM   RECUSNM
C                     MOVELPTDESC  REPTDESC
C                     MOVELSLMNM   RESLMNM
C                     WRITE REWF2R
```

## 錯誤處理

### 1. 檔案讀取錯誤
- 如果銷售訂單明細檔SOVDPF讀取過程中發生錯誤，捕獲錯誤並繼續處理

### 2. 主檔讀取錯誤
- 如果主檔（SOVMPF、PA#HPF、PTMAPF、MTMELF）讀取過程中發生錯誤，捕獲錯誤並使用默認值

### 3. 工作檔寫入錯誤
- 如果工作檔REWF2寫入過程中發生錯誤，捕獲錯誤並返回錯誤訊息

## 維護歷史
- **M001**：98.10.21，由MICHELLE進行Y2K修改
- **M002**：99.11.08，增加客戶群組選項
- **M003**：00.11.08，增加大盤商品功能

## 系統整合
SOR160C1與以下程式整合：
1. **SOR160C**：控制程式，調用SOR160C1執行查詢
2. **SOR1602**：報表格式1生成程式，使用SOR160C1生成的工作檔數據
3. **SOR1603**：報表格式2生成程式，使用SOR160C1生成的工作檔數據

## 使用說明

### 1. 程式調用
- SOR160C1不直接由用戶調用，而是由控制程式SOR160C調用
- 用戶在主程式SOR160的查詢條件畫面輸入查詢條件

### 2. 參數說明
- **COMP**：交易類型（1=出貨，2=退貨，3=調撥，空白=全部）
- **CUST**：客戶代碼（空白=全部）
- **PROD**：商品代碼（空白=全部）
- **SLMN**：業務員代碼（空白=全部）
- **SDATE**：開始日期（YYYYMMDD格式）
- **EDATE**：結束日期（YYYYMMDD格式）
- **CGRP**：客戶群組（空白=全部）
- **PGRP**：商品群組（空白=全部）

### 3. 查詢條件組合
- 支持多種查詢條件的組合，可以指定一個或多個條件
- 如果某個條件為空白，表示不限制該條件

## 效能考量
1. **查詢優化**：優化查詢條件，提高數據查詢效率
2. **索引使用**：合理使用檔案索引，加快查詢速度
3. **記憶體使用**：合理管理記憶體使用，避免佔用過多系統資源

## 安全考量
1. **參數驗證**：驗證輸入參數的有效性，防止非法輸入
2. **數據訪問控制**：確保只處理用戶有權訪問的數據
3. **敏感資訊保護**：確保不暴露敏感資訊

## 未來擴展建議
1. **增強查詢條件**：提供更多的查詢條件選項
2. **優化查詢效率**：進一步優化查詢算法，提高查詢效率
3. **增加數據過濾功能**：支持更複雜的數據過濾條件
4. **增加排序選項**：支持更多的排序選項

## 結論
SOR160C1作為銷售訂單入庫報表程式(SOR160系列)的查詢程式，負責根據用戶指定的查詢條件從銷售訂單相關檔案中查詢數據，並將結果寫入工作檔供報表生成程式使用。該程式的設計遵循清晰易讀和可維護性原則，確保數據查詢的準確性和效率，為報表生成提供可靠的數據基礎，幫助用戶有效地分析和管理銷售訂單數據。 