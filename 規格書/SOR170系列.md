# SOR170系列 - 銷售訂單明細報表程式規格書

## 基本資訊
- **程式名稱**：SOR170系列（SOR170、SOR1701）
- **程式類型**：RPG程式
- **所屬資料庫**：REPLIB
- **功能說明**：銷售訂單明細報表程式
- **相關檔案**：
  - SOR170D（顯示檔案）
  - SOR170P（印表檔案）
  - SOVMPF（銷售訂單主檔）
  - SOVDPF（銷售訂單明細檔）
  - CTMAPF（客戶主檔）
  - MTMCPF（業務員主檔）
  - PTMAPF（產品主檔）
- **系統名稱**：西祺企業經營管理資訊系統
- **子系統**：銷售訂單管理模組
- **作者**：A1546 VINCENT HO
- **建立日期**：97/11/05
- **最後修改日期**：100/03/20（A1492 TERRY）
- **功能特點**：提供銷售訂單明細報表的查詢、列印功能，支持多種查詢條件和報表格式。

## 程式概述
SOR170系列程式是西祺企業經營管理資訊系統中銷售訂單管理模組的重要報表程式，專門用於產生銷售訂單明細報表。此程式允許使用者根據不同的條件（如訂單狀態、訂單日期、客戶代碼、產品類別、訂單號碼、產品代碼、業務員等）產生客製化的銷售訂單明細報表，以便管理者分析銷售訂單執行情況。

程式提供了靈活的查詢條件設定，包括選擇特定的訂單狀態、指定日期範圍、選擇特定客戶或產品等。報表可以按照不同的方式排序和分組，以滿足不同的分析需求。報表內容包括訂單基本資訊、產品明細、數量、金額等重要資料，為銷售管理提供全面的資訊支持。

SOR170系列程式由多個子程式組成，各自負責不同的功能：
- **SOR170**：主程式，負責用戶界面交互和參數設置
- **SOR1701**：負責報表生成和打印

## 程式流程圖
```
開始
  |
  ↓
初始化系統環境
  |
  ↓
顯示查詢條件畫面
  |
  ↓
接收使用者輸入
  |
  ↓
< 使用者是否按F3? > --是--> 返回上層選單
  |
  否
  |
  ↓
< 使用者是否按F4? > --是--> 顯示查詢視窗
  |                         |
  否                        ↓
  |                     接收查詢結果
  ↓                         |
< 使用者是否按F5? > --是--> 產生報表
  |                         |
  否                        ↓
  |                     顯示報表
  ↓                         |
檢查輸入資料                 ↓
  |                     返回查詢條件畫面
  ↓
< 資料是否有效? > --否--> 顯示錯誤訊息
  |                         |
  是                        ↓
  |                     返回查詢條件畫面
  ↓
產生報表
  |
  ↓
顯示報表
  |
  ↓
返回查詢條件畫面
  |
  ↓
結束
```

## 初始化階段
程式啟動時，進行以下初始化操作：
1. 宣告參數列表，包括功能鍵標誌
2. 從本地資料區域(LDA)獲取使用者ID、日期等資訊
3. 初始化查詢條件畫面的預設值

```RPG
C           *ENTRY    PLIST
C           *IN03     PARM *IN03     IN03    1
C           *IN98     PARM *IN98     IN98    1
C           *IN97     PARM *IN97     IN97    1
C  N97N98             EXSR RTN010                     *INIT ENVIRM
```

## 主要處理流程

### 1. 查詢條件處理
SOR170主程式負責顯示查詢條件畫面，並接收用戶輸入的查詢條件：
- 訂單狀態（可選擇1-未處理、2-處理中、3-已完成等狀態）
- 訂單日期範圍
- 客戶代碼範圍
- 產品類別範圍
- 訂單號碼範圍
- 產品代碼範圍
- 業務員代碼範圍
- 報表格式（摘要或明細）
- 列印份數
- 印表機ID

```RPG
C           *IN03     DOUEQ'1'
C           *IN99     OREQ '0'
C                     EXFMTDSPD1
C                     MOVEA*ALL'0'   *IN,60
C           *IN03     IFEQ '0'
C           *IN04     IFEQ '1'
C                     EXSR RTNF4
C                     ELSE
C           *IN05     IFEQ '1'
C                     EXSR RTN200
C                     ELSE
C                     EXSR RTN100                     *CHECK SCR01?
C                     END
C                     END
C                     END
C                     END
```

### 2. 資料檢查
程式檢查用戶輸入的查詢條件是否有效：
- 檢查訂單狀態是否有效（1-9）
- 檢查日期範圍是否有效（起始日期不能大於結束日期）
- 檢查客戶代碼是否存在
- 檢查產品代碼是否存在
- 檢查業務員代碼是否存在
- 檢查其他查詢條件的有效性

```RPG
C           RTN100    BEGSR
C           SOST      IFLT '1'
C           SOST      ORGT '9'
C                     SETON                     639993
C                     END
C   99                GOTO END100
C                     Z-ADDSOST      SOST
C                     MOVELCNO       CNOS
```

### 3. 報表生成
當用戶按下F5鍵時，程式調用SOR1701子程式產生報表：
1. 傳遞查詢條件參數
2. SOR1701子程式根據查詢條件查詢相關資料
3. 生成報表並打印

```RPG
C           RTN200    BEGSR
C                     CALL 'SOR1701'
C                     PARM SOST      S0101I  1
C                     PARM SDTS      S0102I  80
C                     PARM SDTE      S0103I  80
C                     PARM CNOS      S0104I  60
C                     PARM CNOE      S0105I  60
C                     PARM PTCS      S0106I  20
C                     PARM PTCE      S0107I  20
C                     PARM SNOS      S0108I  100
C                     PARM SNOE      S0109I  100
C                     PARM PTNS      S0110I  150
C                     PARM PTNE      S0111I  150
C                     PARM SALS      S0112I  30
C                     PARM SALE      S0113I  30
C                     PARM $EVR      S0114I  1
C                     PARM $CPY      S0115I  30
C                     PARM $PRTID    S0116I  20
C                     PARM           S0101O  1
```

## 畫面說明

### 1. 查詢條件畫面(SCR001)
- 顯示查詢條件輸入欄位
- 支持F3（返回）、F4（查詢）、F5（產生報表）功能鍵
- 主要欄位：
  - 訂單狀態
  - 訂單日期範圍
  - 客戶代碼範圍
  - 產品類別範圍
  - 訂單號碼範圍
  - 產品代碼範圍
  - 業務員代碼範圍
  - 報表格式
  - 列印份數
  - 印表機ID

### 2. 報表格式
銷售訂單明細報表包含以下欄位：
- 報表標題：銷售訂單明細報表
- 報表日期：產生報表的日期
- 頁碼：報表頁碼
- 訂單號碼：訂單的唯一識別號碼
- 訂單日期：訂單建立日期
- 客戶代碼：客戶的代碼
- 客戶名稱：客戶的名稱
- 產品代碼：產品的代碼
- 產品名稱：產品的名稱
- 產品規格：產品的規格
- 訂購數量：訂購的產品數量
- 單位：數量的單位
- 單價：產品的單價
- 金額：訂購數量乘以單價的金額
- 交貨日期：預計交貨日期
- 訂單狀態：訂單的處理狀態
- 業務員：負責此訂單的業務員
- 備註：訂單的備註說明

報表可以按照以下方式排序：
1. 按訂單號碼排序：訂單號碼由小到大排序
2. 按客戶代碼排序：先按客戶代碼排序，再按訂單號碼排序
3. 按產品代碼排序：先按產品代碼排序，再按訂單號碼排序
4. 按業務員排序：先按業務員代碼排序，再按訂單號碼排序

## 資料檔案說明

### 1. 顯示檔案(SOR170D)
定義用戶界面的顯示格式，包括查詢條件畫面的欄位布局和功能鍵設置。

### 2. 印表檔案(SOR170P)
定義報表的打印格式，包括標題、明細和合計區域的布局。

### 3. 銷售訂單主檔(SOVMPF)
存儲銷售訂單的主要資訊，包括訂單編號、客戶編號、業務員編號、日期、狀態等。

### 4. 銷售訂單明細檔(SOVDPF)
存儲銷售訂單的商品明細資訊，包括商品編號、數量、單價、金額等。

### 5. 客戶主檔(CTMAPF)
存儲客戶資訊，用於獲取客戶名稱等資料。

### 6. 業務員主檔(MTMCPF)
存儲業務員資訊，用於獲取業務員名稱等資料。

### 7. 產品主檔(PTMAPF)
存儲產品資訊，用於獲取產品名稱、規格等資料。

## 程式邏輯

### 1. 查詢條件處理邏輯
1. 接收用戶輸入的查詢條件
2. 驗證查詢條件的有效性
3. 將查詢條件傳遞給報表生成子程式

### 2. 報表生成邏輯
1. 根據查詢條件查詢銷售訂單主檔和明細檔
2. 關聯客戶主檔、產品主檔和業務員主檔獲取相關資訊
3. 按照指定的排序方式排序資料
4. 生成報表並打印

## 錯誤處理

### 1. 查詢條件錯誤
- 如果用戶輸入的查詢條件無效，顯示錯誤訊息並返回查詢條件畫面

### 2. 查詢結果為空
- 如果查詢結果為空，顯示無資料訊息並返回查詢條件畫面

### 3. 打印錯誤
- 如果打印過程中發生錯誤，捕獲錯誤並顯示錯誤訊息

## 維護歷史
- **初始版本**：97/11/05，由A1546 VINCENT HO建立
- **最後修改**：100/03/20，由A1492 TERRY修改

## 系統整合
SOR170系列程式與以下系統模塊整合：
1. **銷售訂單管理系統**：使用銷售訂單主檔和明細檔
2. **客戶管理系統**：使用客戶主檔獲取客戶資訊
3. **商品管理系統**：使用產品主檔獲取產品資訊
4. **業務員管理系統**：使用業務員主檔獲取業務員資訊

## 使用說明

### 1. 執行程式
- 在命令行輸入`CALL SOR170`執行程式

### 2. 輸入查詢條件
- 在查詢條件畫面輸入所需的查詢條件
- 使用F4鍵可以查詢客戶、產品、業務員等資訊
- 按F5鍵產生報表

### 3. 查看報表
- 報表會自動打印到指定的印表機
- 可以指定列印份數

### 4. 結束程式
- 在任何畫面按F3鍵結束程式

## 效能考量
1. **查詢效率**：使用適當的查詢條件限制結果集大小，提高查詢效率
2. **記憶體使用**：優化資料處理邏輯，減少記憶體使用
3. **報表生成**：分批處理大量數據，避免一次性處理過多記錄
4. **打印效率**：優化打印格式，減少打印時間

## 安全考量
1. **權限控制**：檢查用戶權限，只允許授權用戶執行程式
2. **數據保護**：只顯示用戶有權訪問的數據
3. **審計追蹤**：記錄用戶的查詢操作，便於後續審計

## 未來擴展建議
1. **增加更多查詢條件**：如訂單類型、付款方式等
2. **支持更多報表格式**：如按日期分組、按業務員分組等
3. **增加圖表功能**：在報表中添加圖表，提高數據可視化效果
4. **增加匯出功能**：支持將報表匯出為Excel、PDF等格式
5. **增加批次處理功能**：支持定時自動生成報表

## 結論
SOR170系列程式是西祺企業經營管理資訊系統中銷售訂單管理模組的重要報表程式，提供了強大的銷售訂單明細報表功能。通過靈活的查詢條件和多樣的報表格式，幫助用戶有效地分析和管理銷售訂單數據，為企業決策提供重要支持。 