# R@S005程序規格說明

## 1. 基本信息

- **程序名稱**：R@S005
- **程序類型**：CL程序
- **庫**：QLIBSS
- **功能描述**：系統授權驗證程序
- **相關文件**：
  - R@S001（RPG程序）
  - R@S002（RPG程序）
  - R@S003（CL程序）
  - HELLO（CL程序）
  - R@DA01（數據區）
- **作者**：JEANNY LIN（A1062）
- **創建日期**：79/05/17

## 2. 程序概述

R@S005是一個系統授權驗證程序，用於檢查系統的合法性和授權狀態。該程序通過檢查CPU ID、機器型號、過期日期等信息，以及執行一系列複雜的計算和比較操作，來確定系統是否被授權使用。如果驗證失敗，程序會調用HELLO程序發送錯誤消息，然後強制用戶登出系統。

## 3. 程序流程

### 3.1 初始化階段

1. **參數定義**：
   ```
   - &FLAG：輸入參數，長度為8字符，必須為'GIANT/PT'
   - &CPUID：CPU ID，長度為8字符
   - &MODEL：機器型號，長度為4字符
   - &EXDATE：過期日期，長度為6字符
   - &SUBSYS：子系統信息，長度為80字符
   - &PTN01：模式1，長度為7字符
   - &PTN02：模式2，長度為4字符
   - &ETTIME：時間信息，長度為9字符
   - &RPTN01：返回模式1，長度為7字符
   - &RPTN02：返回模式2，長度為4字符
   - &ERRC：錯誤代碼，長度為1字符
   ```

2. **參數檢查**：
   ```
   檢查&FLAG是否等於'GIANT/PT'
   如果不等於，則設置&ERRC='8'並跳轉到ERR標籤
   ```

### 3.2 數據獲取階段

1. **從數據區獲取信息**：
   ```
   從R@DA01數據區獲取CPU ID、機器型號、過期日期、子系統信息和模式1
   RTVDTAARA DTAARA(R@DA01 (4 8)) RTNVAR(&CPUID)
   RTVDTAARA DTAARA(R@DA01 (12 4)) RTNVAR(&MODEL)
   RTVDTAARA DTAARA(R@DA01 (16 6)) RTNVAR(&EXDATE)
   RTVDTAARA DTAARA(R@DA01 (22 80)) RTNVAR(&SUBSYS)
   RTVDTAARA DTAARA(R@DA01 (102 7)) RTNVAR(&PTN01)
   ```

### 3.3 驗證階段

1. **調用R@S003驗證CPU ID、機器型號和過期日期**：
   ```
   CALL PGM(R@S003) PARM(&CPUID &MODEL &EXDATE &ERRC)
   如果&ERRC不等於'0'，則跳轉到ERR標籤
   ```

2. **調用R@S001計算模式1**：
   ```
   CALL PGM(R@S001) PARM(&CPUID &MODEL &EXDATE &SUBSYS &RPTN01)
   如果&PTN01不等於&RPTN01，則設置&ERRC='4'並跳轉到ERR標籤
   ```

3. **從LDA獲取模式2和時間信息**：
   ```
   RTVDTAARA DTAARA(*LDA (487 4)) RTNVAR(&PTN02)
   RTVDTAARA DTAARA(*LDA (491 9)) RTNVAR(&ETTIME)
   如果&PTN02或&ETTIME為空，則設置&ERRC='5'並跳轉到ERR標籤
   ```

4. **調用R@S002計算模式2**：
   ```
   CALL R@S002 PARM(&PTN01 &ETTIME &RPTN02)
   如果&PTN02不等於&RPTN02，則設置&ERRC='6'並跳轉到ERR標籤
   ```

### 3.4 結束階段

1. **正常結束**：
   ```
   如果所有驗證都通過，則跳轉到EOJ標籤
   ```

2. **錯誤處理**：
   ```
   ERR標籤：
   調用HELLO程序發送錯誤消息：CALL PGM(HELLO) PARM(&ERRC)
   強制用戶登出系統：SIGNOFF
   ```

## 4. 相關程序詳解

### 4.1 R@S001程序

R@S001是一個RPG程序，用於計算模式1（&RPTN01）。該程序接收CPU ID、機器型號、過期日期和子系統信息作為輸入，通過一系列複雜的計算操作生成一個7字符的模式值。

#### 4.1.1 主要功能

1. 將輸入參數轉換為數組
2. 執行數學運算和查表操作
3. 生成7字符的模式值作為輸出

### 4.2 R@S002程序

R@S002是一個RPG程序，用於計算模式2（&RPTN02）。該程序接收模式1和時間信息作為輸入，通過一系列數學運算生成一個4字符的模式值。

#### 4.2.1 主要功能

1. 將輸入參數轉換為數組
2. 執行乘法和加法運算
3. 生成4字符的模式值作為輸出

### 4.3 R@S003程序

R@S003是一個CL程序，用於驗證CPU ID、機器型號和過期日期。該程序從系統獲取實際的CPU ID和機器型號，並與輸入參數進行比較，同時檢查當前日期是否超過過期日期。

#### 4.3.1 主要功能

1. 驗證CPU ID：
   ```
   RTVSYSVAL SYSVAL(QSRLNBR) RTNVAR(&SCPUID)
   如果&CPUID不等於&SCPUID，則設置&ERRC='7'
   ```

2. 驗證機器型號：
   ```
   如果&MODEL不等於'@@@@'，則：
   RTVSYSVAL SYSVAL(QMODEL) RTNVAR(&SMODEL)
   如果&MODEL不等於&SMODEL，則設置&ERRC='1'
   ```

3. 驗證過期日期：
   ```
   RTVDTAARA DTAARA(*LDA (111 6)) RTNVAR(&LDATE)
   如果&EXDATE不等於'999999'且&LDATE大於&EXDATE，則設置&ERRC='2'
   ```

### 4.4 HELLO程序

HELLO是一個CL程序，用於發送錯誤消息。該程序接收錯誤代碼作為輸入，然後向系統操作員發送一條包含該錯誤代碼的消息。

#### 4.4.1 主要功能

```
SNDMSG MSG('ACCESS VIOLATION, ERROR-CODE =' *BCAT &HELLO) TOUSR(QSYSOPR)
```

## 5. 數據結構

### 5.1 R@DA01數據區

R@DA01是一個數據區，包含以下信息：

- 位置4-11：CPU ID（8字符）
- 位置12-15：機器型號（4字符）
- 位置16-21：過期日期（6字符）
- 位置22-101：子系統信息（80字符）
- 位置102-108：模式1（7字符）

### 5.2 本地數據區（LDA）

本地數據區包含以下信息：

- 位置111-116：當前日期（6字符）
- 位置487-490：模式2（4字符）
- 位置491-499：時間信息（9字符）

### 5.3 錯誤代碼

- '0'：正常，無錯誤
- '1'：機器型號不匹配
- '2'：系統已過期
- '4'：模式1驗證失敗
- '5'：模式2或時間信息為空
- '6'：模式2驗證失敗
- '7'：CPU ID不匹配
- '8'：輸入參數不正確

## 6. 程序特點

### 6.1 安全機制

R@S005程序實現了多層次的安全機制：

1. **參數檢查**：檢查輸入參數是否為特定值（'GIANT/PT'）
2. **硬件驗證**：驗證CPU ID和機器型號
3. **時間限制**：檢查系統是否過期
4. **模式驗證**：通過複雜的計算驗證模式1和模式2
5. **強制登出**：如果驗證失敗，強制用戶登出系統

### 6.2 加密算法

R@S005程序使用了多種加密技術：

1. **查表操作**：R@S001程序使用查表操作進行數據轉換
2. **數學運算**：R@S001和R@S002程序使用複雜的數學運算生成模式值
3. **多重驗證**：通過多個程序和多個步驟進行驗證，增加破解難度

### 6.3 錯誤處理

R@S005程序包含完善的錯誤處理機制：

1. **錯誤代碼**：使用不同的錯誤代碼表示不同類型的錯誤
2. **錯誤消息**：通過HELLO程序向系統操作員發送錯誤消息
3. **強制登出**：如果驗證失敗，強制用戶登出系統，防止未授權使用

## 7. 系統架構關係

### 7.1 與操作系統的關係

R@S005程序與AS/400操作系統緊密相關：

1. 使用RTVSYSVAL命令獲取系統值（CPU ID和機器型號）
2. 使用RTVDTAARA命令獲取數據區中的信息
3. 使用SIGNOFF命令強制用戶登出系統

### 7.2 與其他程序的關係

R@S005程序是一個控制程序，調用多個子程序完成驗證任務：

1. R@S003：驗證CPU ID、機器型號和過期日期
2. R@S001：計算模式1
3. R@S002：計算模式2
4. HELLO：發送錯誤消息

## 8. 安全分析

### 8.1 強度分析

R@S005程序的安全強度較高：

1. **多層次驗證**：通過多個步驟和多個程序進行驗證
2. **硬件綁定**：與特定的CPU ID和機器型號綁定
3. **時間限制**：設置過期日期，限制使用時間
4. **複雜算法**：使用複雜的計算和查表操作生成模式值

### 8.2 弱點分析

R@S005程序可能存在以下弱點：

1. **靜態密鑰**：模式值和驗證參數可能是靜態的，容易被破解
2. **明文存儲**：敏感信息可能以明文形式存儲在數據區中
3. **固定算法**：使用固定的算法，一旦被破解就失去保護作用

### 8.3 改進建議

1. **動態密鑰**：使用動態生成的密鑰，增加破解難度
2. **加密存儲**：對敏感信息進行加密存儲
3. **算法更新**：定期更新驗證算法，防止被破解
4. **網絡驗證**：增加網絡驗證機制，與授權服務器通信

## 9. 結論

R@S005程序是一個複雜的系統授權驗證程序，通過多層次的安全機制和複雜的計算算法，確保系統只能被授權用戶使用。該程序與CPU ID和機器型號綁定，並設置過期日期，有效地控制了系統的使用權限。

雖然該程序的安全強度較高，但仍存在一些潛在的弱點，如靜態密鑰、明文存儲和固定算法等。通過實施動態密鑰、加密存儲、算法更新和網絡驗證等改進措施，可以進一步提高程序的安全性。

總的來說，R@S005程序是一個典型的軟件授權保護系統，反映了早期AS/400系統的安全設計思想。隨著技術的發展和安全需求的提高，現代授權系統通常會採用更先進的加密技術和更複雜的驗證機制。