# SOVRPF 銷售訂單主檔規格書 (更新版)

## 1. 基本資訊

| 項目 | 說明 |
|------|------|
| 檔案名稱 | SOVRPF |
| 檔案類型 | 實體檔案 (Physical File) |
| 檔案用途 | 銷售訂單主檔 |
| 所屬系統 | 西祺企業管理資訊系統 - 銷售模組 |
| 相關程式 | VTA003, VTA004, VTA0171, VTB0041, VTR003C1, VTR0203, VTR0403 等 |
| 相關檔案 | SOVRLF01, SOVRLF02, SOVRLF03, SOVRLF04, SOVQPF |

## 2. 檔案結構

### 2.1 主要欄位定義

| 欄位名稱 | 資料類型 | 長度 | 說明 | 備註 |
|---------|---------|------|------|------|
| VR01 | CHAR | 2 | 訂單格式/類型 | 可能的值：'21', '22', '23', '25', '26', '27', '28', '29', '31', '32', '33', '34', '35', '36' |
| VR04 | CHAR | 6 | 訂單日期 (YYMMDD) | 例如：'220315' |
| VR05 | CHAR | 未知 | 客戶編號 | 從VTB0041.txt可見 |
| VR07 | DEC | 未知 | 付款條件代碼 | 從VTB0041.txt可見 |
| VR08 | CHAR | 1 | 稅別代碼 | 從VTB0041.txt可見 |
| VR09 | DEC | 未知 | 營業稅 | 從VTB0041.txt可見 |
| VR10 | CHAR | 未知 | 送貨地址 | 從VTB0041.txt可見 |
| VR11 | CHAR | 未知 | 備註 | 從VTB0041.txt可見 |
| VR12 | CHAR | 未知 | 負責人/會計 | 從VTB0041.txt可見 |
| VR13 | CHAR | 未知 | 加急標記 | 從VTB0041.txt可見 |
| VR14 | CHAR | 1 | 議價特殊標記 | 從VTB0041.txt可見，'1'表示特殊標記 |
| VR15 | CHAR | 未知 | 付款人編號 | 從VTB0041.txt可見 |
| VR16 | CHAR | 14 | 發票號碼 | 從VTA004.1.txt可見，分為VR161(2), VR162(8), VR163(4)三部分 |
| VR17 | DEC | 未知 | 發票金額 | 從VTB0041.txt可見 |
| VR18 | DEC | 未知 | 已付金額 | 從VTB0041.txt可見 |
| VR21 | DEC | 4,0 | 折讓金額 | 從VTA004D.txt可見，使用EDTCDE(2)編輯碼 |
| VR91 | CHAR | 2 | 客戶類型代碼 | 'W'/'WH'=倉庫, 'R'/'RM'=住宅, 'K'/'KN'=客戶, 'S'/'SC'=市場 |
| VR92 | CHAR | 1 | 辦事處代碼 | '1'=台北, '2'=台中, '3'=高雄 |
| VR96 | CHAR | 6 | 業務員/使用者代碼 | 使用者ID |
| VR97 | DEC | 8,0 | 建檔日期 | 從VTB0041.txt可見 |
| VR98 | TIME | 6,0 | 建檔時間 | 從VTB0041.txt可見 |
| VR99 | CHAR | 10 | 建檔者 | 從VTB0041.txt可見 |

### 2.2 衍生欄位

| 欄位名稱 | 資料類型 | 長度 | 說明 | 衍生方式 |
|---------|---------|------|------|---------|
| VR91L | CHAR | 1 | VR91的第一個字元 | MAPFLD('%SST(VR91 1 1)') |
| CVR04 | CHAR | 6 | 轉換後的日期格式 | MAPFLD 轉換 |
| CVR21 | CHAR | 4 | 轉換後的折讓金額 | 用於與W16連接形成W30 |
| W16 | CHAR | 16 | VR16+VR01組合 | 用於報表顯示 |
| W30 | CHAR | 30 | W16+CVR21組合 | 用於報表顯示 |

### 2.3 索引結構

根據程式碼分析，SOVRPF 檔案可能有以下索引：

1. **主索引**：
   - 欄位組合：VR91 + VR92 + VR04 + VR96
   - 用途：快速查詢特定客戶、辦事處、日期和業務員的訂單

2. **次要索引**：
   - 可能包含VR01、VR16、VR21等欄位組合
   - 用於特定查詢需求

## 3. 檔案操作

### 3.1 讀取操作

在RPG程式中，SOVRPF通常被定義為輸入檔案：

```
FSOVRPF  IF  E           K        DISK
```

主要讀取方式：
- 透過鍵值直接存取
- 透過OPNQRYF命令進行條件查詢

### 3.2 寫入操作

在VTB0041系列程式中，SOVRPF被定義為輸出檔案：

```
FSOVRPF  O   E           K        DISK
```

寫入操作通過WRITE指令完成：

```
WRITEVR0
```

### 3.3 更新操作

更新操作可能透過以下方式進行：
- 先讀取記錄，修改後再寫入
- 使用UPDATE指令直接更新

### 3.4 查詢操作

在CL程式中，常見的查詢方式：

```
OVRDBF     FILE(SOVRPF) SHARE(*YES)
OPNQRYF    FILE((SOVRPF)) QRYSLT('VR91L *EQ &DVR91 & VR92 *EQ %RANGE("' +
           *CAT &DVR92S *CAT '" "' *CAT &DVR92E *CAT +
           '") & CVR04 *EQ %RANGE("' *CAT &YMD6S +
           *CAT '" "' *CAT &YMD6E *CAT '") & VR96 +
           *EQ %RANGE("' *CAT &DVR96S *CAT '" "' +
           *CAT &DVR96E *CAT '") ')
```

常見查詢條件：
- 客戶類型 (VR91L)
- 辦事處範圍 (VR92)
- 日期範圍 (CVR04)
- 業務員範圍 (VR96)

## 4. 業務邏輯

### 4.1 訂單格式/類型定義 (VR01)

根據程式碼分析，VR01欄位可能有以下值和含義：

| 代碼 | 可能的含義 |
|------|----------|
| '21', '23', '25', '26' | 某種訂單類型，在VTA003中使用 |
| '22', '27' | 另一種訂單類型，在VTA003中有特殊處理 |
| '28', '29' | 特殊訂單類型，在VTA003中有特殊處理 |
| '31', '33', '35' | 某種訂單類型，在VTA004中使用 |
| '32', '34', '36' | 另一種訂單類型，在VTA004中有特殊處理 |

### 4.2 客戶類型定義 (VR91)

| 代碼 | 顯示名稱 | 說明 |
|------|---------|------|
| W/WH | 倉庫 | 倉庫類型的客戶 |
| R/RM | 住宅 | 住宅類型的客戶 |
| K/KN | 客戶 | 一般客戶 |
| S/SC | 市場 | 市場類型的客戶 |

### 4.3 辦事處定義 (VR92)

| 代碼 | 顯示名稱 | 說明 |
|------|---------|------|
| 1 | 台北 | 台北辦事處 |
| 2 | 台中 | 台中辦事處 |
| 3 | 高雄 | 高雄辦事處 |

### 4.4 發票號碼結構 (VR16)

VR16欄位長度為14，分為三個部分：
- VR161 (1-2位)：可能是發票類型或前綴
- VR162 (3-10位)：發票號碼主體
- VR163 (11-14位)：可能是後綴或其他識別碼

### 4.5 訂單處理流程

1. **訂單建立**：
   - 透過VTA004程式輸入訂單基本資訊
   - 系統將資料寫入SOVRPF主檔

2. **訂單明細管理**：
   - 訂單明細資料儲存在SOVRLF系列檔案中
   - 透過VR0欄位與主檔關聯

3. **訂單查詢**：
   - 透過VTA017C程式進行訂單查詢
   - 可按客戶類型、辦事處、日期範圍和業務員查詢

4. **報表生成**：
   - 透過VTR003C1等程式生成訂單相關報表

## 5. 系統整合

### 5.1 與其他檔案的關聯

| 關聯檔案 | 關聯欄位 | 關聯類型 | 說明 |
|---------|---------|---------|------|
| SOVRLF01 | VR0 → VRL1 | 一對多 | 訂單明細檔案1 |
| SOVRLF02 | VR0 → VRL1 | 一對多 | 訂單明細檔案2 |
| SOVRLF03 | VR0 → VRL3 | 一對多 | 訂單明細檔案3 |
| SOVRLF04 | VR0 → VRL3 | 一對多 | 訂單明細檔案4 |
| SOVQPF | 未知 | 未知 | 可能是查詢相關檔案 |

### 5.2 與其他模組的整合

1. **使用者管理模組**：
   - 透過業務員代碼(VR96)與使用者資訊關聯

2. **報表模組**：
   - 透過VTR系列程式生成報表

3. **庫存管理模組**：
   - 可能透過訂單明細與庫存資訊關聯

## 6. 程式使用情況

### 6.1 主要使用程式

| 程式名稱 | 程式類型 | 主要功能 |
|---------|---------|---------|
| VTA004 | RPG | 銷售訂單維護主程式 |
| VTA003 | RPG | 銷售訂單相關程式 |
| VTA0171 | RPG | 銷售訂單相關程式 |
| VTB0041 | RPG | 銷售訂單處理程式，負責寫入SOVRPF |
| VTA017C | CL | 銷售訂單查詢控制程式 |
| VTR003C1 | CL | 銷售訂單報表控制程式 |
| VTR0203 | RPG | 銷售訂單報表程式 |
| VTR0403 | RPG | 銷售訂單報表程式 |

### 6.2 程式使用方式

**VTA004 程式**：
- 定義SOVRPF為輸入檔案
- 使用鍵值列表KEYVR, KEYVR1, KEYVR3進行檔案存取
- 處理訂單基本資訊

**VTB0041 程式**：
- 定義SOVRPF為輸出檔案
- 負責將訂單資料寫入SOVRPF
- 設定各欄位的值並執行WRITEVR0

**VTA017C 程式**：
- 使用OVRDBF和OPNQRYF命令查詢SOVRPF
- 根據條件篩選訂單資料

**VTR003C1 程式**：
- 使用OVRDBF和OPNQRYF命令查詢SOVRPF
- 呼叫VTR0031和VTR0032程式處理報表

## 7. 資料安全與存取控制

### 7.1 共享設定

在多數程式中，SOVRPF檔案設定為共享模式：

```
OVRDBF FILE(SOVRPF) SHARE(*YES)
```

這允許多個程式同時存取檔案。

### 7.2 存取權限

根據程式碼分析，可能的存取權限控制：
- 透過使用者代碼(VR96)控制資料存取權限
- 可能有功能權限控制（如@A01欄位中的$ADD, $UPD, $DLT, $INQ）

## 8. 效能考量

### 8.1 索引使用

- 主索引用於直接存取特定訂單
- OPNQRYF命令中的KEYFLD(*FILE)設定使用檔案的主索引

### 8.2 查詢優化

- 使用OPNQRYF命令進行條件查詢
- 使用MAPFLD轉換欄位格式，優化查詢效能

## 9. 維護與擴展建議

### 9.1 潛在改進

1. **欄位標準化**：
   - 考慮將客戶類型和辦事處代碼標準化為固定長度

2. **索引優化**：
   - 根據常用查詢條件，可能需要增加次要索引

3. **程式整合**：
   - 考慮整合相似功能的程式，減少重複代碼

### 9.2 擴展方向

1. **Web介面整合**：
   - 開發Web介面存取SOVRPF資料

2. **報表功能強化**：
   - 增加更多分析報表功能

3. **與現代系統整合**：
   - 開發API允許現代系統存取SOVRPF資料

## 10. 結論

SOVRPF作為西祺企業管理資訊系統中的銷售訂單主檔，扮演著核心角色。它儲存了所有銷售訂單的基本資訊，並與多個相關檔案和程式緊密整合。透過本規格書的詳細說明，可以更全面地了解SOVRPF的結構、功能和使用方式，為系統維護和未來擴展提供參考。