# PIB001 月底存貨結轉程式詳細規格說明書

## 一、基本信息

- **程式ID**: PIB001
- **程式名稱**: 月底存貨結轉程式
- **作者**: AN MING HSIA
- **建立日期**: 03/05/94
- **更新日期**: 07/02/03 (僅複製"R"類型倉庫)
- **系統**: 物料管理系統
- **子系統**: 庫存子系統
- **功能**: 月底存貨結轉作業

## 二、程式概述

PIB001是西祺企業管理信息系統中的月底存貨結轉程式，負責在每月底將當月的庫存資料結轉至下一個月份，以便進行月度庫存管理和報表分析。該程式將當月的庫存資料從IMIAPF(庫存主檔)複製到IMIXPF(庫存歷史檔)和IMIYPF(庫存月結檔)，確保企業能夠保留完整的庫存歷史記錄，並進行月度庫存分析和比較。

## 三、系統架構

### 相關文件

1. **IMIYPF** - 庫存月結檔案（物理文件）
   - 用於存儲月底庫存結轉資料
   - 使用方式：輸出（O）
   - 主鍵：IY01（物料代碼）+ IY02（倉庫代碼）+ IY15（年月）

2. **IMIXPF** - 庫存歷史檔案（物理文件）
   - 用於存儲庫存歷史資料
   - 使用方式：更新（UF）
   - 主鍵：IX01（物料代碼）+ IX11（年月）

3. **IMI1PF** - 庫存主檔案（物理文件）
   - 用於存儲庫存基本資料
   - 使用方式：更新（UF）
   - 主鍵：I101（物料代碼）

4. **IMIAPF** - 庫存主檔案（物理文件）
   - 用於存儲庫存基本資料
   - 使用方式：讀取（IF）
   - 主鍵：IA01（物料代碼）

5. **MTMAPF** - 倉庫主檔案（物理文件）
   - 用於存儲倉庫基本資料
   - 使用方式：讀取（IF）
   - 主鍵：MA01（倉庫代碼）

6. **MTMHPF** - 倉庫歷史檔案（物理文件）
   - 用於存儲倉庫歷史資料
   - 使用方式：讀取（IF）
   - 主鍵：MH01（倉庫代碼）

7. **PIB001D** - 顯示文件
   - 用於用戶界面顯示和資料輸入
   - 包含一個記錄格式：DSPD1（主畫面）

### 資料結構

1. **庫存月結檔案(IMIYPF)主要欄位**:
   - **IY01**: 物料代碼（主鍵部分）
   - **IY02**: 倉庫代碼（主鍵部分）
   - **IY03**: 物料描述
   - **IY04**: 單位
   - **IY05**: 類別
   - **IY06**: 數量
   - **IY07**: 單價
   - **IY08**: 金額
   - **IY09**: 保留欄位
   - **IY10**: 保留欄位
   - **IY15**: 年月（主鍵部分）
   - **IYXX**: 建立日期
   - **IYYY**: 建立時間
   - **IYZZ**: 建立者ID

2. **庫存歷史檔案(IMIXPF)主要欄位**:
   - **IX01**: 物料代碼（主鍵部分）
   - **IX02**: 期初數量
   - **IX03**: 入庫數量
   - **IX04**: 出庫數量
   - **IX05**: 調整數量
   - **IX06**: 期初金額
   - **IX07**: 入庫金額
   - **IX08**: 出庫金額
   - **IX09**: 調整金額
   - **IX10**: 保留欄位
   - **IX11**: 年月（主鍵部分）
   - **IXXX**: 建立日期
   - **IXYY**: 建立時間
   - **IXZZ**: 建立者ID

## 四、程式流程

### 主要流程

1. **初始化（RTN010）**
   - 設定初始值和環境變數
   - 清空年月欄位
   - 獲取系統日期

2. **主畫面處理**
   - 顯示DSPD1畫面（年月輸入）
   - 接收用戶輸入（年月）
   - 處理功能鍵（F3=返回，F14=處理作業）
   - 執行畫面檢查（RTN100）
   - 根據檢查結果執行資料處理（RTN200）

3. **資料處理（RTN200）**
   - 檢查IMIXPF和IMIYPF是否已存在該年月的資料
   - 從IMIAPF和MTMAPF讀取資料
   - 執行資料轉換和計算
   - 寫入IMIXPF和IMIYPF檔案

### 詳細流程

1. **畫面檢查（RTN100）**
   - 檢查年月是否為空（錯誤代碼61/95）
   - 檢查月份是否有效（1-12之間，錯誤代碼61/93）
   - 將年月轉換為系統格式

2. **資料處理（RTN200）**
   - 檢查IMIXPF和IMIYPF是否已存在該年月的資料（錯誤代碼61/94）
   - 執行RTN210（處理IMIXPF）和RTN212（處理IMIYPF）

3. **IMIXPF處理（RTN211）**
   - 讀取MTMAPF檔案中的倉庫記錄
   - 對每個倉庫執行以下操作：
     - 檢查倉庫類型是否為'K'
     - 如果是，讀取相應的MTMHPF記錄
     - 設定IMIXPF的欄位值
     - 寫入IMIXPF檔案

4. **IMIYPF處理（RTN212）**
   - 讀取IMIAPF檔案中的庫存記錄
   - 對每個庫存記錄執行以下操作：
     - 檢查數量是否大於0
     - 如果是，設定IMIYPF的欄位值
     - 寫入IMIYPF檔案

## 五、畫面設計

### DSPD1畫面（主畫面）
- 顯示系統標題和日期
- 顯示當前用戶名稱
- 年月輸入欄位（格式：MM/YY）
- 操作說明區域
- 功能鍵：F3(返回主選單)、F14(處理作業)
- 錯誤訊息顯示區域

## 六、錯誤處理

程式包含完整的錯誤處理機制：

1. **輸入驗證**
   - 年月不能為空（錯誤代碼61/95）
   - 月份必須在1-12之間（錯誤代碼61/93）

2. **資料存在性檢查**
   - 檢查該年月的資料是否已存在於IMIXPF和IMIYPF（錯誤代碼61/94）

3. **錯誤訊息顯示**
   - 使用指示器控制錯誤訊息顯示
   - 錯誤訊息從訊息文件中獲取（PTMF和REMF）

## 七、安全與效能考量

### 安全考量
1. **資料完整性**
   - 檢查年月格式和有效性
   - 防止重複結轉同一月份的資料

2. **資料保護**
   - 記錄資料建立和修改資訊（日期、時間、用戶）
   - 防止未授權修改

3. **審計追蹤**
   - 記錄結轉作業的執行者和時間
   - 可追蹤月底結轉歷史

### 效能考量
1. **資料庫訪問優化**
   - 使用鍵值訪問提高效率（CHAIN和SETLL操作）
   - 批量處理庫存記錄

2. **畫面處理**
   - 使用指示器控制畫面顯示
   - 減少不必要的畫面重繪

3. **錯誤處理**
   - 及時檢查和報告錯誤
   - 防止無效操作消耗系統資源

## 八、程式調用關係

### 被調用程式
無直接調用其他程式

### 調用方式
1. **從系統主選單進入**
   - 通過PIM000程式調用
   - 參數：無

2. **通過命令行直接調用**
   - 命令：CALL PIB001
   - 參數：無

## 九、程式修改歷史

1. **初始版本**
   - 日期：03/05/94
   - 作者：AN MING HSIA
   - 描述：程式初始開發

2. **Y2K修改**
   - 日期：98/11/16
   - 作者：MICHELLE
   - 描述：為應對Y2K問題進行修改
   - 修改內容：日期格式處理和顯示

3. **倉庫類型限制**
   - 日期：07/02/03
   - 作者：MICHELLE
   - 描述：僅複製"R"類型倉庫
   - 修改內容：增加倉庫類型檢查

## 十、使用說明

### 操作流程
1. **進入程式**
   - 從系統主選單選擇月底結轉選項
   - 或直接輸入命令CALL PIB001

2. **主畫面操作**
   - 輸入要結轉的年月（格式：MM/YY）
   - 按F14處理作業
   - 按F3返回主選單

### 常見問題處理
1. **年月格式錯誤**
   - 確認輸入的月份在1-12之間
   - 確認年月格式正確

2. **資料已存在**
   - 確認該年月是否已經結轉過
   - 如需重新結轉，請先刪除該年月的資料

## 十一、系統整合

1. **與其他模塊的關係**
   - 作為物料管理系統的組件
   - 與庫存查詢和報表模塊密切配合
   - 為月度庫存分析提供基礎資料

2. **資料共享**
   - IMIXPF和IMIYPF檔案被多個程式共享使用
   - 結轉資料被庫存報表和查詢程式引用

3. **系統依賴**
   - 依賴庫存主檔案(IMIAPF)提供庫存資訊
   - 依賴倉庫主檔案(MTMAPF)提供倉庫資訊

## 十二、總結

PIB001是西祺企業管理信息系統中的月底存貨結轉程式，提供完整的月底庫存結轉功能。通過將當月的庫存資料結轉至歷史檔案和月結檔案，確保企業能夠保留完整的庫存歷史記錄，並進行月度庫存分析和比較。

程式設計遵循結構化編程原則，具有良好的模塊化和可維護性。通過清晰的流程控制和完善的錯誤處理，確保程式運行的穩定性和可靠性。同時，程式也考慮了效能和安全性，為系統提供高效、安全的月底結轉功能。

作為物料管理的基礎，PIB001程式的穩定運行對整個庫存管理系統的準確性和可用性至關重要。因此，在系統維護和升級過程中，應特別注意保持此程式的完整性和正確性。

2003年的修改限制了只處理"R"類型倉庫，這可能是為了優化處理效率或符合特定的業務需求。在使用此程式時，用戶應注意這一限制，確保所有需要結轉的倉庫都具有正確的類型設置。