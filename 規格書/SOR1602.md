# SOR1602 - 銷售訂單入庫報表格式1生成程式規格書

## 基本資訊
- **程式名稱**：SOR1602
- **程式類型**：RPG程式
- **所屬資料庫**：REPLIB
- **功能說明**：銷售訂單入庫報表格式1生成程式（按客戶分組）
- **相關檔案**：
  - REWF2（工作檔）
  - PA#HPF（客戶主檔）
  - PA#APF（客戶地址檔）
  - MTMELF（業務員主檔）
  - MTMCLF（公司別主檔）
  - SOR160P（打印文件）
- **系統名稱**：西祺企業經營管理資訊系統
- **子系統**：銷售訂單管理系統
- **作者**：EASON
- **建立日期**：96/09/06
- **最後修改日期**：00/11/08
- **功能特點**：負責生成按客戶分組的銷售訂單入庫報表，支持多種查詢條件和排序方式。

## 程式概述
SOR1602是西祺企業經營管理資訊系統中銷售訂單入庫報表程式(SOR160系列)的報表格式1生成程式，負責生成按客戶分組的銷售訂單入庫報表。該程式讀取由SOR160C1查詢程式生成的臨時工作檔中的數據，然後按照客戶分組生成報表，並輸出到打印文件SOR160P。

SOR1602作為報表生成程式，根據用戶的查詢條件和排序要求，生成格式化的報表，包括報表標題、查詢條件摘要、訂單明細資料、小計和合計資訊等，為用戶提供全面的銷售訂單入庫資訊。

## 程式流程圖
```
開始
  |
  ↓
初始化環境
  |
  ↓
讀取工作檔數據
  |
  ↓
<讀取成功?>──否──→ 返回錯誤訊息
  |                 |
  是                ↓
  |               返回控制程式
  ↓
生成報表標題
  |
  ↓
按客戶分組處理數據
  |
  ↓
<處理完成?>──否──→ 繼續處理下一筆數據
  |                 |
  是                ↓
  |               <-----------------
  ↓
生成報表合計
  |
  ↓
返回控制程式
```

## 初始化階段
程式啟動時，進行以下初始化操作：
1. 宣告變數和數據結構
2. 設置環境變數
3. 初始化報表格式
4. 讀取LDA區域中的查詢條件

```RPG
FREWF2   IP  E           K        DISK
FPA#HPF  IF  E           K        DISK
FPA#APF  IF  E           K        DISK
FMTMELF  IF  E           K        DISK
F            ME0                               KRENAMEME0L
FMTMCLF  IF  E           K        DISK
F            MC0                               KRENAMEMC0L
FSOR160P O   E             39     PRINTER
```

## 主要處理流程

### 1. 讀取工作檔數據
SOR1602首先讀取由SOR160C1查詢程式生成的臨時工作檔REWF2中的數據：
1. 讀取工作檔REWF2
2. 檢查數據有效性
3. 準備報表生成

```RPG
C                     EXSR RTN100                     *READE DETAIL
```

### 2. 生成報表標題
SOR1602生成報表標題和查詢條件摘要：
1. 輸出報表標題
2. 輸出查詢條件摘要
3. 輸出欄位標題

```RPG
C           RTN010    BEGSR
C*
C           COMP      IFEQ '1'
C                     MOVEL'出貨'  COMPC
C                     ELSE
C           COMP      IFEQ '2'
C                     MOVEL'退貨'  COMPC
C                     ELSE
C           COMP      IFEQ '3'
C                     MOVEL'調撥'  COMPC
C                     ELSE
C                     MOVEL'全部'  COMPC
C                     END
C                     END
C                     END
```

### 3. 按客戶分組處理數據
SOR1602按照客戶分組處理數據，生成報表明細：
1. 按客戶代碼分組
2. 計算每個客戶的小計
3. 輸出客戶明細資料

```RPG
C           RTN200    BEGSR
```

### 4. 生成報表合計
SOR1602生成報表合計資訊：
1. 計算總數量和總金額
2. 輸出合計資訊
3. 輸出報表頁腳

```RPG
C           RTN500    BEGSR
```

## 錯誤處理

### 1. 工作檔讀取錯誤
- 如果工作檔REWF2讀取過程中發生錯誤，捕獲錯誤並返回錯誤訊息

### 2. 客戶主檔讀取錯誤
- 如果客戶主檔PA#HPF讀取過程中發生錯誤，捕獲錯誤並繼續處理

### 3. 業務員主檔讀取錯誤
- 如果業務員主檔MTMELF讀取過程中發生錯誤，捕獲錯誤並繼續處理

## 維護歷史
- **M001**：98.10.21，由MICHELLE進行Y2K修改
- **M002**：99.11.08，增加客戶群組選項
- **M003**：00.11.08，增加大盤商品功能

## 系統整合
SOR1602與以下程式整合：
1. **SOR160C**：控制程式，調用SOR1602生成報表
2. **SOR160C1**：數據查詢程式，提供要生成報表的數據
3. **SOR160P**：打印文件，定義報表格式

## 使用說明

### 1. 程式調用
- SOR1602不直接由用戶調用，而是由控制程式SOR160C調用
- 用戶在主程式SOR160的查詢條件畫面選擇報表格式1

### 2. 報表格式
- 報表格式1按客戶分組，顯示每個客戶的訂單明細
- 報表包含標題、查詢條件摘要、訂單明細、小計和合計資訊

### 3. 排序方式
- 報表按客戶代碼排序，然後按訂單號碼排序

## 效能考量
1. **數據處理優化**：優化數據處理邏輯，提高報表生成效率
2. **記憶體使用**：合理管理記憶體使用，避免佔用過多系統資源
3. **打印優化**：優化打印格式，減少打印時間

## 安全考量
1. **數據訪問控制**：確保只處理用戶有權訪問的數據
2. **報表訪問控制**：確保只有授權用戶才能生成報表
3. **敏感資訊保護**：確保報表中不包含敏感資訊

## 未來擴展建議
1. **增加更多報表格式**：支持更多類型的報表格式
2. **增強排序功能**：提供更多的排序選項
3. **增加圖表功能**：在報表中添加圖表，提高數據可視化效果
4. **增加匯出功能**：支持將報表匯出為多種格式

## 結論
SOR1602作為銷售訂單入庫報表程式(SOR160系列)的報表格式1生成程式，負責生成按客戶分組的銷售訂單入庫報表。該程式的設計遵循清晰易讀和可維護性原則，生成格式化的報表，包括報表標題、查詢條件摘要、訂單明細資料、小計和合計資訊等，為用戶提供全面的銷售訂單入庫資訊，幫助用戶有效地分析和管理銷售訂單數據。 