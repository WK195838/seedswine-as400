# SOR160系列 - 銷售訂單入庫報表程式規格書

## 基本資訊
- **程式名稱**：SOR160系列（SOR160、SOR160C、SOR160C1、SOR160C2、SOR1602、SOR1603、SOR160D、SOR160P）
- **程式類型**：RPG程式、CL程式、DDS顯示文件、DDS打印文件
- **所屬資料庫**：REPLIB
- **功能說明**：銷售訂單入庫報表程式
- **相關檔案**：SOR160D（顯示文件）、SOR160P（打印文件）、SOSCPF（銷售訂單主檔）、SOSGPF（銷售訂單商品檔）、SOSNPF（銷售訂單備註檔）、REWF1/REWF2（工作檔）、RES18WF（工作檔）
- **系統名稱**：西祺企業經營管理資訊系統
- **子系統**：銷售訂單管理系統
- **作者**：EASON
- **建立日期**：96/09/06
- **最後修改日期**：00/11/08
- **功能特點**：提供銷售訂單入庫報表的查詢、列印和匯出功能，支持多種查詢條件和報表格式。

## 程式概述
SOR160系列程式是西祺企業經營管理資訊系統中銷售訂單管理子系統的重要組成部分，主要用於生成銷售訂單入庫報表。該系列程式允許用戶根據不同的查詢條件（如公司別、客戶編號、業務員、日期範圍等）查詢銷售訂單資料，並生成詳細的報表。報表可以按照不同的處理方式（出貨、退貨、調撥或全部）進行篩選，並支持列印和匯出到PC功能。

SOR160系列程式由多個子程式組成，各自負責不同的功能：
- **SOR160**：主程式，負責用戶界面交互和參數設置
- **SOR160C**：控制程式，負責調用其他子程式和整體流程控制
- **SOR160C1**：負責數據查詢和臨時文件處理
- **SOR160C2**：負責PC匯出功能
- **SOR1602**：負責報表格式1的生成
- **SOR1603**：負責報表格式2的生成
- **SOR160D**：顯示文件，定義用戶界面
- **SOR160P**：打印文件，定義報表格式

## 程式流程圖
```
開始
  |
  ↓
初始化
  |
  ↓
顯示查詢條件畫面(SCR001)
  |
  ↓
用戶輸入查詢條件
  |
  ↓
驗證查詢條件
  |
  ↓
<條件有效?>──否──→ 顯示錯誤訊息
  |                    |
  是                   ↓
  |                  返回查詢條件畫面
  ↓
執行查詢
  |
  ↓
<有查詢結果?>──否──→ 顯示無資料訊息
  |                    |
  是                   ↓
  |                  返回查詢條件畫面
  ↓
生成報表
  |
  ↓
<用戶選擇PC匯出?>──是──→ 執行PC匯出
  |                        |
  否                       ↓
  |                      返回查詢條件畫面
  ↓
列印報表
  |
  ↓
返回查詢條件畫面
  |
  ↓
<用戶按F3?>──是──→ 結束程式
  |                 |
  否                ↓
  |               結束
  ↓
繼續處理
```

## 初始化階段
程式啟動時，進行以下初始化操作：
1. 讀取LDA區域中的參數值
2. 設置默認查詢條件
3. 初始化顯示文件和打印文件
4. 檢查用戶權限

```RPG
C           *ENTRY    PLIST
C           *IN03     PARM *IN03     IN03    1
C           *IN98     PARM *IN98     IN98    1
C           *IN97     PARM *IN97     IN97    1
```

## 主要處理流程

### 1. 查詢條件處理
SOR160主程式負責顯示查詢條件畫面(SCR001)，並接收用戶輸入的查詢條件：
- 處理方式（出貨、退貨、調撥或全部）
- 業務員編號範圍
- 狀態範圍
- 部門範圍
- 客戶編號範圍
- 商品編號範圍
- 日期範圍（出貨日期或確認日期）

### 2. 查詢執行
SOR160C1負責根據用戶輸入的查詢條件執行查詢：
1. 創建臨時工作檔
2. 使用OPNQRYF指令查詢銷售訂單主檔(SOSCPF)
3. 將查詢結果寫入臨時工作檔

```CL
OPNQRYF    FILE((SOSCPF)) QRYSLT('SC01A *EQ %RANGE("' +
           *CAT &COMPS *CAT '" "' *CAT &COMPE *CAT +
           '") &  SC01B *NE "K" & SC45 *EQ %RANGE("' +
           *CAT &DSC45S *CAT '" "' *CAT &DSC45E *CAT +
           '") & SC33                            +
           *EQ %RANGE("' *CAT &DSC33S *CAT '" "' +
           *CAT &DSC33E *CAT '")            +
            & SC34                            +
           *EQ %RANGE("' *CAT &DSC34S *CAT '" "' +
           *CAT &DSC34E *CAT '")            +
           & MSC08 *EQ %RANGE("' *CAT &YMD8S *CAT +
           '" "' *CAT &YMD8E *CAT '") & SC13 *NE "*" +
           & SC35 *NE "T" & SC29 *NE " " ')
```

### 3. 報表生成
根據用戶選擇的報表格式，調用SOR1602或SOR1603生成報表：
- SOR1602：生成按客戶分組的報表
- SOR1603：生成按商品分組的報表

### 4. PC匯出功能
如果用戶選擇PC匯出功能，SOR160C2負責將報表數據匯出到PC：
1. 讀取PYWWPF文件中的PC命令
2. 使用STRPCCMD執行PC命令，將數據傳輸到PC

```CL
CHGVAR     VAR(&CMDTXT) VALUE('STRPCCMD PCCMD('||+
&WW02)
CHGVAR     VAR(&CMDLEN) VALUE(160)
STRPCO
CALL       PGM(QCMDEXC) PARM(&CMDTXT &CMDLEN)
```

## 畫面說明

### 1. 查詢條件畫面(SCR001)
- 顯示查詢條件輸入欄位
- 支持F3（結束）、F4（幫助）、F7（PC匯出）功能鍵
- 主要欄位：
  - 處理方式（出貨、退貨、調撥或全部）
  - 業務員編號範圍
  - 狀態範圍
  - 部門範圍
  - 客戶編號範圍
  - 商品編號範圍
  - 日期範圍（出貨日期或確認日期）

### 2. 報表格式
報表包含以下主要內容：
- 報表標題
- 查詢條件摘要
- 訂單明細資料（包括訂單編號、客戶資料、商品資料、數量、金額等）
- 小計和合計資訊
- 頁碼和日期時間資訊

## 資料檔案說明

### 1. 顯示文件(SOR160D)
定義用戶界面的顯示格式，包括查詢條件畫面的欄位布局和功能鍵設置。

### 2. 打印文件(SOR160P)
定義報表的打印格式，包括標題、明細和合計區域的布局。

### 3. 銷售訂單主檔(SOSCPF)
存儲銷售訂單的主要資訊，包括訂單編號、客戶編號、業務員編號、日期、狀態等。

### 4. 銷售訂單商品檔(SOSGPF)
存儲銷售訂單的商品明細資訊，包括商品編號、數量、單價、金額等。

### 5. 銷售訂單備註檔(SOSNPF)
存儲銷售訂單的備註資訊。

### 6. 工作檔(REWF1/REWF2/RES18WF)
用於臨時存儲查詢結果和報表數據。

## 程式邏輯

### 1. 查詢條件處理邏輯
1. 接收用戶輸入的查詢條件
2. 驗證查詢條件的有效性
3. 將查詢條件存儲在LDA區域中，供其他子程式使用

### 2. 查詢執行邏輯
1. 根據查詢條件構建OPNQRYF指令
2. 執行查詢並將結果寫入臨時工作檔
3. 檢查查詢結果是否為空

### 3. 報表生成邏輯
1. 讀取臨時工作檔中的數據
2. 根據報表格式要求處理數據
3. 計算小計和合計
4. 生成報表

### 4. PC匯出邏輯
1. 讀取PC命令
2. 執行PC命令，將數據傳輸到PC

## 錯誤處理

### 1. 查詢條件錯誤
- 如果用戶輸入的查詢條件無效，顯示錯誤訊息並返回查詢條件畫面

### 2. 查詢結果為空
- 如果查詢結果為空，顯示無資料訊息並返回查詢條件畫面

### 3. PC匯出錯誤
- 如果PC匯出過程中發生錯誤，捕獲錯誤並顯示錯誤訊息

## 維護歷史
- **M001**：98.10.21，由MICHELLE進行Y2K修改
- **M002**：99.11.08，增加客戶群組選項
- **M003**：00.11.08，增加大盤商品功能

## 系統整合
SOR160系列程式與以下系統模塊整合：
1. **銷售訂單管理系統**：使用銷售訂單主檔、商品檔和備註檔
2. **客戶管理系統**：使用客戶主檔獲取客戶資訊
3. **商品管理系統**：使用商品主檔獲取商品資訊
4. **業務員管理系統**：使用業務員主檔獲取業務員資訊

## 使用說明

### 1. 執行程式
- 在命令行輸入`CALL SOR160`執行程式

### 2. 輸入查詢條件
- 在查詢條件畫面輸入所需的查詢條件
- 按Enter鍵執行查詢

### 3. 查看報表
- 查詢執行後，系統會自動生成報表
- 報表會顯示在打印預覽畫面或直接打印

### 4. PC匯出
- 在查詢條件畫面按F7鍵執行PC匯出功能
- 系統會將報表數據匯出到PC

### 5. 結束程式
- 在任何畫面按F3鍵結束程式

## 效能考量
1. **查詢效率**：使用OPNQRYF指令進行高效查詢，並使用適當的查詢條件限制結果集大小
2. **記憶體使用**：使用臨時工作檔存儲中間結果，避免過多的記憶體使用
3. **報表生成**：分批處理大量數據，避免一次性處理過多記錄
4. **PC匯出**：優化數據傳輸過程，減少網絡負載

## 安全考量
1. **權限控制**：檢查用戶權限，只允許授權用戶執行程式
2. **數據保護**：只顯示用戶有權訪問的數據
3. **審計追蹤**：記錄用戶的查詢操作，便於後續審計

## 未來擴展建議
1. **增加更多查詢條件**：如訂單類型、付款方式等
2. **支持更多報表格式**：如按日期分組、按業務員分組等
3. **增強PC匯出功能**：支持更多文件格式，如Excel、PDF等
4. **增加圖表功能**：在報表中添加圖表，提高數據可視化效果
5. **增加批次處理功能**：支持定時自動生成報表

## 結論
SOR160系列程式是西祺企業經營管理資訊系統中銷售訂單管理子系統的重要組成部分，提供了強大的銷售訂單入庫報表功能。通過靈活的查詢條件、多樣的報表格式和便捷的PC匯出功能，幫助用戶有效地分析和管理銷售訂單數據，為企業決策提供重要支持。 