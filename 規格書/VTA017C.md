# VTA017C 出貨進貨查詢列印程式規格說明書

## 1. 基本信息

- **程式名稱**：VTA017C
- **程式類型**：CL程式
- **系統**：西祺企業管理資訊系統
- **子系統**：西祺產銷模組
- **功能**：提供出貨和進貨資料的查詢和列印功能
- **建立日期**：不詳
- **更新日期**：不詳
- **作者**：Michelle

## 2. 程式結構

### 2.1 程式組成
- **VTA017C.txt**：主控制程式（CL程式）
- **VTA017.txt**：顯示和參數處理程式（RPG程式）
- **VTA0171.txt**：資料處理和報表生成程式（RPG程式）
- **VTA017D.txt**：顯示檔案
- **VTA017P.txt**：印表檔案

### 2.2 檔案引用
- **輸入檔案**：
  - `SOVRPF`：銷售訂單主檔
  - `SOVQPF`：進貨訂單主檔
  - `PA#BPF`：客戶主檔

- **輸出檔案**：
  - `VATPF`：臨時工作檔
  - `SOVTPF`：臨時工作檔

### 2.3 參數定義
- `&IN03`：結束指示器
- `&IN14`：處理指示器
- `&IN98`：狀態指示器
- `&DVP91`：客戶類型（W/R/K/S）
- `&YMD6S`/`&YMD6E`：查詢日期範圍（YYMMDD格式）
- `&YMD8S`/`&YMD8E`：查詢日期範圍（YYYYMMDD格式）
- `&FNAME`：輸出檔案名稱

## 3. 程式流程

### 3.1 主程式流程（VTA017C）

1. **初始化**：
   - 調用VTA017程式獲取查詢參數
   - 如果用戶按下F3，則返回上一層
   - 如果用戶按下F14，則進行處理

2. **查詢處理**：
   - 從LDA獲取用戶ID、日期和客戶類型等參數
   - 設置SOVRPF檔案的共享模式
   - 使用OPNQRYF指令查詢符合條件的銷售訂單資料
   - 設置SOVQPF檔案的共享模式
   - 使用OPNQRYF指令查詢符合條件的進貨訂單資料

3. **資料處理**：
   - 清除臨時工作檔VATPF和SOVTPF
   - 設置檔案的共享模式
   - 調用VTA0171程式處理資料並生成報表

4. **結束處理**：
   - 關閉查詢檔案
   - 設置輸出檔案名稱
   - 刪除檔案覆蓋

### 3.2 參數處理流程（VTA017）

1. **初始化畫面**：
   - 設置初始參數值
   - 顯示查詢條件畫面

2. **參數驗證**：
   - 檢查日期範圍的有效性
   - 檢查客戶類型的有效性

3. **參數傳遞**：
   - 將參數值存入LDA
   - 設置處理指示器

### 3.3 資料處理流程（VTA0171）

1. **讀取資料**：
   - 從SOVRPF讀取銷售訂單資料
   - 從SOVQPF讀取進貨訂單資料
   - 從PA#BPF讀取客戶資料

2. **資料整理**：
   - 將資料寫入臨時工作檔VATPF和SOVTPF
   - 進行必要的資料轉換和計算

3. **報表生成**：
   - 使用VTA017P印表檔案格式
   - 生成出貨和進貨資料的報表

## 4. 功能說明

### 4.1 查詢功能
- **日期範圍查詢**：
  - 允許用戶指定查詢的起始和結束日期（MM/YY格式）
  - 系統將日期轉換為適當的格式進行查詢

- **客戶類型篩選**：
  - 允許用戶選擇特定的客戶類型（W/R/K/S）
  - W：批發客戶
  - R：零售客戶
  - K：可能是特殊客戶
  - S：可能是供應商

### 4.2 報表功能
- **出貨報表**：
  - 顯示指定日期範圍內的出貨資料
  - 包含客戶資訊、訂單資訊和產品資訊

- **進貨報表**：
  - 顯示指定日期範圍內的進貨資料
  - 包含供應商資訊、訂單資訊和產品資訊

- **匯出功能**：
  - 將報表資料匯出到檔案
  - 檔案名稱存儲在FNAME參數中

## 5. 資料檔案說明

### 5.1 SOVRPF（銷售訂單主檔）
- **主要欄位**：
  - `VR01`：訂單類型
  - `VR04`：訂單日期
  - `VR16`：發票號碼
  - `VR91`：客戶類型
  - 其他訂單相關欄位

### 5.2 SOVQPF（進貨訂單主檔）
- **主要欄位**：
  - `VQ01`：訂單類型
  - `VQ04`：訂單日期
  - `VQ16`：發票號碼
  - `VQ91`：供應商類型
  - 其他訂單相關欄位

### 5.3 PA#BPF（客戶主檔）
- **主要欄位**：
  - 客戶代碼
  - 客戶名稱
  - 客戶地址
  - 聯絡資訊
  - 其他客戶相關欄位

### 5.4 VATPF（臨時工作檔）
- 用於存儲處理後的出貨資料
- 用於生成報表

### 5.5 SOVTPF（臨時工作檔）
- 用於存儲處理後的進貨資料
- 用於生成報表

## 6. 畫面說明

### 6.1 主查詢畫面（VTA017D）
- **標題**：出貨進貨查詢列印
- **查詢條件**：
  - 客戶類型（W/R/K/S）
  - 日期範圍（MM/YY - MM/YY）
- **功能鍵**：
  - F3：返回上一層
  - F14：處理作業
- **訊息區域**：
  - 顯示錯誤訊息和提示
  - 顯示檔案匯出資訊

### 6.2 報表格式（VTA017P）
- **標題**：產銷系統出貨進貨明細表
- **報表頭部**：
  - 日期和時間
  - 用戶ID
  - 客戶類型
  - 頁碼
- **報表內容**：
  - 訂單資訊
  - 客戶/供應商資訊
  - 產品資訊
  - 金額資訊

## 7. 相關程式

### 7.1 直接相關程式
- **VTA017**：顯示和參數處理程式
- **VTA0171**：資料處理和報表生成程式
- **VTCLEAR**：清除檔案程式

### 7.2 間接相關程式
- **VTM000C**：西祺產銷主選單程式
- **VTA004**：銷售訂單人工輸入程式
- **VTA003**：進貨訂單人工輸入程式
- **VTB004C**：銷售訂單查詢程式

## 8. 業務邏輯

### 8.1 查詢邏輯
- 使用OPNQRYF指令進行高效查詢
- 根據日期範圍和客戶類型篩選資料
- 使用MAPFLD函數處理欄位映射

### 8.2 資料處理邏輯
- 讀取銷售訂單和進貨訂單資料
- 關聯客戶和供應商資訊
- 計算合計金額和數量
- 整理資料用於報表生成

### 8.3 報表生成邏輯
- 使用印表檔案格式生成報表
- 按照特定順序排列資料
- 計算小計和總計
- 生成匯出檔案

## 9. 修改歷史

### 9.1 VTA0171程式的修改記錄
- **M001**（06.12.02）：修改以支援年份為民國年的進貨發票和西元年的出貨發票
- **M001**（06.26.02）：增加格式處理
- **M004**（07.26.04）：處理多種發票格式（29）

## 10. 使用說明

### 10.1 操作步驟
1. 從西祺產銷主選單選擇「出貨進貨查詢列印」選項
2. 輸入查詢條件（客戶類型和日期範圍）
3. 按F14處理作業
4. 系統生成報表並顯示檔案匯出資訊
5. 可以查看報表或下載匯出的檔案

### 10.2 注意事項
- 日期範圍格式為MM/YY
- 客戶類型必須是W、R、K或S之一
- 報表檔案會存儲在REFLIB/VAT001中
- 匯出檔案的名稱會顯示在畫面上

## 11. 維護建議

### 11.1 代碼優化
- 使用更現代的查詢技術替代OPNQRYF
- 簡化檔案處理邏輯
- 改善錯誤處理機制

### 11.2 功能擴展
- 增加更多的查詢條件（如產品代碼、訂單類型等）
- 提供更多的報表格式選項
- 增加圖形化的資料分析功能

### 11.3 界面改進
- 更新為圖形用戶界面
- 提供更直觀的日期選擇控制
- 增加線上說明功能

### 11.4 系統整合
- 與Web界面整合
- 提供資料匯出到Excel等格式的功能
- 與其他報表系統整合

## 12. 總結

VTA017C是西祺企業管理資訊系統中的出貨進貨查詢列印程式，提供了強大的查詢和報表功能，幫助用戶快速獲取和分析出貨和進貨資料。該程式使用OPNQRYF技術進行高效查詢，並生成詳細的報表，是西祺產銷模組中的重要工具。

程式由多個組件組成，包括控制程式、顯示程式、資料處理程式和報表生成程式，它們協同工作，提供完整的功能。通過指定客戶類型和日期範圍，用戶可以獲取特定條件下的出貨和進貨資料，幫助企業進行銷售分析和庫存管理。