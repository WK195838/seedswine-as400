# SOR160C - 銷售訂單入庫報表控制程式規格書

## 基本資訊
- **程式名稱**：SOR160C
- **程式類型**：CL程式
- **所屬資料庫**：REPLIB
- **功能說明**：銷售訂單入庫報表控制程式
- **相關檔案**：
  - SOR160C1（查詢程式）
  - SOR1602（報表格式1生成程式）
  - SOR1603（報表格式2生成程式）
  - REWF2（工作檔）
  - SOR160D（顯示檔）
- **系統名稱**：西祺企業經營管理資訊系統
- **子系統**：銷售訂單管理系統
- **作者**：EASON
- **建立日期**：96/09/06
- **最後修改日期**：00/11/08
- **功能特點**：負責協調銷售訂單入庫報表的查詢和生成流程，支持多種報表格式和查詢條件。

## 程式概述
SOR160C是西祺企業經營管理資訊系統中銷售訂單入庫報表程式(SOR160系列)的控制程式，負責協調整個報表生成流程。該程式接收用戶的查詢條件，調用查詢程式SOR160C1獲取數據，然後根據用戶選擇的報表格式調用相應的報表生成程式（SOR1602或SOR1603）生成報表。

SOR160C作為控制程式，負責整個報表生成流程的協調和控制，確保數據查詢和報表生成的順利進行，為用戶提供準確、全面的銷售訂單入庫資訊。

## 程式流程圖
```
開始
  |
  ↓
接收查詢條件
  |
  ↓
調用SOR160C1查詢數據
  |
  ↓
<查詢成功?>──否──→ 返回錯誤訊息
  |                 |
  是                ↓
  |               返回主程式
  ↓
<報表格式選擇>
  |
  ├──格式1──→ 調用SOR1602生成報表
  |
  └──格式2──→ 調用SOR1603生成報表
  |
  ↓
<報表生成成功?>──否──→ 返回錯誤訊息
  |                     |
  是                    ↓
  |                   返回主程式
  ↓
返回主程式
```

## 初始化階段
程式啟動時，進行以下初始化操作：
1. 宣告變數和參數
2. 設置環境變數
3. 接收來自主程式的查詢條件參數

```CL
PGM        PARM(&COMP &CUST &PROD &SLMN &SDATE &EDATE &RPTF &CGRP &PGRP)
DCL        VAR(&COMP) TYPE(*CHAR) LEN(1)
DCL        VAR(&CUST) TYPE(*CHAR) LEN(6)
DCL        VAR(&PROD) TYPE(*CHAR) LEN(15)
DCL        VAR(&SLMN) TYPE(*CHAR) LEN(4)
DCL        VAR(&SDATE) TYPE(*CHAR) LEN(8)
DCL        VAR(&EDATE) TYPE(*CHAR) LEN(8)
DCL        VAR(&RPTF) TYPE(*CHAR) LEN(1)
DCL        VAR(&CGRP) TYPE(*CHAR) LEN(2)
DCL        VAR(&PGRP) TYPE(*CHAR) LEN(2)
```

## 主要處理流程

### 1. 接收查詢條件
SOR160C接收來自主程式的查詢條件參數：
1. 交易類型（&COMP）
2. 客戶代碼（&CUST）
3. 商品代碼（&PROD）
4. 業務員代碼（&SLMN）
5. 開始日期（&SDATE）
6. 結束日期（&EDATE）
7. 報表格式（&RPTF）
8. 客戶群組（&CGRP）
9. 商品群組（&PGRP）

### 2. 調用查詢程式
SOR160C調用查詢程式SOR160C1獲取數據：
1. 將查詢條件參數傳遞給SOR160C1
2. 調用SOR160C1執行查詢
3. 檢查查詢結果

```CL
CALL       PGM(SOR160C1) PARM(&COMP &CUST &PROD &SLMN &SDATE &EDATE &CGRP &PGRP)
MONMSG     MSGID(CPF0000) EXEC(GOTO CMDLBL(ERROR))
```

### 3. 根據報表格式調用報表生成程式
SOR160C根據用戶選擇的報表格式調用相應的報表生成程式：
1. 如果報表格式為1，調用SOR1602生成按客戶分組的報表
2. 如果報表格式為2，調用SOR1603生成按商品分組的報表

```CL
IF         COND(&RPTF *EQ '1') THEN(DO)
   CALL       PGM(SOR1602)
   MONMSG     MSGID(CPF0000) EXEC(GOTO CMDLBL(ERROR))
ENDDO
IF         COND(&RPTF *EQ '2') THEN(DO)
   CALL       PGM(SOR1603)
   MONMSG     MSGID(CPF0000) EXEC(GOTO CMDLBL(ERROR))
ENDDO
```

### 4. 清理工作檔
SOR160C在報表生成完成後清理工作檔：
1. 刪除臨時工作檔REWF2
2. 釋放資源

```CL
CLRPFM     FILE(REWF2)
MONMSG     MSGID(CPF0000)
```

## 錯誤處理

### 1. 查詢程式調用錯誤
- 如果調用查詢程式SOR160C1過程中發生錯誤，捕獲錯誤並返回錯誤訊息

### 2. 報表生成程式調用錯誤
- 如果調用報表生成程式（SOR1602或SOR1603）過程中發生錯誤，捕獲錯誤並返回錯誤訊息

### 3. 工作檔清理錯誤
- 如果清理工作檔過程中發生錯誤，捕獲錯誤並繼續處理

```CL
ERROR:     SNDPGMMSG  MSG('銷售訂單入庫報表生成失敗') MSGTYPE(*ESCAPE)
ENDPGM
```

## 維護歷史
- **M001**：98.10.21，由MICHELLE進行Y2K修改
- **M002**：99.11.08，增加客戶群組選項
- **M003**：00.11.08，增加大盤商品功能

## 系統整合
SOR160C與以下程式整合：
1. **SOR160**：主程式，調用SOR160C生成報表
2. **SOR160C1**：數據查詢程式，提供要生成報表的數據
3. **SOR1602**：報表格式1生成程式，生成按客戶分組的報表
4. **SOR1603**：報表格式2生成程式，生成按商品分組的報表

## 使用說明

### 1. 程式調用
- SOR160C不直接由用戶調用，而是由主程式SOR160調用
- 用戶在主程式SOR160的查詢條件畫面輸入查詢條件並選擇報表格式

### 2. 參數說明
- **&COMP**：交易類型（1=出貨，2=退貨，3=調撥，空白=全部）
- **&CUST**：客戶代碼（空白=全部）
- **&PROD**：商品代碼（空白=全部）
- **&SLMN**：業務員代碼（空白=全部）
- **&SDATE**：開始日期（YYYYMMDD格式）
- **&EDATE**：結束日期（YYYYMMDD格式）
- **&RPTF**：報表格式（1=按客戶分組，2=按商品分組）
- **&CGRP**：客戶群組（空白=全部）
- **&PGRP**：商品群組（空白=全部）

## 效能考量
1. **查詢優化**：優化查詢條件，提高數據查詢效率
2. **記憶體使用**：合理管理記憶體使用，避免佔用過多系統資源
3. **工作檔管理**：及時清理工作檔，釋放系統資源

## 安全考量
1. **參數驗證**：驗證輸入參數的有效性，防止非法輸入
2. **數據訪問控制**：確保只處理用戶有權訪問的數據
3. **報表訪問控制**：確保只有授權用戶才能生成報表

## 未來擴展建議
1. **增加更多報表格式**：支持更多類型的報表格式
2. **增強查詢條件**：提供更多的查詢條件選項
3. **增加批處理功能**：支持批量生成報表
4. **增加報表預覽功能**：在生成報表前提供預覽功能

## 結論
SOR160C作為銷售訂單入庫報表程式(SOR160系列)的控制程式，負責協調整個報表生成流程。該程式的設計遵循清晰易讀和可維護性原則，接收用戶的查詢條件，調用查詢程式獲取數據，然後根據用戶選擇的報表格式調用相應的報表生成程式生成報表，為用戶提供準確、全面的銷售訂單入庫資訊，幫助用戶有效地分析和管理銷售訂單數據。 