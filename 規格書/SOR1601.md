# SOR1601 銷售訂單報表程式規格說明書

## 1. 基本信息

- **程式名稱**：SOR1601
- **程式類型**：RPG程式
- **系統**：西祺企業管理資訊系統
- **子系統**：銷售訂單模組
- **功能**：生成銷售訂單相關報表
- **建立日期**：不詳
- **更新日期**：
  - M001：98.10.21 - 為Y2K問題進行修改
  - M002：99.11.08 - 增加客戶群組選項
  - M003：00.11.08 - 增加大陸版本

## 2. 程式結構

### 2.1 檔案引用
- **輸入檔案**：
  - `SOSCPF`：銷售訂單主檔
  - `SOSDPF`：銷售訂單明細檔
  - `SOSGPF`：銷售訂單群組檔
  - `SOSHPF`：銷售訂單出貨檔
  - `SOSNPF`：銷售訂單備註檔
  - `SOSOPF`：銷售訂單其他檔
  - `MTMDPF`：主檔資料檔
  - `MTMAPF`：主檔資料檔
  - `PA#HPF`：客戶主檔
  - `RES18WF`：臨時工作檔

- **輸出檔案**：
  - `REWF1`：報表工作檔1
  - `REWF2`：報表工作檔2

### 2.2 資料結構
- **資料區域**：
  - `$USER`：用戶ID
  - `$EGMDY`：系統日期
  - `$EVR`：版本標識
  - `$CPY`：公司代碼
  - `$LPRT`：印表機標識
  - 各種選擇條件變數：
    - `DSC33S`/`DSC33E`：客戶代碼範圍
    - `DSD03S`/`DSD03E`：訂單日期範圍
    - `DSEL2`：選擇條件2
    - `DSEL3`：選擇條件3
    - `DMA01S`/`DMA01E`：部門代碼範圍
    - `DSC34S`/`DSC34E`：業務員代碼範圍

- **資料定義**：
  - 多個工作變數：`WF01`-`WF10`
  - 多個鍵值列表：`KEYWF`、`KEYWF1`、`KEYWF2`、`KEY#H`

### 2.3 程式流程

1. **主程式流程**：
   - 讀取銷售訂單主檔（`SOSCPF`）
   - 處理非作廢的訂單記錄
   - 讀取銷售訂單群組檔（`SOSGPF`）
   - 處理非作廢的群組記錄
   - 讀取銷售訂單備註檔（`SOSNPF`）
   - 處理非作廢的備註記錄
   - 執行最終處理

2. **子程序**：
   - `DTL100`：處理銷售訂單主檔資料
   - `DTL200`：處理銷售訂單群組檔資料
   - `DTL300`：處理銷售訂單備註檔資料
   - `DTL400`：最終處理
   - `RTN100`：處理工作檔記錄
   - `RTN10X`：特殊處理（針對特定訂單類型）

### 2.4 控制程式

- **SOR160C1**：
  - 控制程式，負責設置環境和參數
  - 準備工作檔案
  - 設置印表機參數
  - 調用主程式SOR1601

## 3. 功能說明

### 3.1 主要功能
- 根據用戶指定的條件，從銷售訂單相關檔案中提取資料
- 將資料整理後寫入工作檔
- 生成銷售訂單報表

### 3.2 選擇條件
- 客戶代碼範圍
- 訂單日期範圍
- 部門代碼範圍
- 業務員代碼範圍
- 訂單類型選擇
- 客戶群組選擇（M002新增）

### 3.3 報表類型
- 根據程式中的邏輯，可能支持多種報表格式
- 可能包括訂單摘要報表、訂單明細報表等

## 4. 資料處理邏輯

### 4.1 訂單主檔處理（DTL100）
- 讀取銷售訂單主檔（`SOSCPF`）
- 檢查訂單是否符合選擇條件（日期範圍、客戶範圍等）
- 讀取相關的訂單明細（`SOSDPF`）
- 檢查明細是否符合選擇條件
- 將符合條件的資料寫入工作檔

### 4.2 訂單群組處理（DTL200）
- 讀取銷售訂單群組檔（`SOSGPF`）
- 檢查群組是否符合選擇條件
- 讀取相關的出貨資料（`SOSHPF`）
- 將符合條件的資料寫入工作檔

### 4.3 訂單備註處理（DTL300）
- 讀取銷售訂單備註檔（`SOSNPF`）
- 檢查備註是否符合選擇條件
- 將符合條件的備註資料寫入工作檔

### 4.4 最終處理（DTL400）
- 可能包括資料排序、合計計算等
- 準備最終報表輸出

## 5. 相關程式

### 5.1 直接相關程式
- **SOR160C1**：控制程式，負責設置環境和參數
- **SOR1601.1**、**SOR1601.2**：可能是SOR1601的不同版本或變體

### 5.2 間接相關程式
- 其他銷售訂單報表程式（如SOR1651、SOR1591等）
- 銷售訂單維護程式

## 6. 資料檔案說明

### 6.1 SOSCPF（銷售訂單主檔）
- 包含銷售訂單的基本資訊
- 可能的欄位：訂單編號、客戶代碼、訂單日期、業務員代碼等

### 6.2 SOSDPF（銷售訂單明細檔）
- 包含銷售訂單的明細資訊
- 可能的欄位：訂單編號、產品代碼、數量、單價、金額等

### 6.3 SOSGPF（銷售訂單群組檔）
- 包含銷售訂單的群組資訊
- 可能用於處理多批次或多階段的訂單

### 6.4 SOSHPF（銷售訂單出貨檔）
- 包含銷售訂單的出貨資訊
- 可能的欄位：出貨日期、出貨數量、出貨狀態等

### 6.5 SOSNPF（銷售訂單備註檔）
- 包含銷售訂單的備註資訊
- 可能用於記錄訂單的特殊要求或說明

## 7. 業務邏輯

### 7.1 訂單選擇邏輯
- 根據用戶指定的條件（日期範圍、客戶範圍等）選擇訂單
- 可能包含特殊的業務規則，如排除特定類型的訂單

### 7.2 資料整合邏輯
- 將訂單主檔、明細檔、群組檔、出貨檔和備註檔的資料整合
- 建立資料間的關聯，確保報表資料的完整性

### 7.3 報表生成邏輯
- 根據整合後的資料生成報表
- 可能包含小計、合計等計算
- 可能根據不同的報表類型有不同的格式和內容

## 8. 修改歷史

### 8.1 M001（98.10.21）
- 為Y2K問題進行修改
- 可能涉及日期欄位的格式和處理邏輯的調整

### 8.2 M002（99.11.08）
- 增加客戶群組選項
- 擴展了報表的選擇條件，允許按客戶群組篩選

### 8.3 M003（00.11.08）
- 增加大陸版本
- 可能涉及報表格式或內容的調整，以適應大陸市場的需求

## 9. 使用說明

### 9.1 執行方式
- 通過SOR160C1控制程式執行
- 可能需要設置各種選擇條件參數

### 9.2 參數設置
- 客戶代碼範圍（DSC33S/DSC33E）
- 訂單日期範圍（DSD03S/DSD03E）
- 部門代碼範圍（DMA01S/DMA01E）
- 業務員代碼範圍（DSC34S/DSC34E）
- 訂單類型選擇（DSEL2）
- 其他選擇條件（DSEL3等）

### 9.3 輸出說明
- 報表可能輸出到印表機或檔案
- 報表格式和內容根據選擇條件和報表類型而定

## 10. 維護建議

### 10.1 代碼優化
- 考慮使用更現代的程式結構和技術
- 簡化複雜的條件判斷和邏輯

### 10.2 功能擴展
- 可以考慮增加更多的報表類型和選擇條件
- 增加資料匯出功能，支持不同格式的輸出

### 10.3 效能改進
- 優化資料讀取和處理邏輯，提高報表生成速度
- 考慮使用索引或其他技術加速資料查詢

### 10.4 文檔完善
- 建立詳細的使用說明和維護文檔
- 記錄程式的業務邏輯和技術細節

## 11. 總結

SOR1601是西祺企業管理資訊系統中的銷售訂單報表程式，負責從多個相關檔案中提取資料，整合後生成銷售訂單報表。該程式支持多種選擇條件，可以生成不同類型的報表，滿足用戶對銷售訂單資料分析和查詢的需求。

程式經過多次修改，包括Y2K問題修正、客戶群組選項增加和大陸版本支持，顯示了其在系統中的重要性和長期維護歷史。作為銷售訂單模組的核心報表程式，SOR1601在企業的銷售管理和決策支持中扮演著重要角色。