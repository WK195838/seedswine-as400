# VTB004C程序規格說明文檔

## 1. 基本資訊

- **程序名稱**：VTB004C
- **系統**：西祺企業管理資訊系統 - 銷售模組
- **子系統**：銷售訂單
- **功能描述**：銷售訂單人工錄入程序
- **開發者**：DEREK
- **創建日期**：2012/06/29

## 2. 程序結構

VTB004C程序是一個CL程序，作為銷售訂單人工錄入的主控程序，它調用了以下相關程序：
- VTB004：顯示訂單錄入界面
- VTB004C1：處理PC命令調用
- VTB0041：處理訂單數據並寫入SOVRPF檔案

### 2.1 程序流程

1. 程序啟動後，調用VTB004顯示訂單錄入界面
2. 如果用戶按F3退出，則清除LDA區域並返回
3. 如果用戶未退出，則清除WFSOVR工作檔案
4. 調用VTB004C1程序，該程序負責調用PC程序獲取數據
5. 設置IN98標誌為'1'，表示已處理過數據
6. 返回到START標籤，重新調用VTB004顯示界面

## 3. 相關檔案

### 3.1 主要檔案

- **SOVRPF**：銷售訂單主檔案，用於存儲訂單基本資訊
- **WFSOVR**：工作檔案，用於臨時存儲PC程序傳入的訂單數據
- **PA#BPF**：客戶基本數據檔案，用於獲取客戶資訊

### 3.2 欄位定義

SOVRPF檔案主要欄位：

| 欄位名 | 描述 | 類型 | 備註 |
|-------|------|------|------|
| VR01 | 訂單格式 | 字符(2) | 訂單類型代碼 |
| VR04 | 訂單年月 | 數字(4) | 格式：MM/YY |
| VR05 | 客戶代號 | 字符(8) | 客戶編號 |
| VR07 | 訂單金額 | 數字(9) | 訂單總金額 |
| VR08 | 稅別碼 | 字符(1) | 稅別標識 |
| VR09 | 營業稅 | 數字(9) | 營業稅金額 |
| VR16 | 發票號碼 | 字符(14) | 發票編號 |
| VR17 | 發票日期 | 數字(6) | 格式：MM/DD/YY |
| VR21 | 運費 | 數字(4) | 運輸費用 |
| VR91 | 公司碼 | 字符(1) | 公司標識 |
| VR92 | 辦事處 | 字符(1) | 辦事處代碼 |
| VR96 | 業務代號 | 字符(6) | 業務員編號 |
| VR97 | 創建日期 | 數字(8) | 記錄創建日期 |
| VR98 | 創建時間 | 數字(6) | 記錄創建時間 |
| VR99 | 創建者 | 字符(10) | 創建用戶ID |

## 4. 程序功能詳細說明

### 4.1 VTB004C - 主控程序

VTB004C是整個銷售訂單人工錄入流程的主控程序，負責協調各個子程序的調用和數據流轉。它首先調用VTB004顯示訂單錄入界面，然後根據用戶操作決定後續流程。如果用戶選擇繼續錄入，程序會清除工作檔案WFSOVR，然後調用VTB004C1程序處理PC端數據。

### 4.2 VTB004C1 - PC命令處理

VTB004C1程序負責與PC端交互，它從SCWWPF檔案中讀取記錄，當WW01欄位值為'25'時，構建STRPCCMD命令並執行，調用PC端程序。PC程序執行完成後，調用VTB0041程序處理數據。

### 4.3 VTB0041 - 數據處理

VTB0041是核心的數據處理程序，它從WFSOVR工作檔案讀取PC端傳入的數據，進行必要的轉換和驗證後，寫入SOVRPF銷售訂單主檔案。主要處理流程包括：

1. 初始化環境
2. 從WFSOVR讀取數據
3. 將數據映射到SOVRPF檔案的欄位
4. 根據公司碼和辦事處代碼查詢PA#BPF客戶檔案獲取相關資訊
5. 設置訂單的其他欄位（如創建日期、時間、用戶等）
6. 寫入SOVRPF檔案

## 5. 業務規則

### 5.1 訂單類型(VR01)

- '31'、'32'、'35'、'36'：特殊訂單類型，可能需要特殊處理

### 5.2 稅別處理(VR08)

- 當VR08='2'時，設置VR14='1'，表示特殊稅務處理
- 其他情況下，VR14設為空白

### 5.3 客戶資訊查詢

程序使用公司碼(VR91)和辦事處代碼(VR92)組合查詢PA#BPF客戶檔案，獲取客戶相關資訊：
1. 首先查詢WCOM欄位（由VR91和VR92組合而成）
2. 如果找到記錄，則獲取#B17欄位值作為WCO
3. 再次查詢WCO，如果找到記錄，則獲取#B12作為VR15（訂單聯繫人代號）

## 6. 界面說明

VTB004程序提供了銷售訂單錄入的用戶界面，主要包括：

1. 公司碼選擇
2. 辦事處選擇
3. 訂單年月輸入
4. 操作類型選擇（新增、修改、刪除、查詢）
5. 訂單明細錄入區域，包括：
   - 發票號碼
   - 發票日期
   - 客戶代號
   - 訂單金額
   - 營業稅
   - 訂單格式
   - 稅別碼
   - 運費

## 7. 數據流向

1. PC程序 → WFSOVR工作檔案
2. WFSOVR → VTB0041程序處理
3. VTB0041 → SOVRPF銷售訂單主檔案
4. PA#BPF客戶檔案 → VTB0041（提供客戶資訊）

## 8. 安全與權限

程序沒有明確的安全控制機制，但可能依賴於系統級別的用戶權限控制。用戶ID記錄在VR99欄位中，可用於審計跟蹤。

## 9. 維護建議

1. 考慮增加數據驗證邏輯，確保輸入數據的完整性和正確性
2. 增加錯誤處理機制，提高程序的健壯性
3. 考慮添加日誌記錄功能，便於問題追蹤
4. 可以考慮將硬編碼的值（如稅別處理邏輯）改為配置參數，提高靈活性

## 10. 總結

VTB004C程序是西祺企業管理資訊系統銷售模組中的重要組成部分，負責銷售訂單的人工錄入功能。它通過與PC端程序交互，獲取訂單數據並存儲到SOVRPF銷售訂單主檔案中。程序設計遵循了AS/400系統的典型架構，使用多個相互關聯的程序和檔案完成業務功能。