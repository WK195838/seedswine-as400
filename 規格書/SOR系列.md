# SOR系列銷售訂單報表程序詳細規格說明

## 1. 基本信息

- **程序名稱**：SOR1601、SOR1651、SOR1591（銷售訂單報表程序）
- **程序類型**：RPG程序
- **庫**：REPLIB
- **功能描述**：銷售訂單系統報表生成程序
- **相關文件**：
  - SOR160C1、SOR165C1、SOR159C1（CL控制程序）
  - SOR160D、SOR165D、SOR159D（顯示文件）
  - SOR160P、SOR165P、SOR159P（打印文件）
- **作者**：
  - SOR160D：EASON（A1491）
  - SOR159D：CHARLES（A1084）
- **創建日期**：
  - SOR160D：96/09/06
  - SOR159D：81/05/04

## 2. 程序概述

SOR系列報表程序是西祺企業管理資訊系統中銷售訂單子系統的重要組成部分，主要負責生成各類銷售訂單相關的報表。這些程序通過從銷售訂單主檔、明細檔、商品主檔等數據庫中提取數據，按照特定的條件和格式生成報表，為企業管理和決策提供數據支持。

### 2.1 SOR1601 - 銷售訂單報表

該程序生成按客戶和商品分類的銷售訂單明細報表，提供詳細的訂單信息，包括訂單數量、金額等。

### 2.2 SOR1651 - 銷售訂單商品統計報表

該程序生成按商品分類的銷售訂單統計報表，主要關注商品的銷售情況，包括銷售數量、金額等。

### 2.3 SOR1591 - 銷售訂單客戶商品統計報表

該程序生成按客戶、地區和大類別分類的銷售訂單統計報表，提供多維度的銷售分析數據。

## 3. 程序流程詳解

### 3.1 SOR1601 程序流程

#### 3.1.1 初始化階段

```
- 定義工作變數和鍵值列表
- 設置文件覆蓋和臨時文件
- 讀取LDA中的參數值
```

#### 3.1.2 數據處理階段

1. **主程序流程**：
   ```
   - 讀取銷售訂單主檔(SOSCPF)
   - 讀取銷售訂單商品檔(SOSGPF)
   - 讀取銷售訂單備註檔(SOSNPF)
   - 調用DTL400子程序處理數據
   ```

2. **DTL100子程序**：處理銷售訂單主檔數據
   ```
   - 將SC04(訂單號)賦值給WF02
   - 將SC05(訂單行號)賦值給WF021
   - 檢查商品代碼是否在指定範圍內
   - 檢查訂單數量和金額是否不為零
   - 根據DSEL2參數決定處理方式
   - 如果DSEL2='A'，則更新工作檔
   - 否則調用RTN10X處理特殊情況
   ```

3. **DTL200子程序**：處理銷售訂單商品檔數據
   ```
   - 將SG04(訂單號)賦值給WF02
   - 將SG05(訂單行號)賦值給WF021
   - 檢查客戶代碼是否在指定範圍內
   - 檢查商品代碼是否在指定範圍內
   - 檢查訂單數量和金額是否不為零
   - 根據DSEL2參數決定處理方式
   - 如果DSEL2='A'，則更新工作檔
   - 否則調用RTN20X處理特殊情況
   ```

4. **DTL300子程序**：處理銷售訂單備註檔數據
   ```
   - 檢查商品代碼是否在指定範圍內
   - 檢查訂單數量是否不為零
   - 根據DSEL2參數決定處理方式
   - 如果DSEL2='A'，則更新工作檔
   - 否則調用RTN30X處理特殊情況
   ```

5. **RTN100子程序**：更新工作檔
   ```
   - 初始化工作變數
   - 根據訂單類型(SC03)決定數量的處理方式
   - 如果工作檔中已存在記錄，則更新
   - 否則寫入新記錄
   ```

6. **RTN10X子程序**：處理特殊情況
   ```
   - 檢查商品是否為組合商品(MA54='Y')
   - 如果是組合商品，則調用RTN10Y和RTN10Z
   - 否則按照正常方式處理
   ```

#### 3.1.3 報表生成階段

**DTL400子程序**：生成報表
```
- 從工作檔讀取數據
- 按照特定格式排序和分組
- 計算小計和總計
- 輸出到打印文件
```

### 3.2 SOR1651 程序流程

#### 3.2.1 初始化階段

與SOR1601類似，但使用不同的工作檔(REWF3)。

#### 3.2.2 數據處理階段

1. **DTL100子程序**：處理銷售訂單主檔數據
   ```
   - 將SC04(訂單號)賦值給WF302
   - 根據IN20參數決定使用SC08或SC39作為WF303
   - 檢查商品代碼是否在指定範圍內
   - 檢查訂單數量和金額是否不為零
   - 根據DSEL2參數決定處理方式
   ```

2. **DTL200子程序**：處理銷售訂單商品檔數據
   ```
   - 將SG04(訂單號)賦值給WF302
   - 根據IN20參數決定使用SG06或SG26作為WF303
   - 檢查客戶代碼是否在指定範圍內
   - 檢查商品代碼是否在指定範圍內
   - 檢查訂單數量和金額是否不為零
   - 根據DSEL2參數決定處理方式
   ```

### 3.3 SOR1591 程序流程

#### 3.3.1 初始化階段

與前兩個程序類似，但使用REWF37工作檔，並增加了對大類別(D#L01)的支持。

#### 3.3.2 數據處理階段

1. **主程序流程**：
   ```
   - 讀取銷售訂單主檔(SOSCPF)
   - 讀取銷售訂單商品檔(SOSGPF)
   - 讀取銷售訂單備註檔(SOSNPF)
   - 增加了對大類別(#L0)的處理
   ```

2. **DTL100子程序**：處理銷售訂單主檔數據
   ```
   - 將SC01(客戶代碼)賦值給WF3702
   - 增加了對客戶群組(MD06)的檢查
   - 檢查商品類別(MA11A)是否在指定範圍內
   - 檢查商品代碼是否在指定範圍內
   - 檢查訂單數量和金額是否不為零
   ```

## 4. 數據結構詳解

### 4.1 主要文件結構

#### 4.1.1 銷售訂單主檔(SOSCPF)
- SC01：客戶代碼
- SC02：訂單日期
- SC03：訂單類型
- SC04：訂單號
- SC05：訂單行號
- SC07：訂單日期(YMD格式)
- SC08：訂單金額

#### 4.1.2 銷售訂單明細檔(SOSDPF)
- SD02：客戶代碼
- SD03：商品代碼
- SD03Q：商品代碼(數字部分)
- SD04：訂單數量
- SD05：出貨數量
- SD06：訂單金額

#### 4.1.3 銷售訂單商品檔(SOSGPF)
- SG02：訂單日期
- SG04：訂單號
- SG05：訂單行號
- SG06：訂單金額
- SG15：商品大類別

#### 4.1.4 銷售訂單備註檔(SOSNPF)
- SN01：客戶代碼
- SN02：訂單日期
- SN03：商品代碼

#### 4.1.5 商品主檔(MTMDPF)
- MD01：商品代碼
- MD06：客戶群組
- MD07：客戶代碼
- MD08：地區代碼
- MA11A：商品類別
- MA54：組合商品標誌

### 4.2 工作檔結構

#### 4.2.1 REWF1/REWF2(SOR1601使用)
- WF01：商品代碼
- WF02：訂單號
- WF021：訂單行號
- WF03：訂單數量
- WF04：出貨數量
- WF05：特殊訂單數量
- WF06-WF10：其他金額欄位
- WF11：商品代碼(數字部分)

#### 4.2.2 REWF3(SOR1651使用)
- WF301：商品代碼
- WF302：訂單號
- WF303：訂單金額

#### 4.2.3 REWF37(SOR1591使用)
- WF3701：商品代碼
- WF3702：客戶代碼
- WF3711：商品代碼(數字部分)
- WF3712：商品代碼(數字部分)

## 5. 用戶界面詳解

### 5.1 SOR160D(SOR1601的顯示文件)

#### 5.1.1 主要欄位
- COMP：處理方式(1=新增, 2=修改, 3=刪除, 空白=查詢)
- DSC33S/DSC33E：客戶代碼範圍
- DSD03S/DSD03E：商品代碼範圍
- DSC34S/DSC34E：商品類別範圍
- DSEL2：選擇條件

#### 5.1.2 功能鍵
- F3：返回
- F4：幫助
- F7/F8：其他功能

### 5.2 SOR159D(SOR1591的顯示文件)

#### 5.2.1 主要欄位
- COMP：處理方式
- DMA11：商品類別(1-BRANDY, 2-WHISKY, 3-WINE, 空白-ALL)
- D#L01S/D#L01E：大類別範圍(M003修改增加)
- DSD03S/DSD03E：商品代碼範圍
- DSC33S/DSC33E：客戶代碼範圍
- DSC28S/DSC28E：年度類別範圍

### 5.3 SOR165D(SOR1651的顯示文件)

#### 5.3.1 主要欄位
- COMP：處理方式
- DSC33S/DSC33E：客戶代碼範圍
- 其他欄位與SOR160D類似

## 6. 控制程序詳解

### 6.1 SOR160C1(SOR1601的控制程序)

#### 6.1.1 變數定義
```
- &$EVR：版本標誌
- &$CPY：公司代碼
- &$PRTID：打印機ID
- &DSC33S/&DSC33E：客戶代碼範圍
- &DSC34S/&DSC34E：商品類別範圍
- &YMDS/&YMDE：日期範圍
- &YMD8S/&YMD8E：8位日期範圍(Y2K修改)
- &DSEL2/&DSEL3：選擇條件
```

#### 6.1.2 主要操作
```
- 創建和清除臨時文件(QTEMP/REWF1, QTEMP/RES18WF)
- 設置文件覆蓋(OVRDBF)
- 設置打印參數(OVRPRTF)
- 從LDA讀取參數值
- 調用SOR1601程序處理數據
- 處理完成後刪除臨時文件和覆蓋
```

### 6.2 SOR159C1(SOR1591的控制程序)

與SOR160C1類似，但增加了對大類別(D#L01S/D#L01E)和商品類別(DSC31S/DSC31E)的處理。

### 6.3 SOR165C1(SOR1651的控制程序)

與前兩個控制程序類似，但使用REWF3工作檔，並有一些特殊的處理邏輯。

## 7. 報表格式詳解

### 7.1 SOR1601報表格式

#### 7.1.1 報表標題
- 報表名稱：銷售訂單報表
- 公司名稱：西祺企業
- 日期和時間
- 頁碼

#### 7.1.2 報表內容
- 客戶代碼和名稱
- 訂單號和日期
- 商品代碼和名稱
- 訂單數量和出貨數量
- 訂單金額和出貨金額
- 小計和總計

### 7.2 SOR1651報表格式

#### 7.2.1 報表標題
- 報表名稱：銷售訂單商品統計報表
- 其他標題信息與SOR1601類似

#### 7.2.2 報表內容
- 商品代碼和名稱
- 訂單數量和金額
- 按商品分組的小計和總計

### 7.3 SOR1591報表格式

#### 7.3.1 報表標題
- 報表名稱：銷售訂單客戶商品統計報表
- 其他標題信息與前兩個報表類似

#### 7.3.2 報表內容
- 客戶代碼和名稱
- 地區代碼和名稱
- 商品大類別和名稱
- 商品代碼和名稱
- 訂單數量和金額
- 多層次的小計和總計

## 8. 修改記錄詳解

### 8.1 M001(98.10.21)
- 由MICHELLE進行Y2K問題修正
- 將6位日期格式(YYMMDD)改為8位格式(YYYYMMDD)
- 修改了相關的日期處理邏輯

### 8.2 M002(99.11.08)
- 增加客戶群組選項
- 在SOR1591中增加了對MD06(客戶群組)的檢查
- 增加了DMD06S/DMD06E參數用於指定客戶群組範圍

### 8.3 M003(00.11.08)
- 增加大類別功能
- 在SOR1591中增加了對#L0(大類別)文件的處理
- 增加了D#L01S/D#L01E參數用於指定大類別範圍
- 修改了報表格式以包含大類別信息

## 9. 程序特點詳解

### 9.1 模組化設計

程序採用模組化設計，將不同的功能分解為多個子程序：
- DTL100/DTL200/DTL300：處理不同類型的數據
- RTN100/RTN200/RTN300：更新工作檔
- RTN10X/RTN20X/RTN30X：處理特殊情況

這種設計使程序結構清晰，便於維護和擴展。

### 9.2 參數化查詢

程序支持多種參數化查詢條件：
- 客戶代碼範圍(DSC33S/DSC33E)
- 商品代碼範圍(DSD03S/DSD03E)
- 商品類別範圍(DSC34S/DSC34E)
- 日期範圍(YMDS/YMDE)
- 大類別範圍(D#L01S/D#L01E)
- 處理方式(COMP)
- 選擇條件(DSEL2/DSEL3)

用戶可以通過指定不同的參數組合生成不同內容的報表。

### 9.3 錯誤處理機制

程序包含完善的錯誤處理機制：
- 使用RES18WF工作檔記錄錯誤信息
- 在RTN10Y/RTN10Z子程序中處理特殊情況
- 對組合商品(MA54='Y')進行特殊處理

### 9.4 版本控制

程序包含詳細的修改記錄，記錄了每次修改的內容、日期和負責人，便於追蹤程序的演變歷史。

## 10. 系統架構關係詳解

### 10.1 上游系統

#### 10.1.1 銷售訂單輸入程序
- SOA001/SOA001A：一般客戶訂單輸入
- SOA002/SOA002A：特殊客戶訂單輸入
- SOA003C：銷售訂單資料處理

#### 10.1.2 主檔維護程序
- MTA001：客戶主檔維護
- MTA010：商品主檔維護
- MTA020：地區主檔維護

### 10.2 同級系統

#### 10.2.1 其他銷售訂單報表程序
- SOR041C/SOR042C：其他類型的銷售訂單報表
- SOR050C-SOR090C：各種銷售分析報表

#### 10.2.2 銷售訂單查詢程序
- SOA010C：訂單查詢
- SOA013：出貨查詢
- SOA014C：庫存查詢

### 10.3 下游系統

#### 10.3.1 財務系統
- ARI023：應收帳款報表

#### 10.3.2 庫存系統
- IMI021：庫存報表
- IMI022：庫存異動報表
- IMI026：商品庫存查詢

#### 10.3.3 採購系統
- POI021：採購分析報表

## 11. 數據流分析詳解

### 11.1 輸入數據

#### 11.1.1 用戶輸入
- 處理方式(COMP)
- 客戶代碼範圍(DSC33S/DSC33E)
- 商品代碼範圍(DSD03S/DSD03E)
- 商品類別範圍(DSC34S/DSC34E)
- 日期範圍(YMDS/YMDE)
- 大類別範圍(D#L01S/D#L01E)
- 選擇條件(DSEL2/DSEL3)

#### 11.1.2 系統數據
- 銷售訂單主檔(SOSCPF)
- 銷售訂單明細檔(SOSDPF)
- 銷售訂單商品檔(SOSGPF)
- 銷售訂單備註檔(SOSNPF)
- 商品主檔(MTMDPF)
- 商品屬性檔(MTMAPF)
- 參數檔(PA#HPF)

### 11.2 處理邏輯

#### 11.2.1 數據過濾
- 根據客戶代碼、商品代碼、日期等條件過濾數據
- 檢查訂單數量和金額是否不為零
- 對組合商品進行特殊處理

#### 11.2.2 數據轉換
- 將過濾後的數據寫入工作檔
- 計算小計和總計
- 格式化數據以適應報表格式

### 11.3 輸出數據

#### 11.3.1 報表輸出
- 格式化的報表(SOR160P/SOR165P/SOR159P)
- 包含標題、明細、小計和總計

#### 11.3.2 錯誤輸出
- 錯誤訊息(RES18WF)
- 包含錯誤代碼和描述

## 12. 注意事項與改進建議詳解

### 12.1 代碼優化

#### 12.1.1 重複代碼消除
- DTL100/DTL200/DTL300子程序中有大量相似代碼，可考慮合併
- RTN100/RTN200/RTN300子程序也可以合併為一個通用子程序

#### 12.1.2 變數命名規範化
- 當前變數命名不夠直觀，可考慮使用更有意義的名稱
- 增加註釋以說明變數的用途

### 12.2 錯誤處理增強

#### 12.2.1 更詳細的錯誤信息
- 增加更多的錯誤檢查點
- 提供更詳細的錯誤描述

#### 12.2.2 日誌記錄
- 增加日誌記錄功能，記錄程序的執行過程
- 記錄關鍵操作和異常情況

### 12.3 用戶界面改進

#### 12.3.1 增加查詢條件
- 增加更多的查詢條件，如訂單狀態、付款方式等
- 提供更靈活的日期範圍選擇

#### 12.3.2 排序選項
- 增加多種排序選項，如按金額排序、按日期排序等
- 允許用戶自定義排序方式

### 12.4 報表格式現代化

#### 12.4.1 導出功能
- 增加導出為Excel或PDF格式的功能
- 支持電子郵件發送報表

#### 12.4.2 圖表展示
- 增加圖表展示功能，如銷售趨勢圖、客戶分布圖等
- 提供更直觀的數據可視化

### 12.5 性能優化

#### 12.5.1 SQL查詢優化
- 使用更高效的SQL查詢替代當前的記錄級訪問
- 減少不必要的文件訪問

#### 12.5.2 索引優化
- 檢查和優化相關文件的索引
- 增加必要的索引以提高查詢效率

## 13. 結論

SOR系列銷售訂單報表程序是西祺企業管理資訊系統中重要的報表生成工具，通過從銷售訂單相關檔案中提取數據，生成各類報表，為企業管理和決策提供數據支持。這些程序採用模組化設計，支持參數化查詢，具有良好的可維護性和擴展性。

通過對程序代碼的詳細分析，我們可以看到這些程序經過多次修改和優化，以適應業務需求的變化，特別是Y2K問題修正、客戶群組選項和大類別功能的增加。這些修改使程序更加靈活和功能豐富。

隨著系統的發展，可考慮進一步優化代碼結構、增強錯誤處理、改進用戶界面和報表格式，以滿足不斷變化的業務需求。特別是在現代化方面，可以考慮增加導出功能、圖表展示和電子郵件發送等功能，使報表更加易於使用和分享。

總之，SOR系列銷售訂單報表程序是一個功能完善、結構清晰的報表生成系統，為西祺企業的銷售管理提供了有力的支持。通過持續的優化和改進，這些程序可以更好地滿足企業的管理需求，提高數據分析和決策支持的能力。