# PIR041C 庫存盤點表程式詳細規格說明書

## 一、基本信息

- **程式ID**: PIR041C
- **程式名稱**: 庫存盤點表程式
- **作者**: A1087 JOYCE
- **建立日期**: 81/04/24
- **系統**: 物料管理系統
- **子系統**: 庫存子系統
- **功能**: 庫存盤點表列印

## 二、程式概述

PIR041C是西祺企業管理信息系統中的庫存盤點表程式，負責生成庫存盤點表報表，協助企業進行庫存盤點作業。該程式允許用戶選擇特定倉庫的庫存資料，並根據不同的查詢條件（全部列印、指定頁數列印或特定物料範圍列印）生成相應的盤點表，以便進行實際庫存與系統記錄的核對工作。

## 三、系統架構

### 相關程式

1. **PIR041C** - 主控程式，負責調用PIR041和PIR041C1
2. **PIR041** - 畫面處理程式，負責用戶界面和資料輸入
3. **PIR041C1** - 報表處理程式，負責資料查詢和報表生成
4. **PIR0411** - 報表明細處理程式，負責報表明細資料的處理和輸出
5. **P66** - 列印控制程式，負責報表的列印控制

### 相關文件

1. **MTMEPF** - 倉庫主檔案（物理文件）
   - 用於存儲倉庫基本資料
   - 使用方式：讀取（IF）

2. **PA#APF** - 基本資料主檔案（物理文件）
   - 用於存儲基本資料
   - 使用方式：讀取（IF）

3. **PA#FLF** - 基本資料檔案（物理文件）
   - 用於存儲基本資料
   - 使用方式：讀取（IF）

4. **IMIOPF** - 庫存主檔案（物理文件）
   - 用於存儲庫存基本資料
   - 使用方式：讀取（IP）

5. **MTMAPF** - 倉庫主檔案（物理文件）
   - 用於存儲倉庫基本資料
   - 使用方式：讀取（IF）

6. **PIR041D** - 顯示文件
   - 用於用戶界面顯示和資料輸入
   - 包含一個記錄格式：DSPD1（主畫面）

7. **PIR041P** - 打印文件
   - 用於生成庫存盤點表報表
   - 包含一個記錄格式：PD1（報表明細）

### 資料結構

1. **LDA（本地資料區）主要欄位**:
   - **$EVR** (162): 列印方式（1-立即，2-批次）
   - **$CPY** (125-127): 列印份數
   - **$PRTID** (598-599): 列印機代碼
   - **DIO02** (601-605): 倉庫代碼
   - **DNUM** (606-607): 列印頁數
   - **DSEL** (611): 選擇方式（A-全部列印，B-指定頁數，C-指定物料範圍）
   - **DPNO** (612-613): 起始頁數
   - **DIO03S** (614-622): 起始物料代碼
   - **DIO03E** (623-631): 結束物料代碼

## 四、程式流程

### 主要流程（PIR041C）

1. **初始化**
   - 宣告變數
   - 設定LDA資料區

2. **主循環**
   - 調用PIR041程式處理畫面輸入
   - 檢查返回狀態（F3退出）
   - 根據列印方式決定調用方式：
     - 立即列印：直接調用PIR041C1
     - 批次列印：提交作業調用PIR041C1
   - 返回主循環

### PIR041程式流程

1. **初始化（RTN010）**
   - 設定初始值和環境變數
   - 清空輸入欄位

2. **主畫面處理**
   - 顯示DSPD1畫面（倉庫代碼、列印頁數等輸入）
   - 接收用戶輸入
   - 處理功能鍵（F3=返回，F4=說明）
   - 執行畫面檢查（RTN100）

3. **畫面檢查（RTN100）**
   - 檢查倉庫代碼是否為空
   - 檢查倉庫代碼是否有效
   - 檢查選擇方式和相應參數

4. **F4說明處理（RTNF4）**
   - 根據游標位置提供相應的說明
   - 調用相應的說明程式

### PIR041C1程式流程

1. **初始化**
   - 從LDA獲取參數
   - 設定打印機參數

2. **資料查詢**
   - 根據選擇方式設定查詢條件：
     - A（全部列印）：僅按倉庫代碼查詢
     - B（指定頁數）：處理指定頁數的列印
     - C（指定物料範圍）：按倉庫代碼和物料範圍查詢

3. **報表生成**
   - 調用PIR0411程式生成報表
   - 關閉查詢和覆蓋

4. **列印控制**
   - 調用P66程式控制列印

### PIR0411程式流程

1. **初始化（RTN010）**
   - 設定初始值
   - 設定頁碼

2. **報表明細處理（RTN100）**
   - 讀取庫存記錄
   - 獲取相關資料（公司名稱、倉庫名稱、物料資訊）
   - 輸出報表明細

## 五、畫面設計

### DSPD1畫面（主畫面）
- 顯示系統標題和日期
- 顯示當前用戶名稱
- 倉庫代碼輸入欄位
- 列印頁數輸入欄位
- 選擇方式選項（A-全部列印，B-指定頁數，C-指定物料範圍）
- 起始頁數輸入欄位（選擇方式B時使用）
- 物料範圍輸入欄位（選擇方式C時使用）
- 列印方式選項（1-立即，2-批次）
- 列印份數顯示
- 列印機代碼輸入欄位
- 功能鍵：F3(返回主選單)、F4(說明)
- 錯誤訊息顯示區域

## 六、報表設計

### PD1報表（庫存盤點表）
- 報表標題和日期
- 公司名稱和描述
- 倉庫代碼和名稱
- 物料代碼
- 物料描述
- 單位
- 庫存量
- 頁碼

## 七、錯誤處理

程式包含完整的錯誤處理機制：

1. **輸入驗證**
   - 倉庫代碼不能為空（錯誤代碼61/96）
   - 倉庫代碼必須存在（錯誤代碼61/94）
   - 選擇方式必須有效（錯誤代碼62）

2. **資料存在性檢查**
   - 檢查倉庫代碼是否存在於系統中
   - 檢查物料代碼是否有效

3. **錯誤訊息顯示**
   - 使用指示器控制錯誤訊息顯示
   - 錯誤訊息從訊息文件中獲取（PTMF）

## 八、安全與效能考量

### 安全考量
1. **資料完整性**
   - 檢查輸入資料的有效性
   - 防止無效資料導致報表錯誤

2. **資料保護**
   - 僅允許查詢操作，不修改資料
   - 使用共享模式訪問檔案（SHARE(*YES)）

### 效能考量
1. **資料庫訪問優化**
   - 使用OPNQRYF進行高效查詢
   - 使用鍵值訪問提高效率（CHAIN操作）

2. **報表處理**
   - 批次處理選項減輕系統負擔
   - 使用SBMJOB提交作業進行背景處理

## 九、程式調用關係

### 調用關係
1. **PIR041C**（主控程式）
   - 調用PIR041（畫面處理）
   - 調用PIR041C1（報表處理）

2. **PIR041C1**（報表處理）
   - 調用PIR0411（報表明細處理）
   - 調用P66（列印控制）

### 調用方式
1. **從系統主選單進入**
   - 通過PIM000程式調用
   - 參數：無

2. **通過命令行直接調用**
   - 命令：CALL PIR041C
   - 參數：無

## 十、使用說明

### 操作流程
1. **進入程式**
   - 從系統主選單選擇庫存盤點表選項
   - 或直接輸入命令CALL PIR041C

2. **主畫面操作**
   - 輸入倉庫代碼
   - 輸入列印頁數
   - 選擇列印方式（A-全部列印，B-指定頁數，C-指定物料範圍）
   - 根據選擇方式輸入相應參數
   - 選擇列印方式（1-立即，2-批次）
   - 輸入列印機代碼
   - 按Enter處理
   - 按F3返回主選單

### 常見問題處理
1. **倉庫代碼錯誤**
   - 確認輸入的倉庫代碼存在於系統中
   - 使用F4說明查詢有效的倉庫代碼

2. **報表未列印**
   - 檢查列印機代碼是否正確
   - 檢查列印機是否正常工作
   - 檢查批次作業是否正常執行

## 十一、系統整合

1. **與其他模塊的關係**
   - 作為物料管理系統的組件
   - 與庫存管理和盤點模塊密切配合
   - 為庫存盤點作業提供基礎資料

2. **資料共享**
   - 使用IMIOPF檔案獲取庫存資訊
   - 使用MTMAPF和MTMEPF檔案獲取倉庫資訊
   - 使用PA#APF和PA#FLF檔案獲取基本資料

3. **系統依賴**
   - 依賴庫存主檔案(IMIOPF)提供庫存資訊
   - 依賴倉庫主檔案(MTMAPF)提供倉庫資訊
   - 依賴P66程式控制列印

## 十二、總結

PIR041C是西祺企業管理信息系統中的庫存盤點表程式，提供完整的庫存盤點表生成功能。通過靈活的查詢條件和列印選項，滿足企業不同的盤點需求，協助企業進行庫存盤點作業，確保庫存記錄的準確性。

程式設計遵循結構化編程原則，具有良好的模塊化和可維護性。通過清晰的流程控制和完善的錯誤處理，確保程式運行的穩定性和可靠性。同時，程式也考慮了效能和安全性，為系統提供高效、安全的庫存盤點表功能。

作為庫存管理的重要工具，PIR041C程式的穩定運行對企業的庫存管理和盤點作業至關重要。因此，在系統維護和升級過程中，應特別注意保持此程式的完整性和正確性。