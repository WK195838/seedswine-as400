# P63程序規格說明

## 1. 基本信息

- **程序名稱**：P63
- **程序類型**：CL程序
- **庫**：QLIBSS/REPLIB
- **功能描述**：將用戶ID和日期信息存儲到本地數據區（LDA）
- **相關文件**：
  - P63OA（變體程序）
  - P63OC（變體程序）
  - R@S002（調用程序）
  - S#P63（相關程序）
- **作者**：未明確指定
- **創建日期**：未明確指定
- **文本描述**：PUT USER-ID & DATE TO *LDA

## 2. 程序概述

P63是一個系統初始化程序，主要功能是獲取當前用戶ID、作業信息和系統日期，並將這些信息存儲到本地數據區（LDA）中，以便其他程序使用。此外，程序還執行日期格式轉換，支持西元年和民國年兩種日期格式，並調用R@S002程序進行系統授權驗證。

## 3. 程序流程

### 3.1 初始化階段

1. **變數定義**：
   ```
   - &WRKSTN：工作站名稱，長度為10字符
   - &USER：用戶ID，長度為10字符
   - &CHYMD：民國年日期（YYMMDD），長度為6字符
   - &A8YMD：西元年日期（YYYYMMDD），長度為8字符
   - &C8YMD：民國年日期（YYYYMMDD），長度為8字符
   - &ADMDY：日期格式（MMDDYY），長度為6字符
   - &ADDMY：日期格式（DDMMYY），長度為6字符
   - &ADYMD：日期格式（YYMMDD），長度為6字符
   - &JOBNBR：作業編號，長度為6字符
   - &QYY：系統年份，長度為2字符
   - &QMM：系統月份，長度為2字符
   - &QDD：系統日期，長度為2字符
   - &PYY：臨時年份變數，長度為4位數字
   - &QYY4C：4位民國年，長度為4字符
   - &QYY4A：4位西元年，長度為4字符
   - &HYY：世紀前綴，長度為2字符
   - &QLP：閏年調整，長度為1位數字
   - &PTN01：模式1，長度為7字符
   - &ETTIME：時間信息，長度為9字符
   - &PTN02：模式2，長度為4字符
   ```

2. **獲取作業信息**：
   ```
   RTVJOBA JOB(&WRKSTN) USER(&USER) NBR(&JOBNBR)
   ```

3. **存儲作業信息到LDA**：
   ```
   CHGDTAARA DTAARA(*LDA (163 10)) VALUE(&WRKSTN)
   CHGDTAARA DTAARA(*LDA (101 10)) VALUE(&USER)
   CHGDTAARA DTAARA(*LDA (193 6)) VALUE(&JOBNBR)
   ```

4. **獲取系統日期**：
   ```
   RTVSYSVAL SYSVAL(QYEAR) RTNVAR(&QYY)
   RTVSYSVAL SYSVAL(QMONTH) RTNVAR(&QMM)
   RTVSYSVAL SYSVAL(QDAY) RTNVAR(&QDD)
   RTVSYSVAL SYSVAL(QLEAPADJ) RTNVAR(&QLP)
   ```

### 3.2 日期處理階段

1. **西元年日期處理**（&QLP = 0）：
   ```
   - 根據年份判斷世紀前綴（&HYY）：
     如果&QYY <= '50'，則&HYY = '20'
     否則&HYY = '19'
   - 生成MMDDYY格式日期：&ADMDY = &QMM + &QDD + &QYY
   - 生成DDMMYY格式日期：&ADDMY = &QDD + &QMM + &QYY
   - 生成YYMMDD格式日期：&ADYMD = &QYY + &QMM + &QDD
   - 生成4位西元年：&QYY4A = &HYY + &QYY
   - 計算民國年：&PYY = &QYY4A - 1911
   - 生成4位民國年：&QYY4C = &PYY
   - 更新2位民國年：&QYY = 最後2位&QYY4C
   - 生成民國年日期：&CHYMD = &QYY + &QMM + &QDD
   - 生成8位西元年日期：&A8YMD = &QYY4A + &QMM + &QDD
   - 生成8位民國年日期：&C8YMD = &QYY4C + &QMM + &QDD
   ```

2. **民國年日期處理**（&QLP != 0）：
   ```
   - 生成民國年日期：&CHYMD = &QYY + &QMM + &QDD
   - 生成4位民國年：&QYY4C = '00' + &QYY
   - 計算西元年：&PYY = &QYY4C + 1911
   - 生成4位西元年：&QYY4A = &PYY
   - 更新2位西元年：&QYY = 最後2位&QYY4A
   - 生成MMDDYY格式日期：&ADMDY = &QMM + &QDD + &QYY
   - 生成DDMMYY格式日期：&ADDMY = &QDD + &QMM + &QYY
   - 生成YYMMDD格式日期：&ADYMD = &QYY + &QMM + &QDD
   - 生成8位西元年日期：&A8YMD = &QYY4A + &QMM + &QDD
   - 生成8位民國年日期：&C8YMD = &QYY4C + &QMM + &QDD
   ```

3. **存儲日期信息到LDA**：
   ```
   CHGDTAARA DTAARA(*LDA (111 6)) VALUE(&CHYMD)
   CHGDTAARA DTAARA(*LDA (119 6)) VALUE(&ADMDY)
   CHGDTAARA DTAARA(*LDA (129 6)) VALUE(&ADDMY)
   CHGDTAARA DTAARA(*LDA (187 6)) VALUE(&ADYMD)
   CHGDTAARA DTAARA(*LDA (201 8)) VALUE(&A8YMD)
   CHGDTAARA DTAARA(*LDA (209 8)) VALUE(&C8YMD)
   ```

4. **初始化其他LDA字段**：
   ```
   CHGDTAARA DTAARA(*LDA (125 3)) VALUE('000')
   CHGDTAARA DTAARA(*LDA (128 1)) VALUE('0')
   CHGDTAARA DTAARA(*LDA (162 1)) VALUE('0')
   ```

### 3.3 系統授權驗證階段

1. **獲取模式1**：
   ```
   RTVDTAARA DTAARA(R@DA01 (102 7)) RTNVAR(&PTN01)
   ```

2. **獲取系統時間**：
   ```
   RTVSYSVAL SYSVAL(QTIME) RTNVAR(&ETTIME)
   ```

3. **調用R@S002計算模式2**：
   ```
   CALL R@S002 PARM(&PTN01 &ETTIME &PTN02)
   ```

4. **存儲模式2和時間信息到LDA**：
   ```
   CHGDTAARA DTAARA(*LDA (487 4)) VALUE(&PTN02)
   CHGDTAARA DTAARA(*LDA (491 9)) VALUE(&ETTIME)
   ```

## 4. 相關程序詳解

### 4.1 P63OA程序

P63OA是P63的一個變體程序，主要區別在於日期處理方式：

1. 不使用QLEAPADJ系統值判斷日期格式
2. 直接將系統年份加11作為轉換後的年份
3. 簡化了日期處理邏輯

### 4.2 P63OC程序

P63OC是P63的另一個變體程序，主要區別在於：

1. 不使用QLEAPADJ系統值判斷日期格式
2. 直接將系統年份減11作為轉換後的年份
3. 調整了日期處理的順序

### 4.3 R@S002程序

R@S002是一個RPG程序，用於計算模式2（&PTN02）。該程序接收模式1和時間信息作為輸入，通過一系列數學運算生成一個4字符的模式值，用於系統授權驗證。

### 4.4 S#P63程序

S#P63是一個CL程序，用於調用P63程序並執行額外的操作：

1. 調用P63程序初始化LDA
2. 從S#DA01數據區獲取用戶ID
3. 更新LDA中的用戶ID
4. 調用S#S01程序進行權限檢查

## 5. 數據結構

### 5.1 本地數據區（LDA）

P63程序使用本地數據區（LDA）存儲以下信息：

- 位置101-110：用戶ID（&USER）
- 位置111-116：民國年日期（&CHYMD）
- 位置119-124：MMDDYY格式日期（&ADMDY）
- 位置125-127：初始化為'000'
- 位置128：初始化為'0'
- 位置129-134：DDMMYY格式日期（&ADDMY）
- 位置162：初始化為'0'
- 位置163-172：工作站名稱（&WRKSTN）
- 位置187-192：YYMMDD格式日期（&ADYMD）
- 位置193-198：作業編號（&JOBNBR）
- 位置201-208：8位西元年日期（&A8YMD）
- 位置209-216：8位民國年日期（&C8YMD）
- 位置487-490：模式2（&PTN02）
- 位置491-499：時間信息（&ETTIME）

### 5.2 R@DA01數據區

R@DA01是一個數據區，包含以下信息：

- 位置102-108：模式1（&PTN01），用於系統授權驗證

## 6. 程序特點

### 6.1 日期格式轉換

P63程序支持多種日期格式的轉換和存儲：

1. **西元年和民國年轉換**：
   - 西元年轉民國年：年份 - 1911
   - 民國年轉西元年：年份 + 1911

2. **多種日期格式**：
   - YYMMDD：年月日格式
   - MMDDYY：月日年格式
   - DDMMYY：日月年格式
   - YYYYMMDD：4位年份的年月日格式

3. **世紀判斷**：
   - 如果2位年份 <= 50，則世紀前綴為'20'
   - 否則世紀前綴為'19'

### 6.2 系統授權驗證

P63程序包含系統授權驗證機制：

1. 從R@DA01數據區獲取模式1
2. 獲取系統時間
3. 調用R@S002程序計算模式2
4. 將模式2和時間信息存儲到LDA中

這些信息將被其他程序用於驗證系統的授權狀態。

### 6.3 初始化功能

P63程序作為系統初始化程序，執行以下初始化操作：

1. 獲取並存儲用戶ID和作業信息
2. 獲取並轉換系統日期
3. 初始化LDA中的特定字段
4. 執行系統授權驗證

## 7. 系統架構關係

### 7.1 與操作系統的關係

P63程序與AS/400操作系統緊密相關：

1. 使用RTVJOBA命令獲取作業信息
2. 使用RTVSYSVAL命令獲取系統值
3. 使用CHGDTAARA命令更新數據區
4. 使用RTVDTAARA命令獲取數據區信息

### 7.2 與其他程序的關係

P63程序是系統初始化的一部分，與其他程序的關係包括：

1. 被S#P63程序調用，執行初始化操作
2. 調用R@S002程序進行系統授權驗證
3. 為其他程序提供LDA中的用戶ID和日期信息

## 8. 使用場景

### 8.1 系統登入

當用戶登入系統時，P63程序被調用以初始化LDA中的用戶ID和日期信息，為後續的程序操作提供基礎數據。

### 8.2 日期處理

P63程序提供多種日期格式，滿足不同程序對日期格式的需求，特別是支持西元年和民國年兩種日期系統。

### 8.3 系統授權

P63程序執行系統授權驗證，確保系統只能被授權用戶使用，是系統安全機制的一部分。

## 9. 注意事項與改進建議

### 9.1 代碼優化

1. **變數命名**：使用更有意義的變數名稱，提高代碼可讀性
2. **註釋完善**：增加更詳細的註釋，說明程序的功能和邏輯
3. **模塊化**：將日期處理和系統授權驗證分離為獨立的子程序

### 9.2 功能增強

1. **錯誤處理**：增加錯誤處理機制，處理可能的異常情況
2. **日期格式擴展**：支持更多的日期格式，如ISO格式（YYYY-MM-DD）
3. **參數化**：將硬編碼的LDA位置改為參數，提高靈活性

### 9.3 安全性增強

1. **加密存儲**：對敏感信息進行加密存儲
2. **訪問控制**：增加對LDA的訪問控制，防止未授權的修改
3. **日誌記錄**：記錄LDA的修改操作，便於審計和追蹤

## 10. 結論

P63程序是一個系統初始化程序，主要功能是獲取用戶ID、作業信息和系統日期，並將這些信息存儲到LDA中，以便其他程序使用。程序支持西元年和民國年兩種日期格式，並執行系統授權驗證。

P63程序在系統架構中扮演著重要角色，為其他程序提供基礎數據和授權驗證。通過優化代碼、增強功能和提高安全性，可以進一步提升程序的效能和可靠性。

總的來說，P63程序是一個典型的AS/400系統初始化程序，反映了早期AS/400系統的設計思想和實現方式。隨著技術的發展和需求的變化，程序可能需要進行更新和改進，以適應新的環境和要求。