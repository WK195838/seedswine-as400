# SOR160 銷售訂單報表程式規格說明書

## 1. 基本資訊

- **程式名稱**：SOR160
- **程式類型**：RPG程式
- **程式庫**：REPLIB
- **功能描述**：銷售訂單報表列印程式
- **相關檔案**：
  - SOR160D（顯示檔案）
  - SOR160P（打印檔案）
  - S#SDPF（系統代碼檔）
  - SOVRLF（銷售訂單邏輯檔）
  - SOVRPF（銷售訂單主檔）
  - SOVDPF（銷售訂單明細檔）
  - CTMAPF（客戶主檔）
- **系統名稱**：西祺企業經營管理資訊系統
- **子系統**：銷售訂單管理系統
- **作者**：A1491 EASON
- **建立日期**：96/09/06
- **最後修改日期**：00/11/08（增加大量出貨功能）
- **程式說明**：提供銷售訂單報表的列印功能，支援多種查詢條件和報表格式

## 2. 程式概述

SOR160是西祺企業經營管理資訊系統中銷售訂單管理系統的報表程式，主要功能是根據使用者指定的條件產生銷售訂單報表。此程式提供多種查詢條件，包括訂單日期範圍、客戶代碼範圍、產品代碼範圍、訂單狀態等，使用者可以根據實際需求選擇適合的條件組合，生成客製化的銷售訂單報表。

報表可以按照不同的處理方式進行列印：明細列印、彙總列印或是兩者皆列印。明細列印會顯示每筆銷售訂單的詳細資料，包括訂單編號、客戶資訊、產品明細、數量、單價、金額等；彙總列印則會按照指定的條件（如客戶、產品類別等）進行資料彙總，顯示合計金額和數量。

SOR160程式採用模組化設計，主程式負責參數處理和報表控制，而實際的報表產生則由子程式（SOR1601、SOR1602、SOR1603）完成，確保程式結構清晰、易於維護和擴展。

## 3. 程式流程詳解

### 3.1 主要流程圖

```
開始
  |
  ↓
初始化系統環境
  |
  ↓
顯示選擇畫面
  |
  ↓
接收使用者輸入的查詢條件
  |
  ↓
驗證輸入條件
  |
  ↓
根據處理方式選擇報表類型
  |   ↙        ↓        ↘
明細列印    彙總列印    兩者皆列印
  |            |           |
  ↓            ↓           ↓
呼叫SOR1601  呼叫SOR1602  呼叫SOR1603
  |            |           |
  ↓            ↓           ↓
產生報表     產生報表    產生報表
  |            |           |
  ↘          ↓          ↙
       結束程式
```

### 3.2 詳細流程說明

#### 3.2.1 初始化階段

```RPG
FS#SDPF  IF  E           K        DISK
FSOR160D CF  E                    WORKSTN
F                                              KINFDS DSPFDS
ILDA        UDS
I                                      101 110 $USER
I                                      101 102 $AUT
I                                      119 1240$EGMDY
```

1. **檔案宣告**：
   - `S#SDPF`：系統代碼檔，輸入模式
   - `SOR160D`：顯示檔案，工作站模式

2. **變數宣告**：
   - 從LDA獲取使用者ID、權限和日期資訊
   - 定義查詢條件變數和控制變數

#### 3.2.2 主畫面處理

1. **初始化變數**：
   ```RPG
   C                     EXSR INIT
   ```
   - 初始化查詢條件和控制變數
   - 設定預設值

2. **顯示主畫面**：
   ```RPG
   C                     EXSR DSPMAIN
   ```
   - 顯示查詢條件輸入畫面
   - 處理使用者輸入

3. **驗證輸入**：
   ```RPG
   C                     EXSR CHKVAL
   ```
   - 檢查日期範圍是否有效
   - 檢查代碼範圍是否有效
   - 檢查處理方式是否有效

#### 3.2.3 報表處理

1. **處理方式判斷**：
   ```RPG
   C           COMP      CASEQ'1'     DETAIL
   C           COMP      CASEQ'2'     SUMMARY
   C           COMP      CASEQ'3'     BOTH
   ```
   - `1`：明細列印
   - `2`：彙總列印
   - `3`：兩者皆列印

2. **明細報表處理**：
   ```RPG
   C           DETAIL    BEGSR
   C                     CALL 'SOR1601'
   C                     PARM           PARM01
   C                     ENDSR
   ```
   - 呼叫SOR1601子程式
   - 傳遞查詢條件參數

3. **彙總報表處理**：
   ```RPG
   C           SUMMARY   BEGSR
   C                     CALL 'SOR1602'
   C                     PARM           PARM01
   C                     ENDSR
   ```
   - 呼叫SOR1602子程式
   - 傳遞查詢條件參數

4. **兩者皆列印處理**：
   ```RPG
   C           BOTH      BEGSR
   C                     CALL 'SOR1603'
   C                     PARM           PARM01
   C                     ENDSR
   ```
   - 呼叫SOR1603子程式
   - 傳遞查詢條件參數

#### 3.2.4 功能鍵處理

```RPG
C                     IF        *IN03 = *ON
C                     MOVE *ON       *INLR
C                     ENDIF
C                     IF        *IN04 = *ON
C                     EXSR F4HELP
C                     ENDIF
```
- F3：結束程式
- F4：顯示代碼查詢視窗

## 4. 畫面說明

### 4.1 主畫面（SCR001）

主畫面用於接收使用者輸入的查詢條件。

```
SOR160                      銷售訂單報表                     日期: YY/MM/DD
SCR001                                                      時間: HH:MM:SS
                                                            USER: XXXXXXXXXX

        處理方式: X (1=明細 2=彙總 3=兩者皆列印 " "=預覽)

        訂單日期: XXXXXX - XXXXXX

        客戶代碼: XXXXXX - XXXXXX

        產品代碼: XXXXXXXXX - XXXXXXXXX

        訂單狀態: X - X

        產品類別: XX - XX

        業務人員: XXXXXX - XXXXXX

        客戶群組: XXXXXX - XXXXXX


F3=結束 F4=代碼查詢
```

### 4.2 功能鍵說明

| 功能鍵 | 功能描述 | 處理子程序 |
|--------|---------|-----------|
| F3 | 結束程式 | 返回上層選單 |
| F4 | 代碼查詢 | F4HELP |

## 5. 報表格式說明

### 5.1 明細報表格式

明細報表顯示每筆銷售訂單的詳細資料。

```
                                銷售訂單報表                           頁碼: XXX
                                                                      日期: YY/MM/DD

處理方式: X XXXXXX

業務人員: XXXXXX

產品類別: XX - XX

訂單日期: XXXXXX - XXXXXX        訂單狀態: X - X

客戶代碼: XXXXXX - XXXXXX

訂單編號  訂單日期  客戶代碼  客戶名稱              產品代碼    產品名稱            數量    單價     金額
--------  --------  --------  --------------------  ---------   ----------------  ------  -------  ---------
XXXXXX    YY/MM/DD  XXXXXX    XXXXXXXXXXXXXXXXXXXX  XXXXXXXXX   XXXXXXXXXXXXXXXX  9,999   9,999.99  9,999,999.99
XXXXXX    YY/MM/DD  XXXXXX    XXXXXXXXXXXXXXXXXXXX  XXXXXXXXX   XXXXXXXXXXXXXXXX  9,999   9,999.99  9,999,999.99
XXXXXX    YY/MM/DD  XXXXXX    XXXXXXXXXXXXXXXXXXXX  XXXXXXXXX   XXXXXXXXXXXXXXXX  9,999   9,999.99  9,999,999.99

                                                                      合計金額:  9,999,999.99
```

### 5.2 彙總報表格式

彙總報表按照指定條件（如客戶、產品類別等）進行資料彙總。

```
                                銷售訂單彙總報表                        頁碼: XXX
                                                                      日期: YY/MM/DD

處理方式: X XXXXXX

業務人員: XXXXXX

產品類別: XX - XX

訂單日期: XXXXXX - XXXXXX        訂單狀態: X - X

客戶代碼: XXXXXX - XXXXXX

客戶代碼  客戶名稱              訂單數量  訂單金額      平均金額
--------  --------------------  --------  -----------  -----------
XXXXXX    XXXXXXXXXXXXXXXXXXXX     999    9,999,999.99  9,999,999.99
XXXXXX    XXXXXXXXXXXXXXXXXXXX     999    9,999,999.99  9,999,999.99
XXXXXX    XXXXXXXXXXXXXXXXXXXX     999    9,999,999.99  9,999,999.99

                                  總計:    9,999,999.99
```

## 6. 資料檔案說明

### 6.1 SOVRPF（銷售訂單主檔）

銷售訂單主檔存儲銷售訂單的基本資訊。

| 欄位名稱 | 資料類型 | 長度 | 說明 | 範例值 |
|---------|---------|------|------|--------|
| VR01 | 字元 | 6 | 訂單編號，主鍵 | 'S00123' |
| VR02 | 數值 | 6,0 | 訂單日期（YYMMDD） | 960908 |
| VR03 | 字元 | 6 | 客戶代碼 | 'C00456' |
| VR04 | 字元 | 6 | 業務人員代碼 | 'S00123' |
| VR05 | 字元 | 1 | 訂單狀態（1=新建, 2=處理中, 3=完成, 4=取消） | '2' |
| VR06 | 數值 | 9,2 | 訂單總金額 | 12500.00 |
| VR07 | 字元 | 20 | 備註 | '急件處理' |
| VRXX | 數值 | 6,0 | 建立日期 | 960908 |
| VRYY | 數值 | 6,0 | 建立時間 | 143025 |
| VRZZ | 字元 | 10 | 建立用戶 | 'A1491' |

### 6.2 SOVDPF（銷售訂單明細檔）

銷售訂單明細檔存儲銷售訂單的產品明細資訊。

| 欄位名稱 | 資料類型 | 長度 | 說明 | 範例值 |
|---------|---------|------|------|--------|
| VD01 | 字元 | 6 | 訂單編號，主鍵之一 | 'S00123' |
| VD02 | 數值 | 3,0 | 明細序號，主鍵之一 | 1 |
| VD03 | 字元 | 9 | 產品代碼 | 'P00000123' |
| VD04 | 數值 | 5,0 | 數量 | 10 |
| VD05 | 數值 | 7,2 | 單價 | 1250.00 |
| VD06 | 數值 | 9,2 | 金額（數量×單價） | 12500.00 |
| VD07 | 字元 | 20 | 備註 | '標準配置' |
| VDXX | 數值 | 6,0 | 建立日期 | 960908 |
| VDYY | 數值 | 6,0 | 建立時間 | 143025 |
| VDZZ | 字元 | 10 | 建立用戶 | 'A1491' |

### 6.3 CTMAPF（客戶主檔）

客戶主檔存儲客戶的基本資訊。

| 欄位名稱 | 資料類型 | 長度 | 說明 | 範例值 |
|---------|---------|------|------|--------|
| CT01 | 字元 | 6 | 客戶代碼，主鍵 | 'C00456' |
| CT02 | 字元 | 20 | 客戶名稱 | '台灣電子股份有限公司' |
| CT03 | 字元 | 6 | 客戶群組 | 'G001' |
| CT04 | 字元 | 6 | 業務人員代碼 | 'S00123' |
| CT05 | 字元 | 50 | 地址 | '台北市信義區信義路五段7號' |
| CT06 | 字元 | 15 | 電話 | '02-27291999' |
| CT07 | 字元 | 15 | 傳真 | '02-27291998' |
| CTXX | 數值 | 6,0 | 建立日期 | 950615 |
| CTYY | 數值 | 6,0 | 建立時間 | 093045 |
| CTZZ | 字元 | 10 | 建立用戶 | 'A1045' |

## 7. 程式邏輯說明

### 7.1 查詢條件處理

1. **日期範圍處理**：
   - 如果未輸入起始日期，預設為系統日期減去30天
   - 如果未輸入結束日期，預設為系統日期
   - 檢查起始日期是否小於等於結束日期

2. **代碼範圍處理**：
   - 如果未輸入起始代碼，預設為最小值（低值）
   - 如果未輸入結束代碼，預設為最大值（高值）
   - 檢查起始代碼是否小於等於結束代碼

3. **處理方式處理**：
   - 如果未輸入處理方式，預設為預覽模式
   - 檢查處理方式是否為有效值（1、2、3或空白）

### 7.2 報表產生流程

1. **明細報表（SOR1601）**：
   - 根據查詢條件讀取銷售訂單主檔和明細檔
   - 按照訂單編號排序
   - 顯示每筆訂單的詳細資料
   - 計算合計金額

2. **彙總報表（SOR1602）**：
   - 根據查詢條件讀取銷售訂單主檔和明細檔
   - 按照客戶代碼彙總資料
   - 計算每個客戶的訂單數量、訂單金額和平均金額
   - 計算總計金額

3. **兩者皆列印（SOR1603）**：
   - 先產生明細報表
   - 再產生彙總報表
   - 兩份報表使用相同的查詢條件

### 7.3 參數傳遞機制

程式使用參數結構傳遞查詢條件給子程式：

```RPG
C           PARM01     DS
C                     PARM           YMDS     6 0       起始日期
C                     PARM           YMDE     6 0       結束日期
C                     PARM           DSC33S   6         起始客戶代碼
C                     PARM           DSC33E   6         結束客戶代碼
C                     PARM           DMA01S   9         起始產品代碼
C                     PARM           DMA01E   9         結束產品代碼
C                     PARM           DSC34S   1         起始訂單狀態
C                     PARM           DSC34E   1         結束訂單狀態
C                     PARM           DSD03S   2         起始產品類別
C                     PARM           DSD03E   2         結束產品類別
C                     PARM           DSC45S   6         起始業務人員
C                     PARM           DSC45E   6         結束業務人員
C                     PARM           COMP     1         處理方式
```

## 8. 錯誤處理

### 8.1 輸入驗證錯誤

| 錯誤代碼 | 錯誤訊息 | 處理方式 |
|---------|---------|---------|
| ERR001 | 起始日期不能大於結束日期 | 顯示錯誤訊息，游標定位到起始日期欄位 |
| ERR002 | 起始客戶代碼不能大於結束客戶代碼 | 顯示錯誤訊息，游標定位到起始客戶代碼欄位 |
| ERR003 | 起始產品代碼不能大於結束產品代碼 | 顯示錯誤訊息，游標定位到起始產品代碼欄位 |
| ERR004 | 起始訂單狀態不能大於結束訂單狀態 | 顯示錯誤訊息，游標定位到起始訂單狀態欄位 |
| ERR005 | 起始產品類別不能大於結束產品類別 | 顯示錯誤訊息，游標定位到起始產品類別欄位 |
| ERR006 | 起始業務人員不能大於結束業務人員 | 顯示錯誤訊息，游標定位到起始業務人員欄位 |
| ERR007 | 處理方式必須為1、2、3或空白 | 顯示錯誤訊息，游標定位到處理方式欄位 |

### 8.2 報表產生錯誤

| 錯誤代碼 | 錯誤訊息 | 處理方式 |
|---------|---------|---------|
| ERR101 | 無符合條件的資料 | 顯示警告訊息，返回查詢畫面 |
| ERR102 | 報表產生過程中發生錯誤 | 顯示錯誤訊息，記錄錯誤日誌 |

## 9. 程式維護歷史

| 修改日期 | 修改者 | 修改內容 |
|---------|-------|---------|
| 96/09/06 | A1491 EASON | 程式初版建立 |
| 98/10/21 | MICHELLE | Y2K問題修正，日期格式調整 |
| 99/11/08 | 未知 | 增加客戶群組選項 |
| 00/11/08 | 未知 | 增加大量出貨功能 |

## 10. 系統整合

SOR160作為銷售訂單管理系統的報表程式，與以下系統模組有緊密的整合關係：

1. **銷售訂單管理系統**（SOM000C）：提供銷售訂單資料
2. **客戶管理系統**（CTM000C）：提供客戶資料
3. **產品管理系統**（MTM000C）：提供產品資料
4. **業務人員管理系統**（SAM000C）：提供業務人員資料

## 11. 使用說明

### 11.1 進入程式

從銷售訂單管理系統主選單選擇「銷售訂單報表」選項進入本程式。

### 11.2 設定查詢條件

1. 在主畫面輸入查詢條件
2. 使用F4功能鍵可以查詢代碼
3. 設定處理方式（1=明細、2=彙總、3=兩者皆列印、空白=預覽）
4. 按下Enter鍵確認

### 11.3 報表預覽

如果處理方式設為空白，系統會在螢幕上預覽報表內容，不會實際列印。

### 11.4 報表列印

如果處理方式設為1、2或3，系統會根據設定產生相應的報表並列印。

## 12. 效能考量

### 12.1 查詢優化

程式在處理大量資料時採取以下優化策略：

1. **條件過濾**：
   - 使用查詢條件縮小資料範圍
   - 減少需要處理的記錄數量

2. **索引使用**：
   - 使用銷售訂單主檔和明細檔的索引
   - 提高檔案讀取效率

### 12.2 報表產生

報表產生過程中的效能考量：

1. **分批處理**：
   - 每次讀取一定數量的記錄
   - 避免一次載入過多資料

2. **記憶體管理**：
   - 適當使用暫存變數
   - 避免不必要的資料複製

## 13. 安全考量

### 13.1 權限控制

程式從LDA獲取使用者權限資訊（$AUT），根據使用者的權限控制可執行的操作：

- 只有具有查詢權限的使用者才能執行本程式
- 系統會記錄報表產生的使用者和時間

### 13.2 資料過濾

程式在產生報表時會根據使用者的權限過濾資料：

1. **業務人員限制**：
   - 一般業務人員只能查詢自己負責的客戶訂單
   - 主管可以查詢所有訂單

2. **敏感資料處理**：
   - 根據使用者權限決定是否顯示成本和利潤資訊
   - 限制特定客戶資料的查詢

## 14. 未來擴展建議

### 14.1 功能擴展

1. **報表格式**：
   - 增加更多報表格式選項
   - 支援自定義報表欄位

2. **匯出功能**：
   - 增加將報表匯出為Excel或PDF格式的功能
   - 支援電子郵件發送報表

3. **圖表功能**：
   - 增加銷售趨勢圖表
   - 提供視覺化的銷售分析

### 14.2 技術改進

1. **使用者介面**：
   - 改善查詢條件輸入界面
   - 增加更多的視覺提示

2. **效能優化**：
   - 優化大量資料處理邏輯
   - 實現更高效的報表產生機制

## 15. 結論

SOR160是西祺企業經營管理資訊系統中銷售訂單管理系統的重要報表程式，提供了全面的銷售訂單報表功能。它支援多種查詢條件和報表格式，能夠滿足企業不同層級使用者的需求，為銷售分析和決策提供重要依據。

程式採用模組化設計，主程式負責參數處理和報表控制，而實際的報表產生則由子程式完成，確保程式結構清晰、易於維護和擴展。通過嚴格的輸入驗證和權限控制，確保了系統的安全性和資料的準確性。

隨著系統的不斷發展，SOR160可以進一步擴展功能，如增加更多報表格式、支援資料匯出和圖表顯示等，為企業提供更全面、更靈活的銷售訂單報表解決方案。 